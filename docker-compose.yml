version: '3.8'

networks:
  media_net:
    driver: bridge

services:
  bili-curator:
    build: 
      context: ./bili_curator
      args:
        VERSION: ${VERSION:-v7}
    image: bili_curator:${VERSION:-v7}
    container_name: bili_curator_${VERSION:-v7}
    networks:
      - media_net
    ports:
      - "8080:8080"
    volumes:
      # 本地下载目录
      - ${DOWNLOAD_HOST_PATH:-/Volumes/nas-mk/xiaoya_emby/xiaoya/bilibili}:/app/downloads
      # STRM文件目录 (V7)
      - ${STRM_HOST_PATH:-/Volumes/nas-mk/xiaoya_emby/xiaoya/bilibili_strm}:/app/strm
      # 配置目录
      - ${CONFIG_HOST_PATH:-${HOME}/bilibili_config}:/app/data
      # 日志目录
      - ${CONFIG_HOST_PATH:-${HOME}/bilibili_config}/logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
      - VERSION=${VERSION:-v7}
      - TZ=${TZ:-Asia/Shanghai}
      
      # 基础配置
      - DOWNLOAD_PATH=/app/downloads
      - DB_PATH=/app/data/bilibili_curator.db
      - DEDUP_SCOPE=${DEDUP_SCOPE:-subscription}
      - DEDUP_SCAN_FILESYSTEM=${DEDUP_SCAN_FILESYSTEM:-0}
      - BATCH_IN_SIZE=${BATCH_IN_SIZE:-500}
      
      # STRM配置 (V7)
      - STRM_PATH=/app/strm
      - STRM_DEFAULT_QUALITY=${STRM_DEFAULT_QUALITY:-720p}
      - STRM_CACHE_TTL=${STRM_CACHE_TTL:-300}
      - STRM_MAX_CONCURRENT_STREAMS=${STRM_MAX_CONCURRENT_STREAMS:-10}
      - STRM_RATE_LIMIT_PER_IP=${STRM_RATE_LIMIT_PER_IP:-5}
      - FFMPEG_PATH=${FFMPEG_PATH:-/usr/bin/ffmpeg}
      
      # 指标统计刷新（调度器预热 metrics 缓存，单位：分钟，范围 5~720）
      - METRICS_REFRESH_INTERVAL_MINUTES=${METRICS_REFRESH_INTERVAL_MINUTES:-30}
      
      # B站认证 (STRM模式需要)
      - BILIBILI_SESSDATA=${BILIBILI_SESSDATA:-}
      - BILIBILI_BILI_JCT=${BILIBILI_BILI_JCT:-}
      - BILIBILI_BUVID3=${BILIBILI_BUVID3:-}
      
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "bili_curator.version=${VERSION:-v7}"
      - "bili_curator.mode=${VERSION:-v7}"

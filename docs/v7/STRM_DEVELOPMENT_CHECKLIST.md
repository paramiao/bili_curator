# bili_curator V7 STRM功能开发检查清单

## 版本升级说明

本检查清单适用于从V6稳定版升级到V7 STRM扩展版的开发工作。V7版本保持V6所有功能不变，仅新增STRM流媒体支持。

## Phase 1: 核心基础设施

### Milestone 1.1: 数据模型扩展
- [ ] **models.py扩展**
  - [ ] 添加`DownloadMode`枚举类型
  - [ ] 在`Subscription`类中添加`download_mode`字段
  - [ ] 更新Pydantic模型支持新字段
  
- [ ] **数据库迁移**
  - [ ] 在`_migrate_schema`方法中添加迁移逻辑
  - [ ] 测试现有数据库的兼容性
  - [ ] 验证默认值设置正确（'local'）
  
- [ ] **测试验证**
  - [ ] 创建测试订阅验证字段存在
  - [ ] 确认现有订阅默认为LOCAL模式
  - [ ] 测试新订阅可选择STRM模式

**检查点1.1**：✅ 数据模型扩展完成，现有数据兼容

### Milestone 1.2: 路径管理统一
- [ ] **downloader.py扩展**
  - [ ] 实现`get_subscription_base_path`方法
  - [ ] 修改`_create_subscription_directory`支持STRM路径
  - [ ] 添加文件名安全化方法`_sanitize_filename`
  
- [ ] **环境变量配置**
  - [ ] 更新`docker-compose.yml`添加STRM相关环境变量
  - [ ] 添加STRM目录卷挂载配置
  - [ ] 创建默认配置文档
  
- [ ] **目录结构测试**
  - [ ] 测试LOCAL模式目录创建（现有功能）
  - [ ] 测试STRM模式目录创建
  - [ ] 验证两种模式目录完全隔离

**检查点1.2**：✅ 路径管理统一完成，目录隔离生效

## Phase 2: STRM核心功能

### Milestone 2.1: 代理服务实现
- [ ] **创建代理服务模块**
  - [ ] 新建`app/services/strm_proxy_service.py`
  - [ ] 实现`BilibiliStreamProxy`类
  - [ ] 集成现有`cookie_manager`和重试机制
  
- [ ] **缓存机制实现**
  - [ ] 实现内存缓存（L1级别）
  - [ ] 添加缓存过期和清理逻辑
  - [ ] 实现缓存统计和监控
  
- [ ] **流解析和转换**
  - [ ] 实现B站DASH流解析
  - [ ] 集成FFmpeg进行HLS转换
  - [ ] 处理音视频分离合并
  
- [ ] **API路由添加**
  - [ ] 在`api.py`中添加`/api/v1/stream/{bvid}`路由
  - [ ] 实现流媒体响应和错误处理
  - [ ] 添加BVID格式验证

**检查点2.1**：✅ 代理服务可独立运行，正确解析B站视频流

### Milestone 2.2: 下载器STRM分支
- [ ] **下载分支逻辑**
  - [ ] 扩展`_download_single_video`方法支持模式判断
  - [ ] 实现`_create_strm_entry`方法
  - [ ] 保持现有LOCAL模式逻辑不变
  
- [ ] **STRM文件生成**
  - [ ] 实现.strm文件内容生成
  - [ ] 实现.nfo元数据文件生成
  - [ ] 实现缩略图下载（仅小文件）
  
- [ ] **数据库记录**
  - [ ] 创建Video记录指向.strm文件
  - [ ] 正确设置downloaded状态
  - [ ] 更新订阅统计信息
  
- [ ] **错误处理**
  - [ ] 处理网络异常情况
  - [ ] 实现重试机制
  - [ ] 记录失败原因

**检查点2.2**：✅ STRM模式订阅能正常"下载"，生成正确的文件结构

## Phase 3: API和UI集成

### Milestone 3.1: API接口扩展
- [ ] **订阅管理API扩展**
  - [ ] 扩展`SubscriptionCreate`模型添加`download_mode`
  - [ ] 更新创建订阅接口验证逻辑
  - [ ] 扩展订阅列表接口返回模式信息
  
- [ ] **STRM专用接口**
  - [ ] 实现`/api/strm/status`状态查询接口
  - [ ] 实现`/api/strm/cache`缓存管理接口
  - [ ] 添加缓存清理和刷新接口
  
- [ ] **API文档更新**
  - [ ] 更新OpenAPI文档
  - [ ] 添加新接口的使用示例
  - [ ] 更新错误码说明

**检查点3.1**：✅ API完整支持STRM功能，接口文档齐全

### Milestone 3.2: 前端界面支持
- [ ] **订阅创建界面**
  - [ ] 添加下载模式选择组件
  - [ ] 显示两种模式的对比说明
  - [ ] 实现路径预览功能
  
- [ ] **订阅列表界面**
  - [ ] 添加模式标识图标
  - [ ] 区分显示存储统计信息
  - [ ] 添加STRM服务状态指示器
  
- [ ] **系统监控界面**
  - [ ] 创建STRM服务监控面板
  - [ ] 显示缓存统计和性能指标
  - [ ] 添加服务控制按钮
  
- [ ] **帮助文档**
  - [ ] 更新用户使用指南
  - [ ] 添加STRM模式说明
  - [ ] 创建常见问题解答

**检查点3.2**：✅ 前端完整支持STRM功能，用户体验友好

## Phase 4: 测试和优化

### Milestone 4.1: 集成测试
- [ ] **功能测试**
  - [ ] 端到端测试：创建STRM订阅→生成文件→播放
  - [ ] 兼容性测试：现有LOCAL订阅不受影响
  - [ ] 边界条件测试：网络异常、Cookie失效等
  
- [ ] **性能测试**
  - [ ] 并发播放测试（10个同时流）
  - [ ] 缓存命中率测试
  - [ ] 内存使用和泄漏测试
  
- [ ] **Emby集成测试**
  - [ ] 验证.strm文件被正确识别
  - [ ] 测试.nfo元数据显示
  - [ ] 验证缩略图正常加载
  
- [ ] **错误恢复测试**
  - [ ] 代理服务重启恢复
  - [ ] 网络中断恢复
  - [ ] 缓存失效处理

**检查点4.1**：✅ 系统稳定运行，所有测试用例通过

### Milestone 4.2: 生产就绪
- [ ] **日志和监控**
  - [ ] 完善日志记录（INFO/WARN/ERROR级别）
  - [ ] 添加关键指标监控
  - [ ] 实现健康检查接口
  
- [ ] **配置管理**
  - [ ] 创建配置文件模板
  - [ ] 添加配置验证逻辑
  - [ ] 编写配置说明文档
  
- [ ] **部署文档**
  - [ ] 更新Docker部署指南
  - [ ] 创建升级迁移文档
  - [ ] 编写故障排除指南
  
- [ ] **性能调优**
  - [ ] 优化缓存策略
  - [ ] 调整并发参数
  - [ ] 实现资源限制

**检查点4.2**：✅ 功能完整，文档齐全，可投入生产使用

## 验收标准

### 功能验收
- [ ] 用户可通过UI选择订阅模式
- [ ] STRM模式正确生成.strm、.nfo、.jpg文件
- [ ] Emby能正常扫描和播放STRM文件
- [ ] 代理服务稳定响应播放请求
- [ ] 现有LOCAL模式功能完全不受影响

### 性能验收
- [ ] STRM模式存储占用 < 1%（相比LOCAL模式）
- [ ] 播放启动时间 < 5秒（首次播放）
- [ ] 缓存命中率 > 80%（稳定运行后）
- [ ] 系统内存增长 < 100MB（STRM功能）
- [ ] 支持至少10个并发播放流

### 稳定性验收
- [ ] 连续运行24小时无重大故障
- [ ] 网络异常自动恢复
- [ ] Cookie失效自动重试
- [ ] 代理服务异常自动重启
- [ ] 缓存清理正常工作

### 用户体验验收
- [ ] 界面操作直观易懂
- [ ] 错误信息清晰明确
- [ ] 帮助文档完整准确
- [ ] 配置过程简单明了
- [ ] 故障排除文档实用

## 风险控制检查

### 技术风险
- [ ] B站API变更应对策略
- [ ] FFmpeg依赖可用性确认
- [ ] 网络稳定性保障措施
- [ ] 并发处理能力验证

### 兼容性风险
- [ ] 数据库迁移回滚方案
- [ ] 现有功能隔离验证
- [ ] 多版本Emby兼容性测试
- [ ] 不同操作系统兼容性

### 运维风险
- [ ] 监控告警机制完善
- [ ] 故障恢复流程测试
- [ ] 配置备份和恢复
- [ ] 性能瓶颈识别和优化

## 文档交付清单

- [x] **STRM_IMPLEMENTATION_PLAN.md** - 实现方案文档
- [x] **STRM_ARCHITECTURE_DESIGN.md** - 架构设计文档  
- [x] **STRM_DEVELOPMENT_CHECKLIST.md** - 开发检查清单
- [ ] **STRM_USER_GUIDE.md** - 用户使用指南
- [ ] **STRM_DEPLOYMENT_GUIDE.md** - 部署配置指南
- [ ] **STRM_TROUBLESHOOTING.md** - 故障排除指南
- [ ] **STRM_API_REFERENCE.md** - API接口文档

---

**检查清单版本**：v1.0  
**创建日期**：2025-08-23  
**状态跟踪**：使用 `[ ]` 表示待完成，`[x]` 表示已完成

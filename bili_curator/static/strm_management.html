<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>STRMæµåª’ä½“ç®¡ç† - Bilibili Curator V7</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; 
      margin: 0; 
      padding: 16px; 
      color: #1f2937; 
      background: #f9fafb; 
    }
    
    .container { max-width: 1200px; margin: 0 auto; }
    
    h1 { 
      font-size: 28px; 
      margin: 0 0 24px; 
      color: #111827; 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }
    
    .mode-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    
    .nav-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .nav-tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: #6b7280;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .nav-tab.active {
      color: #2563eb;
      border-bottom-color: #2563eb;
      background: rgba(37, 99, 235, 0.05);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .card { 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      padding: 20px; 
      background: #fff; 
      margin-bottom: 20px; 
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .card h2 { 
      margin: 0 0 16px; 
      font-size: 18px; 
      color: #111827;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #f3f4f6 0%, #ffffff 100%);
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .stat-value.strm { color: #7c3aed; }
    .stat-value.local { color: #059669; }
    .stat-value.active { color: #dc2626; }
    .stat-value.total { color: #2563eb; }
    
    .stat-label {
      font-size: 14px;
      color: #6b7280;
      font-weight: 500;
    }
    
    button { 
      padding: 10px 16px; 
      border-radius: 8px; 
      border: 1px solid #d1d5db; 
      background: #f9fafb; 
      cursor: pointer; 
      font-weight: 500;
      transition: all 0.2s;
    }
    
    button.primary { 
      background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); 
      color: #fff; 
      border-color: #1d4ed8; 
    }
    
    button.success {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      color: #fff;
      border-color: #047857;
    }
    
    button.warning {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: #fff;
      border-color: #b91c1c;
    }
    
    .status-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .status-healthy { background: #ecfdf5; color: #065f46; }
    .status-warning { background: #fef3c7; color: #92400e; }
    .status-error { background: #fef2f2; color: #991b1b; }
    
    .stream-list {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
    }
    
    .stream-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #f3f4f6;
    }
    
    .stream-info {
      flex: 1;
    }
    
    .stream-title {
      font-weight: 500;
      color: #111827;
      margin-bottom: 4px;
    }
    
    .stream-meta {
      font-size: 12px;
      color: #6b7280;
    }
    
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .alert-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
    }
    
    .row {
      display: flex;
      gap: 16px;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .flex-1 { flex: 1; }
    .text-center { text-align: center; }
    .mt-4 { margin-top: 16px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>
      ğŸ¬ STRMæµåª’ä½“ç®¡ç†
      <span class="mode-badge">V7 æ–°åŠŸèƒ½</span>
    </h1>
    
    <!-- å¯¼èˆªæ ‡ç­¾ -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">ğŸ“Š æ€»è§ˆ</button>
      <button class="nav-tab" data-tab="streams">ğŸ¥ æ´»è·ƒæµ</button>
      <button class="nav-tab" data-tab="settings">âš™ï¸ è®¾ç½®</button>
    </div>
    
    <!-- æ€»è§ˆæ ‡ç­¾ -->
    <div class="tab-content active" id="overview">
      <!-- ç»Ÿè®¡å¡ç‰‡ -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value strm" id="stat-strm-subscriptions">-</div>
          <div class="stat-label">STRMè®¢é˜…</div>
        </div>
        <div class="stat-card">
          <div class="stat-value local" id="stat-local-subscriptions">-</div>
          <div class="stat-label">LOCALè®¢é˜…</div>
        </div>
        <div class="stat-card">
          <div class="stat-value active" id="stat-active-streams">-</div>
          <div class="stat-label">æ´»è·ƒæµ</div>
        </div>
        <div class="stat-card">
          <div class="stat-value total" id="stat-total-files">-</div>
          <div class="stat-label">STRMæ–‡ä»¶</div>
        </div>
      </div>
      
      <!-- ç³»ç»ŸçŠ¶æ€ -->
      <div class="card">
        <h2>ğŸ” ç³»ç»ŸçŠ¶æ€</h2>
        <div class="row">
          <div class="flex-1">
            <strong>ä»£ç†æœåŠ¡:</strong>
            <span class="status-indicator status-healthy" id="proxy-status">
              â— è¿è¡Œæ­£å¸¸
            </span>
          </div>
          <div class="flex-1">
            <strong>æ–‡ä»¶ç®¡ç†:</strong>
            <span class="status-indicator status-healthy" id="file-status">
              â— è¿è¡Œæ­£å¸¸
            </span>
          </div>
          <div class="flex-1">
            <strong>FFmpeg:</strong>
            <span class="status-indicator status-healthy" id="ffmpeg-status">
              â— å¯ç”¨
            </span>
          </div>
        </div>
        <div class="mt-4">
          <button class="primary" onclick="checkSystemHealth()">ğŸ”„ æ£€æŸ¥ç³»ç»Ÿå¥åº·</button>
          <button onclick="cleanupExpiredStreams()">ğŸ§¹ æ¸…ç†è¿‡æœŸæµ</button>
        </div>
      </div>
      
      <!-- å¿«é€Ÿæ“ä½œ -->
      <div class="card">
        <h2>âš¡ å¿«é€Ÿæ“ä½œ</h2>
        <div class="row">
          <button class="success" onclick="showCreateStreamDialog()">â• åˆ›å»ºæµ</button>
          <button onclick="syncAllDirectories()">ğŸ”„ åŒæ­¥ç›®å½•</button>
          <button onclick="refreshStats()">ğŸ“Š åˆ·æ–°ç»Ÿè®¡</button>
          <button class="warning" onclick="showSystemDiagnostics()">ğŸ”§ ç³»ç»Ÿè¯Šæ–­</button>
        </div>
      </div>
    </div>
    
    <!-- æ´»è·ƒæµæ ‡ç­¾ -->
    <div class="tab-content" id="streams">
      <div class="card">
        <h2>ğŸ¥ æ´»è·ƒæµåˆ—è¡¨</h2>
        <div class="alert alert-info">
          <span>ğŸ’¡</span>
          <span>æ˜¾ç¤ºå½“å‰æ­£åœ¨æ’­æ”¾çš„STRMæµï¼ŒåŒ…æ‹¬æ’­æ”¾çŠ¶æ€å’Œè®¿é—®ç»Ÿè®¡</span>
        </div>
        <div class="stream-list" id="active-streams-list">
          <div class="loading">åŠ è½½æ´»è·ƒæµåˆ—è¡¨...</div>
        </div>
      </div>
    </div>
    
    <!-- è®¾ç½®æ ‡ç­¾ -->
    <div class="tab-content" id="settings">
      <div class="card">
        <h2>âš™ï¸ STRMè®¾ç½®</h2>
        <div class="alert alert-info">
          <span>âš™ï¸</span>
          <span>STRMåŠŸèƒ½é…ç½®å’Œç¯å¢ƒéªŒè¯</span>
        </div>
        <div class="settings-content">
          <div class="row">
            <div class="flex-1">
              <label><strong>STRMæ–‡ä»¶ç›®å½•:</strong></label>
              <input type="text" id="strm-directory" placeholder="/path/to/strm/files" style="width: 100%; margin-top: 4px;">
            </div>
            <button onclick="browseDirectory()">ğŸ“ æµè§ˆ</button>
          </div>
          <div class="row">
            <div class="flex-1">
              <label><strong>FFmpegè·¯å¾„:</strong></label>
              <input type="text" id="ffmpeg-path" placeholder="/usr/local/bin/ffmpeg" style="width: 100%; margin-top: 4px;">
            </div>
            <button onclick="detectFFmpeg()">ğŸ” è‡ªåŠ¨æ£€æµ‹</button>
          </div>
          <div class="row">
            <label><strong>æœåŠ¡ç«¯å£:</strong></label>
            <input type="number" id="proxy-port" value="8080" style="width: 100px; margin-left: 8px;">
          </div>
          <div class="mt-4">
            <button class="primary" onclick="validateEnvironment()">ğŸ” éªŒè¯ç¯å¢ƒ</button>
            <button onclick="saveSettings()">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
            <button class="warning" onclick="resetSettings()">ğŸ”„ é‡ç½®</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // å…¨å±€çŠ¶æ€
    let currentTab = 'overview';
    let refreshInterval = null;
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeTabs();
      loadInitialData();
      loadSettings();
      startAutoRefresh();
    });
    
    // æ ‡ç­¾åˆ‡æ¢
    function initializeTabs() {
      const tabs = document.querySelectorAll('.nav-tab');
      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          switchTab(tabId);
        });
      });
    }
    
    function switchTab(tabId) {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
      
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabId).classList.add('active');
      
      currentTab = tabId;
      
      if (tabId === 'streams') {
        loadActiveStreams();
      }
    }
    
    // åŠ è½½åˆå§‹æ•°æ®
    async function loadInitialData() {
      await loadOverviewData();
    }
    
    // åŠ è½½æ€»è§ˆæ•°æ®
    async function loadOverviewData() {
      try {
        const [streamStats, fileStats, healthStatus] = await Promise.all([
          fetch('/api/strm/stats/streams').then(r => r.json()),
          fetch('/api/strm/stats/files').then(r => r.json()),
          fetch('/api/strm/health').then(r => r.json())
        ]);
        
        if (streamStats.success) {
          document.getElementById('stat-active-streams').textContent = streamStats.data.active_streams || 0;
        }
        
        if (fileStats.success) {
          document.getElementById('stat-total-files').textContent = fileStats.data.total_strm_files || 0;
        }
        
        updateSystemStatus(healthStatus);
        
      } catch (error) {
        console.error('åŠ è½½æ€»è§ˆæ•°æ®å¤±è´¥:', error);
      }
    }
    
    // æ›´æ–°ç³»ç»ŸçŠ¶æ€
    function updateSystemStatus(healthData) {
      if (!healthData.success) {
        updateStatusIndicator('proxy-status', 'error', 'â— å¼‚å¸¸');
        updateStatusIndicator('file-status', 'error', 'â— å¼‚å¸¸');
        updateStatusIndicator('ffmpeg-status', 'error', 'â— ä¸å¯ç”¨');
        return;
      }
      
      const data = healthData.data;
      const proxyStatus = data.proxy_service?.status === 'healthy' ? 'healthy' : 'error';
      const proxyText = proxyStatus === 'healthy' ? 'â— è¿è¡Œæ­£å¸¸' : 'â— å¼‚å¸¸';
      updateStatusIndicator('proxy-status', proxyStatus, proxyText);
      
      const fileStatus = data.file_manager?.status === 'healthy' ? 'healthy' : 'error';
      const fileText = fileStatus === 'healthy' ? 'â— è¿è¡Œæ­£å¸¸' : 'â— å¼‚å¸¸';
      updateStatusIndicator('file-status', fileStatus, fileText);
      
      updateStatusIndicator('ffmpeg-status', 'healthy', 'â— å¯ç”¨');
    }
    
    function updateStatusIndicator(elementId, status, text) {
      const element = document.getElementById(elementId);
      element.className = `status-indicator status-${status}`;
      element.textContent = text;
    }
    
    // åŠ è½½æ´»è·ƒæµ
    async function loadActiveStreams() {
      const container = document.getElementById('active-streams-list');
      container.innerHTML = '<div class="loading">åŠ è½½æ´»è·ƒæµåˆ—è¡¨...</div>';
      
      try {
        const response = await fetch('/api/strm/stats/streams');
        const data = await response.json();
        
        if (data.success && data.data.streams) {
          renderActiveStreams(data.data.streams);
        } else {
          container.innerHTML = '<div class="text-center">æš‚æ— æ´»è·ƒæµ</div>';
        }
      } catch (error) {
        console.error('åŠ è½½æ´»è·ƒæµå¤±è´¥:', error);
        container.innerHTML = '<div class="text-center" style="color: #dc2626;">åŠ è½½å¤±è´¥</div>';
      }
    }
    
    function renderActiveStreams(streams) {
      const container = document.getElementById('active-streams-list');
      
      if (streams.length === 0) {
        container.innerHTML = '<div class="text-center">æš‚æ— æ´»è·ƒæµ</div>';
        return;
      }
      
      const html = streams.map(stream => `
        <div class="stream-item">
          <div class="stream-info">
            <div class="stream-title">${stream.bilibili_id}</div>
            <div class="stream-meta">
              è´¨é‡: ${stream.quality} | 
              è®¿é—®æ¬¡æ•°: ${stream.access_count} | 
              åˆ›å»ºæ—¶é—´: ${new Date(stream.created_at).toLocaleString()}
            </div>
          </div>
        </div>
      `).join('');
      
      container.innerHTML = html;
    }
    
    // å·¥å…·å‡½æ•°
    async function checkSystemHealth() {
      try {
        const response = await fetch('/api/strm/health');
        const data = await response.json();
        updateSystemStatus(data);
        showAlert(data.success ? 'ç³»ç»Ÿå¥åº·æ£€æŸ¥å®Œæˆ' : 'ç³»ç»Ÿæ£€æŸ¥å‘ç°é—®é¢˜');
      } catch (error) {
        showAlert('å¥åº·æ£€æŸ¥å¤±è´¥');
      }
    }
    
    async function cleanupExpiredStreams() {
      try {
        const response = await fetch('/api/strm/cleanup/expired', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showAlert('è¿‡æœŸæµæ¸…ç†å®Œæˆ');
          loadActiveStreams();
        } else {
          showAlert('æ¸…ç†å¤±è´¥');
        }
      } catch (error) {
        showAlert('æ¸…ç†æ“ä½œå¤±è´¥');
      }
    }
    
    function refreshStats() {
      loadOverviewData();
      showAlert('ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°');
    }
    
    function showAlert(message) {
      const alert = document.createElement('div');
      alert.className = 'alert alert-info';
      alert.innerHTML = `<span>âœ“</span><span>${message}</span>`;
      alert.style.position = 'fixed';
      alert.style.top = '20px';
      alert.style.right = '20px';
      alert.style.zIndex = '1000';
      
      document.body.appendChild(alert);
      
      setTimeout(() => {
        alert.remove();
      }, 3000);
    }
    
    function startAutoRefresh() {
      refreshInterval = setInterval(() => {
        if (currentTab === 'overview') {
          loadOverviewData();
        } else if (currentTab === 'streams') {
          loadActiveStreams();
        }
      }, 30000);
    }
    
    // å®ç”¨åŠŸèƒ½å‡½æ•°
    async function showCreateStreamDialog() {
      const bilibiliId = prompt('è¯·è¾“å…¥Bç«™è§†é¢‘BVå·:');
      if (!bilibiliId) return;
      
      try {
        const response = await fetch('/api/strm/streams/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ bilibili_id: bilibiliId, quality: 'auto' })
        });
        const data = await response.json();
        
        if (data.success) {
          showAlert('æµåˆ›å»ºæˆåŠŸ');
          loadActiveStreams();
        } else {
          showAlert('åˆ›å»ºå¤±è´¥: ' + data.message);
        }
      } catch (error) {
        showAlert('åˆ›å»ºå¤±è´¥: ç½‘ç»œé”™è¯¯');
      }
    }
    
    async function syncAllDirectories() {
      try {
        const response = await fetch('/api/strm/files/sync', { method: 'POST' });
        const data = await response.json();
        
        if (data.success) {
          showAlert(`åŒæ­¥å®Œæˆï¼Œå¤„ç†äº† ${data.data.synced_count} ä¸ªæ–‡ä»¶`);
          refreshStats();
        } else {
          showAlert('åŒæ­¥å¤±è´¥: ' + data.message);
        }
      } catch (error) {
        showAlert('åŒæ­¥å¤±è´¥: ç½‘ç»œé”™è¯¯');
      }
    }
    
    async function showSystemDiagnostics() {
      try {
        const response = await fetch('/api/strm/health');
        const data = await response.json();
        
        let diagnostics = 'ğŸ”§ ç³»ç»Ÿè¯Šæ–­ç»“æœ:\n\n';
        if (data.success) {
          const health = data.data;
          diagnostics += `ä»£ç†æœåŠ¡: ${health.proxy_service?.status || 'unknown'}\n`;
          diagnostics += `æ–‡ä»¶ç®¡ç†: ${health.file_manager?.status || 'unknown'}\n`;
          diagnostics += `FFmpeg: ${health.ffmpeg?.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}\n`;
          diagnostics += `å†…å­˜ä½¿ç”¨: ${health.system?.memory_usage || 'N/A'}\n`;
          diagnostics += `CPUä½¿ç”¨: ${health.system?.cpu_usage || 'N/A'}\n`;
        } else {
          diagnostics += 'è¯Šæ–­å¤±è´¥: ' + data.message;
        }
        
        alert(diagnostics);
      } catch (error) {
        showAlert('è¯Šæ–­å¤±è´¥: ç½‘ç»œé”™è¯¯');
      }
    }
    
    async function validateEnvironment() {
      try {
        const response = await fetch('/api/strm/health');
        const data = await response.json();
        
        if (data.success) {
          const health = data.data;
          let issues = [];
          
          if (health.proxy_service?.status !== 'healthy') issues.push('ä»£ç†æœåŠ¡å¼‚å¸¸');
          if (health.file_manager?.status !== 'healthy') issues.push('æ–‡ä»¶ç®¡ç†å¼‚å¸¸');
          if (!health.ffmpeg?.available) issues.push('FFmpegä¸å¯ç”¨');
          
          if (issues.length === 0) {
            showAlert('âœ… ç¯å¢ƒéªŒè¯é€šè¿‡ï¼Œæ‰€æœ‰ç»„ä»¶æ­£å¸¸');
          } else {
            showAlert('âš ï¸ å‘ç°é—®é¢˜: ' + issues.join(', '));
          }
        } else {
          showAlert('éªŒè¯å¤±è´¥: ' + data.message);
        }
      } catch (error) {
        showAlert('éªŒè¯å¤±è´¥: ç½‘ç»œé”™è¯¯');
      }
    }
    
    function browseDirectory() {
      showAlert('è¯·æ‰‹åŠ¨è¾“å…¥ç›®å½•è·¯å¾„');
    }
    
    function detectFFmpeg() {
      // å¸¸è§FFmpegè·¯å¾„
      const commonPaths = ['/usr/local/bin/ffmpeg', '/usr/bin/ffmpeg', '/opt/homebrew/bin/ffmpeg'];
      document.getElementById('ffmpeg-path').value = commonPaths[0];
      showAlert('å·²è®¾ç½®ä¸ºå¸¸è§è·¯å¾„ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´');
    }
    
    function saveSettings() {
      const settings = {
        strm_directory: document.getElementById('strm-directory').value,
        ffmpeg_path: document.getElementById('ffmpeg-path').value,
        proxy_port: document.getElementById('proxy-port').value
      };
      
      localStorage.setItem('strm_settings', JSON.stringify(settings));
      showAlert('è®¾ç½®å·²ä¿å­˜åˆ°æœ¬åœ°');
    }
    
    function resetSettings() {
      document.getElementById('strm-directory').value = '';
      document.getElementById('ffmpeg-path').value = '/usr/local/bin/ffmpeg';
      document.getElementById('proxy-port').value = '8080';
      showAlert('è®¾ç½®å·²é‡ç½®');
    }
    
    // åŠ è½½ä¿å­˜çš„è®¾ç½®
    function loadSettings() {
      const saved = localStorage.getItem('strm_settings');
      if (saved) {
        const settings = JSON.parse(saved);
        if (settings.strm_directory) document.getElementById('strm-directory').value = settings.strm_directory;
        if (settings.ffmpeg_path) document.getElementById('ffmpeg-path').value = settings.ffmpeg_path;
        if (settings.proxy_port) document.getElementById('proxy-port').value = settings.proxy_port;
      }
    }
  </script>
</body>
</html>

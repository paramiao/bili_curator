<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>队列调试页面</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status { padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.done { background: #d4edda; color: #155724; }
        .status.queued { background: #cce5ff; color: #004085; }
        .status.failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>队列调试页面</h1>
    
    <div class="section">
        <h2>API测试</h2>
        <button onclick="testApiRequests()">测试 /api/requests</button>
        <button onclick="testApiStats()">测试 /api/queue/stats</button>
        <button onclick="testApiHealth()">测试 /health</button>
        <div id="api-results"></div>
    </div>

    <div class="section">
        <h2>网络请求状态</h2>
        <div id="network-status"></div>
    </div>

    <div class="section">
        <h2>任务列表</h2>
        <button onclick="loadAndDisplayTasks()">加载任务列表</button>
        <div id="task-count"></div>
        <table id="task-table" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>类型</th>
                    <th>订阅ID</th>
                    <th>需要Cookie</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>开始时间</th>
                    <th>完成时间</th>
                    <th>错误信息</th>
                </tr>
            </thead>
            <tbody id="task-tbody"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>控制台日志</h2>
        <div id="console-log"></div>
    </div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // API请求函数
        async function apiRequest(url, options = {}) {
            try {
                log(`发送请求: ${url}`);
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                
                log(`响应状态: ${response.status} ${response.statusText}`);
                
                const ct = (response.headers.get('content-type') || '').toLowerCase();
                let payload;
                
                if (ct.includes('application/json')) {
                    payload = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    payload = text ? { message: text } : null;
                }
                
                if (!response.ok) {
                    const msg = (payload && (payload.error || payload.message)) || `HTTP ${response.status}`;
                    log(`API错误: ${msg}`, 'error');
                    return { error: msg, status: response.status };
                }
                
                log(`API成功: 收到数据`, 'success');
                return payload ?? {};
            } catch (error) {
                log(`网络错误: ${error.message}`, 'error');
                return { error: error.message };
            }
        }

        // 测试API端点
        async function testApiRequests() {
            const result = await apiRequest('/api/requests');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML = `<div class="error">❌ /api/requests 失败: ${result.error}</div>`;
            } else {
                const count = result.items ? result.items.length : (Array.isArray(result) ? result.length : 0);
                resultsDiv.innerHTML = `<div class="success">✅ /api/requests 成功: 返回 ${count} 个任务</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function testApiStats() {
            const result = await apiRequest('/api/queue/stats');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML += `<div class="error">❌ /api/queue/stats 失败: ${result.error}</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="success">✅ /api/queue/stats 成功</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function testApiHealth() {
            const result = await apiRequest('/health');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML += `<div class="error">❌ /health 失败: ${result.error}</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="success">✅ /health 成功</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        // 格式化时间
        function formatTime(s) {
            if (!s) return '';
            try { 
                return new Date(s).toLocaleString(); 
            } catch { 
                return s; 
            }
        }

        // 状态样式
        function statusClass(s) {
            return 'status ' + (s||'').toLowerCase();
        }

        // 加载并显示任务
        async function loadAndDisplayTasks() {
            try {
                log('开始加载任务列表...');
                const data = await apiRequest('/api/requests');
                
                if (data.error) {
                    log(`加载失败: ${data.error}`, 'error');
                    return;
                }

                const items = data.items || data || [];
                log(`成功获取 ${items.length} 个任务`, 'success');
                
                const countDiv = document.getElementById('task-count');
                countDiv.innerHTML = `<div class="info">📊 任务总数: ${items.length}</div>`;
                
                const tbody = document.getElementById('task-tbody');
                const table = document.getElementById('task-table');
                
                tbody.innerHTML = '';
                
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9">暂无任务</td></tr>';
                } else {
                    for (const it of items) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="font-family: monospace; font-size: 11px;">${it.id || ''}</td>
                            <td>${it.type || ''}</td>
                            <td>${it.subscription_id ?? ''}</td>
                            <td>${it.requires_cookie ? '是' : '否'}</td>
                            <td><span class="${statusClass(it.status)}">${it.status || ''}</span></td>
                            <td style="font-size: 12px;">${formatTime(it.created_at)}</td>
                            <td style="font-size: 12px;">${formatTime(it.started_at)}</td>
                            <td style="font-size: 12px;">${formatTime(it.finished_at)}</td>
                            <td style="font-size: 12px;">${it.last_error || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
                
                table.style.display = 'table';
                log(`任务列表渲染完成`, 'success');
                
            } catch (e) {
                log(`加载任务时发生异常: ${e.message}`, 'error');
            }
        }

        // 页面加载完成后自动测试
        window.onload = function() {
            log('页面加载完成，开始自动测试...');
            testApiHealth();
        };
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜Ÿåˆ—è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; cursor: pointer; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status { padding: 2px 6px; border-radius: 3px; font-size: 12px; }
        .status.running { background: #fff3cd; color: #856404; }
        .status.done { background: #d4edda; color: #155724; }
        .status.queued { background: #cce5ff; color: #004085; }
        .status.failed { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <h1>é˜Ÿåˆ—è°ƒè¯•é¡µé¢</h1>
    
    <div class="section">
        <h2>APIæµ‹è¯•</h2>
        <button onclick="testApiRequests()">æµ‹è¯• /api/requests</button>
        <button onclick="testApiStats()">æµ‹è¯• /api/queue/stats</button>
        <button onclick="testApiHealth()">æµ‹è¯• /health</button>
        <div id="api-results"></div>
    </div>

    <div class="section">
        <h2>ç½‘ç»œè¯·æ±‚çŠ¶æ€</h2>
        <div id="network-status"></div>
    </div>

    <div class="section">
        <h2>ä»»åŠ¡åˆ—è¡¨</h2>
        <button onclick="loadAndDisplayTasks()">åŠ è½½ä»»åŠ¡åˆ—è¡¨</button>
        <div id="task-count"></div>
        <table id="task-table" style="display: none;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç±»å‹</th>
                    <th>è®¢é˜…ID</th>
                    <th>éœ€è¦Cookie</th>
                    <th>çŠ¶æ€</th>
                    <th>åˆ›å»ºæ—¶é—´</th>
                    <th>å¼€å§‹æ—¶é—´</th>
                    <th>å®Œæˆæ—¶é—´</th>
                    <th>é”™è¯¯ä¿¡æ¯</th>
                </tr>
            </thead>
            <tbody id="task-tbody"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>æ§åˆ¶å°æ—¥å¿—</h2>
        <div id="console-log"></div>
    </div>

    <script>
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        // APIè¯·æ±‚å‡½æ•°
        async function apiRequest(url, options = {}) {
            try {
                log(`å‘é€è¯·æ±‚: ${url}`);
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                const ct = (response.headers.get('content-type') || '').toLowerCase();
                let payload;
                
                if (ct.includes('application/json')) {
                    payload = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    payload = text ? { message: text } : null;
                }
                
                if (!response.ok) {
                    const msg = (payload && (payload.error || payload.message)) || `HTTP ${response.status}`;
                    log(`APIé”™è¯¯: ${msg}`, 'error');
                    return { error: msg, status: response.status };
                }
                
                log(`APIæˆåŠŸ: æ”¶åˆ°æ•°æ®`, 'success');
                return payload ?? {};
            } catch (error) {
                log(`ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                return { error: error.message };
            }
        }

        // æµ‹è¯•APIç«¯ç‚¹
        async function testApiRequests() {
            const result = await apiRequest('/api/requests');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML = `<div class="error">âŒ /api/requests å¤±è´¥: ${result.error}</div>`;
            } else {
                const count = result.items ? result.items.length : (Array.isArray(result) ? result.length : 0);
                resultsDiv.innerHTML = `<div class="success">âœ… /api/requests æˆåŠŸ: è¿”å› ${count} ä¸ªä»»åŠ¡</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function testApiStats() {
            const result = await apiRequest('/api/queue/stats');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML += `<div class="error">âŒ /api/queue/stats å¤±è´¥: ${result.error}</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="success">âœ… /api/queue/stats æˆåŠŸ</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        async function testApiHealth() {
            const result = await apiRequest('/health');
            const resultsDiv = document.getElementById('api-results');
            
            if (result.error) {
                resultsDiv.innerHTML += `<div class="error">âŒ /health å¤±è´¥: ${result.error}</div>`;
            } else {
                resultsDiv.innerHTML += `<div class="success">âœ… /health æˆåŠŸ</div>`;
                resultsDiv.innerHTML += `<pre>${JSON.stringify(result, null, 2)}</pre>`;
            }
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(s) {
            if (!s) return '';
            try { 
                return new Date(s).toLocaleString(); 
            } catch { 
                return s; 
            }
        }

        // çŠ¶æ€æ ·å¼
        function statusClass(s) {
            return 'status ' + (s||'').toLowerCase();
        }

        // åŠ è½½å¹¶æ˜¾ç¤ºä»»åŠ¡
        async function loadAndDisplayTasks() {
            try {
                log('å¼€å§‹åŠ è½½ä»»åŠ¡åˆ—è¡¨...');
                const data = await apiRequest('/api/requests');
                
                if (data.error) {
                    log(`åŠ è½½å¤±è´¥: ${data.error}`, 'error');
                    return;
                }

                const items = data.items || data || [];
                log(`æˆåŠŸè·å– ${items.length} ä¸ªä»»åŠ¡`, 'success');
                
                const countDiv = document.getElementById('task-count');
                countDiv.innerHTML = `<div class="info">ğŸ“Š ä»»åŠ¡æ€»æ•°: ${items.length}</div>`;
                
                const tbody = document.getElementById('task-tbody');
                const table = document.getElementById('task-table');
                
                tbody.innerHTML = '';
                
                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9">æš‚æ— ä»»åŠ¡</td></tr>';
                } else {
                    for (const it of items) {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td style="font-family: monospace; font-size: 11px;">${it.id || ''}</td>
                            <td>${it.type || ''}</td>
                            <td>${it.subscription_id ?? ''}</td>
                            <td>${it.requires_cookie ? 'æ˜¯' : 'å¦'}</td>
                            <td><span class="${statusClass(it.status)}">${it.status || ''}</span></td>
                            <td style="font-size: 12px;">${formatTime(it.created_at)}</td>
                            <td style="font-size: 12px;">${formatTime(it.started_at)}</td>
                            <td style="font-size: 12px;">${formatTime(it.finished_at)}</td>
                            <td style="font-size: 12px;">${it.last_error || ''}</td>
                        `;
                        tbody.appendChild(tr);
                    }
                }
                
                table.style.display = 'table';
                log(`ä»»åŠ¡åˆ—è¡¨æ¸²æŸ“å®Œæˆ`, 'success');
                
            } catch (e) {
                log(`åŠ è½½ä»»åŠ¡æ—¶å‘ç”Ÿå¼‚å¸¸: ${e.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æµ‹è¯•
        window.onload = function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è‡ªåŠ¨æµ‹è¯•...');
            testApiHealth();
        };
    </script>
</body>
</html>

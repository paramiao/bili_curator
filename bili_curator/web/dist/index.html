<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bili_curator V6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #00a1d6 0%, #0084b4 100%); color: white; padding: 2rem 1rem; text-align: center; box-shadow: 0 4px 20px rgba(0,161,214,0.3); }
        .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .card h3 { margin-bottom: 0.5rem; font-size: 1.05rem; color: #333; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem; background: #fff; border-radius: 8px 8px 0 0; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease; font-weight: 500; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #00a1d6; color: #00a1d6; background: #f0f9ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn { background: #00a1d6; color: white; border: none; padding: 0.45rem 0.8rem; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #0084b4; }
        .btn-outline { background: #fff; color: #007fa6; border: 1px solid #cde8f3; }
        .btn-outline:hover { background: #f2fbff; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 12px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }


        /* ä»»åŠ¡ç®¡ç†æ ·å¼ */
        .task-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-header h4 {
            margin: 0;
            color: #333;
        }

        /* ç»Ÿè®¡å°èƒ¶å›Š */
        .subscription-stats .stat-item { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #f6f8fa; border: 1px solid #eef2f7; color: #333; }
        .stat-total { background: #eef7ff; color: #0b5cab; border-color: #d9ecff; }
        .stat-downloaded { background: #e9f9ef; color: #1e7e34; border-color: #d6f5df; }
        .stat-pending { background: #fff7e6; color: #b26a00; border-color: #ffe7ba; }

        /* è¡¨æ ¼ç»Ÿä¸€æ ·å¼ï¼ˆè§†é¢‘ç®¡ç†ï¼‰ */
        .table-wrap { overflow: auto; }
        table.data { width: 100%; border-collapse: collapse; font-size: 14px; }
        table.data thead th { position: sticky; top: 0; background: #f9fbfd; color: #445; text-align: left; border-bottom: 1px solid #eef2f7; padding: 10px 12px; }
        table.data tbody td { border-bottom: 1px solid #f0f3f7; padding: 10px 12px; color: #333; }
        table.data tbody tr:nth-child(even) { background: #fcfdff; }
        table.data tbody tr:hover { background: #f0f7ff; }
        .pager { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
        .num { text-align: right; }
        .mono { font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 12px; color: #555; }

        /* å¡ç‰‡å†…åˆ†èŠ‚æ ‡é¢˜è¡Œ */
        .card .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; }

        /* é˜Ÿåˆ—ç®¡ç†æ ·å¼ */
        .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; background:#f3f4f6; color:#374151; }
        .badge-success { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
        .badge-danger { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
        .stat-card { border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff; }
        .stat-title { font-weight:600; margin-bottom:6px; color:#374151; }
        .stat-row { display:flex; align-items:center; justify-content: space-between; padding:4px 0; }
        .stat-label { color:#6b7280; font-size:12px; }
        .stat-number { font-weight:700; color:#111827; }
        .stat-number.ok { color:#065f46; }
        .stat-number.warn { color:#b45309; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status.pending { background: #f3f4f6; color: #374151; }
        .status.running { background: #dbeafe; color: #1e40af; }
        .status.done { background: #dcfce7; color: #166534; }
        .status.failed { background: #fee2e2; color: #dc2626; }
        .status.cancelled { background: #f3f4f6; color: #6b7280; }

        .task-controls {
            display: flex;
            gap: 8px;
        }

        .task-info {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-status {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
        }

        .status-pending .task-status { background-color: #6c757d; }
        .status-checking .task-status { background-color: #17a2b8; }
        .status-downloading .task-status { background-color: #007bff; }
        .status-paused .task-status { background-color: #ffc107; color: #000; }
        .status-completed .task-status { background-color: #28a745; }
        .status-failed .task-status { background-color: #dc3545; }
        .status-cancelled .task-status { background-color: #6c757d; }

        .task-progress {
            color: #666;
        }

        .current-video {
            color: #007bff;
            font-style: italic;
        }

        .progress-bar {
            position: relative;
            background-color: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #007bff;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-logs {
            margin-top: 12px;
        }

        .logs-content {
            background-color: #f1f3f4;
            border: 1px solid #e1e3e4;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
            white-space: pre-wrap;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
        }

        .btn-outline:hover {
            background-color: #6c757d;
            color: white;
        }

        /* è¡¨å•å¢å¼ºæ ·å¼ */
        .form-section {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .form-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .half-width {
            flex: 1;
        }

        .third-width {
            flex: 1;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }

        /* è®¢é˜…ç»Ÿè®¡æ ·å¼ */
        .subscription-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 13px; }

        .stat-item {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }
        
        /* æµç¨‹å¯è§†åŒ–æ ·å¼ */
        .flow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            min-width: 100px;
        }
        
        .flow-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            font-weight: bold;
        }
        
        .flow-text {
            text-align: center;
        }
        
        .flow-title {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .flow-desc {
            font-size: 12px;
            color: #6b7280;
        }
        
        .flow-arrow {
            font-size: 20px;
            color: #9ca3af;
            font-weight: bold;
        }

        .stat-total {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .stat-downloaded {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .stat-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .subscription-item { border: 1px solid #e9ecef; border-radius: 8px; padding: 14px; margin-bottom: 12px; background-color: #fff; }
        .section-toolbar { display:flex; gap:8px; align-items:center; }
        .muted { color:#6b7280; }

        /* STRMæ¨¡å¼é€‰æ‹©æ ·å¼ */
        .mode-option {
            flex: 1;
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .mode-option:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .mode-option.selected {
            border-color: #2563eb;
            background: #dbeafe;
            box-shadow: 0 0 0 1px #2563eb;
        }

        .mode-option input[type="radio"] {
            margin: 0;
        }

        .mode-option label {
            cursor: pointer;
            margin: 0;
        }

        /* è®¢é˜…åˆ—è¡¨ä¸­çš„æ¨¡å¼æ ‡è¯† */
        .download-mode-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .download-mode-badge.local {
            background: #ecfdf5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .download-mode-badge.strm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 1px solid #667eea;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .subscription-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .subscription-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .type-collection {
            background-color: #007bff;
        }

        .type-uploader {
            background-color: #28a745;
        }

        .type-keyword {
            background-color: #ffc107;
            color: #000;
        }

        .type-specific_urls {
            background-color: #6f42c1;
        }

        .subscription-controls {
            display: flex;
            gap: 8px;
        }

        .subscription-filters {
            margin-top: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .filter-tag {
            display: inline-block;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        .status { padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¬ bili_curator V6</h1>
        <p>Bç«™è§†é¢‘ä¸‹è½½ç®¡ç†ç³»ç»Ÿ - å®¶ç”¨ç®€åŒ–ç‰ˆ</p>
    </div>

    <div class="container">
        <div class="card">
            <div class="tabs">
                <div class="tab" onclick="showTab(this,'dashboard')">æ€»è§ˆ</div>
                <div class="tab" onclick="showTab(this,'monitor')">ç³»ç»Ÿç›‘æ§</div>
                <div class="tab" onclick="showTab(this,'subscriptions')">è®¢é˜…ç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'tasks')">ä¸‹è½½ä»»åŠ¡</div>
                <div class="tab" onclick="showTab(this,'queue')">é˜Ÿåˆ—ç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'strm')">ğŸ¬ STRMç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'cookies')">Cookieç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'settings')">ç³»ç»Ÿè®¾ç½®</div>
            </div>

            <!-- æ€»è§ˆï¼ˆåª’ä½“æ•°æ®æ¦‚è§ˆï¼‰ -->
            <div id="dashboard" class="tab-content active">

                <div id="media-overview" class="card" style="margin-top:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>åª’ä½“æ€»è§ˆ</h3>
                        <div>
                            <button class="btn btn-outline" onclick="loadMediaOverview(false)">åˆ·æ–°</button>
                            <button class="btn" onclick="loadMediaOverview(true)">æ‰«æç£ç›˜</button>
                        </div>
                    </div>
                    <div id="media-overview-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-sub-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>è®¢é˜…ç»Ÿè®¡</h3>
                        <input id="sub-filter" type="text" placeholder="æœç´¢è®¢é˜…åç§°..." oninput="renderSubscriptionStats()" style="padding:6px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div id="media-sub-stats-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-dir-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ç›®å½•ç»Ÿè®¡</h3>
                    </div>
                    <div id="media-dir-stats-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-sub-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-sub-detail-title">è®¢é˜…æ˜ç»†</h3>
                        <button class="btn btn-outline" onclick="hideSubscriptionDetail()">è¿”å›ç»Ÿè®¡</button>
                    </div>
                    <div id="media-sub-detail-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-dir-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-dir-detail-title">ç›®å½•æ˜ç»†</h3>
                        <button class="btn btn-outline" onclick="hideDirectoryDetail()">è¿”å›ç»Ÿè®¡</button>
                    </div>
                    <div id="media-dir-detail-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>
            </div>
            <!-- é˜Ÿåˆ—è¯Šæ–­æ¨¡æ€ -->
            <div id="queue-insights-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; right: 0; top: 0; height: 100%; width: min(560px, 100%); background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.15); display:flex; flex-direction:column;">
                    <div style="padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <h3 style="margin:0;">é˜Ÿåˆ—è¯Šæ–­</h3>
                            <small id="insights-meta" style="color:#666;"></small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline" onclick="loadQueueInsights()">åˆ·æ–°</button>
                            <button class="btn" onclick="hideQueueInsights()">å…³é—­</button>
                        </div>
                    </div>
                    <div id="queue-insights-content" style="padding: 12px 16px; overflow: auto; flex:1;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
            </div>

            <!-- è®¢é˜…ç®¡ç† -->
            <div id="subscriptions" class="tab-content">
                <div class="section-header">
                    <h2>è®¢é˜…ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; flex-wrap: wrap; align-items:center;">
                        <button onclick="showAddSubscription()" class="btn btn-primary">æ·»åŠ è®¢é˜…</button>
                        <button onclick="localSync()" class="btn btn-secondary">æœ¬åœ°åŒæ­¥</button>
                        <button onclick="triggerCheckSubscriptions()" class="btn">æ£€æŸ¥è®¢é˜…</button>
                        <button onclick="triggerLiteSyncGlobal()" class="btn">è¿œç«¯åŒæ­¥(å…¨å±€)</button>
                    </div>
                </div>
                <div id="subscription-list"></div>
            </div>
            
            <!-- ä¸‹è½½ä»»åŠ¡ -->
            <div id="tasks" class="tab-content">
                <div class="section-header">
                    <h2>ä¸‹è½½ä»»åŠ¡æµç¨‹ç›‘æ§</h2>
                    <button onclick="refreshTasks()" class="btn btn-secondary">åˆ·æ–°</button>
                    <button onclick="clearCompletedTasks()" class="btn btn-outline">æ¸…ç†å®Œæˆä»»åŠ¡</button>
                </div>

                <!-- ä¸šåŠ¡æµç¨‹å¯è§†åŒ– -->
                <div class="card" style="margin-bottom:16px;">
                    <h3>è®¢é˜…â†’ä¸‹è½½ä¸šåŠ¡æµç¨‹</h3>
                    <div style="display:flex; align-items:center; gap:12px; margin:12px 0; padding:12px; background:#f8f9fa; border-radius:8px; overflow-x:auto;">
                        <div class="flow-step">
                            <div class="flow-icon" style="background:#3b82f6;">ğŸ“‹</div>
                            <div class="flow-text">
                                <div class="flow-title">è®¢é˜…æ£€æŸ¥</div>
                                <div class="flow-desc">å®šæ—¶æ£€æŸ¥è¿œç«¯æ›´æ–°</div>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="flow-icon" style="background:#10b981;">ğŸ”</div>
                            <div class="flow-text">
                                <div class="flow-title">è¿œç«¯æŸ¥è¯¢</div>
                                <div class="flow-desc">è·å–è§†é¢‘åˆ—è¡¨</div>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="flow-icon" style="background:#f59e0b;">âš–ï¸</div>
                            <div class="flow-text">
                                <div class="flow-title">æœ¬åœ°æ¯”å¯¹</div>
                                <div class="flow-desc">ç­›é€‰å¾…ä¸‹è½½</div>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="flow-icon" style="background:#8b5cf6;">ğŸ“</div>
                            <div class="flow-text">
                                <div class="flow-title">è®¢é˜…é˜Ÿåˆ—</div>
                                <div class="flow-desc">æŒ‰è®¢é˜…ç»„ç»‡ä»»åŠ¡</div>
                            </div>
                        </div>
                        <div class="flow-arrow">â†’</div>
                        <div class="flow-step">
                            <div class="flow-icon" style="background:#ef4444;">â¬‡ï¸</div>
                            <div class="flow-text">
                                <div class="flow-title">å…¨å±€ä¸‹è½½</div>
                                <div class="flow-desc">å¹¶å‘æ‰§è¡Œä¸‹è½½</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- è®¢é˜…çº§ä»»åŠ¡æ±‡æ€» -->
                <div class="card" id="download-aggregate" style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>è®¢é˜…ä»»åŠ¡æ±‡æ€»</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="agg-collapse-btn" class="btn btn-outline" onclick="DownloadAggregateManager.toggleCollapse()" title="æŠ˜å /å±•å¼€">æŠ˜å </button>
                            <button class="btn btn-outline" onclick="DownloadAggregateManager.load()">åˆ·æ–°</button>
                            <label style="color:#666; font-size:12px; display:flex; align-items:center; gap:6px;">
                                <input type="checkbox" id="agg-autorefresh" onchange="DownloadAggregateManager.toggleAuto(this.checked)"> è‡ªåŠ¨åˆ·æ–°(15s)
                            </label>
                        </div>
                    </div>
                    <div id="agg-content">
                        <div id="agg-totals" class="subscription-stats" style="margin:8px 0;">-</div>
                        <div class="table-wrap">
                            <table class="data">
                                <thead>
                                    <tr>
                                        <th>è®¢é˜…å</th>
                                        <th class="num">å·²ä¸‹è½½</th>
                                        <th class="num">å¾…ä¸‹è½½</th>
                                        <th class="num">é˜Ÿåˆ—ä¸­</th>
                                        <th class="num">ä¸‹è½½ä¸­</th>
                                        <th class="num">è¿œç«¯æ€»æ•°</th>
                                        <th class="num">æ— æ³•ä¸‹è½½</th>
                                        <th>æœ€ååŒæ­¥</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody id="agg-tbody"></tbody>
                            </table>
                        </div>
                        <div style="margin-top:6px; color:#6b7280; font-size:12px;">
                            <div>â€¢ è¿œç«¯æ€»æ•°ç¼“å­˜1å°æ—¶ï¼Œé¿å…é¢‘ç¹è¯·æ±‚</div>
                            <div>â€¢ å¾…ä¸‹è½½æ•°åŸºäºæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿå®æ—¶è®¡ç®—</div>
                            <div>â€¢ æ— æ³•ä¸‹è½½æŒ‡æ°¸ä¹…å¤±è´¥çš„è§†é¢‘ï¼ˆå·²åˆ é™¤/ç§æœ‰ç­‰ï¼‰</div>
                        </div>
                    </div>
                </div>

                <!-- å…¨å±€ä»»åŠ¡åˆ—è¡¨ -->
                <div class="card">
                    <h3>å…¨å±€ä»»åŠ¡æ‰§è¡Œ</h3>
                    <div id="task-list">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- STRMç®¡ç† -->
            <div id="strm" class="tab-content">
                <div class="section-header">
                    <h2>ğŸ¬ STRMæµåª’ä½“ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">V7 æ–°åŠŸèƒ½</span>
                        <button onclick="openStrmManagement()" class="btn btn-primary">æ‰“å¼€STRMç®¡ç†ç•Œé¢</button>
                    </div>
                </div>
                
                <!-- STRMåŠŸèƒ½æ¦‚è§ˆ -->
                <div class="card">
                    <h3>ğŸ“‹ åŠŸèƒ½æ¦‚è§ˆ</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-top: 12px;">
                        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">ğŸ¥ æµåª’ä½“ä»£ç†</div>
                            <div style="font-size: 14px; color: #64748b;">å®æ—¶ä»£ç†Bç«™è§†é¢‘æµï¼Œæ”¯æŒHLSæ ¼å¼è½¬æ¢</div>
                        </div>
                        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">ğŸ“ æ–‡ä»¶ç®¡ç†</div>
                            <div style="font-size: 14px; color: #64748b;">ç”Ÿæˆ.strmæ–‡ä»¶å’ŒNFOå…ƒæ•°æ®ï¼Œæ”¯æŒåª’ä½“åº“</div>
                        </div>
                        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">ğŸ’¾ å­˜å‚¨ä¼˜åŒ–</div>
                            <div style="font-size: 14px; color: #64748b;">æ¯è§†é¢‘ä»…å ç”¨~50KBï¼Œç›¸æ¯”æœ¬åœ°æ¨¡å¼èŠ‚çœ99%ç©ºé—´</div>
                        </div>
                        <div style="padding: 16px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 8px;">ğŸ”„ åŒæ¨¡å¼æ”¯æŒ</div>
                            <div style="font-size: 14px; color: #64748b;">LOCALå’ŒSTRMæ¨¡å¼å¯æŒ‰è®¢é˜…ç‹¬ç«‹é…ç½®</div>
                        </div>
                    </div>
                </div>
                
                <!-- å¿«é€Ÿç»Ÿè®¡ -->
                <div class="card">
                    <h3>ğŸ“Š å¿«é€Ÿç»Ÿè®¡</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div class="stat-card">
                            <div class="stat-title">STRMè®¢é˜…</div>
                            <div class="stat-number" id="strm-subscriptions-count">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">æ´»è·ƒæµ</div>
                            <div class="stat-number" id="strm-active-streams">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">STRMæ–‡ä»¶</div>
                            <div class="stat-number" id="strm-files-count">-</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">èŠ‚çœç©ºé—´</div>
                            <div class="stat-number ok" id="strm-space-saved">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- ç³»ç»ŸçŠ¶æ€ -->
                <div class="card">
                    <h3>ğŸ” ç³»ç»ŸçŠ¶æ€</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span>ä»£ç†æœåŠ¡</span>
                            <span class="badge badge-success" id="strm-proxy-status">è¿è¡Œæ­£å¸¸</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span>æ–‡ä»¶ç®¡ç†</span>
                            <span class="badge badge-success" id="strm-file-status">è¿è¡Œæ­£å¸¸</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0;">
                            <span>FFmpeg</span>
                            <span class="badge badge-success" id="strm-ffmpeg-status">å¯ç”¨</span>
                        </div>
                    </div>
                </div>
                
                <!-- ä½¿ç”¨è¯´æ˜ -->
                <div class="card">
                    <h3>ğŸ“– ä½¿ç”¨è¯´æ˜</h3>
                    <div style="font-size: 14px; line-height: 1.6; color: #4b5563;">
                        <ol style="margin: 12px 0 0 20px; padding: 0;">
                            <li style="margin-bottom: 8px;"><strong>åˆ›å»ºSTRMè®¢é˜…ï¼š</strong>åœ¨è®¢é˜…ç®¡ç†ä¸­é€‰æ‹©"STRM æµåª’ä½“æ¨¡å¼"</li>
                            <li style="margin-bottom: 8px;"><strong>é…ç½®åª’ä½“åº“ï¼š</strong>å°†STRMæ–‡ä»¶ç›®å½•æ·»åŠ åˆ°Plexã€Jellyfinç­‰åª’ä½“æœåŠ¡å™¨</li>
                            <li style="margin-bottom: 8px;"><strong>æ’­æ”¾è§†é¢‘ï¼š</strong>é€šè¿‡åª’ä½“æœåŠ¡å™¨æ’­æ”¾ï¼Œç³»ç»Ÿè‡ªåŠ¨ä»£ç†Bç«™è§†é¢‘æµ</li>
                            <li style="margin-bottom: 8px;"><strong>ç›‘æ§ç®¡ç†ï¼š</strong>ä½¿ç”¨STRMç®¡ç†ç•Œé¢ç›‘æ§æ´»è·ƒæµå’Œç³»ç»ŸçŠ¶æ€</li>
                        </ol>
                        <div style="margin-top: 16px; padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;">
                            <strong>ğŸ’¡ æç¤ºï¼š</strong>STRMæ¨¡å¼éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥å’Œæœ‰æ•ˆçš„Bç«™Cookieã€‚å»ºè®®å…ˆæµ‹è¯•å°‘é‡è®¢é˜…ç¡®è®¤ç¯å¢ƒæ­£å¸¸ã€‚
                        </div>
                    </div>
                </div>
            </div>

            <!-- é˜Ÿåˆ—ç®¡ç† -->
            <div id="queue" class="tab-content">
                <div class="section-header">
                    <h2>è¯·æ±‚é˜Ÿåˆ—ç®¡ç†</h2>
                    <div style="font-size: 14px; color: #666;">å¯è§†åŒ–æ§åˆ¶å¹¶å‘ã€æš‚åœå’Œä»»åŠ¡ä¼˜å…ˆçº§ï¼Œå®æ—¶è§‚å¯Ÿé˜Ÿåˆ—</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div class="card">
                        <h3>æš‚åœ/æ¢å¤</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <select id="pause-scope" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="all">å…¨éƒ¨(all)</option>
                                <option value="requires_cookie">éœ€è¦Cookie</option>
                                <option value="no_cookie">æ— éœ€Cookie</option>
                            </select>
                            <button id="btn-pause" class="btn">æš‚åœ</button>
                            <button id="btn-resume" class="btn">æ¢å¤</button>
                        </div>
                        <div style="color: #666; font-size: 12px;">æ³¨ï¼šæš‚åœä»…é˜»æ­¢æ–°ä»»åŠ¡è¿›å…¥è¿è¡Œï¼Œå·²åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ä¸è¢«å¼ºåˆ¶ä¸­æ–­ã€‚</div>
                    </div>

                    <div class="card">
                        <h3>å¹¶å‘é…ç½®</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px;">éœ€è¦Cookie: <input id="cap-cookie" type="number" min="0" value="1" style="width:80px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px;" /></label>
                            <label style="display: flex; align-items: center; gap: 8px;">æ— éœ€Cookie: <input id="cap-nocookie" type="number" min="0" value="2" style="width:80px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px;" /></label>
                            <button id="btn-apply-cap" class="btn">åº”ç”¨</button>
                        </div>
                        <div style="color: #666; font-size: 12px;">ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆã€‚è®¾ç½®ä¸º 0 è¡¨ç¤ºç¦æ­¢è¯¥é€šé“çš„æ–°ä»»åŠ¡è¿›å…¥è¿è¡Œã€‚</div>
                    </div>

                    <div class="card">
                        <h3>ä»»åŠ¡æ“ä½œ</h3>
                        <div style="margin-bottom: 12px;">
                            <input id="job-id" placeholder="è¾“å…¥ job_id" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;" />
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="btn-cancel" class="btn btn-outline">å–æ¶ˆ</button>
                            <button id="btn-prio" class="btn">ç½®é¡¶ä¼˜å…ˆ</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="display:flex; align-items:center; gap:8px;">é˜Ÿåˆ—æ€»è§ˆ <span id="badge-paused" style="padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; background:#f3f4f6; color:#374151;">-</span></h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:8px;" id="cap-cards">
                        <!-- cards injected here -->
                    </div>
                    <details style="margin-top:8px;">
                        <summary style="cursor:pointer;">æŸ¥çœ‹åŸå§‹æ•°æ®(JSON)</summary>
                        <pre id="stats" style="margin-top:8px; color: #666; font-size: 12px; background: #f8f9fa; padding: 12px; border-radius: 6px; overflow: auto;">è½½å…¥ä¸­...</pre>
                    </details>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3>è¯·æ±‚åˆ—è¡¨</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="color: #666; font-size: 14px;">æ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°</div>
                            <button id="btn-refresh" class="btn btn-outline">ç«‹å³åˆ·æ–°</button>
                            <button id="btn-insights" class="btn" onclick="showQueueInsights()">è¯Šæ–­</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="data">
                            <thead>
                                <tr>
                                    <th>job_id</th>
                                    <th>ç±»å‹</th>
                                    <th>è®¢é˜…ID</th>
                                    <th>å·²ä¸‹è½½</th>
                                    <th>å¾…ä¸‹è½½</th>
                                    <th>æ’é˜Ÿä¸­</th>
                                    <th>ä¸‹è½½ä¸­</th>
                                    <th>è¿œç«¯æ€»æ•°</th>
                                    <th>æ— æ³•ä¸‹è½½</th>
                                    <th>æœ€ååŒæ­¥</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="queue-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
                <div id="add-subscription" style="display:none; margin-top:1rem;">
                    <h3>æ·»åŠ æ–°è®¢é˜…</h3>
                    <div class="form-group">
                        <label>è®¢é˜…ç±»å‹</label>
                        <select id="sub-type" onchange="toggleSubFields()">
                            <option value="collection">åˆé›†è®¢é˜…</option>
                            <option value="uploader">UPä¸»è®¢é˜…</option>
                            <option value="keyword">å…³é”®è¯è®¢é˜…</option>
                            <option value="specific_urls">ç‰¹å®šè§†é¢‘è®¢é˜…</option>
                        </select>
                    </div>
                    
                    <!-- åˆé›†è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="collection-fields">
                        <label>åˆé›†URL <span class="help-text">ç²˜è´´Bç«™åˆé›†é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åç§°</span></label>
                        <input type="text" id="sub-url" placeholder="https://space.bilibili.com/xxx/channel/collectiondetail?sid=xxx" onblur="autoFillCollectionName()">
                    </div>
                    
                    <!-- UPä¸»è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="uploader-fields" style="display:none;">
                        <label>UPä¸»IDæˆ–åç§° <span class="help-text">è¾“å…¥UPä¸»çš„IDæˆ–ç”¨æˆ·å</span></label>
                        <input type="text" id="sub-uploader" placeholder="UPä¸»IDæˆ–ç”¨æˆ·å">
                    </div>
                    
                    <!-- å…³é”®è¯è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="keyword-fields" style="display:none;">
                        <label>æœç´¢å…³é”®è¯ <span class="help-text">è¾“å…¥è¦æœç´¢çš„å…³é”®è¯</span></label>
                        <input type="text" id="sub-keyword" placeholder="æœç´¢å…³é”®è¯">
                    </div>
                    
                    <!-- ç‰¹å®šURLå­—æ®µ -->
                    <div class="form-group" id="specific-urls-fields" style="display:none;">
                        <label>ç‰¹å®šè§†é¢‘URL <span class="help-text">æ¯è¡Œä¸€ä¸ªè§†é¢‘é“¾æ¥</span></label>
                        <textarea id="sub-specific-urls" rows="4" placeholder="https://www.bilibili.com/video/BVxxx&#10;https://www.bilibili.com/video/BVyyy"></textarea>
                    </div>
                    
                    <!-- ç­›é€‰æ¡ä»¶ -->
                    <div class="form-section">
                        <h4>ç­›é€‰æ¡ä»¶ <span class="help-text">å¯é€‰ï¼Œç”¨äºè¿‡æ»¤ä¸‹è½½çš„è§†é¢‘</span></h4>
                        
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label>å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="sub-date-after">
                            </div>
                            <div class="form-group half-width">
                                <label>ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="sub-date-before">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group third-width">
                                <label>æœ€å°ç‚¹èµæ•°</label>
                                <input type="number" id="sub-min-likes" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>æœ€å°æ”¶è—æ•°</label>
                                <input type="number" id="sub-min-favorites" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>æœ€å°æ’­æ”¾æ•°</label>
                                <input type="number" id="sub-min-views" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸‹è½½æ¨¡å¼é€‰æ‹© -->
                    <div class="form-section">
                        <h4>ğŸ“ ä¸‹è½½æ¨¡å¼ <span class="help-text">V7æ–°åŠŸèƒ½ï¼šé€‰æ‹©è§†é¢‘å­˜å‚¨æ–¹å¼</span></h4>
                        
                        <div style="display: flex; gap: 16px; margin-bottom: 16px;">
                            <div class="mode-option" onclick="selectDownloadMode('LOCAL')" id="mode-local">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="download-mode" value="LOCAL" id="radio-local" checked>
                                    <label for="radio-local" style="font-weight: 600; color: #059669;">ğŸ’¾ LOCAL æœ¬åœ°æ¨¡å¼</label>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">å®Œæ•´ä¸‹è½½è§†é¢‘æ–‡ä»¶åˆ°æœ¬åœ°å­˜å‚¨</div>
                                <div style="font-size: 11px; color: #059669; font-weight: 500;">å­˜å‚¨éœ€æ±‚: ~500MB/è§†é¢‘</div>
                                <div style="font-size: 11px; color: #6b7280;">âœ“ ç¦»çº¿æ’­æ”¾ âœ“ é«˜è´¨é‡ âœ“ ç¨³å®š</div>
                            </div>
                            
                            <div class="mode-option" onclick="selectDownloadMode('STRM')" id="mode-strm">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <input type="radio" name="download-mode" value="STRM" id="radio-strm">
                                    <label for="radio-strm" style="font-weight: 600; color: #7c3aed;">ğŸ¬ STRM æµåª’ä½“æ¨¡å¼</label>
                                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2px 6px; border-radius: 8px; font-size: 10px; font-weight: 600;">NEW</span>
                                </div>
                                <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">ç”Ÿæˆè½»é‡çº§æµåª’ä½“æ–‡ä»¶ï¼Œå®æ—¶æ’­æ”¾</div>
                                <div style="font-size: 11px; color: #7c3aed; font-weight: 500;">å­˜å‚¨éœ€æ±‚: ~50KB/è§†é¢‘</div>
                                <div style="font-size: 11px; color: #6b7280;">âœ“ çœç©ºé—´ âœ“ å³æ—¶è®¿é—® âœ“ åŠ¨æ€è´¨é‡</div>
                            </div>
                        </div>
                        
                        <div id="strm-notice" style="display: none; padding: 12px; background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px; font-size: 12px; color: #1e40af;">
                            <strong>ğŸ’¡ STRMæ¨¡å¼è¯´æ˜ï¼š</strong>
                            <ul style="margin: 4px 0 0 16px; padding: 0;">
                                <li>éœ€è¦ç¨³å®šçš„ç½‘ç»œè¿æ¥å’Œæœ‰æ•ˆçš„Bç«™Cookie</li>
                                <li>æ’­æ”¾æ—¶å®æ—¶ä»Bç«™è·å–è§†é¢‘æµ</li>
                                <li>æ”¯æŒå¤šç§åª’ä½“æ’­æ”¾å™¨ï¼ˆPlexã€Jellyfinç­‰ï¼‰</li>
                                <li>å¯éšæ—¶åˆ‡æ¢å›LOCALæ¨¡å¼é‡æ–°ä¸‹è½½</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>è®¢é˜…åç§°</label>
                        <input type="text" id="sub-name" placeholder="è‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨è¾“å…¥">
                        <small style="color:#666;">åˆé›†è®¢é˜…ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º"UPä¸»åï¼šåˆé›†å"</small>
                    </div>
                    
                    <button class="btn" onclick="addSubscription()">æ·»åŠ è®¢é˜…</button>
                    <button class="btn" onclick="hideAddSubscription()" style="background:#666;">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- ç³»ç»Ÿç›‘æ§ï¼ˆæ•´åˆä»»åŠ¡æƒ…å†µå’Œç³»ç»Ÿè®¾ç½®ï¼‰ -->
            <div id="monitor" class="tab-content">
                <!-- ç³»ç»Ÿå¥åº·çŠ¶æ€ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ” ç³»ç»Ÿå¥åº·ç›‘æ§</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <span id="health-indicator" class="badge">æ£€æŸ¥ä¸­...</span>
                            <button class="btn btn-outline" onclick="loadSystemHealth()">åˆ·æ–°çŠ¶æ€</button>
                        </div>
                    </div>
                    <div id="system-health-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- ä»»åŠ¡æ‰§è¡Œæ¦‚è§ˆ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>âš¡ ä»»åŠ¡æ‰§è¡Œæ¦‚è§ˆ</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" onclick="loadTaskOverview()">åˆ·æ–°</button>
                            <button id="btn-sync-global" class="btn" onclick="triggerLiteSyncGlobal()">è¿œç«¯åŒæ­¥</button>
                        </div>
                    </div>
                    <div id="task-overview-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- é˜Ÿåˆ—çŠ¶æ€ç›‘æ§ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸš€ é˜Ÿåˆ—çŠ¶æ€ç›‘æ§</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <span id="queue-status-indicator" class="badge">ç›‘æ§ä¸­...</span>
                            <button class="btn btn-outline" onclick="loadQueueStatus()">åˆ·æ–°</button>
                            <button class="btn" onclick="showTab(this,'queue')">è¯¦ç»†ç®¡ç†</button>
                        </div>
                    </div>
                    <div id="queue-status-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- ç³»ç»Ÿé…ç½®çŠ¶æ€ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>âš™ï¸ ç³»ç»Ÿé…ç½®çŠ¶æ€</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" onclick="loadConfigStatus()">æ£€æŸ¥é…ç½®</button>
                            <button class="btn" onclick="showTab(this,'settings')">é…ç½®ç®¡ç†</button>
                        </div>
                    </div>
                    <div id="config-status-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- æ•°æ®ä¸€è‡´æ€§ç›‘æ§ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ“Š æ•°æ®ä¸€è‡´æ€§ç›‘æ§</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" onclick="loadConsistencyStatus()">æ£€æŸ¥çŠ¶æ€</button>
                            <button id="btn-consistency-check" class="btn" onclick="triggerConsistencyCheck()">æ‰§è¡Œæ£€æŸ¥</button>
                        </div>
                    </div>
                    <div id="consistency-status-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <!-- èµ„æºä½¿ç”¨ç›‘æ§ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ’¾ èµ„æºä½¿ç”¨ç›‘æ§</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" onclick="loadResourceStatus()">åˆ·æ–°</button>
                            <button class="btn" onclick="loadMediaOverview(true)">æ‰«æç£ç›˜</button>
                        </div>
                    </div>
                    <div id="resource-status-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- Cookieç®¡ç† -->
            <div id="cookies" class="tab-content">
                <h2>Cookieç®¡ç†</h2>
                <button class="btn" onclick="showAddCookie()">æ·»åŠ Cookie</button>
                <button class="btn btn-outline" onclick="validateAllCookies()">å…¨éƒ¨éªŒè¯</button>
                <div id="cookie-list">åŠ è½½ä¸­...</div>
                
                <div id="add-cookie" style="display:none; margin-top:1rem;">
                    <h3>æ·»åŠ æ–°Cookie</h3>
                    <div class="form-group">
                        <label>Cookieåç§°</label>
                        <input type="text" id="cookie-name" placeholder="è¾“å…¥Cookieåç§°">
                    </div>
                    <div class="form-group">
                        <label>SESSDATA</label>
                        <input type="text" id="cookie-sessdata" placeholder="è¾“å…¥SESSDATAå€¼">
                    </div>
                    <div class="form-group">
                        <label>bili_jct</label>
                        <input type="text" id="cookie-jct" placeholder="è¾“å…¥bili_jctå€¼">
                    </div>
                    <div class="form-group">
                        <label>DedeUserID</label>
                        <input type="text" id="cookie-userid" placeholder="è¾“å…¥DedeUserIDå€¼">
                    </div>
                    <button class="btn" onclick="addCookie()">æ·»åŠ </button>
                    <button class="btn" onclick="hideAddCookie()" style="background:#666;">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings" class="tab-content">
                <!-- åŸºç¡€é…ç½® -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ“ åŸºç¡€é…ç½®</h3>
                        <button class="btn btn-outline" onclick="loadBasicSettings()">åˆ·æ–°</button>
                    </div>
                    <p style="color:#666; margin-bottom:1rem;">ç³»ç»Ÿè¿è¡Œçš„åŸºæœ¬é…ç½®å‚æ•°</p>
                    <div id="basic-settings-content">åŠ è½½ä¸­...</div>
                </div>

                <!-- ä¸‹è½½é…ç½® -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>â¬‡ï¸ ä¸‹è½½é…ç½®</h3>
                        <button class="btn btn-outline" onclick="loadDownloadSettings()">åˆ·æ–°</button>
                    </div>
                    <p style="color:#666; margin-bottom:1rem;">è§†é¢‘ä¸‹è½½ç›¸å…³çš„é…ç½®é€‰é¡¹</p>
                    <div id="download-settings-content">åŠ è½½ä¸­...</div>
                </div>

                <!-- åŒæ­¥çŠ¶æ€ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ”„ åŒæ­¥çŠ¶æ€</h3>
                        <div>
                            <button class="btn btn-outline" onclick="loadSyncStatus()">åˆ·æ–°çŠ¶æ€</button>
                            <button class="btn" onclick="clearSyncCache()">æ¸…ç†ç¼“å­˜</button>
                        </div>
                    </div>
                    <p style="color:#666; margin-bottom:1rem;">å„è®¢é˜…çš„è¿œç«¯åŒæ­¥çŠ¶æ€å’Œç¼“å­˜ä¿¡æ¯</p>
                    <div id="sync-status-content">åŠ è½½ä¸­...</div>
                </div>

                <!-- æ•°æ®ç»´æŠ¤ -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ğŸ› ï¸ æ•°æ®ç»´æŠ¤</h3>
                        <button class="btn btn-outline" onclick="loadMaintenanceStatus()">åˆ·æ–°çŠ¶æ€</button>
                    </div>
                    <p style="color:#666; margin-bottom:1rem;">æ•°æ®åº“ç»´æŠ¤å’Œä¸€è‡´æ€§æ£€æŸ¥å·¥å…·</p>
                    
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:16px; margin-top:16px;">
                        <!-- ä¸€è‡´æ€§æ£€æŸ¥ -->
                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
                            <h4 style="margin:0 0 8px 0; color:#374151;">æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥</h4>
                            <p style="color:#6b7280; font-size:14px; margin-bottom:12px;">æ£€æŸ¥æœ¬åœ°ç›®å½•ä¸æ•°æ®åº“è®°å½•çš„ä¸€è‡´æ€§</p>
                            <div style="display:flex; gap:8px; margin-bottom:12px;">
                                <button class="btn" onclick="triggerConsistencyCheck()">æ‰§è¡Œæ£€æŸ¥</button>
                                <button class="btn btn-outline" onclick="loadConsistencyStats()">æŸ¥çœ‹çŠ¶æ€</button>
                            </div>
                            <div id="consistency-stats">
                                <div class="status">ç‚¹å‡»"æŸ¥çœ‹çŠ¶æ€"è·å–æœ€æ–°ä¿¡æ¯</div>
                            </div>
                        </div>

                        <!-- å®¹é‡å›å¡« -->
                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
                            <h4 style="margin:0 0 8px 0; color:#374151;">å®¹é‡æ•°æ®å›å¡«</h4>
                            <p style="color:#6b7280; font-size:14px; margin-bottom:12px;">å›å¡«ç¼ºå¤±çš„è§†é¢‘æ–‡ä»¶å¤§å°ä¿¡æ¯</p>
                            <div style="display:flex; gap:8px; margin-bottom:12px;">
                                <button class="btn" onclick="triggerRefreshSizes()">æ‰§è¡Œå›å¡«</button>
                                <button class="btn btn-outline" onclick="checkRefreshSizesStatus()">æŸ¥çœ‹è¿›åº¦</button>
                            </div>
                            <div id="refresh-sizes-status">
                                <div class="status">ç‚¹å‡»"æŸ¥çœ‹è¿›åº¦"è·å–çŠ¶æ€ä¿¡æ¯</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é«˜çº§è®¾ç½® -->
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>âš™ï¸ é«˜çº§è®¾ç½®</h3>
                        <button class="btn btn-outline" onclick="loadAdvancedSettings()">åˆ·æ–°</button>
                    </div>
                    <p style="color:#666; margin-bottom:1rem;">ç³»ç»Ÿå†…éƒ¨é…ç½®å’Œè°ƒè¯•é€‰é¡¹</p>
                    <div style="background:#fff7e6; border:1px solid #ffe7ba; border-radius:6px; padding:12px; margin-bottom:16px;">
                        <div style="color:#b26a00; font-weight:600; margin-bottom:4px;">âš ï¸ æ³¨æ„</div>
                        <div style="color:#b26a00; font-size:14px;">é«˜çº§è®¾ç½®é¡¹ä¸»è¦ç”¨äºç³»ç»Ÿè°ƒè¯•ï¼Œä¸€èˆ¬ç”¨æˆ·æ— éœ€ä¿®æ”¹</div>
                    </div>
                    <details>
                        <summary style="cursor:pointer; color:#0066cc; font-weight:600;">å±•å¼€æŸ¥çœ‹æ‰€æœ‰è®¾ç½®é¡¹</summary>
                        <div id="advanced-settings-content" style="margin-top:12px;">åŠ è½½ä¸­...</div>
                    </details>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(el, tabName) {
            // å…¼å®¹æ—§è°ƒç”¨ç­¾åï¼šshowTab('videos')
            if (typeof el === 'string' && !tabName) {
                tabName = el;
                el = null;
            }
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                // æ—  el æ—¶ï¼Œæ¿€æ´»ä¸ tabName å¯¹åº”çš„ tab
                const candidate = Array.from(document.querySelectorAll('.tab')).find(t => (t.getAttribute('onclick') || '').includes(`'${tabName}'`));
                if (candidate) candidate.classList.add('active');
            }
            const pane = document.getElementById(tabName);
            if (pane) pane.classList.add('active');
            // åŠ è½½å¯¹åº”æ•°æ®
            loadTabData(tabName);
        }

        // åŠ è½½æ ‡ç­¾é¡µæ•°æ®
        function loadTabData(tabName) {
            // åˆ‡æ¢åˆ°éä»»åŠ¡æ ‡ç­¾æ—¶åœæ­¢è½®è¯¢
            if (tabName !== 'tasks') {
                stopTasksPolling();
                if (typeof DownloadAggregateManager !== 'undefined') DownloadAggregateManager.stop();
            }
            // åˆ‡æ¢åˆ°éé˜Ÿåˆ—æ ‡ç­¾æ—¶åœæ­¢é˜Ÿåˆ—è½®è¯¢
            if (tabName !== 'queue') {
                stopQueuePolling();
            }
            // åˆ‡æ¢åˆ°éè®¢é˜…æ ‡ç­¾æ—¶åœæ­¢è®¢é˜…åŒæ­¥è½®è¯¢
            if (tabName !== 'subscriptions') {
                stopSubscriptionsSyncPolling();
            }
            // åˆ‡æ¢åˆ°éæ€»è§ˆæ ‡ç­¾æ—¶åœæ­¢Dashboardè½®è¯¢
            if (tabName !== 'dashboard') {
                if (typeof stopDashboardPolling === 'function') stopDashboardPolling();
            }
            // åˆ‡æ¢åˆ°éè®¾ç½®æ ‡ç­¾æ—¶åœæ­¢ä¸€è‡´æ€§è½®è¯¢
            if (tabName !== 'settings') {
                stopConsistencyPolling();
            }
            switch(tabName) {
                case 'dashboard':
                    // åª’ä½“æ•°æ®æ€»è§ˆ
                    loadMediaOverview();
                    loadSubscriptionStats();
                    loadDirectoryStats();
                    loadVideos();
                    break;
                case 'videos':
                    loadVideos();
                    break;
                case 'monitor':
                    loadSystemHealth();
                    loadTaskOverview();
                    loadConsistencyStatus();
                    loadResourceStatus();
                    break;
                case 'subscriptions':
                    loadSubscriptions();
                    startSubscriptionsSyncPolling();
                    break;
                case 'tasks':
                    startTasksPolling();
                    break;
                case 'queue':
                    loadQueueData();
                    break;
                case 'strm':
                    loadStrmOverview();
                    break;
                case 'cookies':
                    loadCookies();
                    break;
                case 'settings':
                    loadSettings();
                    startConsistencyPolling();
                    break;
            }
        }

        // â€”â€” æµ®åŠ¨ Cookie ç®¡ç†é¢æ¿ï¼ˆå¯¹æ¥æ–°æ¥å£ /api/cookie/*ï¼‰ â€”â€”
        function showCookiePanel() {
            let overlay = document.getElementById('cookie-panel-overlay');
            if (overlay) { overlay.style.display = 'block'; loadCookiePanelData(); return; }
            overlay = document.createElement('div');
            overlay.id = 'cookie-panel-overlay';
            overlay.style.cssText = 'position:fixed; inset:0; background:rgba(0,0,0,0.35); z-index:9999; display:flex; align-items:center; justify-content:center;';
            overlay.addEventListener('click', (e) => { if (e.target === overlay) hideCookiePanel(); });
            const panel = document.createElement('div');
            panel.style.cssText = 'background:#fff; width:min(920px, 92vw); max-height:86vh; overflow:auto; border-radius:10px; box-shadow:0 10px 30px rgba(0,0,0,0.2); padding:16px;';
            panel.innerHTML = `
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">Cookie ç®¡ç†</h3>
                <div>
                  <button class="btn btn-outline" onclick="triggerCookieValidateAllNew()">æ‰¹é‡éªŒè¯</button>
                  <button class="btn" style="margin-left:8px;" onclick="hideCookiePanel()">å…³é—­</button>
                </div>
              </div>
              <div id="cookie-panel-summary" style="margin-top:8px; color:#444; font-size:14px;">åŠ è½½ä¸­...</div>
              <div class="card" style="margin-top:12px;">
                <h4 style="margin-top:0;">Cookie åˆ—è¡¨</h4>
                <div id="cookie-panel-list">åŠ è½½ä¸­...</div>
              </div>
              <div class="card" style="margin-top:12px;">
                <h4 style="margin-top:0;">ä¸Šä¼ /æ–°å¢ Cookie</h4>
                <div class="form-group"><label>åç§°</label><input id="cp-name" type="text" placeholder="åç§°"></div>
                <div class="form-group"><label>SESSDATA</label><input id="cp-sessdata" type="text" placeholder="SESSDATA"></div>
                <div class="form-group"><label>bili_jct</label><input id="cp-jct" type="text" placeholder="bili_jct"></div>
                <div class="form-group"><label>DedeUserID</label><input id="cp-uid" type="text" placeholder="DedeUserID"></div>
                <div><button class="btn" onclick="cookieUploadNew()">ä¸Šä¼ </button></div>
              </div>
            `;
            overlay.appendChild(panel);
            document.body.appendChild(overlay);
            loadCookiePanelData();
        }

        function hideCookiePanel() {
            const overlay = document.getElementById('cookie-panel-overlay');
            if (overlay) overlay.style.display = 'none';
        }

        async function loadCookiePanelData() {
            try {
                const s = await apiRequest('/api/cookie/status');
                const sum = s && s.summary || s && s.cookie_summary || {};
                const items = Array.isArray(s && s.items) ? s.items : [];
                const summaryEl = document.getElementById('cookie-panel-summary');
                if (summaryEl) summaryEl.innerHTML = `æ´»è·ƒ ${sum.active ?? '-'} / æ€»æ•° ${sum.total ?? '-'}ï¼Œå½“å‰é€šé“: ${sum.current_cookie_id ? ('#'+sum.current_cookie_id) : '-'}`;
                const listEl = document.getElementById('cookie-panel-list');
                if (listEl) {
                    if (items.length === 0) { listEl.innerHTML = '<p>æš‚æ—  Cookie</p>'; return; }
                    listEl.innerHTML = items.map(c => `
                      <div class="list-item" style="display:flex; justify-content:space-between; align-items:center;">
                        <div>
                          <strong>${c.name || ('#'+c.id)}</strong>
                          <div style="color:#666; font-size:12px;">ID: ${c.id} ï½œ çŠ¶æ€: ${c.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</div>
                        </div>
                        <div>
                          <button class="btn" onclick="cookieToggleNew(${c.id}, ${c.is_active ? 'false' : 'true'})">${c.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        </div>
                      </div>
                    `).join('');
                }
            } catch (e) {
                const summaryEl = document.getElementById('cookie-panel-summary');
                if (summaryEl) summaryEl.innerHTML = `<span style="color:#b91c1c;">åŠ è½½å¤±è´¥ï¼š${e?.message || e}</span>`;
            }
        }

        async function cookieToggleNew(id, toActive) {
            try {
                await apiRequest('/api/cookie/toggle', { method: 'POST', body: JSON.stringify({ id, is_active: !!toActive }) });
                await loadCookiePanelData();
            } catch (e) {
                alert('åˆ‡æ¢å¤±è´¥: ' + (e?.message || e));
            }
        }

        async function cookieUploadNew() {
            const name = document.getElementById('cp-name').value.trim();
            const sessdata = document.getElementById('cp-sessdata').value.trim();
            const bili_jct = document.getElementById('cp-jct').value.trim();
            const dedeuserid = document.getElementById('cp-uid').value.trim();
            if (!name || !sessdata) { alert('è¯·è¾“å…¥åç§°ä¸ SESSDATA'); return; }
            try {
                await apiRequest('/api/cookie/upload', { method: 'POST', body: JSON.stringify({ name, sessdata, bili_jct, dedeuserid }) });
                document.getElementById('cp-name').value = '';
                document.getElementById('cp-sessdata').value = '';
                document.getElementById('cp-jct').value = '';
                document.getElementById('cp-uid').value = '';
                await loadCookiePanelData();
            } catch (e) {
                alert('ä¸Šä¼ å¤±è´¥: ' + (e?.message || e));
            }
        }

        async function triggerCookieValidateAllNew() {
            try {
                const btns = document.querySelectorAll('button[onclick="triggerCookieValidateAllNew()"]');
                btns.forEach(b => b.disabled = true);
                await apiRequest('/api/cookie/validate-all', { method: 'POST' });
                alert('å·²è§¦å‘åå°æ‰¹é‡æ ¡éªŒ');
            } catch (e) {
                alert('è§¦å‘å¤±è´¥: ' + (e?.message || e));
            } finally {
                const btns = document.querySelectorAll('button[onclick="triggerCookieValidateAllNew()"]');
                btns.forEach(b => b.disabled = false);
                try { await loadCookiePanelData(); } catch (_) {}
            }
        }

        // æœ¬åœ°åŒæ­¥ï¼ˆæŒ‰è®¢é˜…ï¼šä»…è¯¥è®¢é˜…ç›®å½•æ‰«æ + ä»…è¯¥è®¢é˜…è‡ªåŠ¨å…³è” + ä»…è¯¥è®¢é˜…ç»Ÿè®¡é‡ç®—ï¼‰
        async function localSyncSubscription(subscriptionId, btnEl) {
            if (!subscriptionId) return alert('è®¢é˜…IDæ— æ•ˆ');
            if (!confirm('ç¡®è®¤ä»…å¯¹è¯¥è®¢é˜…æ‰§è¡Œæœ¬åœ°åŒæ­¥ï¼ˆæ‰«æ + å…³è”ï¼‰ï¼Ÿ')) return;
            const oldText = btnEl ? btnEl.innerText : '';
            if (btnEl) { btnEl.disabled = true; btnEl.innerText = 'åŒæ­¥ä¸­...'; }
            try {
                const res = await apiRequest(`/api/auto-import/scan-associate/${subscriptionId}`, { method: 'POST' });
                if (res && res.error) {
                    alert('æœ¬åœ°åŒæ­¥å¤±è´¥ï¼ˆæŒ‰è®¢é˜…ï¼‰ï¼š' + res.error);
                } else {
                    alert('æœ¬åœ°åŒæ­¥å®Œæˆï¼ˆæŒ‰è®¢é˜…ï¼‰\nå¯¼å…¥: ' + (res?.scan?.imported ?? 0) + '\nè·³è¿‡: ' + (res?.scan?.skipped ?? 0) + '\næ–°å…³è”: ' + (res?.associate?.associated ?? 0));
                    // åŒæ­¥ååˆ·æ–°åˆ—è¡¨ä»¥æ›´æ–°ç»Ÿè®¡
                    await loadSubscriptions();
                }
            } catch (e) {
                alert('è¯·æ±‚å¤±è´¥ï¼š' + e);
            } finally {
                if (btnEl) { btnEl.disabled = false; btnEl.innerText = oldText; }
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const ct = (response.headers.get('content-type') || '').toLowerCase();
                let payload;
                if (ct.includes('application/json')) {
                    payload = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    payload = text ? { message: text } : null;
                }
                if (!response.ok) {
                    const msg = (payload && (payload.error || payload.message)) || `HTTP ${response.status}`;
                    return { error: msg, status: response.status };
                }
                return payload ?? {};
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return { error: error.message };
            }
        }

        // åˆ·æ–°å¹¶æ˜¾ç¤ºåˆé›†çš„è¿œç«¯æ€»æ•°ï¼ˆ1å°æ—¶ç¼“å­˜ï¼ŒlocalStorage æŒä¹…åŒ–ï¼‰
        const __expectedCache = {};
        function getExpectedCache(id) {
            try {
                const k = `expectedCache:${id}`;
                const s = localStorage.getItem(k);
                if (!s) return null;
                const obj = JSON.parse(s);
                if (!obj || typeof obj.at !== 'number') return null;
                return obj;
            } catch (_) { return null; }
        }
        function setExpectedCache(id, value) {
            const obj = { value, at: Date.now() };
            __expectedCache[id] = obj;
            try { localStorage.setItem(`expectedCache:${id}`, JSON.stringify(obj)); } catch (_) {}
            return obj;
        }
        // 10 ç§’èŠ‚æµï¼Œé¿å…é‡å¤åˆ·æ–°
        const __expectedThrottle = {};
        function __canRefreshExpected(id) {
            const now = Date.now();
            const last = __expectedThrottle[id] || 0;
            if ((now - last) < 10000) return false;
            __expectedThrottle[id] = now;
            return true;
        }
        async function refreshExpected(subscriptionId, force = false) {
            const el = document.getElementById(`expected-${subscriptionId}`);
            if (!el) return;
            const countEl = el.querySelector('.expected-count');
            const btns = el.querySelectorAll('button');
            // èŠ‚æµï¼š10s å†…é‡å¤ç‚¹å‡»ç›´æ¥å¿½ç•¥
            if (!__canRefreshExpected(subscriptionId)) {
                return;
            }
            // å‘½ä¸­ç¼“å­˜ä¸”æœªè¿‡æœŸï¼ˆ1å°æ—¶ï¼‰ä¸”éå¼ºåˆ¶åˆ·æ–°
            const now = Date.now();
            const c = __expectedCache[subscriptionId] || getExpectedCache(subscriptionId);
            const notExpired = c && (now - c.at < 3600 * 1000);
            if (!force && notExpired) {
                if (countEl) countEl.textContent = String(c.value);
                return;
            }
            if (countEl) countEl.textContent = 'åŠ è½½ä¸­...';
            btns.forEach(b => b.disabled = true);
            const url = `/api/subscriptions/${subscriptionId}/expected-total` + (force ? '?force=1' : '');
            const data = await apiRequest(url);
            if (data && typeof data.expected_total === 'number') {
                if (countEl) countEl.textContent = String(data.expected_total);
                setExpectedCache(subscriptionId, data.expected_total);
                // ä¸åœ¨å‰ç«¯é‡æ–°è®¡ç®— pendingï¼Œäº¤ç”±åç«¯å£å¾„ç»Ÿä¸€ï¼›è½»é‡åˆ·æ–°åˆ—è¡¨ä»¥è·å–æœ€æ–° pending
                try { if (typeof loadSubscriptions === 'function') { await loadSubscriptions(); } } catch (_) {}
            }
 else {
                if (countEl) countEl.textContent = 'è·å–å¤±è´¥';
            }
            btns.forEach(b => b.disabled = false);
        }

        // â€”â€” Dashboard è½»é‡è½®è¯¢ â€”â€”
        let __dashboardTimer = null;
        const __dashboardIntervalMs = 20000;
        function startDashboardPolling() {
            stopDashboardPolling();
            // å…ˆåˆ·æ–°ä¸€æ¬¡
            loadDashboard();
            __dashboardTimer = setInterval(() => {
                // ä»…åœ¨ dashboard å¯è§æ—¶åˆ·æ–°
                const tab = document.getElementById('dashboard');
                if (tab && tab.style.display !== 'none') {
                    loadDashboard();
                }
            }, __dashboardIntervalMs);
        }
        function stopDashboardPolling() {
            if (__dashboardTimer) {
                clearInterval(__dashboardTimer);
                __dashboardTimer = null;
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            const data = await apiRequest('/api/status');
            const html = `
                <div class="status success">
                    <strong>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</strong> - ç‰ˆæœ¬: ${data.version || '6.0.0'}
                </div>
                <div style="display:flex; align-items:center; gap:12px; margin:8px 0 4px 0;">
                    <label style="display:flex; align-items:center; gap:6px; font-size:13px; color:#444;">
                        <input id="auto-refresh-dashboard" type="checkbox" /> è‡ªåŠ¨åˆ·æ–°ï¼ˆ20ç§’ï¼‰
                    </label>
                    <button id="btn-refresh-dashboard" class="btn btn-outline btn-small">ç«‹å³åˆ·æ–°</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                    <div class="card">
                        <h3>è®¢é˜…ç»Ÿè®¡</h3>
                        <p>æ€»è®¢é˜…: ${data.statistics?.total_subscriptions || 0}</p>
                        <p>æ´»è·ƒè®¢é˜…: ${data.statistics?.active_subscriptions || 0}</p>
                    </div>
                    <div class="card">
                        <h3>è§†é¢‘ç»Ÿè®¡</h3>
                        <p>æ€»è§†é¢‘: ${data.statistics?.total_videos || 0}</p>
                        <p>å·²ä¸‹è½½: ${data.statistics?.downloaded_videos || 0}</p>
                    </div>
                    <div class="card">
                        <h3>Cookieæ¦‚è§ˆ</h3>
                        <div id="cookie-overview">åŠ è½½ä¸­...</div>
                        <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                          <button class="btn btn-outline" onclick="showCookiePanel()">ç®¡ç†</button>
                          <button class="btn btn-outline" onclick="triggerCookieValidateAllNew()">æ‰¹é‡éªŒè¯</button>
                        </div>
                    </div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>è°ƒåº¦ä»»åŠ¡</h3>
                            <button class="btn btn-outline btn-small" onclick="loadDashboard()">åˆ·æ–°</button>
                        </div>
                        <div id="scheduler-jobs" style="margin-top:6px; font-size:13px; color:#333;">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>è¿è¡Œä¸­ä»»åŠ¡</h3>
                            <button class="btn btn-outline btn-small" onclick="loadDashboard()">åˆ·æ–°</button>
                        </div>
                        <div id="running-tasks" style="margin-top:6px; font-size:13px; color:#333;">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3>æœ€è¿‘ä»»åŠ¡</h3>
                            <button class="btn btn-outline btn-small" onclick="loadDashboard()">åˆ·æ–°</button>
                        </div>
                        <div id="recent-tasks" style="margin-top:6px; font-size:13px; color:#333;">åŠ è½½ä¸­...</div>
                    </div>
                    <div class="card">
                        <div class="section-header">
                            <h3 style="margin:0;">å¤±è´¥ä»»åŠ¡</h3>
                            <div>
                                <button class="btn btn-outline btn-small" onclick="loadFailedTasks()">åˆ·æ–°</button>
                            </div>
                        </div>
                        <div id="failed-tasks" style="margin-top:6px; font-size:13px; color:#333;">åŠ è½½ä¸­...</div>
                    </div>
                </div>
            `;
            document.getElementById('system-status').innerHTML = html;
            // ç»‘å®šè‡ªåŠ¨åˆ·æ–°ä¸ç«‹å³åˆ·æ–°
            try {
                const cb = document.getElementById('auto-refresh-dashboard');
                const btn = document.getElementById('btn-refresh-dashboard');
                if (btn) btn.onclick = () => loadDashboard();
                if (cb) {
                    // è¯»å–æœ¬åœ°åå¥½
                    let pref = false;
                    try { pref = localStorage.getItem('pref_auto_refresh_dashboard') === '1'; } catch (_) {}
                    cb.checked = !!pref;
                    cb.onchange = () => {
                        const on = !!cb.checked;
                        try { localStorage.setItem('pref_auto_refresh_dashboard', on ? '1' : '0'); } catch (_) {}
                        if (on) startDashboardPolling(); else stopDashboardPolling();
                    };
                    if (pref) startDashboardPolling();
                }
            } catch (_) {}

            // æ¸²æŸ“è°ƒåº¦ä»»åŠ¡
            try {
                const jobs = data.scheduler_jobs || [];
                const jobsEl = document.getElementById('scheduler-jobs');
                jobsEl.innerHTML = jobs.length ? jobs.map(j => `<div class="mono" style="font-size:12px;">${j.id} Â· ${j.name || ''} Â· ${j.status || ''}</div>`).join('') : '<div style="color:#666;">æš‚æ— æ•°æ®</div>';
            } catch (_) {}

            // æ¸²æŸ“è¿è¡Œä¸­ä»»åŠ¡
            try {
                const running = data.running_tasks || [];
                const runEl = document.getElementById('running-tasks');
                runEl.innerHTML = running.length ? running.map(t => `<div class="mono" style="font-size:12px;">${t.id} Â· ${t.type || ''} Â· ${t.progress || ''}</div>`).join('') : '<div style="color:#666;">æš‚æ— è¿è¡Œä¸­ä»»åŠ¡</div>';
            } catch (_) {}

            // æ¸²æŸ“æœ€è¿‘ä»»åŠ¡
            try {
                const recent = data.recent_tasks || [];
                const recentEl = document.getElementById('recent-tasks');
                recentEl.innerHTML = recent.length ? recent.map(t => `<div class="mono" style="font-size:12px;">${t.id} Â· ${t.type || ''} Â· ${t.status || ''} Â· ${t.finished_at || ''}</div>`).join('') : '<div style="color:#666;">æš‚æ— æœ€è¿‘ä»»åŠ¡</div>';
            } catch (_) {}
        }

        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions() {
            const result = await apiRequest('/api/subscriptions?size=1000');
            if (result && result.error) {
                document.getElementById('subscription-list').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${result.error}</p>`;
                return;
            }

            // å…¼å®¹åç«¯åˆ†é¡µå“åº”(PaginatedResponse: {data,total,page,size})ä¸æ•°ç»„å“åº”
            const list = Array.isArray(result)
                ? result
                : (Array.isArray(result?.data)
                    ? result.data
                    : (Array.isArray(result?.items) ? result.items : []));

            let html = '';
            list.forEach(sub => {
                const statusClass = sub.is_active ? 'success' : 'error';
                const statusText = sub.is_active ? 'æ´»è·ƒ' : 'æš‚åœ';
                const lastCheck = sub.last_check ? new Date(sub.last_check).toLocaleString() : 'ä»æœª';
                
                // ç»Ÿè®¡ä¿¡æ¯ï¼ˆç»Ÿä¸€å£å¾„ï¼Œæ¥è‡ªåç«¯ metrics_serviceï¼‰
                const onDiskTotal = (typeof sub.on_disk_total === 'number') ? sub.on_disk_total : (sub.downloaded_videos || 0);
                const dbTotalVideos = (typeof sub.db_total === 'number') ? sub.db_total : ((typeof sub.db_total_videos === 'number') ? sub.db_total_videos : onDiskTotal);
                // è¿œç«¯æ€»æ•°ï¼šæ ‡å‡†å­—æ®µ expected_totalï¼Œå…¼å®¹ remote_total
                const remoteTotal = (typeof sub.expected_total === 'number') ? sub.expected_total : ((typeof sub.remote_total === 'number') ? sub.remote_total : null);
                // å¾…ä¸‹è½½ï¼šæ ‡å‡†å­—æ®µ pendingï¼ˆè‹¥è¿œç«¯ç¼ºå¤±åˆ™å¯èƒ½ä¸º nullï¼‰ï¼›å…¼å®¹ pending_videos
                const serverPendingRaw = (typeof sub.pending === 'number') ? sub.pending : ((typeof sub.pending_videos === 'number') ? sub.pending_videos : null);
                const serverPending = (typeof serverPendingRaw === 'number') ? Math.max(serverPendingRaw, 0) : null;
                
                // è®¢é˜…ç±»å‹æ˜¾ç¤º
                const typeTexts = {
                    'collection': 'åˆé›†è®¢é˜…',
                    'uploader': 'UPä¸»è®¢é˜…', 
                    'keyword': 'å…³é”®è¯è®¢é˜…',
                    'specific_urls': 'ç‰¹å®šè§†é¢‘è®¢é˜…'
                };
                const typeText = typeTexts[sub.type] || sub.type;
                
                // ç­›é€‰æ¡ä»¶æ˜¾ç¤º
                let filtersHtml = '';
                const filters = [];
                if (sub.date_after) filters.push(`å¼€å§‹æ—¥æœŸ: ${sub.date_after}`);
                if (sub.date_before) filters.push(`ç»“æŸæ—¥æœŸ: ${sub.date_before}`);
                if (sub.min_likes) filters.push(`æœ€å°ç‚¹èµ: ${sub.min_likes}`);
                if (sub.min_favorites) filters.push(`æœ€å°æ”¶è—: ${sub.min_favorites}`);
                if (sub.min_views) filters.push(`æœ€å°æ’­æ”¾: ${sub.min_views}`);
                
                if (filters.length > 0) {
                    filtersHtml = `
                        <div class="subscription-filters">
                            ç­›é€‰æ¡ä»¶: ${filters.map(f => `<span class="filter-tag">${f}</span>`).join('')}
                        </div>
                    `;
                }
                
                // è¿œç«¯ä¿¡æ¯ä¼˜å…ˆçº§ï¼šåç«¯ expected_total/pending > åç«¯ expected_total_cached > æœ¬åœ°ç¼“å­˜ expected_totalï¼›ä¸å†å‰ç«¯è‡ªç®— pending
                const cached = getExpectedCache(sub.id);
                const cachedOk = cached && (Date.now() - cached.at < 3600*1000);
                const serverCached = (typeof sub.expected_total_cached === 'number') ? sub.expected_total_cached : null;
                const expectedText = (remoteTotal !== null)
                    ? String(remoteTotal)
                    : (serverCached !== null)
                        ? String(serverCached)
                        : (cachedOk ? String(cached.value) : 'æœªè·å–');

                // æ–°é²œåº¦/TTL å±•ç¤ºï¼šä¼˜å…ˆä½¿ç”¨åç«¯ expected_total_snapshot_at
                let freshnessHtml = '';
                if (sub.expected_total_snapshot_at) {
                    const snapAt = new Date(sub.expected_total_snapshot_at);
                    const ageMs = Date.now() - snapAt.getTime();
                    const mins = Math.floor(ageMs / 60000);
                    const expired = ageMs > 3600*1000;
                    const label = expired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ';
                    const ageText = mins <= 0 ? 'åˆšåˆš' : `${mins} åˆ†é’Ÿå‰`;
                    freshnessHtml = `<small class="expected-freshness" style="margin-left:6px;opacity:.75;">(${ageText} Â· ${label})</small>`;
                }
                const pendingToShow = (serverPending !== null) ? serverPending : '-';
                const pendingSource = (serverPending !== null) ? 'åç«¯' : 'æœªçŸ¥';

                html += `
                    <div class="subscription-item" id="sub-${sub.id}" data-total="${onDiskTotal}" data-downloaded="${onDiskTotal}">
                        <div class="subscription-header">
                            <div>
                                <h3 class="subscription-title">${sub.name}</h3>
                                <span class="subscription-type type-${sub.type}">${typeText}</span>
                            </div>
                            <div class="subscription-controls">
                                <button onclick="toggleSubscription(${sub.id}, ${sub.is_active})" class="btn ${sub.is_active ? 'btn-warning' : 'btn-success'}">
                                    ${sub.is_active ? 'æš‚åœ' : 'å¯ç”¨'}
                                </button>
                                ${sub.type === 'uploader' ? `<button onclick="resolveUploader(${sub.id}, this)" class="btn btn-outline" title="å°è¯•è§£æå¹¶å›å¡«UPä¸»åå­—/ID">ç«‹å³è§£æ</button>` : ''}
                                <button onclick="viewPending(${sub.id})" class="btn btn-outline">æŸ¥çœ‹å¾…ä¸‹è½½</button>
                                <button onclick="editSubscription(${sub.id})" class="btn btn-info">è¯¦æƒ…/ç¼–è¾‘</button>
                                <button onclick="deleteSubscription(${sub.id})" class="btn btn-danger">åˆ é™¤</button>
                                <button onclick="localSyncSubscription(${sub.id}, this)" class="btn">æœ¬åœ°åŒæ­¥</button>
                                <button onclick="triggerLiteSyncSubscription(${sub.id}, this)" class="btn">è¿œç«¯åŒæ­¥</button>
                            </div>
                        </div>
                        
                        <div class="subscription-stats">
                            <span class="stat-item stat-total">æœ¬åœ°(æœ‰æ–‡ä»¶): ${onDiskTotal}</span>
                            <span class="stat-item" title="æ•°æ®åº“ä¸­çš„è§†é¢‘è®°å½•æ€»æ•°ï¼ˆå¯èƒ½åŒ…å«æ— æœ¬åœ°æ–‡ä»¶çš„è®°å½•ï¼‰">æ•°æ®åº“è®°å½•: ${dbTotalVideos}</span>
                            <span class="stat-item stat-downloaded">å·²ä¸‹è½½: ${onDiskTotal}</span>
                            <span class="stat-item stat-pending">å¾…ä¸‹è½½: <span id="pending-${sub.id}">${pendingToShow}</span> <small id="pending-src-${sub.id}" style="opacity:.7;">(${pendingSource})</small></span>
                            <span class="stat-item" id="retry-${sub.id}" style="background:#fff0f0;color:#b91c1c;">å¤±è´¥å›è¡¥é˜Ÿåˆ—: <span class="retry-count">-</span></span>
                            ${sub.type === 'collection' ? `
                            <span class="stat-item" id="expected-${sub.id}" style="background-color:#f3e5f5;color:#6a1b9a;">
                                è¿œç«¯æ€»æ•°: <span class="expected-count">${expectedText}</span>${freshnessHtml}
                                <button class="btn btn-small btn-outline" style="margin-left:6px;" onclick="refreshExpected(${sub.id}, true)">åˆ·æ–°è¿œç«¯å¿«ç…§</button>
                            </span>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">
                            çŠ¶æ€: ${statusText} | æœ€åæ£€æŸ¥: ${lastCheck}
                        </div>
                        
                        ${filtersHtml}
                    </div>
                `;
            });
            
            document.getElementById('subscription-list').innerHTML = html || '<p>æš‚æ— è®¢é˜…</p>';
            // é«˜äº®è·³è½¬çš„è®¢é˜…ï¼ˆæ¥è‡ªä¸‹è½½æ±‡æ€»ç‚¹å‡»ï¼‰
            try {
                const sid = localStorage.getItem('highlight_subscription');
                if (sid) {
                    const el = document.getElementById('sub-' + sid);
                    if (el && typeof DownloadAggregateManager !== 'undefined' && DownloadAggregateManager.highlightEl) {
                        DownloadAggregateManager.highlightEl(el);
                    } else if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    localStorage.removeItem('highlight_subscription');
                }
            } catch (_) {}
            // ä¸å†è‡ªåŠ¨æ‹‰å–ï¼Œä¾èµ–æœ¬åœ°ç¼“å­˜ä¸æŒ‰é’®è§¦å‘ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
            // ä½†ä¼šæœ‰è½»é‡çš„çŠ¶æ€è½®è¯¢ï¼Œç”¨äºåˆ·æ–° pending_estimated / retry é˜Ÿåˆ—é•¿åº¦
        }

        // è¿œç«¯åŒæ­¥ï¼šAPI å®¢æˆ·ç«¯ä¸è½®è¯¢
        let __subsSyncTimer = null;
        const __subsSyncIntervalMs = 15000;

        function startSubscriptionsSyncPolling() {
            stopSubscriptionsSyncPolling();
            // ç«‹å³è·‘ä¸€æ¬¡
            refreshSubscriptionsSyncStatus();
            __subsSyncTimer = setInterval(refreshSubscriptionsSyncStatus, __subsSyncIntervalMs);
        }

        function stopSubscriptionsSyncPolling() {
            if (__subsSyncTimer) {
                clearInterval(__subsSyncTimer);
                __subsSyncTimer = null;
            }
        }

        // â€”â€” ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆè®¾ç½®é¡µï¼‰ â€”â€”
        let __consistencyTimer = null;
        const __consistencyIntervalMs = 15000;

        function startConsistencyPolling() {
            stopConsistencyPolling();
            // ç«‹å³åˆ·æ–°ä¸€æ¬¡
            window.loadConsistencyStats();
            __consistencyTimer = setInterval(() => window.loadConsistencyStats(), __consistencyIntervalMs);
        }

        function stopConsistencyPolling() {
            if (__consistencyTimer) {
                clearInterval(__consistencyTimer);
                __consistencyTimer = null;
            }
        }

        async function triggerLiteSyncGlobal() {
            const btn = document.getElementById('btn-sync-global');
            if (btn) btn.disabled = true;
            try {
                const res = await apiRequest('/api/sync/trigger', { method: 'POST', body: JSON.stringify({}) });
                if (res && res.error) {
                    alert('è¿œç«¯åŒæ­¥è§¦å‘å¤±è´¥: ' + res.error);
                } else {
                    // è§¦å‘åè½»é‡åˆ·æ–°å‡ ä¸ªåŒºåŸŸ
                    loadOverview();
                    if (typeof DownloadAggregateManager !== 'undefined') DownloadAggregateManager.load();
                    refreshSubscriptionsSyncStatus();
                }
            } catch (e) {
                alert('è¿œç«¯åŒæ­¥è§¦å‘å¤±è´¥: ' + (e?.message || e));
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        async function triggerLiteSyncSubscription(subscriptionId, el) {
            if (el) el.disabled = true;
            try {
                const res = await apiRequest('/api/sync/trigger', { method: 'POST', body: JSON.stringify({ sid: subscriptionId }) });
                if (res && res.error) {
                    alert('è®¢é˜…è¿œç«¯åŒæ­¥å¤±è´¥: ' + res.error);
                } else {
                    // è§¦å‘ååˆ·æ–°è¯¥è®¢é˜…çš„ expected ä¸ pending å±•ç¤º
                    refreshExpected(subscriptionId, true);
                    // ç«‹å³æ‹‰å–ä¸€æ¬¡çŠ¶æ€
                    await refreshSubscriptionsSyncStatus(subscriptionId);
                }
            } catch (e) {
                alert('è®¢é˜…è¿œç«¯åŒæ­¥å¤±è´¥: ' + (e?.message || e));
            } finally {
                if (el) el.disabled = false;
            }
        }

        async function refreshSubscriptionsSyncStatus(onlySid) {
            try {
                let url = '/api/sync/status';
                if (typeof onlySid === 'number') url += `?sid=${onlySid}`;
                const data = await apiRequest(url);
                const items = (data && data.items) ? data.items : [];
                items.forEach(stat => {
                    const sid = stat.subscription_id;
                    // pending_estimated ä»…åœ¨åç«¯ pending ç¼ºå¤±æ—¶ä½œä¸ºå…œåº•æ˜¾ç¤ºï¼Œå¹¶æ ‡æ³¨â€œä¼°ç®—â€
                    if (typeof stat.pending_estimated === 'number') {
                        const pEl = document.getElementById(`pending-${sid}`);
                        const sEl = document.getElementById(`pending-src-${sid}`);
                        if (pEl) {
                            const cur = (pEl.textContent || '').trim();
                            if (!cur || cur === '-' || cur === 'â€”') {
                                pEl.textContent = String(Math.max(0, stat.pending_estimated));
                                if (sEl) sEl.textContent = '(ä¼°ç®—)';
                            }
                        }
                    }
                    // retry é˜Ÿåˆ—é•¿åº¦
                    const rEl = document.getElementById(`retry-${sid}`);
                    if (rEl) {
                        const rc = rEl.querySelector('.retry-count');
                        if (rc) rc.textContent = String(stat.retry_queue_len || 0);
                    }
                });
            } catch (_) {}
        }

        // æŸ¥çœ‹å¾…ä¸‹è½½ï¼ˆè¿œç«¯-æœ¬åœ°å·®é›†ï¼‰
        async function viewPending(subscriptionId) {
            // å…ˆæ˜¾ç¤ºåŠ è½½æç¤º
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; overflow-y:auto;`;
            modal.innerHTML = `
                <div style="background: white; padding: 1rem 1.5rem; border-radius: 8px; max-width: 800px; width: 92%; max-height: 85%; overflow:auto;">
                    <h3 style="margin-top:0;">å¾…ä¸‹è½½åˆ—è¡¨</h3>
                    <div id="pending-content" style="margin: .5rem 0;">åŠ è½½ä¸­...</div>
                    <div style="text-align:right; margin-top: .5rem;">
                        <button onclick="this.closest('div[style*=position]').remove()" class="btn">å…³é—­</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            const data = await apiRequest(`/api/subscriptions/${subscriptionId}/pending`);
            const container = modal.querySelector('#pending-content');
            if (!container) return;
            if (!data || data.error) {
                container.innerHTML = `<div class="error">è·å–å¤±è´¥: ${data?.error || 'æœªçŸ¥é”™è¯¯'}</div>`;
                return;
            }

            const total = Number(data.remote_total || 0);
            const existing = Number(data.existing || 0);
            const pending = Number(data.pending || 0);
            const list = Array.isArray(data.videos) ? data.videos : [];

            const rows = list.map((v, idx) => {
                const url = v.webpage_url || '#';
                const title = (v.title || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const id = v.id || '';
                const queuedBadge = v.is_queued ? `<span style="display:inline-block;margin-left:8px;padding:2px 6px;background:#e8f5e9;color:#1b5e20;border-radius:10px;font-size:11px;vertical-align:middle;">å·²åœ¨é˜Ÿåˆ—</span>` : '';
                return `<tr>
                    <td style="width:48px;text-align:right;color:#666;">${idx+1}</td>
                    <td style="word-break:break-all;">
                        <div style="font-weight:600;">${title || '(æ— æ ‡é¢˜)'} ${queuedBadge}</div>
                        <div style="font-size:12px;color:#666;">ID: ${id}</div>
                    </td>
                    <td style="width:260px; text-align:right;">
                        <a href="${url}" target="_blank" class="btn btn-small btn-outline">æ‰“å¼€é“¾æ¥</a>
                        ${v.is_queued ? `<button class="btn btn-small" disabled style="opacity:.7;cursor:not-allowed;">å·²åœ¨é˜Ÿåˆ—</button>` : `<button class="btn btn-small btn-primary" onclick="enqueuePendingVideo(${subscriptionId}, '${id}', this)">åŠ å…¥é˜Ÿåˆ—</button>`}
                    </td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div style="margin-bottom:.5rem; color:#333;">
                    è¿œç«¯æ€»æ•°: <strong>${total}</strong> | æœ¬åœ°å·²æœ‰: <strong>${existing}</strong> | å¾…ä¸‹è½½: <strong>${pending}</strong>
                </div>
                <div class="table-wrap">
                    <table class="data">
                        <thead>
                            <tr><th>#</th><th>è§†é¢‘</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>${rows || '<tr><td colspan="3" style="text-align:center;color:#666;">æ— å¾…ä¸‹è½½è§†é¢‘</td></tr>'}</tbody>
                    </table>
                </div>`;
        }

        // å°†å¾…ä¸‹è½½æ¡ç›®åŠ å…¥é˜Ÿåˆ—
        async function enqueuePendingVideo(subscriptionId, videoId, el) {
            if (!subscriptionId || !videoId) return;
            if (el) el.disabled = true;
            try {
                const res = await apiRequest(`/api/subscriptions/${subscriptionId}/enqueue_video`, {
                    method: 'POST',
                    body: JSON.stringify({ video_id: videoId })
                });
                if (res && res.error) {
                    alert('åŠ å…¥é˜Ÿåˆ—å¤±è´¥: ' + res.error);
                    if (el) el.disabled = false;
                    return;
                }
                // æ›´æ–°è¡Œå†…UIï¼šæ ‡è®°å¾½ç« å¹¶ç¦ç”¨æŒ‰é’®
                if (el) {
                    const row = el.closest('tr');
                    const titleDiv = row ? row.querySelector('td:nth-child(2) > div:first-child') : null;
                    if (titleDiv && !titleDiv.querySelector('.queued-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'queued-badge';
                        badge.style.cssText = 'display:inline-block;margin-left:8px;padding:2px 6px;background:#e8f5e9;color:#1b5e20;border-radius:10px;font-size:11px;vertical-align:middle;';
                        badge.textContent = 'å·²åœ¨é˜Ÿåˆ—';
                        titleDiv.appendChild(badge);
                    }
                    el.textContent = 'å·²åœ¨é˜Ÿåˆ—';
                    el.classList.remove('btn-primary');
                    el.classList.add('btn');
                    el.disabled = true;
                    el.style.opacity = '.7';
                    el.style.cursor = 'not-allowed';
                }
            } catch (e) {
                alert('åŠ å…¥é˜Ÿåˆ—å¤±è´¥: ' + (e?.message || e));
                if (el) el.disabled = false;
            }
        }

        // è§¦å‘åå°æ£€æŸ¥è®¢é˜…ï¼ˆå·®å€¼å…¥é˜Ÿå¹¶æŒç»­è¡¥é½ï¼‰
        async function triggerCheckSubscriptions() {
            const btns = document.querySelectorAll('button[onclick="triggerCheckSubscriptions()"]');
            btns.forEach(b => b.disabled = true);
            try {
                const res = await apiRequest('/api/scheduler/check-subscriptions', { method: 'POST' });
                if (res && res.error) {
                    alert('è§¦å‘å¤±è´¥: ' + res.error);
                } else {
                    alert('å·²è§¦å‘è®¢é˜…æ£€æŸ¥ï¼Œåå°æ­£åœ¨å¤„ç†');
                    loadSubscriptions();
                }
            } catch (e) {
                alert('è§¦å‘å¤±è´¥: ' + (e?.message || e));
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }
        
        // åˆ‡æ¢è®¢é˜…çŠ¶æ€
        async function toggleSubscription(subscriptionId, currentStatus) {
            const newStatus = !currentStatus;
            const result = await apiRequest(`/api/subscriptions/${subscriptionId}`, {
                method: 'PUT',
                body: JSON.stringify({ is_active: newStatus })
            });
            
            if (result.error) {
                // é’ˆå¯¹UPä¸»æœªè§£æå¯¼è‡´çš„å¯ç”¨å¤±è´¥ï¼Œç»™å‡ºå‹å¥½æç¤ºå¹¶æä¾›ç«‹å³è§£æå…¥å£
                const msg = String(result.error || '');
                if (result.status === 400 && (/æœªè§£æ/.test(msg) || /resolve/i.test(msg) || /UPä¸»/.test(msg))) {
                    const go = confirm('å¯ç”¨å¤±è´¥ï¼šUPä¸»åç§°æœªè§£ææˆåŠŸï¼Œæš‚ä¸èƒ½å¯ç”¨ã€‚\næ˜¯å¦ç°åœ¨å°è¯•â€œç«‹å³è§£æâ€ï¼Ÿ');
                    if (go) {
                        try { await resolveUploader(subscriptionId); } catch (_) {}
                        // è§£æåå°è¯•åˆ·æ–°è®¢é˜…åˆ—è¡¨
                        await loadSubscriptions();
                    }
                } else {
                    alert('æ“ä½œå¤±è´¥: ' + msg);
                }
            } else {
                loadSubscriptions();
            }
        }

        // è§£æå¹¶å›å¡«æŒ‡å®šè®¢é˜…çš„UPä¸»åå­—/IDï¼ˆä»…å¯¹ type='uploader' ç”Ÿæ•ˆï¼‰
        async function resolveUploader(subscriptionId, el) {
            if (!subscriptionId) return;
            let oldText = '';
            if (el) { el.disabled = true; oldText = el.innerText; el.innerText = 'è§£æä¸­...'; }
            try {
                const res = await apiRequest(`/api/subscriptions/${subscriptionId}/resolve`, {
                    method: 'POST'
                });
                if (res && res.error) {
                    alert('è§£æå¤±è´¥ï¼š' + res.error);
                } else {
                    // æ ¹æ®è¿”å›å€¼ç»™å‡ºæ›´å‹å¥½çš„æç¤º
                    if (res && typeof res.changed === 'boolean') {
                        if (res.changed) {
                            const after = res.after || {};
                            const nm = after.name ? `åç§°ï¼š${after.name}` : '';
                            const mid = after.uploader_id ? `IDï¼š${after.uploader_id}` : '';
                            const joined = [nm, mid].filter(Boolean).join('ï¼Œ');
                            alert('è§£ææˆåŠŸï¼Œå·²å›å¡«' + (joined ? `ï¼ˆ${joined}ï¼‰` : '') + 'ã€‚');
                        } else {
                            alert('å·²å°è¯•è§£æï¼Œä½†æ²¡æœ‰å¯æ›´æ–°çš„å­—æ®µï¼ˆå¯èƒ½å·²è§£æè¿‡æˆ–ä»æ— æ³•è§£æï¼‰ã€‚');
                        }
                    } else {
                        alert('å·²å°è¯•è§£æå¹¶å›å¡«ï¼ˆè‹¥æˆåŠŸå°†è‡ªåŠ¨ä¿å­˜ï¼‰ã€‚');
                    }
                    // åˆ·æ–°è®¢é˜…åˆ—è¡¨
                    await loadSubscriptions();
                    // è‹¥ç¼–è¾‘æ¨¡æ€æ‰“å¼€ä¸”å¯¹åº”å½“å‰è®¢é˜…ï¼Œå…³é—­å¹¶é‡æ–°æ‰“å¼€ä»¥è·å–æœ€æ–°æ•°æ®
                    if (window.__currentEditingSubId && Number(window.__currentEditingSubId) === Number(subscriptionId)) {
                        try { closeEditModal(); } catch(_) {}
                        // ç•¥ç­‰ä¸€å¸§å†æ‰“å¼€ï¼Œé¿å…DOMå°šæœªæ›´æ–°
                        setTimeout(() => editSubscription(subscriptionId), 0);
                    }
                }
            } catch (e) {
                alert('è§£æå¤±è´¥ï¼š' + (e?.message || e));
            } finally {
                if (el) { el.disabled = false; el.innerText = oldText || 'ç«‹å³è§£æ'; }
            }
        }

        // åˆ‡æ¢è®¢é˜…ç±»å‹å­—æ®µ
        function toggleSubFields() {
            const type = document.getElementById('sub-type').value;
            
            // éšè—æ‰€æœ‰å­—æ®µ
            document.getElementById('collection-fields').style.display = 'none';
            document.getElementById('uploader-fields').style.display = 'none';
            document.getElementById('keyword-fields').style.display = 'none';
            document.getElementById('specific-urls-fields').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”å­—æ®µ
            if (type === 'collection') {
                document.getElementById('collection-fields').style.display = 'block';
            } else if (type === 'uploader') {
                document.getElementById('uploader-fields').style.display = 'block';
            } else if (type === 'keyword') {
                document.getElementById('keyword-fields').style.display = 'block';
            } else if (type === 'specific_urls') {
                document.getElementById('specific-urls-fields').style.display = 'block';
            }
            
            // æ¸…ç©ºè®¢é˜…åç§°
            document.getElementById('sub-name').value = '';
        }

        // è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°
        async function autoFillCollectionName() {
            const url = document.getElementById('sub-url').value;
            if (!url) return;
            
            try {
                // è°ƒç”¨åç«¯APIè·å–åˆé›†ä¿¡æ¯
                const result = await apiRequest('/api/subscriptions/parse-collection', {
                    method: 'POST',
                    body: JSON.stringify({ url })
                });
                
                if (result.name) {
                    document.getElementById('sub-name').value = result.name;
                } else if (result.error) {
                    console.warn('æ— æ³•è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°:', result.error);
                }
            } catch (error) {
                console.warn('è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤º/éšè—æ·»åŠ è®¢é˜…è¡¨å•
        function showAddSubscription() {
            document.getElementById('add-subscription').style.display = 'block';
            toggleSubFields(); // åˆå§‹åŒ–å­—æ®µæ˜¾ç¤º
            selectDownloadMode('LOCAL'); // é»˜è®¤é€‰æ‹©LOCALæ¨¡å¼
        }

        // STRMæ¨¡å¼é€‰æ‹©å‡½æ•°
        function selectDownloadMode(mode) {
            // æ›´æ–°å•é€‰æŒ‰é’®çŠ¶æ€
            document.getElementById('radio-local').checked = (mode === 'LOCAL');
            document.getElementById('radio-strm').checked = (mode === 'STRM');
            
            // æ›´æ–°è§†è§‰æ ·å¼
            document.getElementById('mode-local').classList.toggle('selected', mode === 'LOCAL');
            document.getElementById('mode-strm').classList.toggle('selected', mode === 'STRM');
            
            // æ˜¾ç¤º/éšè—STRMè¯´æ˜
            const strmNotice = document.getElementById('strm-notice');
            if (strmNotice) {
                strmNotice.style.display = (mode === 'STRM') ? 'block' : 'none';
            }
        }
        
        function hideAddSubscription() {
            document.getElementById('add-subscription').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-url').value = '';
            document.getElementById('sub-uploader').value = '';
            document.getElementById('sub-keyword').value = '';
        }

        // æ·»åŠ è®¢é˜…
        async function addSubscription() {
            const type = document.getElementById('sub-type').value;
            let name = document.getElementById('sub-name').value;
            
            // æ ¹æ®ç±»å‹è·å–ç›¸åº”çš„å€¼
            let data = { type };
            
            if (type === 'collection') {
                const url = document.getElementById('sub-url').value;
                if (!url) {
                    alert('è¯·è¾“å…¥åˆé›†URL');
                    return;
                }
                data.url = url;
                
                // è‹¥åç§°ç•™ç©ºï¼Œè°ƒç”¨è§£ææ¥å£è‡ªåŠ¨å›å¡«åˆé›†åç§°
                if (!name) {
                    try {
                        const parsed = await apiRequest('/api/subscriptions/parse-collection', {
                            method: 'POST',
                            body: JSON.stringify({ url })
                        });
                        if (parsed && parsed.name) {
                            name = parsed.name;
                        }
                    } catch (_) { /* è§£æå¤±è´¥åˆ™å¿½ç•¥ï¼Œåç»­Pydanticä¼šæ ¡éªŒnameæ˜¯å¦ä¸ºç©º */ }
                }
                
            } else if (type === 'uploader') {
                const uploader = document.getElementById('sub-uploader').value;
                if (!uploader) {
                    alert('è¯·è¾“å…¥UPä¸»IDæˆ–åç§°');
                    return;
                }
                // å¼ºåˆ¶é¢„è§£ææ ¡éªŒï¼šä¼˜å…ˆæŠŠçº¯æ•°å­—å½“ä½œIDï¼Œå¦åˆ™å½“ä½œåç§°è¿›è¡Œè§£æ
                const isNumericId = /^\d+$/.test(uploader.trim());
                let preResolveBody = {};
                if (isNumericId) preResolveBody.uploader_id = uploader.trim();
                else preResolveBody.name = uploader.trim();

                let pre;
                try {
                    pre = await apiRequest('/api/uploader/resolve', {
                        method: 'POST',
                        body: JSON.stringify(preResolveBody)
                    });
                } catch (e) {
                    alert('è§£ææ¥å£å¼‚å¸¸ï¼š' + (e?.message || e));
                    return;
                }
                if (!pre || pre.error) {
                    alert('è§£æå¤±è´¥ï¼š' + (pre?.error || 'æœªçŸ¥é”™è¯¯'));
                    return;
                }
                const resolved = pre.resolved || {};
                const resolvedName = (resolved.name || '').trim();
                const resolvedMid = (resolved.uploader_id || '').toString().trim();
                // è¦æ±‚â€œåç§°â€å’Œâ€œIDâ€éƒ½è§£ææˆåŠŸï¼Œå¦åˆ™ç¦æ­¢åˆ›å»º
                if (!resolvedName || !resolvedMid) {
                    alert('æ— æ³•è§£æè¯¥UPä¸»ï¼Œè¯·è¾“å…¥æœ‰æ•ˆçš„UPä¸»IDæˆ–åç§°ï¼ˆéœ€èƒ½åŒæ—¶è§£æå‡ºåç§°ä¸IDï¼‰');
                    return;
                }
                // å›å¡«è§£æç»“æœï¼šä½¿ç”¨è§£æå‡ºçš„IDï¼›è‹¥ç”¨æˆ·æœªè‡ªå®šä¹‰åç§°ï¼Œåˆ™ä½¿ç”¨è§£æå‡ºçš„åç§°
                data.uploader_id = resolvedMid;
                if (!name) name = resolvedName;
            } else if (type === 'keyword') {
                const keyword = document.getElementById('sub-keyword').value;
                if (!keyword) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }
                data.keyword = keyword;
                
                // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨å…³é”®è¯
                if (!name) {
                    name = 'å…³é”®è¯è®¢é˜… - ' + keyword;
                }
                
            } else if (type === 'specific_urls') {
                const specificUrls = document.getElementById('sub-specific-urls').value;
                if (!specificUrls.trim()) {
                    alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè§†é¢‘URL');
                    return;
                }
                
                // è§£æURLåˆ—è¡¨
                const urls = specificUrls.split('\n').map(url => url.trim()).filter(url => url);
                if (urls.length === 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘URL');
                    return;
                }
                
                data.specific_urls = JSON.stringify(urls);
                
                // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨URLæ•°é‡
                if (!name) {
                    name = `ç‰¹å®šè§†é¢‘è®¢é˜… - ${urls.length}ä¸ªè§†é¢‘`;
                }
            }
            
            // è·å–ç­›é€‰æ¡ä»¶
            const dateAfter = document.getElementById('sub-date-after').value;
            const dateBefore = document.getElementById('sub-date-before').value;
            const minLikes = document.getElementById('sub-min-likes').value;
            const minFavorites = document.getElementById('sub-min-favorites').value;
            const minViews = document.getElementById('sub-min-views').value;
            
            if (dateAfter) data.date_after = dateAfter;
            if (dateBefore) data.date_before = dateBefore;
            if (minLikes && parseInt(minLikes) > 0) data.min_likes = parseInt(minLikes);
            if (minFavorites && parseInt(minFavorites) > 0) data.min_favorites = parseInt(minFavorites);
            if (minViews && parseInt(minViews) > 0) data.min_views = parseInt(minViews);
            
            // è·å–ä¸‹è½½æ¨¡å¼
            const downloadMode = document.querySelector('input[name="download-mode"]:checked').value;
            // åç«¯æšä¸¾è¦æ±‚å°å†™ï¼š'local' | 'strm'
            data.download_mode = (downloadMode || '').toLowerCase();
            
            data.name = name;
            
            const result = await apiRequest('/api/subscriptions', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('æ·»åŠ å¤±è´¥: ' + result.error);
            } else {
                alert('æ·»åŠ æˆåŠŸ');
                hideAddSubscription();
                loadSubscriptions();
            }
        }

        // å·²ç§»é™¤â€œå¼€å§‹ä¸‹è½½â€ï¼šä¸‹è½½ç”±å¯ç”¨è®¢é˜…åè°ƒåº¦å™¨è‡ªåŠ¨æ‰§è¡Œ

        // æœ¬åœ°åŒæ­¥ï¼ˆå…¨é‡æ‰«æ + è‡ªåŠ¨å…³è” + ç»Ÿè®¡é‡ç®—ï¼‰
        async function localSync() {
            if (!confirm('ç¡®è®¤æ‰§è¡Œæœ¬åœ°åŒæ­¥ï¼ˆå…¨é‡æ‰«æ + è‡ªåŠ¨å…³è”ï¼‰ï¼Ÿ')) return;
            const res = await apiRequest('/api/auto-import/scan-associate', { method: 'POST' });
            if (res && res.error) {
                alert('æœ¬åœ°åŒæ­¥å¤±è´¥: ' + res.error);
            } else if (res && res.running) {
                alert('å·²æœ‰æœ¬åœ°åŒæ­¥åœ¨è¿è¡Œä¸­ï¼Œè¯·ç¨åå†è¯•');
            } else {
                alert('æœ¬åœ°åŒæ­¥å®Œæˆ');
                loadSubscriptions();
            }
        }

        // ä¿ç•™æ—§å‡½æ•°ä»¥å…¼å®¹å†å²å…¥å£ï¼ˆä¸å†åœ¨UIä¸­å±•ç¤ºï¼‰
        async function scanAll() { return localSync(); }
        async function associateAll() { return localSync(); }


        // â€”â€” ä¸‹è½½æ±‡æ€»ï¼ˆæŒ‰è®¢é˜…ï¼‰ â€”â€”
        const DownloadAggregateManager = {
            timer: null,
            intervalMs: 15000,
            start() {
                try {
                    // è‹¥å‹¾é€‰è‡ªåŠ¨åˆ·æ–°åˆ™å¯åŠ¨å®šæ—¶å™¨
                    // åˆå§‹åŒ–è‡ªåŠ¨åˆ·æ–°å‹¾é€‰çŠ¶æ€
                    const auto = document.getElementById('agg-autorefresh');
                    if (auto) {
                        const persisted = localStorage.getItem('agg_autorefresh') === '1';
                        auto.checked = persisted;
                    }
                    // åˆå§‹åŒ–æŠ˜å çŠ¶æ€
                    this.applyCollapseFromStore();
                    // ç«‹å³åŠ è½½ä¸€æ¬¡
                    this.load();
                    // é‡ç½®å¹¶æ ¹æ®å‹¾é€‰å¯åŠ¨è½®è¯¢
                    this.stop();
                    if (auto && auto.checked) this.timer = setInterval(() => this.load(), this.intervalMs);
                } catch (_) {}
            },
            stop() {
                if (this.timer) { clearInterval(this.timer); this.timer = null; }
            },
            toggleAuto(on) {
                if (on) {
                    this.stop();
                    this.timer = setInterval(() => this.load(), this.intervalMs);
                } else {
                    this.stop();
                }
                try { localStorage.setItem('agg_autorefresh', on ? '1' : '0'); } catch (_) {}
            },
            applyCollapseFromStore() {
                const collapsed = localStorage.getItem('agg_collapsed') === '1';
                const content = document.getElementById('agg-content');
                const btn = document.getElementById('agg-collapse-btn');
                if (content) content.style.display = collapsed ? 'none' : '';
                if (btn) btn.textContent = collapsed ? 'å±•å¼€' : 'æŠ˜å ';
            },
            toggleCollapse() {
                const content = document.getElementById('agg-content');
                const btn = document.getElementById('agg-collapse-btn');
                if (!content) return;
                const collapsed = content.style.display === 'none';
                content.style.display = collapsed ? '' : 'none';
                if (btn) btn.textContent = collapsed ? 'æŠ˜å ' : 'å±•å¼€';
                try { localStorage.setItem('agg_collapsed', (!collapsed) ? '1' : '0'); } catch (_) {}
            },
            async load() {
                const totalsEl = document.getElementById('agg-totals');
                const tbody = document.getElementById('agg-tbody');
                if (!totalsEl || !tbody) return;
                totalsEl.textContent = 'åŠ è½½ä¸­...';
                try {
                    const data = await apiRequest('/api/download/aggregate');
                    if (!data || data.error) {
                        totalsEl.innerHTML = `<span style="color:#b91c1c;">åŠ è½½å¤±è´¥ï¼š${(data && data.error) || 'æœªçŸ¥é”™è¯¯'}</span> <button class="btn btn-small btn-outline" onclick="DownloadAggregateManager.load()">é‡è¯•</button>`;
                        return;
                    }
                    this.render(data);
                } catch (e) {
                    totalsEl.innerHTML = `<span style="color:#b91c1c;">åŠ è½½å¼‚å¸¸ï¼š${e?.message || e}</span> <button class=\"btn btn-small btn-outline\" onclick=\"DownloadAggregateManager.load()\">é‡è¯•</button>`;
                }
            },
            render(data) {
                const totals = data.totals || {};
                const items = Array.isArray(data.items) ? data.items.slice() : [];
                // æ’åºï¼šæ´»è·ƒåº¦(queued+running) é™åºï¼Œå…¶æ¬¡ pending_estimated é™åº
                items.sort((a,b) => {
                    const aAct = (a.queue?.queued||0) + (a.queue?.running||0);
                    const bAct = (b.queue?.queued||0) + (b.queue?.running||0);
                    if (bAct !== aAct) return bAct - aAct;
                    const ap = a.pending_estimated ?? 0;
                    const bp = b.pending_estimated ?? 0;
                    return bp - ap;
                });

                const totalHtml = `
                    <span class="stat-item stat-downloaded">Downloaded: ${totals.downloaded || 0}</span>
                    <span class="stat-item stat-pending">Pending: ${totals.pending_estimated || 0}</span>
                    <span class="stat-item">Queued: ${totals.queued || 0}</span>
                    <span class="stat-item">Running: ${totals.running || 0}</span>
                `;
                document.getElementById('agg-totals').innerHTML = totalHtml;

                const rows = items.map(x => {
                    const name = (x.subscription && x.subscription.name) || `#${x.subscription_id || ''}`;
                    const sid = (x.subscription && x.subscription.id) || x.subscription_id;
                    const remote = (typeof x.remote_total === 'number') ? x.remote_total : '-';
                    const onClick = sid ? `onclick=\"DownloadAggregateManager.gotoSubscription(${sid})\"` : '';
                    const failed = x.failed ?? 0;
                    const lastSync = x.last_sync_time ? new Date(x.last_sync_time).toLocaleString('zh-CN', {month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit'}) : '-';
                    return `
                        <tr>
                            <td ${onClick} style="cursor:${sid?'pointer':'default'};">${name}</td>
                            <td class="num">${x.downloaded ?? 0}</td>
                            <td class="num">${x.pending_estimated ?? 0}</td>
                            <td class="num">${(x.queue && x.queue.queued) ?? 0}</td>
                            <td class="num">${(x.queue && x.queue.running) ?? 0}</td>
                            <td class="num">${remote}</td>
                            <td class="num" style="color:${failed > 0 ? '#ef4444' : '#6b7280'}">${failed}</td>
                            <td style="font-size:12px;">${lastSync}</td>
                            <td>
                                <button class="btn btn-outline" style="font-size:12px; padding:2px 6px;" onclick="triggerSubscriptionSync(${sid})">åŒæ­¥</button>
                            </td>
                        </tr>`;
                }).join('');
                document.getElementById('agg-tbody').innerHTML = rows || '<tr><td colspan="9" style="text-align:center; color:#666;">æš‚æ— æ•°æ®</td></tr>';
            },
            gotoSubscription(sid) {
                if (!sid) return;
                try { localStorage.setItem('highlight_subscription', String(sid)); } catch (_) {}
                showTab('subscriptions');
                // è‹¥åˆ—è¡¨å·²åœ¨ï¼Œç›´æ¥å°è¯•é«˜äº®
                setTimeout(() => {
                    const el = document.getElementById('sub-' + sid);
                    if (el) this.highlightEl(el);
                }, 300);
            },
            highlightEl(el) {
                if (!el) return;
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const prevBg = el.style.backgroundColor;
                const prevShadow = el.style.boxShadow;
                el.style.transition = 'background-color .3s ease, box-shadow .3s ease';
                el.style.backgroundColor = '#fff7ed';
                el.style.boxShadow = '0 0 0 3px rgba(249,115,22,0.35) inset';
                setTimeout(() => {
                    el.style.backgroundColor = prevBg || '';
                    el.style.boxShadow = prevShadow || '';
                }, 4000);
            }
        };

        // è®¢é˜…åŒæ­¥è§¦å‘å‡½æ•°
        async function triggerSubscriptionSync(subscriptionId) {
            if (!subscriptionId) return;
            
            try {
                const response = await fetch(`/api/subscriptions/${subscriptionId}/sync`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok) {
                    showToast('è®¢é˜…åŒæ­¥å·²è§¦å‘', 'success');
                    // åˆ·æ–°æ±‡æ€»è¡¨æ ¼
                    if (window.DownloadAggregateManager) {
                        setTimeout(() => DownloadAggregateManager.load(), 1000);
                    }
                } else {
                    const error = await response.text();
                    showToast(`åŒæ­¥å¤±è´¥: ${error}`, 'error');
                }
            } catch (error) {
                console.error('è§¦å‘è®¢é˜…åŒæ­¥å¤±è´¥:', error);
                showToast('åŒæ­¥è¯·æ±‚å¤±è´¥', 'error');
            }
        }

        // ä»»åŠ¡è½®è¯¢ä¸æ¸²æŸ“
        let tasksPollTimer = null;

        function startTasksPolling() {
            refreshTasks();
            stopTasksPolling();
            tasksPollTimer = setInterval(refreshTasks, 2000);
        }

        function stopTasksPolling() {
            if (tasksPollTimer) {
                clearInterval(tasksPollTimer);
                tasksPollTimer = null;
            }
        }

        async function refreshTasks() {
            const data = await apiRequest('/api/requests');
            if (data.error) {
                document.getElementById('task-list').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${data.error}</p>`;
                return;
            }
            // å…¼å®¹åç«¯è¿”å›å¯¹è±¡ï¼ˆä»¥ task_id ä¸ºé”®ï¼‰æˆ–æ•°ç»„
            const tasksArr = data.items || data || [];
            renderTasks(tasksArr);
        }

        function renderTasks(tasks) {
            if (!tasks || tasks.length === 0) {
                document.getElementById('task-list').innerHTML = '<p>æš‚æ— ä»»åŠ¡</p>';
                return;
            }
            const statusText = {
                'pending': 'æ’é˜Ÿä¸­',
                'downloading': 'ä¸‹è½½ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'paused': 'å·²æš‚åœ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            const html = tasks.map(t => {
                const progress = typeof t.progress_percent === 'number' ? Math.max(0, Math.min(100, t.progress_percent)) : 0;
                const barClass = t.status === 'completed' ? 'success' : (t.status === 'failed' ? 'error' : '');
                const controls = renderTaskControls(t);
                return `
                    <div class="card" style="margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>ä»»åŠ¡#${t.task_id || t.id || '-'}</strong>
                                <span style="margin-left:8px;color:#666;">${statusText[t.status] || t.status}</span>
                            </div>
                            <div>${controls}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress ${barClass}" style="width:${progress}%"></div>
                        </div>
                        ${t.error_message ? `<div class="error">${t.error_message}</div>` : ''}
                        <div style="font-size:12px;color:#666;margin-top:4px;">
                            å¼€å§‹: ${t.started_at || '-'} | ç»“æŸ: ${t.completed_at || '-'}
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('task-list').innerHTML = html;
        }

        function renderTaskControls(t) {
            const buttons = [];
            if (t.status === 'downloading') {
                buttons.push(`<button class="btn btn-warning" onclick=\"pauseTask('${t.task_id || t.id}')\">æš‚åœ</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">å–æ¶ˆ</button>`);
            } else if (t.status === 'paused') {
                buttons.push(`<button class="btn btn-success" onclick=\"resumeTask('${t.task_id || t.id}')\">æ¢å¤</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">å–æ¶ˆ</button>`);
            }
            return buttons.join(' ');
        }

        async function pauseTask(taskId) {
            const res = await apiRequest(`/api/requests/${taskId}/pause`, { method: 'POST' });
            if (res.error) return alert('æš‚åœå¤±è´¥: ' + res.error);
            refreshTasks();
        }
        async function resumeTask(taskId) {
            const res = await apiRequest(`/api/requests/${taskId}/resume`, { method: 'POST' });
            if (res.error) return alert('æ¢å¤å¤±è´¥: ' + res.error);
            refreshTasks();
        }
        async function cancelTask(taskId) {
            const res = await apiRequest(`/api/requests/${taskId}/cancel`, { method: 'POST' });
            if (res.error) return alert('å–æ¶ˆå¤±è´¥: ' + res.error);
            refreshTasks();
        }

        async function clearCompletedTasks() {
            const res = await apiRequest('/api/requests/clear-completed', { method: 'POST' });
            if (res.error) return alert('æ¸…ç†å¤±è´¥: ' + res.error);
            refreshTasks();
        }

        // æŸ¥çœ‹è®¢é˜…è¯¦æƒ…
        

        // ç¼–è¾‘è®¢é˜…
        async function editSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}`);
            if (result.error) {
                alert('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥: ' + result.error);
                return;
            }
            
            const sub = result;
            const typeTexts = {
                'collection': 'åˆé›†è®¢é˜…',
                'uploader': 'UPä¸»è®¢é˜…', 
                'keyword': 'å…³é”®è¯è®¢é˜…',
                'specific_urls': 'ç‰¹å®šè§†é¢‘è®¢é˜…'
            };
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'subscription-edit-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; overflow-y: auto;
            `;
            modal.innerHTML = `
                <div class="modal-content" style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; margin: 2rem;">
                    <h3>è®¢é˜…è¯¦æƒ… / ç¼–è¾‘</h3>
                    <div style="background:#f8f9fa; border:1px solid #e5e7eb; padding:12px; border-radius:6px; margin: 0 0 12px; font-size: 14px; color:#374151;">
                        <div><strong>ID:</strong> ${sub.id}</div>
                        <div><strong>ç±»å‹:</strong> ${typeTexts[sub.type] || sub.type}</div>
                        <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${sub.created_at ? new Date(sub.created_at).toLocaleString() : '-'}</div>
                        <div><strong>æœ€åæ£€æŸ¥:</strong> ${sub.last_check ? new Date(sub.last_check).toLocaleString() : 'ä»æœª'}</div>
                    </div>
                    <form id="edit-subscription-form">
                        <div class="form-group">
                            <label>è®¢é˜…åç§°</label>
                            <input type="text" id="edit-name" value="${sub.name}" required>
                        </div>
                        <div class="form-group">
                            <label>è®¢é˜…URL</label>
                            <input type="url" id="edit-url" value="${sub.url || ''}" ${sub.type === 'collection' ? 'required' : ''}>
                        </div>
                        ${sub.type === 'uploader' ? `
                        <div class="form-group">
                            <label>UPä¸»ID <span class="help-text">çº¯æ•°å­—IDï¼Œå¦‚ï¼š1850091</span></label>
                            <input type="text" id="edit-uploader-id" value="${sub.uploader_id || ''}" required>
                        </div>
                        ` : ''}
                        ${sub.type === 'keyword' ? `
                        <div class="form-group">
                            <label>æœç´¢å…³é”®è¯</label>
                            <input type="text" id="edit-keyword" value="${sub.keyword || ''}" required>
                        </div>
                        ` : ''}
                        <div class="form-group">
                            <label>çŠ¶æ€</label>
                            <select id="edit-active">
                                <option value="true" ${sub.is_active ? 'selected' : ''}>æ´»è·ƒ</option>
                                <option value="false" ${!sub.is_active ? 'selected' : ''}>æš‚åœ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ (å¯é€‰)</label>
                            <input type="date" id="edit-date-after" value="${sub.date_after || ''}">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ (å¯é€‰)</label>
                            <input type="date" id="edit-date-before" value="${sub.date_before || ''}">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°ç‚¹èµæ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-likes" value="${sub.min_likes || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°æ”¶è—æ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-favorites" value="${sub.min_favorites || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°æ’­æ”¾æ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-views" value="${sub.min_views || ''}" min="0">
                        </div>
                        <div style="margin-top: 1rem;">
                            <button type="button" onclick="updateSubscription(${id})" class="btn btn-primary">ä¿å­˜</button>
                            <button type="button" onclick="window.closeEditModal()" class="btn btn-secondary" style="margin-left: 0.5rem;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
            // è®°å½•æ­£åœ¨ç¼–è¾‘çš„è®¢é˜…ID
            window.__currentEditingSubId = id;
            // é˜»æ­¢å†…å®¹åŒºåŸŸç‚¹å‡»å†’æ³¡
            const contentEl = modal.querySelector('.modal-content');
            if (contentEl) contentEl.addEventListener('click', (e) => e.stopPropagation());
            // ç‚¹å‡»é®ç½©å…³é—­
            modal.addEventListener('click', (e) => { if (e.target === modal) closeEditModal(); });
            // ESC å…³é—­
            window.__editModalEscHandler = function(ev){ if (ev.key === 'Escape') { closeEditModal(); } };
            window.addEventListener('keydown', window.__editModalEscHandler);
        }

        function closeEditModal() {
            try {
                const modal = document.getElementById('subscription-edit-modal');
                if (modal && modal.parentNode) modal.parentNode.removeChild(modal);
            } catch (_) {}
            if (window.__editModalEscHandler) {
                window.removeEventListener('keydown', window.__editModalEscHandler);
                window.__editModalEscHandler = null;
            }
            // æ¸…ç†æ ‡è®°
            window.__currentEditingSubId = null;
        }
        window.closeEditModal = closeEditModal;

        // æ›´æ–°è®¢é˜…
        async function updateSubscription(id) {
            const formData = {
                name: document.getElementById('edit-name').value,
                url: document.getElementById('edit-url').value,
                is_active: document.getElementById('edit-active').value === 'true',
                date_after: document.getElementById('edit-date-after').value || null,
                date_before: document.getElementById('edit-date-before').value || null,
                min_likes: parseInt(document.getElementById('edit-min-likes').value) || null,
                min_favorites: parseInt(document.getElementById('edit-min-favorites').value) || null,
                min_views: parseInt(document.getElementById('edit-min-views').value) || null
            };
            
            // æ ¹æ®è®¢é˜…ç±»å‹æ·»åŠ ç‰¹å®šå­—æ®µ
            const uploaderIdField = document.getElementById('edit-uploader-id');
            if (uploaderIdField) {
                formData.uploader_id = uploaderIdField.value;
            }
            
            const keywordField = document.getElementById('edit-keyword');
            if (keywordField) {
                formData.keyword = keywordField.value;
            }
            
            const result = await apiRequest(`/api/subscriptions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (result.error) {
                alert('æ›´æ–°è®¢é˜…å¤±è´¥: ' + result.error);
            } else {
                alert('è®¢é˜…æ›´æ–°æˆåŠŸ');
                closeEditModal();
                loadSubscriptions();
            }
        }

        // åˆ é™¤è®¢é˜…
        async function deleteSubscription(id) {
            // åˆ›å»ºåˆ é™¤æ¨¡å¼é€‰æ‹©å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%;">
                    <h3 style="margin-top: 0; color: #dc3545;">âš ï¸ åˆ é™¤è®¢é˜…ç¡®è®¤</h3>
                    <p style="margin: 20px 0; line-height: 1.6;">
                        è¯·é€‰æ‹©åˆ é™¤æ¨¡å¼ï¼š
                    </p>
                    <div style="margin: 20px 0;">
                        <label style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="deleteMode" value="keep" checked style="margin-right: 8px;">
                            <strong>ä¿ç•™æœ¬åœ°æ–‡ä»¶</strong> - ä»…åˆ é™¤è®¢é˜…è®°å½•ï¼Œä¿ç•™å·²ä¸‹è½½çš„è§†é¢‘æ–‡ä»¶
                        </label>
                        <label style="display: block; margin: 10px 0; cursor: pointer;">
                            <input type="radio" name="deleteMode" value="remove" style="margin-right: 8px;">
                            <strong style="color: #dc3545;">åˆ é™¤æœ¬åœ°æ–‡ä»¶</strong> - åˆ é™¤è®¢é˜…è®°å½•å’Œæ‰€æœ‰ç›¸å…³çš„æœ¬åœ°æ–‡ä»¶
                        </label>
                    </div>
                    <div style="text-align: right; margin-top: 30px;">
                        <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" 
                                style="margin-right: 10px; padding: 8px 16px; border: 1px solid #ccc; background: white; border-radius: 4px; cursor: pointer;">
                            å–æ¶ˆ
                        </button>
                        <button onclick="confirmDelete(${id}, this)" 
                                style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            ç¡®è®¤åˆ é™¤
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // ç¡®è®¤åˆ é™¤è®¢é˜…
        async function confirmDelete(id, button) {
            const modal = button.closest('div[style*="position: fixed"]');
            const selectedMode = modal.querySelector('input[name="deleteMode"]:checked').value;
            const keepFiles = selectedMode === 'keep';
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            button.disabled = true;
            button.textContent = 'åˆ é™¤ä¸­...';
            
            try {
                const result = await apiRequest(`/api/subscriptions/${id}?keep_files=${keepFiles}&force=true`, { 
                    method: 'DELETE' 
                });
                
                modal.remove();
                
                if (result.error) {
                    alert('åˆ é™¤å¤±è´¥: ' + result.error);
                } else {
                    const message = result.data?.message || 'åˆ é™¤æˆåŠŸ';
                    const details = result.data ? 
                        `\nåˆ é™¤äº† ${result.data.deleted_videos} ä¸ªè§†é¢‘è®°å½•${!keepFiles ? `ï¼Œ${result.data.deleted_files} ä¸ªæœ¬åœ°æ–‡ä»¶` : ''}` : '';
                    alert(message + details);
                    loadSubscriptions();
                }
            } catch (error) {
                modal.remove();
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // â€”â€” è§†é¢‘ç®¡ç†ï¼ˆæ–°ï¼‰ â€”â€”
        let __subStatsCache = [];

        async function loadVideos() {
            // å±•ç¤ºå®¹å™¨
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';

            await loadMediaOverview(false);
            await loadSubscriptionStats();
            await loadDirectoryStats();
        }

        async function loadMediaOverview(scan) {
            const content = document.getElementById('media-overview-content');
            content.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest(`/api/media/overview${scan ? '?scan=true' : ''}`);
            const totalSize = formatBytes(data.total_size || 0);
            const diskInfo = data.scan ? ` | æ–‡ä»¶æ•°: ${data.files_on_disk || 0} | ç£ç›˜å ç”¨: ${formatBytes(data.size_on_disk || 0)} | è·¯å¾„: ${data.download_path || ''}` : '';
            content.innerHTML = `
                <div>æ€»è§†é¢‘: <strong>${data.total_videos || 0}</strong> | å·²ä¸‹è½½: <strong>${data.downloaded_videos || 0}</strong> | æ€»å®¹é‡(æ•°æ®åº“): <strong>${totalSize}</strong> ${diskInfo}</div>
            `;
        }

        // â€”â€” ç³»ç»Ÿç›‘æ§æ¨¡å—å‡½æ•° â€”â€”
        
        // ç³»ç»Ÿå¥åº·çŠ¶æ€
        async function loadSystemHealth() {
            const box = document.getElementById('system-health-content');
            const indicator = document.getElementById('health-indicator');
            if (!box) return;
            
            box.innerHTML = 'æ£€æŸ¥ä¸­...';
            indicator.textContent = 'æ£€æŸ¥ä¸­...';
            indicator.className = 'badge';
            
            try {
                const [healthData, overviewData] = await Promise.all([
                    apiRequest('/health'),
                    apiRequest('/api/overview')
                ]);
                
                const isHealthy = !healthData?.error && !overviewData?.error;
                const queuePaused = overviewData?.queue?.paused?.all || false;
                const recentFails = overviewData?.recent_failed_24h || 0;
                
                // æ›´æ–°å¥åº·æŒ‡ç¤ºå™¨
                if (isHealthy && !queuePaused && recentFails < 5) {
                    indicator.textContent = 'å¥åº·';
                    indicator.className = 'badge badge-success';
                } else if (queuePaused || recentFails >= 5) {
                    indicator.textContent = 'è­¦å‘Š';
                    indicator.className = 'badge badge-warn';
                } else {
                    indicator.textContent = 'å¼‚å¸¸';
                    indicator.className = 'badge badge-danger';
                }
                
                box.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                        <div class="stat-card">
                            <div class="stat-title">APIçŠ¶æ€</div>
                            <div class="stat-number ${isHealthy ? 'ok' : 'warn'}">${isHealthy ? 'æ­£å¸¸' : 'å¼‚å¸¸'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">é˜Ÿåˆ—çŠ¶æ€</div>
                            <div class="stat-number ${queuePaused ? 'warn' : 'ok'}">${queuePaused ? 'æš‚åœä¸­' : 'è¿è¡Œä¸­'}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">24hå¤±è´¥ä»»åŠ¡</div>
                            <div class="stat-number ${recentFails >= 5 ? 'warn' : 'ok'}">${recentFails}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">ç³»ç»Ÿæ—¶é—´</div>
                            <div class="stat-number">${new Date().toLocaleString('zh-CN')}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                indicator.textContent = 'é”™è¯¯';
                indicator.className = 'badge badge-danger';
                box.innerHTML = `<p class="status error">å¥åº·æ£€æŸ¥å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // ä»»åŠ¡æ‰§è¡Œæ¦‚è§ˆ
        async function loadTaskOverview() {
            const box = document.getElementById('task-overview-content');
            if (!box) return;
            
            box.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/overview');
            if (data && data.error) { 
                box.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; 
                return; 
            }
            
            const remote = data.remote_total ?? '-';
            const local = data.local_total ?? '-';
            const pending = data.pending_total ?? (typeof remote==='number' && typeof local==='number' ? Math.max(remote-local,0) : '-');
            const recentFail = data.recent_failed_24h ?? '-';
            // æ–°é²œåº¦ï¼šæ¥è‡ªåç«¯ computed_atï¼ˆæ¦‚è§ˆèšåˆè®¡ç®—æ—¶é—´ï¼‰ï¼ŒTTL=60s
            let freshnessHtml = '';
            if (data.computed_at) {
                try {
                    const t = new Date(data.computed_at);
                    const ageMs = Date.now() - t.getTime();
                    const mins = Math.floor(ageMs / 60000);
                    const expired = ageMs > 60*1000;
                    const label = expired ? 'å·²è¿‡æœŸ' : 'æœ‰æ•ˆ';
                    const ageText = ageMs < 30*1000 ? 'åˆšåˆš' : (mins <= 0 ? 'ä¸åˆ°1åˆ†é’Ÿ' : `${mins} åˆ†é’Ÿå‰`);
                    freshnessHtml = `<div style="margin-bottom:6px; color:#6b7280; font-size:12px;">æ¦‚è§ˆå¿«ç…§ï¼š${ageText} Â· ${label}</div>`;
                } catch (_) {}
            }
            
            box.innerHTML = `
                ${freshnessHtml}
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                    <div class="stat-card">
                        <div class="stat-title">è¿œç«¯æ€»æ•°</div>
                        <div class="stat-number">${remote}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">æœ¬åœ°æ€»æ•°</div>
                        <div class="stat-number">${local}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">å¾…ä¸‹è½½</div>
                        <div class="stat-number ${pending > 0 ? 'warn' : 'ok'}">${pending}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">æœ€è¿‘24hå¤±è´¥</div>
                        <div class="stat-number ${recentFail > 0 ? 'warn' : 'ok'}">${recentFail}</div>
                    </div>
                </div>
            `;
        }
        
        // é˜Ÿåˆ—çŠ¶æ€ç›‘æ§
        async function loadQueueStatus() {
            const box = document.getElementById('queue-status-content');
            const indicator = document.getElementById('queue-status-indicator');
            if (!box) return;
            
            box.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/overview');
            if (data && data.error) { 
                box.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; 
                return; 
            }
            
            const q = data.queue || {};
            const counts = q.counts || {};
            const running = counts.running ?? counts.RUNNING ?? 0;
            const queued = counts.queued ?? counts.QUEUED ?? 0;
            const succeeded = counts.succeeded ?? counts.SUCCEEDED ?? 0;
            const failed = counts.failed ?? counts.FAILED ?? 0;
            const paused = q.paused && (q.paused.all || q.paused.requires_cookie || q.paused.no_cookie);
            
            // æ›´æ–°é˜Ÿåˆ—çŠ¶æ€æŒ‡ç¤ºå™¨
            if (paused) {
                indicator.textContent = 'æš‚åœ';
                indicator.className = 'badge badge-warn';
            } else if (running > 0) {
                indicator.textContent = 'è¿è¡Œä¸­';
                indicator.className = 'badge badge-success';
            } else {
                indicator.textContent = 'ç©ºé—²';
                indicator.className = 'badge';
            }
            
            box.innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap:12px;">
                    <div class="stat-card">
                        <div class="stat-title">è¿è¡Œä¸­</div>
                        <div class="stat-number ${running > 0 ? 'ok' : ''}">${running}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">æ’é˜Ÿä¸­</div>
                        <div class="stat-number ${queued > 10 ? 'warn' : ''}">${queued}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">å·²æˆåŠŸ</div>
                        <div class="stat-number ok">${succeeded}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">å·²å¤±è´¥</div>
                        <div class="stat-number ${failed > 0 ? 'warn' : ''}">${failed}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">æš‚åœçŠ¶æ€</div>
                        <div class="stat-number ${paused ? 'warn' : 'ok'}">${paused ? 'æ˜¯' : 'å¦'}</div>
                    </div>
                </div>
            `;
        }
        
        // ç³»ç»Ÿé…ç½®çŠ¶æ€
        async function loadConfigStatus() {
            const box = document.getElementById('config-status-content');
            if (!box) return;
            
            box.innerHTML = 'æ£€æŸ¥ä¸­...';
            try {
                const data = await apiRequest('/api/settings');
                if (data && data.error) { 
                    box.innerHTML = `<p class="status error">é…ç½®æ£€æŸ¥å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; 
                    return; 
                }
                
                const settings = Array.isArray(data) ? data : [];
                const downloadPath = settings.find(s => s.key === 'DOWNLOAD_PATH')?.value || 'æœªè®¾ç½®';
                const cookieCount = settings.filter(s => s.key.includes('cookie')).length;
                
                box.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:12px;">
                        <div class="stat-card">
                            <div class="stat-title">ä¸‹è½½è·¯å¾„</div>
                            <div class="stat-number" style="font-size:12px; word-break:break-all;">${downloadPath}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">Cookieæ•°é‡</div>
                            <div class="stat-number ${cookieCount > 0 ? 'ok' : 'warn'}">${cookieCount}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">é…ç½®é¡¹æ€»æ•°</div>
                            <div class="stat-number">${settings.length}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                box.innerHTML = `<p class="status error">é…ç½®æ£€æŸ¥å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // æ•°æ®ä¸€è‡´æ€§çŠ¶æ€
        async function loadConsistencyStatus() {
            const box = document.getElementById('consistency-status-content');
            if (!box) return;
            
            box.innerHTML = 'æ£€æŸ¥ä¸­...';
            try {
                const data = await apiRequest('/api/system/consistency-stats');
                if (data && data.error) { 
                    box.innerHTML = `<p class="status error">ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; 
                    return; 
                }
                
                const totalVideos = data.total_videos || 0;
                const withPath = data.with_path || 0;
                const withoutPath = data.without_path || 0;
                const downloadedVideos = data.downloaded_videos || 0;
                
                // è®¡ç®—ä¸€è‡´æ€§æŒ‡æ ‡
                const pathMissing = totalVideos - withPath; // æœ‰è®°å½•ä½†æ— è·¯å¾„çš„è§†é¢‘
                const consistencyRate = totalVideos > 0 ? ((withPath / totalVideos) * 100).toFixed(1) : 100;
                
                box.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                        <div class="stat-card">
                            <div class="stat-title">æ€»è§†é¢‘è®°å½•</div>
                            <div class="stat-number">${totalVideos}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">æœ‰è·¯å¾„è®°å½•</div>
                            <div class="stat-number ok">${withPath}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">ç¼ºå¤±è·¯å¾„</div>
                            <div class="stat-number ${withoutPath > 0 ? 'warn' : 'ok'}">${withoutPath}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">ä¸€è‡´æ€§ç‡</div>
                            <div class="stat-number ${consistencyRate < 95 ? 'warn' : 'ok'}">${consistencyRate}%</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                box.innerHTML = `<p class="status error">ä¸€è‡´æ€§æ£€æŸ¥å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // èµ„æºä½¿ç”¨ç›‘æ§
        async function loadResourceStatus() {
            const box = document.getElementById('resource-status-content');
            if (!box) return;
            
            box.innerHTML = 'æ£€æŸ¥ä¸­...';
            try {
                const data = await apiRequest('/api/media/directories');
                if (data && data.error) { 
                    box.innerHTML = `<p class="status error">èµ„æºæ£€æŸ¥å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; 
                    return; 
                }
                
                const items = data.items || [];
                const totalSize = items.reduce((sum, item) => sum + (item.total_size || 0), 0);
                const totalVideos = items.reduce((sum, item) => sum + (item.total_videos || 0), 0);
                const totalDirs = items.length;
                
                box.innerHTML = `
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                        <div class="stat-card">
                            <div class="stat-title">æ€»å­˜å‚¨ç©ºé—´</div>
                            <div class="stat-number">${formatBytes(totalSize)}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">è§†é¢‘æ–‡ä»¶æ•°</div>
                            <div class="stat-number">${totalVideos}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">ç›®å½•æ•°é‡</div>
                            <div class="stat-number">${totalDirs}</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-title">å¹³å‡æ–‡ä»¶å¤§å°</div>
                            <div class="stat-number">${totalVideos > 0 ? formatBytes(totalSize / totalVideos) : '0 B'}</div>
                        </div>
                    </div>
                `;
            } catch (error) {
                box.innerHTML = `<p class="status error">èµ„æºæ£€æŸ¥å¤±è´¥ï¼š${error.message}</p>`;
            }
        }

        async function loadSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            content.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/media/subscription-stats');
            if (data && data.error) {
                content.innerHTML = `<p class="status error">è®¢é˜…ç»Ÿè®¡è·å–å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                __subStatsCache = [];
                return;
            }
            __subStatsCache = Array.isArray(data) ? data : [];
            renderSubscriptionStats();
        }

        function renderSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            const kw = (document.getElementById('sub-filter').value || '').toLowerCase();
            const list = __subStatsCache.filter(x => !kw || (x.subscription_name || '').toLowerCase().includes(kw));
            const rows = list.map(x => {
                const failedDisplay = x.failed > 0 ? 
                    `<span style="color: #dc3545; font-weight: bold;">${x.failed}</span>` : 
                    `<span style="color: #6c757d;">${x.failed || 0}</span>`;
                
                return `
                <tr>
                    <td>${x.subscription_name || '-'}</td>
                    <td>${x.type || '-'}</td>
                    <td class="num">${x.total_videos}</td>
                    <td class="num">${x.local_total || x.total_videos}</td>
                    <td class="num">${x.downloaded_videos}</td>
                    <td class="num">${x.pending_videos || 0}</td>
                    <td class="num">${failedDisplay}</td>
                    <td class="num">${formatBytes(x.total_size || 0)}</td>
                    <td>${x.latest_upload ? new Date(x.latest_upload).toLocaleString() : '-'}</td>
                    <td>
                        <button class="btn btn-small" onclick="showSubscriptionDetail(${x.subscription_id})">æŸ¥çœ‹è§†é¢‘</button>
                        <button class="btn btn-small" onclick="syncSubscription(${x.subscription_id})" style="margin-left: 4px;">åŒæ­¥</button>
                        ${x.failed > 0 ? `<button class="btn btn-small" onclick="clearFailedVideos(${x.subscription_id})" style="margin-left: 4px; background: #dc3545; color: white;">æ¸…ç†å¤±è´¥</button>` : ''}
                    </td>
                </tr>`;
            }).join('');
            content.innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>è®¢é˜…åç§°</th>
                        <th>ç±»å‹</th>
                        <th>æœ¬åœ°æ–‡ä»¶</th>
                        <th>æ•°æ®åº“è®°å½•</th>
                        <th>å·²ä¸‹è½½</th>
                        <th>å¾…ä¸‹è½½</th>
                        <th>æ— æ³•ä¸‹è½½</th>
                        <th>å®¹é‡</th>
                        <th>æœ€è¿‘ä¸Šä¼ </th>
                        <th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
            `;
        }

        async function syncSubscription(subscriptionId) {
            try {
                const response = await fetch(`/api/subscriptions/${subscriptionId}/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`è®¢é˜…åŒæ­¥æˆåŠŸï¼æ¸…ç†äº† ${result.cleaned_failed_videos} ä¸ªå¤±è´¥è§†é¢‘`);
                    // åˆ·æ–°è®¢é˜…ç»Ÿè®¡æ•°æ®
                    await loadSubscriptionStats();
                } else {
                    const error = await response.json();
                    alert(`åŒæ­¥å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`åŒæ­¥å¤±è´¥: ${error.message}`);
            }
        }

        async function clearFailedVideos(subscriptionId) {
            if (!confirm('ç¡®å®šè¦æ¸…ç†è¯¥è®¢é˜…çš„æ‰€æœ‰å¤±è´¥è§†é¢‘è®°å½•å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/subscriptions/${subscriptionId}/clear-failed`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const result = await response.json();
                    alert(`æˆåŠŸæ¸…ç†äº† ${result.cleared_count} ä¸ªå¤±è´¥è§†é¢‘è®°å½•`);
                    // åˆ·æ–°è®¢é˜…ç»Ÿè®¡æ•°æ®
                    await loadSubscriptionStats();
                } else {
                    const error = await response.json();
                    alert(`æ¸…ç†å¤±è´¥: ${error.detail || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                alert(`æ¸…ç†å¤±è´¥: ${error.message}`);
            }
        }

        async function showSubscriptionDetail(sid, name) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'block';
            document.getElementById('media-sub-detail-title').innerText = `è®¢é˜…æ˜ç»† - ${name || sid}`;
            await loadSubscriptionDetailPage(sid, 1);
        }

        function hideSubscriptionDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';
        }

        async function loadSubscriptionDetailPage(sid, page) {
            const size = 20;
            // 1) è®¢é˜…çº§æŒ‡æ ‡ï¼ˆç»Ÿä¸€å£å¾„ï¼‰ï¼šä»…ä¾èµ–åç«¯ /api/subscriptions åˆ—è¡¨è¿”å›
            let subMetrics = null;
            try {
                const subs = await apiRequest('/api/subscriptions');
                if (Array.isArray(subs)) {
                    subMetrics = subs.find(s => String(s.id) === String(sid)) || null;
                }
            } catch (_) { subMetrics = null; }

            // 2) åŠ è½½è¯¥è®¢é˜…çš„è§†é¢‘æ˜ç»†
            const data = await apiRequest(`/api/media/subscriptions/${sid}/videos?page=${page}&size=${size}&include_disk=true`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td class="num">${formatBytes(v.file_size || 0)}</td>
                    <td>${v.on_disk ? 'åœ¨ç£ç›˜' : 'ç¼ºæ–‡ä»¶'}</td>
                    <td class="mono">${v.video_path || '-'}</td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div class="pager">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page-1})">ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page+1})">ä¸‹ä¸€é¡µ</button>
                </div>`;
            // 3) æ¸²æŸ“è®¢é˜…æŒ‡æ ‡ + æ–°é²œåº¦/TTL æç¤ºï¼ˆ1å°æ—¶ï¼‰
            let metricsHtml = '';
            if (subMetrics) {
                const et = (subMetrics.expected_total ?? null);
                const snapAt = subMetrics.expected_total_snapshot_at || null;
                const cached = !!subMetrics.expected_total_cached;
                const freshness = formatSnapshotFreshness(snapAt, 60); // 60 åˆ†é’Ÿ TTL
                const etDisplay = (typeof et === 'number') ? et : '-';
                const badge = cached ? '<span class="badge">æœ‰æ•ˆ</span>' : '<span class="badge" style="background:#fde68a; color:#92400e; border:1px solid #fcd34d;">å¯èƒ½å·²è¿‡æœŸ</span>';
                metricsHtml = `
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px; color:#374151;">
                  <div>è¿œç«¯æ€»æ•°ï¼š<strong>${etDisplay}</strong></div>
                  <div style="color:#6b7280;">å¿«ç…§ï¼š${freshness.text} Â· ${freshness.valid ? 'æœ‰æ•ˆ' : 'å·²è¿‡æœŸ'}</div>
                  ${badge}
                </div>`;
            }
            document.getElementById('media-sub-detail-content').innerHTML = `
                ${metricsHtml}
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>æ ‡é¢˜</th>
                        <th>BV</th>
                        <th>ä¸Šä¼ æ—¥æœŸ</th>
                        <th class="num">å¤§å°</th>
                        <th>ç£ç›˜</th>
                        <th>è·¯å¾„</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}
            `;
        }

        function formatBytes(bytes) {
            if (!bytes || bytes <= 0) return '0 B';
            const units = ['B','KB','MB','GB','TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + units[i];
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',' ':' ' }[c] || c));
        }

        // ç»Ÿä¸€ï¼šå¿«ç…§æ–°é²œåº¦/TTL æ ¼å¼åŒ–ï¼ˆå•ä½ï¼šåˆ†é’ŸTTLï¼‰
        function formatSnapshotFreshness(isoTime, ttlMinutes) {
            const res = { text: '-', valid: false };
            if (!isoTime) return res;
            try {
                const t = new Date(isoTime);
                const now = new Date();
                const diffMs = now - t;
                const mins = Math.floor(diffMs / 60000);
                let text = 'åˆšåˆš';
                if (mins <= 0) text = 'åˆšåˆš';
                else if (mins < 60) text = `${mins} åˆ†é’Ÿå‰`;
                else {
                    const hours = Math.floor(mins / 60);
                    const remMin = mins % 60;
                    text = remMin ? `${hours} å°æ—¶ ${remMin} åˆ†é’Ÿå‰` : `${hours} å°æ—¶å‰`;
                }
                return { text, valid: mins <= ttlMinutes };
            } catch (_) {
                return res;
            }
        }

        // â€”â€” ç›®å½•ç»Ÿè®¡ä¸æ˜ç»† â€”â€”
        async function loadDirectoryStats() {
            const wrap = document.getElementById('media-dir-stats-content');
            if (!wrap) return;
            wrap.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/media/directories');
            if (data && data.error) {
                wrap.innerHTML = `<p class="status error">ç›®å½•ç»Ÿè®¡è·å–å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                return;
            }
            const items = (data && Array.isArray(data.items)) ? data.items : [];
            if (items.length === 0) { wrap.innerHTML = '<p>æš‚æ— ç›®å½•æ•°æ®</p>'; return; }
            const rows = items.map(d => `
              <tr>
                <td>${escapeHtml(d.display_name || d.dir)}</td>
                <td class="num">${d.total_videos}</td>
                <td class="num">${d.downloaded_videos}</td>
                <td class="num">${formatBytes(d.total_size || 0)}</td>
                <td><button class="btn btn-small" onclick="showDirectoryDetail(${d.subscription_id || 'null'}, '${d.dir.replace(/'/g, "\\'")}')">æŸ¥çœ‹è§†é¢‘</button></td>
              </tr>`).join('');
            wrap.innerHTML = `
              <div class="table-wrap">
                <table class="data">
                  <thead>
                    <tr>
                      <th>ç›®å½•</th>
                      <th class="num">æ€»æ•°</th>
                      <th class="num">å·²ä¸‹è½½</th>
                      <th class="num">å®¹é‡</th>
                      <th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
        }

        async function showDirectoryDetail(sid, dir) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'none';
            document.getElementById('media-dir-stats').style.display = 'none';
            const panel = document.getElementById('media-dir-detail');
            panel.style.display = 'block';
            document.getElementById('media-dir-detail-title').innerText = `ç›®å½•æ˜ç»† - ${dir || (sid ? ('SID ' + sid) : '-')}`;
            await loadDirectoryVideosPage(sid, dir, 1);
        }

        function hideDirectoryDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-dir-stats').style.display = 'block';
            document.getElementById('media-dir-detail').style.display = 'none';
        }

        async function loadDirectoryVideosPage(sid, dir, page) {
            const size = 20;
            const q = sid ? `sid=${sid}` : `dir=${encodeURIComponent(dir)}`;
            const data = await apiRequest(`/api/media/directory-videos?${q}&page=${page}&size=${size}`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td class="num">${formatBytes(v.file_size || 0)}</td>
                    <td class="mono">${v.video_path || '-'}</td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div class="pager">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page-1})">ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page+1})">ä¸‹ä¸€é¡µ</button>
                </div>`;
            document.getElementById('media-dir-detail-content').innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>æ ‡é¢˜</th>
                        <th>BV</th>
                        <th>ä¸Šä¼ æ—¥æœŸ</th>
                        <th class="num">å¤§å°</th>
                        <th>è·¯å¾„</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}`;
        }

        // åŠ è½½Cookieåˆ—è¡¨
        async function loadCookies() {
            const data = await apiRequest('/api/cookies');
            const html = data.map(cookie => `
                <div class="list-item">
                    <div>
                        <strong>${cookie.name}</strong>
                        <br><small>ä½¿ç”¨æ¬¡æ•°: ${cookie.usage_count} | çŠ¶æ€: ${cookie.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleCookieActive(${cookie.id}, ${cookie.is_active})">${cookie.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn" onclick="validateCookie(${cookie.id})">éªŒè¯</button>
                        <button class="btn" onclick="deleteCookie(${cookie.id})" style="background:#dc3545;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cookie-list').innerHTML = html || '<p>æš‚æ— Cookie</p>';
        }

        // æ˜¾ç¤º/éšè—æ·»åŠ Cookieè¡¨å•
        function showAddCookie() {
            document.getElementById('add-cookie').style.display = 'block';
        }
        function hideAddCookie() {
            document.getElementById('add-cookie').style.display = 'none';
        }

        // æ·»åŠ Cookie
        async function addCookie() {
            const name = document.getElementById('cookie-name').value;
            const sessdata = document.getElementById('cookie-sessdata').value;
            const bili_jct = document.getElementById('cookie-jct').value;
            const dedeuserid = document.getElementById('cookie-userid').value;
            
            if (!name || !sessdata) {
                alert('è¯·è¾“å…¥Cookieåç§°å’ŒSESSDATA');
                return;
            }
            
            const data = { name, sessdata, bili_jct, dedeuserid };
            const result = await apiRequest('/api/cookies', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('æ·»åŠ å¤±è´¥: ' + result.error);
            } else {
                alert('æ·»åŠ æˆåŠŸ');
                hideAddCookie();
                loadCookies();
            }
        }

        // éªŒè¯Cookie
        async function validateCookie(id) {
            const result = await apiRequest(`/api/cookies/${id}/validate`, { method: 'POST' });
            alert(result.valid ? 'Cookieæœ‰æ•ˆ' : 'Cookieæ— æ•ˆ');
            loadCookies();
        }

        // æ‰¹é‡éªŒè¯Cookie
        async function validateAllCookies() {
            const triggers = document.querySelectorAll('button[onclick="validateAllCookies()"]');
            triggers.forEach(b => b.disabled = true);
            try {
                const list = await apiRequest('/api/cookies');
                const cookies = Array.isArray(list) ? list : [];
                if (cookies.length === 0) {
                    alert('æš‚æ— å¯éªŒè¯çš„Cookie');
                    return;
                }
                let ok = 0, fail = 0;
                for (const c of cookies) {
                    try {
                        const res = await apiRequest(`/api/cookies/${c.id}/validate`, { method: 'POST' });
                        if (res && res.valid) ok++; else fail++;
                    } catch (_) { fail++; }
                }
                alert(`éªŒè¯å®Œæˆï¼šæœ‰æ•ˆ ${ok}ï¼Œæ— æ•ˆ ${fail}`);
            } catch (e) {
                alert('æ‰¹é‡éªŒè¯å¤±è´¥: ' + (e?.message || e));
            } finally {
                triggers.forEach(b => b.disabled = false);
                loadCookies();
            }
        }

        // å¯ç”¨/ç¦ç”¨ Cookie
        async function toggleCookieActive(id, current) {
            const payload = { is_active: !current };
            const result = await apiRequest(`/api/cookies/${id}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
            if (result && result.error) {
                alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
            } else {
                loadCookies();
            }
        }

        // åˆ é™¤Cookie
        async function deleteCookie(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªCookieå—ï¼Ÿ')) return;
            
            const result = await apiRequest(`/api/cookies/${id}`, { method: 'DELETE' });
            if (result.error) {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            } else {
                alert('åˆ é™¤æˆåŠŸ');
                loadCookies();
            }
        }

        // åŠ è½½åŸºç¡€é…ç½®
        async function loadBasicSettings() {
            const content = document.getElementById('basic-settings-content');
            if (!content) return;
            
            content.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const data = await apiRequest('/api/settings');
                if (data && data.error) {
                    content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                    return;
                }
                
                // åŸºç¡€é…ç½®é¡¹
                const basicKeys = ['download_path', 'video_quality', 'max_concurrent_downloads'];
                const basicSettings = {};
                basicKeys.forEach(key => {
                    if (data[key] !== undefined) {
                        // å¤„ç†æ–°çš„APIæ•°æ®æ ¼å¼ {value: "...", description: "..."}
                        const setting = data[key];
                        basicSettings[key] = typeof setting === 'object' && setting.value !== undefined ? setting.value : setting;
                    }
                });
                
                if (Object.keys(basicSettings).length === 0) {
                    content.innerHTML = '<p class="status">æš‚æ— åŸºç¡€é…ç½®é¡¹</p>';
                    return;
                }
                
                let html = '<div style="display:grid; gap:12px;">';
                for (const [key, value] of Object.entries(basicSettings)) {
                    const displayName = {
                        'download_path': 'ä¸‹è½½è·¯å¾„',
                        'video_quality': 'è§†é¢‘è´¨é‡',
                        'max_concurrent_downloads': 'æœ€å¤§å¹¶å‘ä¸‹è½½æ•°'
                    }[key] || key;
                    
                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid #e5e7eb; border-radius:6px;">
                            <div>
                                <div style="font-weight:600; color:#374151;">${escapeHtml(displayName)}</div>
                                <div style="font-size:12px; color:#6b7280;">${escapeHtml(key)}</div>
                            </div>
                            <div style="font-family:monospace; color:#059669; background:#ecfdf5; padding:4px 8px; border-radius:4px;">${escapeHtml(String(value))}</div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // åŠ è½½ä¸‹è½½é…ç½®
        async function loadDownloadSettings() {
            const content = document.getElementById('download-settings-content');
            if (!content) return;
            
            content.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const data = await apiRequest('/api/settings');
                if (data && data.error) {
                    content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                    return;
                }
                
                // ä¸‹è½½ç›¸å…³é…ç½®é¡¹
                const downloadKeys = ['video_quality', 'audio_quality', 'download_format', 'retry_count'];
                const downloadSettings = {};
                downloadKeys.forEach(key => {
                    if (data[key] !== undefined) {
                        // å¤„ç†æ–°çš„APIæ•°æ®æ ¼å¼ {value: "...", description: "..."}
                        const setting = data[key];
                        downloadSettings[key] = typeof setting === 'object' && setting.value !== undefined ? setting.value : setting;
                    }
                });
                
                if (Object.keys(downloadSettings).length === 0) {
                    content.innerHTML = '<p class="status">æš‚æ— ä¸‹è½½é…ç½®é¡¹</p>';
                    return;
                }
                
                let html = '<div style="display:grid; gap:12px;">';
                for (const [key, value] of Object.entries(downloadSettings)) {
                    const displayName = {
                        'video_quality': 'è§†é¢‘è´¨é‡',
                        'audio_quality': 'éŸ³é¢‘è´¨é‡', 
                        'download_format': 'ä¸‹è½½æ ¼å¼',
                        'retry_count': 'é‡è¯•æ¬¡æ•°'
                    }[key] || key;
                    
                    html += `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; border:1px solid #e5e7eb; border-radius:6px;">
                            <div>
                                <div style="font-weight:600; color:#374151;">${escapeHtml(displayName)}</div>
                                <div style="font-size:12px; color:#6b7280;">${escapeHtml(key)}</div>
                            </div>
                            <div style="font-family:monospace; color:#059669; background:#ecfdf5; padding:4px 8px; border-radius:4px;">${escapeHtml(String(value))}</div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // åŠ è½½åŒæ­¥çŠ¶æ€
        async function loadSyncStatus() {
            const content = document.getElementById('sync-status-content');
            if (!content) return;
            
            content.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const data = await apiRequest('/api/settings');
                if (data && data.error) {
                    content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                    return;
                }
                
                // åŒæ­¥çŠ¶æ€ç›¸å…³é…ç½®é¡¹
                const syncKeys = Object.keys(data).filter(key => key.startsWith('sync:'));
                
                if (syncKeys.length === 0) {
                    content.innerHTML = '<p class="status">æš‚æ— åŒæ­¥çŠ¶æ€æ•°æ®</p>';
                    return;
                }
                
                // æŒ‰è®¢é˜…IDåˆ†ç»„
                const syncBySubscription = {};
                syncKeys.forEach(key => {
                    const parts = key.split(':');
                    if (parts.length >= 2) {
                        const subId = parts[1];
                        const type = parts.slice(2).join(':');
                        if (!syncBySubscription[subId]) {
                            syncBySubscription[subId] = {};
                        }
                        // å¤„ç†æ–°çš„APIæ•°æ®æ ¼å¼
                        const setting = data[key];
                        const actualValue = typeof setting === 'object' && setting.value !== undefined ? setting.value : setting;
                        syncBySubscription[subId][type] = actualValue;
                    }
                });
                
                let html = '<div style="display:grid; gap:16px;">';
                for (const [subId, syncData] of Object.entries(syncBySubscription)) {
                    html += `
                        <div style="border:1px solid #e5e7eb; border-radius:8px; padding:16px;">
                            <h4 style="margin:0 0 12px 0; color:#374151;">è®¢é˜… ${escapeHtml(subId)}</h4>
                            <div style="display:grid; gap:8px;">
                    `;
                    
                    for (const [type, value] of Object.entries(syncData)) {
                        const displayName = {
                            'status': 'åŒæ­¥çŠ¶æ€',
                            'remote_total_cached': 'è¿œç«¯æ€»æ•°',
                            'last_cursor': 'æœ€åæ¸¸æ ‡',
                            'head_snapshot': 'å¤´éƒ¨å¿«ç…§',
                            'trace': 'æ‰§è¡Œè½¨è¿¹'
                        }[type] || type;
                        
                        let displayValue;
                        const actualValue = value;
                        
                        if (typeof actualValue === 'object') {
                            try {
                                displayValue = JSON.stringify(actualValue, null, 2);
                            } catch (e) {
                                displayValue = '[å¤æ‚å¯¹è±¡]';
                            }
                        } else {
                            displayValue = String(actualValue);
                        }
                        
                        if (displayValue.length > 100) {
                            displayValue = displayValue.substring(0, 100) + '...';
                        }
                        
                        html += `
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; padding:8px; background:#f9fafb; border-radius:4px;">
                                <div style="font-weight:500; color:#374151; min-width:120px;">${escapeHtml(displayName)}</div>
                                <div style="font-family:monospace; font-size:12px; color:#6b7280; text-align:right; word-break:break-all;">${escapeHtml(displayValue)}</div>
                            </div>
                        `;
                    }
                    
                    html += `
                            </div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // åŠ è½½é«˜çº§è®¾ç½®
        async function loadAdvancedSettings() {
            const content = document.getElementById('advanced-settings-content');
            if (!content) return;
            
            content.innerHTML = 'åŠ è½½ä¸­...';
            try {
                const data = await apiRequest('/api/settings');
                if (data && data.error) {
                    content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                    return;
                }
                
                if (!data || Object.keys(data).length === 0) {
                    content.innerHTML = '<p class="status">æš‚æ— è®¾ç½®é¡¹</p>';
                    return;
                }
                
                let html = '<div style="display:grid; gap:8px;">';
                for (const [key, setting] of Object.entries(data)) {
                    let displayValue;
                    let description = '';
                    
                    // å¤„ç†æ–°çš„APIæ•°æ®æ ¼å¼
                    if (typeof setting === 'object' && setting.value !== undefined) {
                        const actualValue = setting.value;
                        description = setting.description || '';
                        
                        // å¤„ç†æ˜¾ç¤ºå€¼
                        if (typeof actualValue === 'string') {
                            // å°è¯•è§£æJSONå­—ç¬¦ä¸²
                            try {
                                const parsed = JSON.parse(actualValue);
                                displayValue = JSON.stringify(parsed, null, 2);
                            } catch {
                                // ä¸æ˜¯JSONï¼Œç›´æ¥æ˜¾ç¤ºå­—ç¬¦ä¸²
                                displayValue = actualValue;
                            }
                        } else if (typeof actualValue === 'object' && actualValue !== null) {
                            try {
                                displayValue = JSON.stringify(actualValue, null, 2);
                            } catch (e) {
                                displayValue = '[å¤æ‚å¯¹è±¡]';
                            }
                        } else {
                            displayValue = String(actualValue);
                        }
                    } else {
                        displayValue = String(setting);
                    }
                    
                    if (displayValue.length > 300) {
                        displayValue = displayValue.substring(0, 300) + '...';
                    }
                    
                    html += `
                        <div style="padding:12px; border:1px solid #e5e7eb; border-radius:6px; background:#f9fafb;">
                            <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:8px;">
                                <div style="font-weight:600; color:#374151;">${escapeHtml(key)}</div>
                                ${description ? `<div style="font-size:11px; color:#9ca3af; max-width:200px; text-align:right;">${escapeHtml(description)}</div>` : ''}
                            </div>
                            <div style="font-family:monospace; font-size:12px; color:#6b7280; word-break:break-all; white-space:pre-wrap; background:#f3f4f6; padding:8px; border-radius:4px; max-height:150px; overflow-y:auto;">${escapeHtml(displayValue)}</div>
                        </div>
                    `;
                }
                html += '</div>';
                content.innerHTML = html;
            } catch (error) {
                content.innerHTML = `<p class="status error">åŠ è½½å¤±è´¥ï¼š${error.message}</p>`;
            }
        }
        
        // æ¸…ç†åŒæ­¥ç¼“å­˜
        async function clearSyncCache() {
            if (!confirm('ç¡®å®šè¦æ¸…ç†æ‰€æœ‰åŒæ­¥ç¼“å­˜å—ï¼Ÿè¿™å°†é‡ç½®æ‰€æœ‰è®¢é˜…çš„åŒæ­¥çŠ¶æ€ã€‚')) {
                return;
            }
            
            try {
                const response = await fetch('/api/sync/clear-cache', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('åŒæ­¥ç¼“å­˜å·²æ¸…ç†');
                    loadSyncStatus(); // åˆ·æ–°çŠ¶æ€
                } else if (response.status === 404) {
                    alert('æ¸…ç†ç¼“å­˜åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥åç«¯APIå®ç°');
                } else {
                    alert('æ¸…ç†å¤±è´¥ï¼š' + response.statusText);
                }
            } catch (error) {
                alert('æ¸…ç†å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // è§¦å‘å®¹é‡å›å¡«
        async function triggerRefreshSizes() {
            try {
                const response = await fetch('/api/media/refresh-sizes', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('å®¹é‡å›å¡«ä»»åŠ¡å·²å¯åŠ¨');
                    checkRefreshSizesStatus(); // æ£€æŸ¥çŠ¶æ€
                } else if (response.status === 404) {
                    alert('å®¹é‡å›å¡«åŠŸèƒ½æš‚ä¸å¯ç”¨ï¼Œè¯·æ£€æŸ¥åç«¯APIå®ç°');
                } else {
                    alert('å¯åŠ¨å¤±è´¥ï¼š' + response.statusText);
                }
            } catch (error) {
                alert('å¯åŠ¨å¤±è´¥ï¼š' + error.message);
            }
        }
        
        // æ£€æŸ¥å®¹é‡å›å¡«çŠ¶æ€
        async function checkRefreshSizesStatus() {
            const statusDiv = document.getElementById('refresh-sizes-status');
            if (!statusDiv) return;
            
            statusDiv.innerHTML = `
                <div class="status info">
                    å®¹é‡å›å¡«ä»»åŠ¡åœ¨åå°è¿è¡Œä¸­<br>
                    <small style="color:#6b7280;">ä»»åŠ¡ä¼šæ‰«ææ‰€æœ‰æœ‰è·¯å¾„çš„è§†é¢‘è®°å½•ï¼Œå›å¡«æ–‡ä»¶å¤§å°ä¿¡æ¯</small>
                </div>
            `;
        }
        
        // åŠ è½½ç»´æŠ¤çŠ¶æ€
        async function loadMaintenanceStatus() {
            // åŒæ—¶åŠ è½½ä¸€è‡´æ€§æ£€æŸ¥å’Œå®¹é‡å›å¡«çŠ¶æ€
            loadConsistencyStats();
            checkRefreshSizesStatus();
        }

        // æ›´æ–°è®¾ç½®
        async function updateSetting(key, value) {
            const result = await apiRequest(`/api/settings/${key}`, {
                method: 'PUT',
                body: JSON.stringify({ value: String(value) })
            });
            
            if (result.error) {
                alert('æ›´æ–°å¤±è´¥: ' + result.error);
            }
        }

        // é˜Ÿåˆ—ç®¡ç†ç›¸å…³å‡½æ•°
        let queuePollingTimer = null;

        function formatTime(s) {
            if (!s) return '';
            try { return new Date(s).toLocaleString(); } catch { return s; }
        }

        function setPausedBadge(s) {
            const el = document.getElementById('badge-paused');
            if (!el || !s || !s.paused) return;
            const anyPaused = !!(s.paused.all || s.paused.requires_cookie || s.paused.no_cookie);
            el.textContent = anyPaused ? 'å·²æš‚åœ' : 'è¿è¡Œä¸­';
            el.className = 'badge ' + (anyPaused ? 'badge-danger' : 'badge-success');
        }

        function renderCapCards(s) {
            const root = document.getElementById('cap-cards');
            if (!root) return;
            const cc = (s && s.capacity) || {};
            const cb = (s && s.counts && s.counts_by_channel) ? s.counts_by_channel : (s && s.counts_by_channel) || {};
            const queuedCookie = typeof cb.queued_cookie === 'number' ? cb.queued_cookie : '-';
            const queuedNoCookie = typeof cb.queued_nocookie === 'number' ? cb.queued_nocookie : '-';
            const blocks = [
                { title: 'éœ€è¦Cookie', cfg: cc.requires_cookie, run: cc.running_cookie, avail: (cc.available_cookie ?? (cc.requires_cookie - cc.running_cookie)), queued: queuedCookie },
                { title: 'æ— éœ€Cookie', cfg: cc.no_cookie, run: cc.running_nocookie, avail: (cc.available_nocookie ?? (cc.no_cookie - cc.running_nocookie)), queued: queuedNoCookie },
            ];
            root.innerHTML = blocks.map(b => `
                <div class="stat-card">
                    <div class="stat-title">${b.title}</div>
                    <div class="stat-row"><span class="stat-label">é…ç½®</span><span class="stat-number">${b.cfg ?? '-'}</span></div>
                    <div class="stat-row"><span class="stat-label">è¿è¡Œ</span><span class="stat-number">${b.run ?? '-'}</span></div>
                    <div class="stat-row"><span class="stat-label">å¯ç”¨</span><span class="stat-number ${Number(b.avail) > 0 ? 'ok' : 'warn'}">${(b.avail ?? '-')}</span></div>
                    <div class="stat-row"><span class="stat-label">æ’é˜Ÿ</span><span class="stat-number">${b.queued}</span></div>
                </div>
            `).join('');
        }

        async function loadQueueStats() {
            try {
                const s = await apiRequest('/api/queue/stats');
                setPausedBadge(s);
                renderCapCards(s);
                document.getElementById('stats').textContent = JSON.stringify(s, null, 2);
                if (s && s.capacity) {
                    if (typeof s.capacity.requires_cookie === 'number') document.getElementById('cap-cookie').value = s.capacity.requires_cookie;
                    if (typeof s.capacity.no_cookie === 'number') document.getElementById('cap-nocookie').value = s.capacity.no_cookie;
                }
            } catch (e) {
                document.getElementById('stats').textContent = 'åŠ è½½å¤±è´¥: ' + e.message;
            }
        }

        function statusClass(s) {
            return 'status ' + (s||'').toLowerCase();
        }

        async function loadQueueRequests() {
            try {
                const data = await apiRequest('/api/requests');
                const items = data.items || data || [];
                const tbody = document.getElementById('queue-tbody');
                tbody.innerHTML = '';
                for (const it of items) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-family: monospace; font-size: 11px; color: #666;">${it.id}</td>
                        <td>${it.type || ''}</td>
                        <td>${it.subscription_id ?? ''}</td>
                        <td>${it.requires_cookie ? 'æ˜¯' : 'å¦'}</td>
                        <td><span class="${statusClass(it.status)}">${it.status}</span></td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.created_at)}</td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.started_at)}</td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.finished_at)}</td>
                        <td style="font-size: 12px; color: #666;">${it.last_error || ''}</td>
                    `;
                    tbody.appendChild(tr);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function loadQueueData() {
            loadQueueStats();
            loadQueueRequests();
            // å¯åŠ¨é˜Ÿåˆ—è½®è¯¢
            if (queuePollingTimer) clearInterval(queuePollingTimer);
            queuePollingTimer = setInterval(() => {
                loadQueueStats();
                loadQueueRequests();
            }, 2000);
        }

        function stopQueuePolling() {
            if (queuePollingTimer) {
                clearInterval(queuePollingTimer);
                queuePollingTimer = null;
            }
        }

        // â€”â€” é˜Ÿåˆ—è¯Šæ–­ï¼ˆ/api/queue/insightsï¼‰ â€”â€”
        function showQueueInsights() {
            const modal = document.getElementById('queue-insights-modal');
            if (!modal) return;
            modal.style.display = 'block';
            loadQueueInsights();
        }

        function hideQueueInsights() {
            const modal = document.getElementById('queue-insights-modal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        async function loadQueueInsights() {
            const content = document.getElementById('queue-insights-content');
            const meta = document.getElementById('insights-meta');
            if (!content) return;
            content.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/queue/insights');
            if (data && data.error) { content.innerHTML = `<p class=\"status error\">åŠ è½½å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`; return; }
            try { meta.textContent = `å¤±è´¥æ ·æœ¬ ${Array.isArray(data.failed_samples)?data.failed_samples.length:0}`; } catch { /* noop */ }
            content.innerHTML = renderInsightsHtml(data);
        }

        function renderInsightsHtml(d) {
            const wr = d && d.wait_reasons || {};
            const et = d && d.errors_top || [];
            const fs = d && d.failed_samples || [];
            const paused = d && d.paused || {};
            const cap = d && d.capacity || {};
            const counts = d && d.counts || {};
            const waitRows = Object.entries(wr).map(([k,v]) => `<tr><td>${escapeHtml(k)}</td><td class=\"num\">${v}</td></tr>`).join('');
            const errRows = et.map(x => `<tr><td class=\"mono\" style=\"max-width:260px; overflow:hidden; text-overflow:ellipsis;\" title=\"${escapeHtml(x.message || '')}\">${escapeHtml(x.message || '')}</td><td class=\"num\">${x.count || 0}</td></tr>`).join('');
            const failRows = fs.map(x => `<tr><td class=\"mono\" style=\"max-width:120px;\">${escapeHtml(x.id || '')}</td><td>${escapeHtml(x.type || '')}</td><td>${x.subscription_id ?? ''}</td><td class=\"mono\" title=\"${escapeHtml(x.last_error || '')}\" style=\"max-width:240px; overflow:hidden; text-overflow:ellipsis;\">${escapeHtml(x.last_error || '')}</td><td>${x.finished_at ? new Date(x.finished_at).toLocaleString() : '-'}</td></tr>`).join('');
            return `
                <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;\">
                    <div class=\"stat-card\"><div class=\"stat-title\">è¿è¡Œ</div><div class=\"stat-number\">${counts.running ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">æ’é˜Ÿ</div><div class=\"stat-number\">${counts.queued ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">æˆåŠŸ</div><div class=\"stat-number\">${counts.succeeded ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">å¤±è´¥</div><div class=\"stat-number\">${counts.failed ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">æš‚åœ</div><div class=\"stat-number\">${(paused.all || paused.requires_cookie || paused.no_cookie) ? 'æ˜¯' : 'å¦'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">å¹¶å‘(éœ€Cookie/æ— éœ€)</div><div class=\"stat-number\">${cap.requires_cookie ?? '-'} / ${cap.no_cookie ?? '-'}</div></div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>ç­‰å¾…åŸå› åˆ†å¸ƒ</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>åŸå› </th><th class=\"num\">æ•°é‡</th></tr></thead><tbody>${waitRows || '<tr><td colspan=2>æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
                    </div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>é”™è¯¯Top</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>é”™è¯¯</th><th class=\"num\">æ¬¡æ•°</th></tr></thead><tbody>${errRows || '<tr><td colspan=2>æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
                    </div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>å¤±è´¥æ ·æœ¬</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>job_id</th><th>ç±»å‹</th><th>è®¢é˜…</th><th>é”™è¯¯</th><th>ç»“æŸæ—¶é—´</th></tr></thead><tbody>${failRows || '<tr><td colspan=5>æš‚æ— æ•°æ®</td></tr>'}</tbody></table>
                    </div>
                </div>
            `;
        }

        // é˜Ÿåˆ—ç®¡ç†äº‹ä»¶ç»‘å®š
        document.addEventListener('DOMContentLoaded', function() {
            // é˜Ÿåˆ—æ§åˆ¶æŒ‰é’®äº‹ä»¶
            const btnRefresh = document.getElementById('btn-refresh');
            if (btnRefresh) {
                btnRefresh.onclick = () => { loadQueueStats(); loadQueueRequests(); };
            }

            const btnPause = document.getElementById('btn-pause');
            if (btnPause) {
                btnPause.onclick = async () => {
                    const scope = document.getElementById('pause-scope').value;
                    await apiRequest('/api/queue/pause', { method: 'POST', body: JSON.stringify({ scope }) });
                    await loadQueueStats();
                };
            }

            const btnResume = document.getElementById('btn-resume');
            if (btnResume) {
                btnResume.onclick = async () => {
                    const scope = document.getElementById('pause-scope').value;
                    await apiRequest('/api/queue/resume', { method: 'POST', body: JSON.stringify({ scope }) });
                    await loadQueueStats();
                };
            }

            const btnApplyCap = document.getElementById('btn-apply-cap');
            if (btnApplyCap) {
                btnApplyCap.onclick = async () => {
                    const requires_cookie = document.getElementById('cap-cookie').value;
                    const no_cookie = document.getElementById('cap-nocookie').value;
                    await apiRequest('/api/queue/capacity', { 
                        method: 'POST', 
                        body: JSON.stringify({ requires_cookie: parseInt(requires_cookie), no_cookie: parseInt(no_cookie) })
                    });
                    await loadQueueStats();
                };
            }

            const btnCancel = document.getElementById('btn-cancel');
            if (btnCancel) {
                btnCancel.onclick = async () => {
                    const id = document.getElementById('job-id').value.trim();
                    if (!id) return alert('è¯·è¾“å…¥ job_id');
                    await apiRequest(`/api/requests/${encodeURIComponent(id)}/cancel`, { method: 'POST' });
                    await loadQueueStats();
                    await loadQueueRequests();
                };
            }

            const btnPrio = document.getElementById('btn-prio');
            if (btnPrio) {
                btnPrio.onclick = async () => {
                    const id = document.getElementById('job-id').value.trim();
                    if (!id) return alert('è¯·è¾“å…¥ job_id');
                    await apiRequest(`/api/requests/${encodeURIComponent(id)}/prioritize`, { 
                        method: 'POST', 
                        body: JSON.stringify({ priority: 0 })
                    });
                    await loadQueueRequests();
                };
            }

            // ä¸€è‡´æ€§æ£€æŸ¥ç›¸å…³å‡½æ•°
            window.triggerConsistencyCheck = async function() {
                const btn = document.getElementById('btn-consistency-check');
                const originalText = btn.textContent;
                
                try {
                    btn.textContent = 'æ£€æŸ¥ä¸­...';
                    btn.disabled = true;
                    
                    const result = await apiRequest('/api/system/consistency-check', 'POST');
                    
                    // æ˜¾ç¤ºæ£€æŸ¥ç»“æœ
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `
                        <div class="status success">ä¸€è‡´æ€§æ£€æŸ¥å®Œæˆ</div>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="stat-item">
                                <strong>æ•°æ®åº“è®°å½•æ•°:</strong> ${result.total_db_records || 0}
                            </div>
                            <div class="stat-item">
                                <strong>æœ¬åœ°æ–‡ä»¶æ•°:</strong> ${result.files_found || 0}
                            </div>
                            <div class="stat-item">
                                <strong>ç¼ºå¤±æ–‡ä»¶æ•°:</strong> ${result.files_missing || 0}
                            </div>
                            <div class="stat-item">
                                <strong>æ›´æ–°è®°å½•æ•°:</strong> ${result.records_updated || 0}
                            </div>
                            <div class="stat-item">
                                <strong>æ¸…ç†è®°å½•æ•°:</strong> ${result.records_cleaned || 0}
                            </div>
                            <div class="stat-item">
                                <strong>å­¤ç«‹æ–‡ä»¶æ•°:</strong> ${result.orphan_files || 0}
                            </div>
                            <div class="stat-item">
                                <strong>å¯¼å…¥è§†é¢‘æ•°:</strong> ${result.imported_videos || 0}
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `<div class="status error">æ£€æŸ¥å¤±è´¥: ${error.message}</div>`;
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            };
            
            window.loadConsistencyStats = async function() {
                try {
                    const result = await apiRequest('/api/system/consistency-stats');
                    
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `
                        <div class="status">å½“å‰ä¸€è‡´æ€§çŠ¶æ€</div>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="stat-item">
                                <strong>æ€»è§†é¢‘æ•°:</strong> ${result.total_videos || 0}
                            </div>
                            <div class="stat-item">
                                <strong>å·²ä¸‹è½½æ•°:</strong> ${result.downloaded_videos || 0}
                            </div>
                            <div class="stat-item">
                                <strong>æœ‰è·¯å¾„è®°å½•:</strong> ${result.with_path || 0}
                            </div>
                            <div class="stat-item">
                                <strong>æ— è·¯å¾„è®°å½•:</strong> ${result.without_path || 0}
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
                            æœ€åæ£€æŸ¥æ—¶é—´: ${result.last_check_time || 'æœªçŸ¥'}
                        </div>
                    `;
                    
                } catch (error) {
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `<div class="status error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
                }
            };

            loadTabData('dashboard');
        });

        // STRMç®¡ç†ç›¸å…³å‡½æ•°
        async function loadStrmOverview() {
            try {
                // åŠ è½½STRMç»Ÿè®¡æ•°æ®
                const [streamStats, fileStats, healthStatus] = await Promise.all([
                    apiRequest('/api/strm/stats/streams'),
                    apiRequest('/api/strm/stats/files'),
                    apiRequest('/api/strm/health')
                ]);

                // æ›´æ–°ç»Ÿè®¡æ•°æ®
                if (streamStats && !streamStats.error) {
                    document.getElementById('strm-active-streams').textContent = streamStats.data?.active_streams || 0;
                }

                if (fileStats && !fileStats.error) {
                    document.getElementById('strm-files-count').textContent = fileStats.data?.total_strm_files || 0;
                    // è®¡ç®—èŠ‚çœçš„ç©ºé—´ï¼ˆå‡è®¾æ¯ä¸ªè§†é¢‘500MBï¼ŒSTRMæ–‡ä»¶50KBï¼‰
                    const strmFiles = fileStats.data?.total_strm_files || 0;
                    const savedGB = Math.round((strmFiles * 500) / 1024 * 100) / 100;
                    document.getElementById('strm-space-saved').textContent = savedGB > 0 ? `${savedGB}GB` : '-';
                }

                // æ›´æ–°ç³»ç»ŸçŠ¶æ€
                updateStrmSystemStatus(healthStatus);

                // åŠ è½½STRMè®¢é˜…æ•°é‡
                const subscriptions = await apiRequest('/api/subscriptions');
                if (subscriptions && !subscriptions.error) {
                    const strmCount = subscriptions.filter(sub => sub.download_mode === 'STRM').length;
                    document.getElementById('strm-subscriptions-count').textContent = strmCount;
                }

            } catch (error) {
                console.error('åŠ è½½STRMæ¦‚è§ˆæ•°æ®å¤±è´¥:', error);
            }
        }

        function updateStrmSystemStatus(healthData) {
            if (!healthData || healthData.error) {
                document.getElementById('strm-proxy-status').className = 'badge badge-danger';
                document.getElementById('strm-proxy-status').textContent = 'å¼‚å¸¸';
                document.getElementById('strm-file-status').className = 'badge badge-danger';
                document.getElementById('strm-file-status').textContent = 'å¼‚å¸¸';
                document.getElementById('strm-ffmpeg-status').className = 'badge badge-danger';
                document.getElementById('strm-ffmpeg-status').textContent = 'ä¸å¯ç”¨';
                return;
            }

            const data = healthData.data || {};
            
            // ä»£ç†æœåŠ¡çŠ¶æ€
            const proxyStatus = data.proxy_service?.status === 'healthy' ? 'success' : 'danger';
            const proxyText = proxyStatus === 'success' ? 'è¿è¡Œæ­£å¸¸' : 'å¼‚å¸¸';
            document.getElementById('strm-proxy-status').className = `badge badge-${proxyStatus}`;
            document.getElementById('strm-proxy-status').textContent = proxyText;

            // æ–‡ä»¶ç®¡ç†çŠ¶æ€
            const fileStatus = data.file_manager?.status === 'healthy' ? 'success' : 'danger';
            const fileText = fileStatus === 'success' ? 'è¿è¡Œæ­£å¸¸' : 'å¼‚å¸¸';
            document.getElementById('strm-file-status').className = `badge badge-${fileStatus}`;
            document.getElementById('strm-file-status').textContent = fileText;

            // FFmpegçŠ¶æ€ï¼ˆå‡è®¾å¯ç”¨ï¼‰
            document.getElementById('strm-ffmpeg-status').className = 'badge badge-success';
            document.getElementById('strm-ffmpeg-status').textContent = 'å¯ç”¨';
        }

        function openStrmManagement() {
            // åœ¨æ–°çª—å£ä¸­æ‰“å¼€STRMç®¡ç†ç•Œé¢
            window.open('/static/strm_management.html', '_blank', 'width=1200,height=800');
        }
    </script>
</body>
</html>

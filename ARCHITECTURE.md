# bili_curator V7 æ¶æ„æ¦‚è§ˆ

## ğŸ—ï¸ æ•´ä½“æ¶æ„

bili_curator é‡‡ç”¨ç°ä»£åŒ–å¾®æœåŠ¡æ¶æ„ï¼Œæ”¯æŒ LOCAL æœ¬åœ°ä¸‹è½½å’Œ STRM æµåª’ä½“åŒæ¨¡å¼ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·è®¿é—®å±‚                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»SPAåº”ç”¨ (/)           â”‚    åŠŸèƒ½æ¨¡å—é¡µé¢ (/static/*)      â”‚
â”‚  â€¢ ç»Ÿä¸€å¯¼èˆªç•Œé¢           â”‚    â€¢ é˜Ÿåˆ—ç®¡ç†å·¥å…·                â”‚
â”‚  â€¢ è®¢é˜…ç®¡ç†              â”‚    â€¢ STRMé…ç½®ç•Œé¢                â”‚
â”‚  â€¢ ä»»åŠ¡ç›‘æ§              â”‚    â€¢ è§†é¢‘æ£€æµ‹å·¥å…·                â”‚
â”‚  â€¢ ç³»ç»Ÿè®¾ç½®              â”‚    â€¢ è®¢é˜…è¯¦æƒ…é¡µé¢                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API æœåŠ¡å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  FastAPI 7.0.0 + æ¨¡å—åŒ–è·¯ç”±                                â”‚
â”‚  â€¢ /api/subscriptions    â€¢ /api/cache                      â”‚
â”‚  â€¢ /api/cookies          â€¢ /api/strm                       â”‚
â”‚  â€¢ /api/migrations       â€¢ /api/data                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡æœåŠ¡å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ ¸å¿ƒæœåŠ¡ (20+ ç»„ä»¶)                                        â”‚
â”‚  â€¢ EnhancedDownloader    â€¢ DataConsistencyService          â”‚
â”‚  â€¢ STRMProxyService      â€¢ UnifiedCacheService             â”‚
â”‚  â€¢ MetricsService        â€¢ RemoteSyncService               â”‚
â”‚  â€¢ PendingListService    â€¢ SubscriptionStats               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ•°æ®å­˜å‚¨å±‚                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SQLite + Redis (V7)                                       â”‚
â”‚  â€¢ è®¢é˜…/è§†é¢‘å…ƒæ•°æ®        â€¢ ç¼“å­˜å’Œä¼šè¯å­˜å‚¨                   â”‚
â”‚  â€¢ ä»»åŠ¡é˜Ÿåˆ—çŠ¶æ€          â€¢ STRMä»£ç†ç¼“å­˜                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ å‰ç«¯æ¶æ„

### ä¸»SPAåº”ç”¨
- **å…¥å£**: `web/dist/index.html` (216KB æ‰“åŒ…æ–‡ä»¶)
- **è·¯ç”±**: `/` ä¼˜å…ˆè¿”å›ç»Ÿä¸€SPAç•Œé¢
- **åŠŸèƒ½**: 6å¤§æ ¸å¿ƒæ¨¡å—çš„ç»Ÿä¸€å¯¼èˆªå’Œç®¡ç†

### åŠŸèƒ½æ¨¡å—é¡µé¢
- **ä½ç½®**: `static/*.html` (5ä¸ªç‹¬ç«‹é¡µé¢)
- **ç”¨é€”**: ä¸“é¡¹ç®¡ç†å·¥å…·ï¼ŒSPAçš„åŠŸèƒ½è¡¥å……
- **å…³ç³»**: ç‹¬ç«‹è®¿é—®ï¼Œéä¸»åº”ç”¨æ¶æ„ç»„æˆéƒ¨åˆ†

| é¡µé¢ | ç”¨é€” | è®¿é—®è·¯å¾„ |
|------|------|----------|
| queue_admin.html | è¯·æ±‚é˜Ÿåˆ—ç®¡ç† | /static/queue_admin.html |
| strm_management.html | STRMæµåª’ä½“é…ç½® | /static/strm_management.html |
| subscription_detail.html | è®¢é˜…åŒæ­¥è¯¦æƒ… | /static/subscription_detail.html |
| video_detection.html | è§†é¢‘æ£€æµ‹å·¥å…· | /static/video_detection.html |
| test.html | å¼€å‘æµ‹è¯•é¡µé¢ | /static/test.html |

## ğŸ”§ åç«¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶ (49ä¸ªPythonæ–‡ä»¶)

#### APIå±‚ (`app/api_endpoints/`)
- `subscription_management.py` - è®¢é˜…ç®¡ç†API
- `strm_management.py` - STRMæµåª’ä½“API  
- `cache_management.py` - ç¼“å­˜ç®¡ç†API
- `cookie_management.py` - Cookieç®¡ç†API
- `data_maintenance.py` - æ•°æ®ç»´æŠ¤API
- `migration_management.py` - è¿ç§»ç®¡ç†API

#### æœåŠ¡å±‚ (`app/services/`)
**ä¸‹è½½æœåŠ¡**:
- `enhanced_downloader.py` - å¢å¼ºä¸‹è½½å™¨ï¼ˆæ”¯æŒSTRMï¼‰
- `strm_downloader.py` - STRMä¸“ç”¨ä¸‹è½½å™¨
- `download_plan_service.py` - ä¸‹è½½è®¡åˆ’æœåŠ¡

**STRMæœåŠ¡**:
- `strm_proxy_service.py` - STRMä»£ç†æœåŠ¡
- `strm_file_manager.py` - STRMæ–‡ä»¶ç®¡ç†
- `strm_performance_optimizer.py` - STRMæ€§èƒ½ä¼˜åŒ–

**æ•°æ®æœåŠ¡**:
- `data_consistency_service.py` - æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- `unified_cache_service.py` - ç»Ÿä¸€ç¼“å­˜æœåŠ¡
- `metrics_service.py` - ç»Ÿè®¡æŒ‡æ ‡æœåŠ¡
- `remote_sync_service.py` - è¿œç¨‹åŒæ­¥æœåŠ¡
- `pending_list_service.py` - å¾…ä¸‹è½½åˆ—è¡¨æœåŠ¡

#### æ ¸å¿ƒå±‚ (`app/core/`)
- `config.py` - ç»Ÿä¸€é…ç½®ç®¡ç†
- `dependencies.py` - ä¾èµ–æ³¨å…¥
- `exceptions.py` - å¼‚å¸¸å®šä¹‰
- `exception_handlers.py` - å¼‚å¸¸å¤„ç†å™¨

## ğŸ“Š åŒæ¨¡å¼æ”¯æŒ

### LOCALæ¨¡å¼ (ä¼ ç»Ÿä¸‹è½½)
- **å­˜å‚¨**: `/downloads` ç›®å½•
- **ç‰¹ç‚¹**: å®Œæ•´è§†é¢‘æ–‡ä»¶æœ¬åœ°å­˜å‚¨
- **é€‚ç”¨**: ç¦»çº¿è§‚çœ‹ã€å­˜æ¡£éœ€æ±‚

### STRMæ¨¡å¼ (æµåª’ä½“)
- **å­˜å‚¨**: `/strm` ç›®å½• (ä»….strmæ–‡ä»¶)
- **ç‰¹ç‚¹**: å®æ—¶æµåª’ä½“ä»£ç†ï¼ŒèŠ‚çœ99%å­˜å‚¨ç©ºé—´
- **é€‚ç”¨**: åœ¨çº¿è§‚çœ‹ã€å­˜å‚¨å—é™ç¯å¢ƒ

### æ¨¡å¼åˆ‡æ¢
æ•°æ®æ¨¡å‹ä¸­ `Subscription.download_mode` å­—æ®µæ§åˆ¶ï¼š
- `'local'` - LOCALæ¨¡å¼ (é»˜è®¤)
- `'strm'` - STRMæ¨¡å¼

è°ƒåº¦å™¨ (`scheduler.py`) è‡ªåŠ¨è¯†åˆ«å¹¶åˆ†æµåˆ°å¯¹åº”å¤„ç†é€»è¾‘ã€‚

## ğŸ”„ è°ƒåº¦å™¨æ¶æ„

### å®šæ—¶ä»»åŠ¡
- **è®¢é˜…æ£€æŸ¥**: æ¯30åˆ†é’Ÿæ£€æŸ¥æ–°è§†é¢‘
- **CookieéªŒè¯**: æ¯6å°æ—¶éªŒè¯æœ‰æ•ˆæ€§  
- **ä»»åŠ¡æ¸…ç†**: æ¯å¤©å‡Œæ™¨2ç‚¹æ¸…ç†æ—§ä»»åŠ¡
- **åƒµå°¸å›æ”¶**: æ¯5åˆ†é’Ÿæ¸…ç†è¶…æ—¶ä»»åŠ¡
- **å…¥é˜Ÿåè°ƒ**: æ¯3åˆ†é’Ÿåè°ƒä¸‹è½½é˜Ÿåˆ—

### STRMåˆ†æµé€»è¾‘
```python
# è°ƒåº¦å™¨ä¸­çš„STRMæ£€æŸ¥ (scheduler.py:530-538)
download_mode = getattr(sub, 'download_mode', 'local')
if download_mode == 'strm':
    # STRMæ¨¡å¼ï¼šä½¿ç”¨å¢å¼ºä¸‹è½½å™¨
    await self._process_subscription(sub, db)
    continue
else:
    # LOCALæ¨¡å¼ï¼šä½¿ç”¨ä¼ ç»Ÿä¸‹è½½å™¨
    await downloader.compute_pending_list(sub.id, db)
```

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

### å­˜å‚¨æ•ˆç‡
- **LOCALæ¨¡å¼**: ~500MB/è§†é¢‘
- **STRMæ¨¡å¼**: ~50KB/è§†é¢‘ (99%èŠ‚çœ)

### å“åº”æ€§èƒ½
- **APIå“åº”**: <200ms
- **æµå¯åŠ¨**: <2s
- **ç¼“å­˜å‘½ä¸­ç‡**: >80%

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

### åç«¯
- **æ¡†æ¶**: FastAPI 7.0.0
- **æ•°æ®åº“**: SQLite + SQLAlchemy 2.0.32
- **ç¼“å­˜**: Redis 5.0.1 (V7æ–°å¢)
- **ä»»åŠ¡è°ƒåº¦**: APScheduler 3.10.4
- **è§†é¢‘å¤„ç†**: yt-dlp 2025.8.20 + FFmpeg

### å‰ç«¯
- **ä¸»åº”ç”¨**: ç°ä»£åŒ–SPAæ¡†æ¶
- **å·¥å…·é¡µé¢**: åŸç”ŸHTML + JavaScript
- **æ ·å¼**: CSS3 + å“åº”å¼è®¾è®¡

### åŸºç¡€è®¾æ–½
- **éƒ¨ç½²**: Docker Compose
- **æ—¥å¿—**: Loguru 0.7.2
- **ç›‘æ§**: psutil 5.9.8
- **HTTP**: aiohttp 3.9.5 + httpx 0.27.2

## ğŸ“ ç›®å½•ç»“æ„

```
bili_curator/
â”œâ”€â”€ web/                     # ä¸»SPAåº”ç”¨
â”‚   â”œâ”€â”€ dist/index.html     # SPAæ‰“åŒ…å…¥å£ (216KB)
â”‚   â””â”€â”€ src/                # SPAæºç 
â”œâ”€â”€ static/                  # åŠŸèƒ½æ¨¡å—é¡µé¢
â”‚   â”œâ”€â”€ queue_admin.html    # é˜Ÿåˆ—ç®¡ç†
â”‚   â”œâ”€â”€ strm_management.html # STRMé…ç½®
â”‚   â””â”€â”€ *.html              # å…¶ä»–å·¥å…·é¡µé¢
â”œâ”€â”€ app/                     # åç«¯åº”ç”¨
â”‚   â”œâ”€â”€ api_endpoints/      # APIè·¯ç”±æ¨¡å—
â”‚   â”œâ”€â”€ services/           # ä¸šåŠ¡æœåŠ¡å±‚ (20+ç»„ä»¶)
â”‚   â”œâ”€â”€ core/               # æ ¸å¿ƒé…ç½®å’Œå¼‚å¸¸
â”‚   â”œâ”€â”€ database/           # æ•°æ®åº“è¿æ¥
â”‚   â””â”€â”€ schemas/            # æ•°æ®æ¨¡å‹å®šä¹‰
â”œâ”€â”€ downloads/               # LOCALæ¨¡å¼å­˜å‚¨
â”œâ”€â”€ strm/                    # STRMæ¨¡å¼å­˜å‚¨
â””â”€â”€ docs/                    # æŠ€æœ¯æ–‡æ¡£
```

## ğŸš€ éƒ¨ç½²æ¶æ„

### Dockerå®¹å™¨åŒ–
- **å•å®¹å™¨éƒ¨ç½²**: `docker-compose up -d`
- **ç«¯å£æ˜ å°„**: 8080 (Web) + 8889 (STRMä»£ç†)
- **æ•°æ®æŒä¹…åŒ–**: å·æŒ‚è½½ `/downloads`ã€`/strm`ã€`/data`

### ç¯å¢ƒé…ç½®
- **é…ç½®æ–‡ä»¶**: `.env` ç¯å¢ƒå˜é‡
- **æ•°æ®åº“**: è‡ªåŠ¨åˆå§‹åŒ– SQLite
- **ä¾èµ–ç®¡ç†**: `requirements.txt` + `requirements-v7.txt`

---

**æ¶æ„è®¾è®¡åŸåˆ™**: æ¨¡å—åŒ–ã€å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€æ˜“ç»´æŠ¤
**ç‰ˆæœ¬**: V7.0.0 (2025-08-28)

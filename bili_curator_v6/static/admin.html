<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bili Curator ç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: #f5f5f5;
      color: #1f2937;
      line-height: 1.6;
    }
    
    /* å¸ƒå±€ç»“æ„ */
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* ä¾§è¾¹æ  */
    .sidebar {
      width: 240px;
      background: #1f2937;
      color: #fff;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #374151;
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .sidebar-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }
    
    .sidebar-nav {
      padding: 20px 0;
    }
    
    .nav-item {
      display: block;
      padding: 12px 20px;
      color: #d1d5db;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .nav-item:hover {
      background: #374151;
      color: #fff;
    }
    
    .nav-item.active {
      background: #3b82f6;
      color: #fff;
    }
    
    .nav-item .nav-icon {
      display: inline-block;
      width: 16px;
      margin-right: 8px;
    }
    
    /* ä¸»å†…å®¹åŒº */
    .main-content {
      flex: 1;
      margin-left: 240px;
      padding: 0;
    }
    
    .content-header {
      background: #fff;
      padding: 20px 30px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .content-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .content-subtitle {
      color: #6b7280;
      font-size: 14px;
    }
    
    .content-body {
      padding: 30px;
      max-width: 1200px;
    }
    
    /* é€šç”¨ç»„ä»¶æ ·å¼ */
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    
    .grid {
      display: grid;
      gap: 20px;
    }
    
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    }
    
    /* æŒ‰é’®æ ·å¼ */
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      text-decoration: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: #fff;
      border-color: #2563eb;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* è¡¨å•æ ·å¼ */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* çŠ¶æ€æŒ‡ç¤ºå™¨ */
    .status {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #dc2626;
    }
    
    /* æ¨¡æ€æ¡†æ ·å¼ */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: #374151;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    /* éšè—ç±» */
    .hidden {
      display: none !important;
    }
    
    /* å“åº”å¼è®¾è®¡ */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .content-body {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- ä¾§è¾¹æ  -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Bili Curator</div>
        <div class="sidebar-subtitle">ç®¡ç†åå° v6.0</div>
      </div>
      
      <div class="sidebar-nav">
        <button class="nav-item active" data-module="dashboard">
          <span class="nav-icon">ğŸ“Š</span>
          ä»ªè¡¨æ¿
        </button>
        <button class="nav-item" data-module="subscriptions">
          <span class="nav-icon">ğŸ“º</span>
          è®¢é˜…ç®¡ç†
        </button>
        <button class="nav-item" data-module="queue">
          <span class="nav-icon">âš¡</span>
          é˜Ÿåˆ—ç›‘æ§
        </button>
        <button class="nav-item" data-module="videos">
          <span class="nav-icon">ğŸ¬</span>
          è§†é¢‘æ£€æµ‹
        </button>
        <button class="nav-item" data-module="settings">
          <span class="nav-icon">âš™ï¸</span>
          ç³»ç»Ÿè®¾ç½®
        </button>
        <button class="nav-item" data-module="backend">
          <span class="nav-icon">ğŸ”§</span>
          åå°ç®¡ç†
        </button>
      </div>
    </nav>
    
    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <header class="content-header">
        <h1 class="content-title" id="page-title">ä»ªè¡¨æ¿</h1>
        <p class="content-subtitle" id="page-subtitle">ç³»ç»Ÿæ¦‚è§ˆå’Œå…³é”®æŒ‡æ ‡</p>
      </header>
      
      <div class="content-body" id="content-body">
        <!-- å†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        <div class="loading">åŠ è½½ä¸­...</div>
      </div>
    </main>
  </div>

  <script>
    // å…¨å±€åº”ç”¨çŠ¶æ€
    const App = {
      currentModule: 'dashboard',
      modules: {},
      apiClient: null,
      
      init() {
        this.setupApiClient();
        this.setupNavigation();
        this.loadModule('dashboard');
      },
      
      setupApiClient() {
        this.apiClient = new ApiClient();
      },
      
      setupNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            const module = e.target.closest('.nav-item').dataset.module;
            this.loadModule(module);
          });
        });
      },
      
      async loadModule(moduleName) {
        if (this.currentModule === moduleName) return;
        
        // æ›´æ–°å¯¼èˆªçŠ¶æ€
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.toggle('active', item.dataset.module === moduleName);
        });
        
        this.currentModule = moduleName;
        
        // åŠ è½½æ¨¡å—
        try {
          const module = await this.getModule(moduleName);
          await module.render();
        } catch (error) {
          console.error('Failed to load module:', error);
          this.showError('åŠ è½½æ¨¡å—å¤±è´¥: ' + error.message);
        }
      },
      
      async getModule(moduleName) {
        if (!this.modules[moduleName]) {
          this.modules[moduleName] = new (this.getModuleClass(moduleName))();
        }
        return this.modules[moduleName];
      },
      
      getModuleClass(moduleName) {
        const moduleClasses = {
          dashboard: DashboardModule,
          subscriptions: SubscriptionsModule,
          queue: QueueModule,
          videos: VideosModule,
          settings: SettingsModule,
          backend: BackendModule
        };
        return moduleClasses[moduleName] || DashboardModule;
      },
      
      updatePageHeader(title, subtitle) {
        document.getElementById('page-title').textContent = title;
        document.getElementById('page-subtitle').textContent = subtitle;
      },
      
      showError(message) {
        document.getElementById('content-body').innerHTML = `
          <div class="error">${message}</div>
        `;
      }
    };
    
    // API å®¢æˆ·ç«¯
    class ApiClient {
      async get(path) {
        const response = await fetch(path);
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async post(path, data) {
        const response = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async put(path, data) {
        const response = await fetch(path, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async delete(path) {
        const response = await fetch(path, { method: 'DELETE' });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
    }
    
    // åŸºç¡€æ¨¡å—ç±»
    class BaseModule {
      constructor() {
        this.container = document.getElementById('content-body');
      }
      
      async render() {
        this.container.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
        try {
          const content = await this.getContent();
          this.container.innerHTML = content;
          this.bindEvents();
        } catch (error) {
          this.container.innerHTML = `<div class="error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
        }
      }
      
      async getContent() {
        return '<div>æ¨¡å—å†…å®¹</div>';
      }
      
      bindEvents() {
        // å­ç±»é‡å†™
      }
      
      formatTime(timeStr) {
        if (!timeStr) return 'æœªçŸ¥';
        try {
          return new Date(timeStr).toLocaleString();
        } catch {
          return timeStr;
        }
      }
    }
    
    // ä»ªè¡¨æ¿æ¨¡å—
    class DashboardModule extends BaseModule {
      async render() {
        App.updatePageHeader('ä»ªè¡¨æ¿', 'ç³»ç»Ÿæ¦‚è§ˆå’Œå…³é”®æŒ‡æ ‡');
        await super.render();
      }
      
      async getContent() {
        // è·å–ç³»ç»Ÿç»Ÿè®¡æ•°æ®
        const [subscriptions, queueStats] = await Promise.all([
          App.apiClient.get('/api/subscriptions').catch(() => ({ items: [] })),
          App.apiClient.get('/api/queue/stats').catch(() => ({}))
        ]);
        
        const activeSubscriptions = subscriptions.items?.filter(s => s.is_active).length || 0;
        const totalSubscriptions = subscriptions.items?.length || 0;
        const runningTasks = queueStats.counts?.running || 0;
        const queuedTasks = queueStats.counts?.queued || 0;
        
        return `
          <div class="grid grid-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æ´»è·ƒè®¢é˜…</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #059669;">${activeSubscriptions}</div>
              <div style="color: #6b7280; font-size: 14px;">æ€»å…± ${totalSubscriptions} ä¸ªè®¢é˜…</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">è¿è¡Œä¸­ä»»åŠ¡</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${runningTasks}</div>
              <div style="color: #6b7280; font-size: 14px;">é˜Ÿåˆ—ä¸­ ${queuedTasks} ä¸ª</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ç³»ç»ŸçŠ¶æ€</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #059669;">æ­£å¸¸</div>
              <div style="color: #6b7280; font-size: 14px;">æ‰€æœ‰æœåŠ¡è¿è¡Œä¸­</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æœ€åæ›´æ–°</h3>
              </div>
              <div style="font-size: 16px; font-weight: 600;">${this.formatTime(new Date().toISOString())}</div>
              <div style="color: #6b7280; font-size: 14px;">è‡ªåŠ¨åˆ·æ–°</div>
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="App.loadModule('subscriptions')">ç®¡ç†è®¢é˜…</button>
                <button class="btn btn-primary" onclick="App.loadModule('queue')">æŸ¥çœ‹é˜Ÿåˆ—</button>
                <button class="btn" onclick="location.reload()">åˆ·æ–°æ•°æ®</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ç³»ç»Ÿä¿¡æ¯</h3>
              </div>
              <div style="color: #6b7280; font-size: 14px; line-height: 1.8;">
                <div>ç‰ˆæœ¬: Bili Curator v6.0</div>
                <div>è¿è¡Œæ—¶é—´: ${this.getUptime()}</div>
                <div>æ•°æ®åº“: SQLite</div>
                <div>ä¸‹è½½å¼•æ“: yt-dlp</div>
              </div>
            </div>
          </div>
        `;
      }
      
      getUptime() {
        // ç®€å•çš„è¿è¡Œæ—¶é—´æ˜¾ç¤º
        const start = new Date();
        start.setHours(0, 0, 0, 0);
        const now = new Date();
        const diff = now - start;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}å°æ—¶${minutes}åˆ†é’Ÿ`;
      }
    }
    
    // è®¢é˜…ç®¡ç†æ¨¡å—
    class SubscriptionsModule extends BaseModule {
      constructor() {
        super();
        this.subscriptions = [];
        this.syncOverview = {};
        this.selectedIds = new Set();
        this.poller = null;
      }
      
      async render() {
        App.updatePageHeader('è®¢é˜…ç®¡ç†', 'ç®¡ç†æ‰€æœ‰è®¢é˜…å’ŒåŒæ­¥çŠ¶æ€');
        await super.render();
        this.startPolling();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æ‰¹é‡æ“ä½œ</h3>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn" onclick="subscriptionsModule.selectAll()">å…¨é€‰</button>
                <button class="btn" onclick="subscriptionsModule.clearSelection()">æ¸…ç©º</button>
                <button class="btn btn-primary" onclick="subscriptionsModule.batchSync()">æ‰¹é‡åŒæ­¥</button>
                <button class="btn" onclick="subscriptionsModule.batchToggleActive()">åˆ‡æ¢çŠ¶æ€</button>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                å·²é€‰æ‹© <span id="selected-count">0</span> ä¸ªè®¢é˜…
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">åŒæ­¥æ¦‚è§ˆ</h3>
                <button class="btn btn-sm" onclick="subscriptionsModule.refreshData()">åˆ·æ–°</button>
              </div>
              <div class="grid grid-3" style="gap: 12px;">
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #059669;" id="running-count">0</div>
                  <div style="font-size: 12px; color: #6b7280;">åŒæ­¥ä¸­</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #dc2626;" id="pending-count">0</div>
                  <div style="font-size: 12px; color: #6b7280;">å¾…ä¸‹è½½</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #3b82f6;" id="total-videos">0</div>
                  <div style="font-size: 12px; color: #6b7280;">æ€»è§†é¢‘æ•°</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">è®¢é˜…åˆ—è¡¨</h3>
              <button class="btn btn-primary" onclick="subscriptionsModule.showAddModal()">æ·»åŠ è®¢é˜…</button>
            </div>
            <div class="subscription-list" id="subscription-list">
              ${this.renderSubscriptionList()}
            </div>
          </div>
          
          <!-- è®¢é˜…è¯¦æƒ…æ¨¡æ€æ¡† -->
          <div id="subscription-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3 id="modal-title">è®¢é˜…è¯¦æƒ…</h3>
                <button class="modal-close" onclick="subscriptionsModule.closeModal()">&times;</button>
              </div>
              <div class="modal-body" id="modal-body">
                <!-- å†…å®¹åŠ¨æ€åŠ è½½ -->
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          // åŠ è½½è®¢é˜…åˆ—è¡¨
          const subscriptionsResponse = await App.apiClient.get('/api/subscriptions').catch(() => ({ items: [] }));
          this.subscriptions = subscriptionsResponse.items || subscriptionsResponse || [];
          
          // è·å–åŒæ­¥çŠ¶æ€æ¦‚è§ˆ
          this.syncOverview = { items: [] };
          if (this.subscriptions.length > 0) {
            const ids = this.subscriptions.map(s => s.id);
            try {
              this.syncOverview = await App.apiClient.post('/api/subscriptions/sync_overview', {
                subscription_ids: ids
              });
            } catch (error) {
              console.warn('Failed to load sync overview:', error);
              this.syncOverview = { items: [] };
            }
          }
        } catch (error) {
          console.error('Failed to load subscriptions:', error);
          this.subscriptions = [];
          this.syncOverview = { items: [] };
        }
      }
      
      renderSubscriptionList() {
        if (!this.subscriptions.length) {
          return '<div style="text-align: center; padding: 40px; color: #6b7280;">æš‚æ— è®¢é˜…</div>';
        }
        
        return this.subscriptions.map(sub => {
          const syncData = this.syncOverview.items?.find(s => s.id === sub.id) || {};
          const statusClass = this.getStatusClass(syncData.status);
          const statusText = this.getStatusText(syncData.status);
          
          return `
            <div class="subscription-item" style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #e5e7eb;">
              <input type="checkbox" class="subscription-checkbox" value="${sub.id}" 
                     onchange="subscriptionsModule.updateSelection()" style="margin-right: 12px;">
              
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">${sub.name}</div>
                    <div style="color: #6b7280; font-size: 14px;">
                      ${sub.type} â€¢ ${sub.is_active ? 'æ´»è·ƒ' : 'å·²æš‚åœ'} â€¢ 
                      ${sub.video_count || 0} ä¸ªè§†é¢‘
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div class="status ${statusClass}" style="margin-bottom: 4px;">${statusText}</div>
                    <div style="font-size: 12px; color: #6b7280;">
                      ${this.formatTime(syncData.updated_at)}
                    </div>
                  </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; gap: 16px; font-size: 12px;">
                    <span style="color: ${syncData.pending > 0 ? '#dc2626' : '#6b7280'};">
                      å¾…ä¸‹è½½: ${syncData.pending || 0}
                    </span>
                    <span style="color: #6b7280;">
                      æ€»æ•°: ${syncData.remote_total || 0}
                    </span>
                  </div>
                  
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" onclick="subscriptionsModule.viewSyncDetail(${sub.id})">
                      åŒæ­¥è¯¦æƒ…
                    </button>
                    <button class="btn btn-sm" onclick="subscriptionsModule.editSubscription(${sub.id})">
                      ç¼–è¾‘
                    </button>
                    <button class="btn btn-sm" onclick="subscriptionsModule.toggleActive(${sub.id})">
                      ${sub.is_active ? 'æš‚åœ' : 'å¯ç”¨'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      bindEvents() {
        // å°†æ¨¡å—å®ä¾‹ç»‘å®šåˆ°å…¨å±€ï¼Œä¾›onclickä½¿ç”¨
        window.subscriptionsModule = this;
        this.updateSummary();
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-success',
          'completed': 'status-info',
          'failed': 'status-error',
          'idle': 'status-warning'
        };
        return classMap[status] || 'status-info';
      }
      
      getStatusText(status) {
        const textMap = {
          'running': 'åŒæ­¥ä¸­',
          'completed': 'å·²å®Œæˆ',
          'failed': 'å¤±è´¥',
          'idle': 'ç©ºé—²'
        };
        return textMap[status] || 'æœªçŸ¥';
      }
      
      updateSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        this.selectedIds.clear();
        checkboxes.forEach(cb => {
          if (cb.checked) {
            this.selectedIds.add(parseInt(cb.value));
          }
        });
        document.getElementById('selected-count').textContent = this.selectedIds.size;
      }
      
      selectAll() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        this.updateSelection();
      }
      
      clearSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        this.updateSelection();
      }
      
      async batchSync() {
        if (this.selectedIds.size === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„è®¢é˜…');
          return;
        }
        
        if (!confirm(`ç¡®å®šè¦åŒæ­¥é€‰ä¸­çš„ ${this.selectedIds.size} ä¸ªè®¢é˜…å—ï¼Ÿ`)) {
          return;
        }
        
        // è¿™é‡Œè°ƒç”¨æ‰¹é‡åŒæ­¥API
        console.log('Batch sync subscriptions:', Array.from(this.selectedIds));
        alert('åŒæ­¥ä»»åŠ¡å·²æäº¤ï¼Œè¯·ç¨åæŸ¥çœ‹çŠ¶æ€');
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('subscription-list').innerHTML = this.renderSubscriptionList();
        this.updateSummary();
      }
      
      updateSummary() {
        const syncItems = this.syncOverview.items || [];
        const runningCount = syncItems.filter(s => s.status === 'running').length;
        const pendingCount = syncItems.reduce((sum, s) => sum + (s.pending || 0), 0);
        const totalVideos = syncItems.reduce((sum, s) => sum + (s.remote_total || 0), 0);
        
        document.getElementById('running-count').textContent = runningCount;
        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('total-videos').textContent = totalVideos;
      }
      
      async viewSyncDetail(subscriptionId) {
        try {
          const [status, trace] = await Promise.all([
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_status`),
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_trace`)
          ]);
          
          this.showSyncDetailModal(subscriptionId, status, trace);
        } catch (error) {
          alert('è·å–åŒæ­¥è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
      }
      
      showSyncDetailModal(subscriptionId, status, trace) {
        const subscription = this.subscriptions.find(s => s.id === subscriptionId);
        
        document.getElementById('modal-title').textContent = `${subscription.name} - åŒæ­¥è¯¦æƒ…`;
        document.getElementById('modal-body').innerHTML = `
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 12px;">åŒæ­¥çŠ¶æ€</h4>
            <div class="grid grid-3" style="gap: 12px;">
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: ${status.pending > 0 ? '#dc2626' : '#059669'};">
                  ${status.pending || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">å¾…ä¸‹è½½</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">
                  ${status.remote_total || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">è¿œç«¯æ€»æ•°</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: #059669;">
                  ${status.existing || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">å·²å­˜åœ¨</div>
              </div>
            </div>
            
            <div style="margin-top: 12px; font-size: 12px; color: #6b7280;">
              çŠ¶æ€: <span class="status ${this.getStatusClass(status.status)}">${this.getStatusText(status.status)}</span> â€¢ 
              æ›´æ–°æ—¶é—´: ${this.formatTime(status.updated_at)}
            </div>
          </div>
          
          <div>
            <h4 style="margin-bottom: 12px;">äº‹ä»¶æ—¶é—´çº¿</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
              ${this.renderTraceEvents(trace.events || [])}
            </div>
          </div>
        `;
        
        this.showModal();
      }
      
      renderTraceEvents(events) {
        if (!events.length) {
          return '<div style="text-align: center; color: #6b7280;">æš‚æ— äº‹ä»¶è®°å½•</div>';
        }
        
        return events.slice(-10).reverse().map(event => {
          const isError = event.type.includes('failed');
          const iconColor = isError ? '#dc2626' : '#059669';
          
          return `
            <div style="display: flex; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f3f4f6;">
              <div style="width: 8px; height: 8px; border-radius: 50%; background: ${iconColor}; margin-top: 6px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${this.getEventTypeText(event.type)}</div>
                <div style="font-size: 12px; color: #6b7280;">
                  ${this.formatTime(event.ts)}
                  ${event.range ? ` â€¢ èŒƒå›´: ${event.range}` : ''}
                  ${event.count ? ` â€¢ æ•°é‡: ${event.count}` : ''}
                  ${event.duration_ms ? ` â€¢ è€—æ—¶: ${event.duration_ms}ms` : ''}
                </div>
                ${event.error ? `<div style="font-size: 12px; color: #dc2626; margin-top: 4px;">é”™è¯¯: ${event.error}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
      
      getEventTypeText(type) {
        const typeMap = {
          'list_start': 'å¼€å§‹è·å–åˆ—è¡¨',
          'chunk_ok': 'åˆ†é¡µè·å–æˆåŠŸ',
          'chunk_failed': 'åˆ†é¡µè·å–å¤±è´¥',
          'list_done': 'åˆ—è¡¨è·å–å®Œæˆ',
          'list_failed': 'åˆ—è¡¨è·å–å¤±è´¥'
        };
        return typeMap[type] || type;
      }
      
      showModal() {
        document.getElementById('subscription-modal').classList.remove('hidden');
      }
      
      closeModal() {
        document.getElementById('subscription-modal').classList.add('hidden');
      }
      
      startPolling() {
        this.stopPolling();
        this.poller = setInterval(() => {
          this.refreshData();
        }, 10000); // 10ç§’åˆ·æ–°ä¸€æ¬¡
      }
      
      stopPolling() {
        if (this.poller) {
          clearInterval(this.poller);
          this.poller = null;
        }
      }
      
      // ç¼ºå¤±çš„æ–¹æ³•å®ç°
      updateSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        this.selectedIds = checked.map(cb => parseInt(cb.value));
        this.updateSummary();
      }
      
      updateSummary() {
        const summaryElement = document.getElementById('selection-summary');
        if (summaryElement) {
          summaryElement.textContent = `å·²é€‰æ‹© ${this.selectedIds.length} ä¸ªè®¢é˜…`;
        }
      }
      
      selectAll() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        this.updateSelection();
      }
      
      clearSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        this.updateSelection();
      }
      
      async batchSync() {
        if (this.selectedIds.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦åŒæ­¥çš„è®¢é˜…');
          return;
        }
        
        try {
          await App.apiClient.post('/api/subscriptions/batch_sync', {
            subscription_ids: this.selectedIds
          });
          alert(`å·²å¯åŠ¨ ${this.selectedIds.length} ä¸ªè®¢é˜…çš„åŒæ­¥ä»»åŠ¡`);
          this.clearSelection();
          await this.refreshData();
        } catch (error) {
          alert('æ‰¹é‡åŒæ­¥å¤±è´¥: ' + error.message);
        }
      }
      
      async batchToggle() {
        if (this.selectedIds.length === 0) {
          alert('è¯·å…ˆé€‰æ‹©è¦æ“ä½œçš„è®¢é˜…');
          return;
        }
        
        try {
          await App.apiClient.post('/api/subscriptions/batch_toggle', {
            subscription_ids: this.selectedIds
          });
          alert(`å·²åˆ‡æ¢ ${this.selectedIds.length} ä¸ªè®¢é˜…çš„çŠ¶æ€`);
          this.clearSelection();
          await this.refreshData();
        } catch (error) {
          alert('æ‰¹é‡åˆ‡æ¢çŠ¶æ€å¤±è´¥: ' + error.message);
        }
      }
      
      async viewSyncDetail(subscriptionId) {
        try {
          const [syncStatus, syncTrace] = await Promise.all([
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_status`),
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_trace`)
          ]);
          
          const subscription = this.subscriptions.find(s => s.id === subscriptionId);
          
          document.getElementById('modal-title').textContent = `${subscription?.name || 'è®¢é˜…'} - åŒæ­¥è¯¦æƒ…`;
          document.getElementById('modal-body').innerHTML = this.renderSyncDetail(syncStatus, syncTrace);
          this.showModal();
        } catch (error) {
          alert('åŠ è½½åŒæ­¥è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
      }
      
      async editSubscription(subscriptionId) {
        alert('ç¼–è¾‘åŠŸèƒ½å¼€å‘ä¸­...');
      }
      
      async toggleActive(subscriptionId) {
        try {
          await App.apiClient.post(`/api/subscriptions/${subscriptionId}/toggle`);
          await this.refreshData();
        } catch (error) {
          alert('åˆ‡æ¢è®¢é˜…çŠ¶æ€å¤±è´¥: ' + error.message);
        }
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-warning',
          'completed': 'status-success',
          'failed': 'status-error',
          'idle': 'status-info'
        };
        return classMap[status] || 'status-info';
      }
      
      getStatusText(status) {
        const textMap = {
          'running': 'åŒæ­¥ä¸­',
          'completed': 'å·²å®Œæˆ',
          'failed': 'å¤±è´¥',
          'idle': 'ç©ºé—²'
        };
        return textMap[status] || 'æœªçŸ¥';
      }
      
      async refreshData() {
        await this.loadData();
        const listElement = document.getElementById('subscription-list');
        if (listElement) {
          listElement.innerHTML = this.renderSubscriptionList();
        }
        this.updateSummary();
      }
    }
    
    // é˜Ÿåˆ—ç›‘æ§æ¨¡å—
    class QueueModule extends BaseModule {
      constructor() {
        super();
        this.queueStats = {};
        this.requests = [];
        this.poller = null;
      }
      
      async render() {
        App.updatePageHeader('é˜Ÿåˆ—ç›‘æ§', 'ç›‘æ§è¯·æ±‚é˜Ÿåˆ—å’Œä¸‹è½½ä»»åŠ¡');
        await super.render();
        this.startPolling();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æš‚åœ/æ¢å¤æ§åˆ¶</h3>
              </div>
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                <select id="pause-scope" class="form-input" style="width: auto;">
                  <option value="all">å…¨éƒ¨(all)</option>
                  <option value="requires_cookie">éœ€è¦Cookie</option>
                  <option value="no_cookie">æ— éœ€Cookie</option>
                </select>
                <button class="btn" onclick="queueModule.pauseQueue()">æš‚åœ</button>
                <button class="btn btn-primary" onclick="queueModule.resumeQueue()">æ¢å¤</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                æš‚åœä»…é˜»æ­¢æ–°ä»»åŠ¡è¿›å…¥è¿è¡Œï¼Œå·²åœ¨è¿è¡Œä¸­çš„ä»»åŠ¡ä¸è¢«å¼ºåˆ¶ä¸­æ–­
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å¹¶å‘é…ç½®</h3>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                <div>
                  <label style="font-size: 12px; color: #6b7280;">éœ€è¦Cookie:</label>
                  <input id="cap-cookie" type="number" min="0" value="1" class="form-input" style="width: 80px;" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">æ— éœ€Cookie:</label>
                  <input id="cap-nocookie" type="number" min="0" value="2" class="form-input" style="width: 80px;" />
                </div>
                <button class="btn btn-primary" onclick="queueModule.applyCapacity()">åº”ç”¨</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                ä¿®æ”¹åç«‹å³ç”Ÿæ•ˆã€‚è®¾ç½®ä¸º 0 è¡¨ç¤ºç¦æ­¢è¯¥é€šé“çš„æ–°ä»»åŠ¡è¿›å…¥è¿è¡Œ
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h3 class="card-title">é˜Ÿåˆ—æ€»è§ˆ <span id="queue-status-badge" class="status">-</span></h3>
              <button class="btn btn-sm" onclick="queueModule.refreshData()">åˆ·æ–°</button>
            </div>
            <div class="grid grid-4" id="queue-stats">
              ${this.renderQueueStats()}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ä»»åŠ¡æ“ä½œ</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
              <input id="job-id" placeholder="è¾“å…¥ job_id" class="form-input" style="width: 300px;" />
              <button class="btn" onclick="queueModule.cancelJob()">å–æ¶ˆä»»åŠ¡</button>
              <button class="btn" onclick="queueModule.prioritizeJob()">ç½®é¡¶ä¼˜å…ˆ</button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">è¯·æ±‚åˆ—è¡¨</h3>
              <div style="font-size: 12px; color: #6b7280;">æ¯ 2 ç§’è‡ªåŠ¨åˆ·æ–°</div>
            </div>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Job ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ç±»å‹</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">è®¢é˜…ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">éœ€Cookie</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">çŠ¶æ€</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">åˆ›å»ºæ—¶é—´</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">å¼€å§‹æ—¶é—´</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ç»“æŸæ—¶é—´</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">é”™è¯¯ä¿¡æ¯</th>
                  </tr>
                </thead>
                <tbody id="requests-table">
                  ${this.renderRequestsTable()}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const [stats, requests] = await Promise.all([
            App.apiClient.get('/api/queue/stats').catch(() => ({})),
            App.apiClient.get('/api/requests').catch(() => ({ items: [] }))
          ]);
          
          this.queueStats = stats;
          this.requests = requests.items || requests || [];
        } catch (error) {
          console.error('Failed to load queue data:', error);
        }
      }
      
      renderQueueStats() {
        const stats = this.queueStats;
        const capacity = stats.capacity || {};
        const counts = stats.counts_by_channel || {};
        
        return `
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #059669;">
              ${capacity.requires_cookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Cookieé€šé“é…ç½®</div>
            <div style="font-size: 10px; color: #6b7280;">
              è¿è¡Œ: ${capacity.running_cookie || 0} | å¯ç”¨: ${capacity.available_cookie || 0}
            </div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">
              ${capacity.no_cookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">æ— Cookieé€šé“é…ç½®</div>
            <div style="font-size: 10px; color: #6b7280;">
              è¿è¡Œ: ${capacity.running_nocookie || 0} | å¯ç”¨: ${capacity.available_nocookie || 0}
            </div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">
              ${counts.queued_cookie + counts.queued_nocookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280;">æ’é˜Ÿä»»åŠ¡</div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #10b981;">
              ${(capacity.running_cookie || 0) + (capacity.running_nocookie || 0)}
            </div>
            <div style="font-size: 12px; color: #6b7280;">è¿è¡Œä»»åŠ¡</div>
          </div>
        `;
      }
      
      renderRequestsTable() {
        if (!this.requests.length) {
          return '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— ä»»åŠ¡</td></tr>';
        }
        
        return this.requests.slice(0, 20).map(req => `
          <tr>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-family: monospace; font-size: 12px;">
              ${req.id}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.type || ''}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.subscription_id || ''}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.requires_cookie ? 'æ˜¯' : 'å¦'}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <span class="status ${this.getStatusClass(req.status)}">${req.status}</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.created_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.started_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.finished_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #dc2626; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
              ${req.last_error || ''}
            </td>
          </tr>
        `).join('');
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-success',
          'queued': 'status-warning',
          'failed': 'status-error',
          'canceled': 'status-info',
          'completed': 'status-success'
        };
        return classMap[status] || 'status-info';
      }
      
      bindEvents() {
        window.queueModule = this;
        this.updateStatusBadge();
        this.updateCapacityInputs();
      }
      
      updateStatusBadge() {
        const badge = document.getElementById('queue-status-badge');
        const paused = this.queueStats.paused || {};
        const anyPaused = paused.all || paused.requires_cookie || paused.no_cookie;
        
        if (anyPaused) {
          badge.textContent = 'å·²æš‚åœ';
          badge.className = 'status status-error';
        } else {
          badge.textContent = 'è¿è¡Œä¸­';
          badge.className = 'status status-success';
        }
      }
      
      updateCapacityInputs() {
        const capacity = this.queueStats.capacity || {};
        if (capacity.requires_cookie !== undefined) {
          document.getElementById('cap-cookie').value = capacity.requires_cookie;
        }
        if (capacity.no_cookie !== undefined) {
          document.getElementById('cap-nocookie').value = capacity.no_cookie;
        }
      }
      
      async pauseQueue() {
        try {
          const scope = document.getElementById('pause-scope').value;
          await App.apiClient.post('/api/queue/pause', { scope });
          await this.refreshData();
        } catch (error) {
          alert('æš‚åœé˜Ÿåˆ—å¤±è´¥: ' + error.message);
        }
      }
      
      async resumeQueue() {
        try {
          const scope = document.getElementById('pause-scope').value;
          await App.apiClient.post('/api/queue/resume', { scope });
          await this.refreshData();
        } catch (error) {
          alert('æ¢å¤é˜Ÿåˆ—å¤±è´¥: ' + error.message);
        }
      }
      
      async applyCapacity() {
        try {
          const requires_cookie = parseInt(document.getElementById('cap-cookie').value);
          const no_cookie = parseInt(document.getElementById('cap-nocookie').value);
          
          await App.apiClient.post('/api/queue/capacity', { requires_cookie, no_cookie });
          await this.refreshData();
        } catch (error) {
          alert('è®¾ç½®å¹¶å‘å¤±è´¥: ' + error.message);
        }
      }
      
      async cancelJob() {
        const jobId = document.getElementById('job-id').value.trim();
        if (!jobId) {
          alert('è¯·è¾“å…¥ job_id');
          return;
        }
        
        try {
          await App.apiClient.post(`/api/requests/${encodeURIComponent(jobId)}/cancel`);
          await this.refreshData();
          document.getElementById('job-id').value = '';
        } catch (error) {
          alert('å–æ¶ˆä»»åŠ¡å¤±è´¥: ' + error.message);
        }
      }
      
      async prioritizeJob() {
        const jobId = document.getElementById('job-id').value.trim();
        if (!jobId) {
          alert('è¯·è¾“å…¥ job_id');
          return;
        }
        
        try {
          await App.apiClient.post(`/api/requests/${encodeURIComponent(jobId)}/prioritize`, { priority: 0 });
          await this.refreshData();
          document.getElementById('job-id').value = '';
        } catch (error) {
          alert('ç½®é¡¶ä»»åŠ¡å¤±è´¥: ' + error.message);
        }
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('queue-stats').innerHTML = this.renderQueueStats();
        document.getElementById('requests-table').innerHTML = this.renderRequestsTable();
        this.updateStatusBadge();
        this.updateCapacityInputs();
      }
      
      startPolling() {
        this.stopPolling();
        this.poller = setInterval(() => {
          this.refreshData();
        }, 2000);
      }
      
      stopPolling() {
        if (this.poller) {
          clearInterval(this.poller);
          this.poller = null;
        }
      }
    }
    
    // è§†é¢‘æ£€æµ‹æ¨¡å—
    class VideosModule extends BaseModule {
      constructor() {
        super();
        this.videos = [];
        this.stats = {};
        this.filters = {
          status: '',
          subscription_id: '',
          search: ''
        };
        this.pagination = {
          page: 1,
          size: 20,
          total: 0
        };
      }
      
      async render() {
        App.updatePageHeader('è§†é¢‘æ£€æµ‹', 'æ–‡ä»¶æ‰«æå’ŒåŒ¹é…çŠ¶æ€');
        await super.render();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æ–‡ä»¶æ‰«æ</h3>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                <input id="scan-path" placeholder="æ‰«æè·¯å¾„ (ç•™ç©ºä½¿ç”¨é»˜è®¤)" class="form-input" style="flex: 1;" />
                <button class="btn btn-primary" onclick="videosModule.startScan()">å¼€å§‹æ‰«æ</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                æ‰«ææŒ‡å®šç›®å½•ä¸‹çš„è§†é¢‘æ–‡ä»¶ï¼Œæ£€æµ‹æ–‡ä»¶å®Œæ•´æ€§å’ŒåŒ¹é…çŠ¶æ€
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ç»Ÿè®¡ä¿¡æ¯</h3>
              </div>
              <div class="grid grid-2" style="gap: 12px;">
                <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                  <div style="font-size: 18px; font-weight: 700; color: #059669;">
                    ${this.stats.total || 0}
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">è§†é¢‘æ€»æ•°</div>
                </div>
                <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                  <div style="font-size: 18px; font-weight: 700; color: #dc2626;">
                    ${this.stats.missing || 0}
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">ç¼ºå¤±æ–‡ä»¶</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">ç­›é€‰æ¡ä»¶</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
              <select id="status-filter" class="form-input" style="width: 150px;">
                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                <option value="exists">æ–‡ä»¶å­˜åœ¨</option>
                <option value="missing">æ–‡ä»¶ç¼ºå¤±</option>
                <option value="partial">éƒ¨åˆ†æ–‡ä»¶</option>
              </select>
              <input id="subscription-filter" placeholder="è®¢é˜…ID" class="form-input" style="width: 120px;" />
              <input id="search-filter" placeholder="æœç´¢æ ‡é¢˜æˆ–æ–‡ä»¶å" class="form-input" style="flex: 1;" />
              <button class="btn" onclick="videosModule.applyFilters()">ç­›é€‰</button>
              <button class="btn btn-sm" onclick="videosModule.clearFilters()">æ¸…ç©º</button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">è§†é¢‘åˆ—è¡¨</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" onclick="videosModule.refreshData()">åˆ·æ–°</button>
                <button class="btn btn-sm" onclick="videosModule.exportResults()">å¯¼å‡ºç»“æœ</button>
              </div>
            </div>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">æ ‡é¢˜</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">è®¢é˜…</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">æ–‡ä»¶çŠ¶æ€</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">æ–‡ä»¶å¤§å°</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ä¸Šä¼ æ—¶é—´</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="videos-table">
                  ${this.renderVideosTable()}
                </tbody>
              </table>
            </div>
            
            <div style="display: flex; justify-content: between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
              <div style="font-size: 14px; color: #6b7280;">
                æ˜¾ç¤º ${Math.min((this.pagination.page - 1) * this.pagination.size + 1, this.pagination.total)} - 
                ${Math.min(this.pagination.page * this.pagination.size, this.pagination.total)} 
                å…± ${this.pagination.total} æ¡
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" ${this.pagination.page <= 1 ? 'disabled' : ''} 
                        onclick="videosModule.changePage(${this.pagination.page - 1})">ä¸Šä¸€é¡µ</button>
                <span style="padding: 6px 12px; font-size: 14px;">ç¬¬ ${this.pagination.page} é¡µ</span>
                <button class="btn btn-sm" ${this.pagination.page * this.pagination.size >= this.pagination.total ? 'disabled' : ''} 
                        onclick="videosModule.changePage(${this.pagination.page + 1})">ä¸‹ä¸€é¡µ</button>
              </div>
            </div>
          </div>
          
          <!-- è§†é¢‘è¯¦æƒ…æ¨¡æ€æ¡† -->
          <div id="video-detail-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3>è§†é¢‘è¯¦æƒ…</h3>
                <button class="modal-close" onclick="videosModule.closeVideoDetail()">&times;</button>
              </div>
              <div class="modal-body" id="video-detail-content">
                <!-- è¯¦æƒ…å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const params = new URLSearchParams({
            page: this.pagination.page,
            size: this.pagination.size,
            ...this.filters
          });
          
          const [videos, stats] = await Promise.all([
            App.apiClient.get(`/api/videos?${params}`).catch(() => ({ items: [], total: 0 })),
            App.apiClient.get('/api/videos/stats').catch(() => ({}))
          ]);
          
          this.videos = videos.items || [];
          this.pagination.total = videos.total || 0;
          this.stats = stats;
        } catch (error) {
          console.error('Failed to load videos data:', error);
        }
      }
      
      renderVideosTable() {
        if (!this.videos.length) {
          return '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— è§†é¢‘æ•°æ®</td></tr>';
        }
        
        return this.videos.map(video => `
          <tr>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-family: monospace; font-size: 12px;">
              ${video.id}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; max-width: 300px;">
              <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${video.title || ''}
              </div>
              <div style="font-size: 11px; color: #6b7280; font-family: monospace;">
                BV${video.bvid || ''}
              </div>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <div style="font-size: 12px;">${video.subscription_title || ''}</div>
              <div style="font-size: 10px; color: #6b7280;">ID: ${video.subscription_id || ''}</div>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <span class="status ${this.getFileStatusClass(video.file_status)}">${this.getFileStatusText(video.file_status)}</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px;">
              ${this.formatFileSize(video.file_size)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(video.upload_date)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <button class="btn btn-sm" onclick="videosModule.showVideoDetail(${video.id})">è¯¦æƒ…</button>
            </td>
          </tr>
        `).join('');
      }
      
      getFileStatusClass(status) {
        const classMap = {
          'exists': 'status-success',
          'missing': 'status-error',
          'partial': 'status-warning',
          'unknown': 'status-info'
        };
        return classMap[status] || 'status-info';
      }
      
      getFileStatusText(status) {
        const textMap = {
          'exists': 'æ–‡ä»¶å®Œæ•´',
          'missing': 'æ–‡ä»¶ç¼ºå¤±',
          'partial': 'éƒ¨åˆ†æ–‡ä»¶',
          'unknown': 'æœªçŸ¥'
        };
        return textMap[status] || 'æœªçŸ¥';
      }
      
      formatFileSize(bytes) {
        if (!bytes) return '-';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }
        
        return `${size.toFixed(1)} ${units[unitIndex]}`;
      }
      
      bindEvents() {
        window.videosModule = this;
        
        // ç»‘å®šç­›é€‰è¾“å…¥æ¡†çš„å›è½¦äº‹ä»¶
        ['status-filter', 'subscription-filter', 'search-filter'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                this.applyFilters();
              }
            });
          }
        });
      }
      
      async startScan() {
        const path = document.getElementById('scan-path').value.trim();
        
        try {
          await App.apiClient.post('/api/videos/scan', { path: path || null });
          alert('æ–‡ä»¶æ‰«æå·²å¼€å§‹ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœ');
          await this.refreshData();
        } catch (error) {
          alert('å¯åŠ¨æ‰«æå¤±è´¥: ' + error.message);
        }
      }
      
      applyFilters() {
        this.filters.status = document.getElementById('status-filter').value;
        this.filters.subscription_id = document.getElementById('subscription-filter').value;
        this.filters.search = document.getElementById('search-filter').value;
        this.pagination.page = 1;
        this.refreshData();
      }
      
      clearFilters() {
        this.filters = { status: '', subscription_id: '', search: '' };
        document.getElementById('status-filter').value = '';
        document.getElementById('subscription-filter').value = '';
        document.getElementById('search-filter').value = '';
        this.pagination.page = 1;
        this.refreshData();
      }
      
      async changePage(page) {
        if (page < 1 || page * this.pagination.size > this.pagination.total + this.pagination.size) {
          return;
        }
        this.pagination.page = page;
        await this.refreshData();
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('videos-table').innerHTML = this.renderVideosTable();
        // æ›´æ–°åˆ†é¡µä¿¡æ¯
        const content = await this.getContent();
        document.getElementById('main-content').innerHTML = content;
        this.bindEvents();
      }
      
      async showVideoDetail(videoId) {
        try {
          const video = await App.apiClient.get(`/api/videos/${videoId}`);
          const content = `
            <div style="display: grid; gap: 16px;">
              <div>
                <h4 style="margin: 0 0 8px 0;">åŸºæœ¬ä¿¡æ¯</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                  <div><strong>æ ‡é¢˜:</strong> ${video.title || ''}</div>
                  <div><strong>BVID:</strong> BV${video.bvid || ''}</div>
                  <div><strong>è®¢é˜…:</strong> ${video.subscription_title || ''} (ID: ${video.subscription_id || ''})</div>
                  <div><strong>ä¸Šä¼ æ—¶é—´:</strong> ${this.formatTime(video.upload_date)}</div>
                  <div><strong>æ—¶é•¿:</strong> ${video.duration || 0} ç§’</div>
                </div>
              </div>
              
              <div>
                <h4 style="margin: 0 0 8px 0;">æ–‡ä»¶ä¿¡æ¯</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                  <div><strong>çŠ¶æ€:</strong> <span class="status ${this.getFileStatusClass(video.file_status)}">${this.getFileStatusText(video.file_status)}</span></div>
                  <div><strong>æ–‡ä»¶å¤§å°:</strong> ${this.formatFileSize(video.file_size)}</div>
                  <div><strong>æ–‡ä»¶è·¯å¾„:</strong> ${video.file_path || 'æœªçŸ¥'}</div>
                  ${video.file_error ? `<div style="color: #dc2626;"><strong>é”™è¯¯ä¿¡æ¯:</strong> ${video.file_error}</div>` : ''}
                </div>
              </div>
              
              ${video.description ? `
              <div>
                <h4 style="margin: 0 0 8px 0;">è§†é¢‘æè¿°</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                  ${video.description.replace(/\n/g, '<br>')}
                </div>
              </div>
              ` : ''}
            </div>
          `;
          
          document.getElementById('video-detail-content').innerHTML = content;
          document.getElementById('video-detail-modal').classList.remove('hidden');
        } catch (error) {
          alert('åŠ è½½è§†é¢‘è¯¦æƒ…å¤±è´¥: ' + error.message);
        }
      }
      
      closeVideoDetail() {
        document.getElementById('video-detail-modal').classList.add('hidden');
      }
      
      async exportResults() {
        try {
          const params = new URLSearchParams({
            ...this.filters,
            export: 'csv'
          });
          
          const response = await fetch(`/api/videos?${params}`);
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `videos_export_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('å¯¼å‡ºå¤±è´¥: ' + error.message);
        }
      }
    }
    
    // åå°ç®¡ç†æ¨¡å—
    class BackendModule extends BaseModule {
      async render() {
        App.updatePageHeader('åå°ç®¡ç†', 'ç³»ç»Ÿåå°ç®¡ç†å’Œç»´æŠ¤å·¥å…·');
        await super.render();
      }
      
      async getContent() {
        return `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">åå°ç®¡ç†å·¥å…·</h3>
            </div>
            <div style="display: grid; gap: 16px;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/queue_admin.html', '_blank')">é˜Ÿåˆ—ç®¡ç†åå°</button>
                <span style="font-size: 12px; color: #6b7280;">åŸå§‹é˜Ÿåˆ—ç®¡ç†ç•Œé¢ï¼ŒåŒ…å«è¯¦ç»†çš„é˜Ÿåˆ—æ“ä½œåŠŸèƒ½</span>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/subscription_detail.html', '_blank')">è®¢é˜…è¯¦æƒ…é¡µé¢</button>
                <span style="font-size: 12px; color: #6b7280;">ç‹¬ç«‹çš„è®¢é˜…åŒæ­¥è¯¦æƒ…æŸ¥çœ‹é¡µé¢</span>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/test.html', '_blank')">APIæµ‹è¯•é¡µé¢</button>
                <span style="font-size: 12px; color: #6b7280;">ç”¨äºæµ‹è¯•APIæ¥å£çš„ç®€å•å·¥å…·é¡µé¢</span>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
            </div>
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" onclick="backendModule.restartScheduler()">é‡å¯è°ƒåº¦å™¨</button>
                <button class="btn" onclick="backendModule.clearCache()">æ¸…ç†ç¼“å­˜</button>
                <button class="btn" onclick="backendModule.checkHealth()">å¥åº·æ£€æŸ¥</button>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" onclick="backendModule.viewLogs()">æŸ¥çœ‹æ—¥å¿—</button>
                <button class="btn" onclick="backendModule.exportConfig()">å¯¼å‡ºé…ç½®</button>
                <button class="btn" onclick="backendModule.backupData()">å¤‡ä»½æ•°æ®</button>
              </div>
            </div>
          </div>
        `;
      }
      
      bindEvents() {
        window.backendModule = this;
      }
      
      async restartScheduler() {
        try {
          await App.apiClient.post('/api/scheduler/restart');
          alert('è°ƒåº¦å™¨é‡å¯æˆåŠŸ');
        } catch (error) {
          alert('é‡å¯è°ƒåº¦å™¨å¤±è´¥: ' + error.message);
        }
      }
      
      async clearCache() {
        try {
          await App.apiClient.post('/api/cache/clear');
          alert('ç¼“å­˜æ¸…ç†æˆåŠŸ');
        } catch (error) {
          alert('æ¸…ç†ç¼“å­˜å¤±è´¥: ' + error.message);
        }
      }
      
      async checkHealth() {
        try {
          const health = await App.apiClient.get('/api/health');
          alert('ç³»ç»Ÿå¥åº·çŠ¶æ€: ' + (health.status || 'OK'));
        } catch (error) {
          alert('å¥åº·æ£€æŸ¥å¤±è´¥: ' + error.message);
        }
      }
      
      async viewLogs() {
        window.open('/api/logs/view', '_blank');
      }
      
      async exportConfig() {
        try {
          const response = await fetch('/api/config/export');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `config_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('å¯¼å‡ºé…ç½®å¤±è´¥: ' + error.message);
        }
      }
      
      async backupData() {
        try {
          const response = await fetch('/api/backup/create');
          const result = await response.json();
          alert('æ•°æ®å¤‡ä»½æˆåŠŸ: ' + result.backup_file);
        } catch (error) {
          alert('æ•°æ®å¤‡ä»½å¤±è´¥: ' + error.message);
        }
      }
    }

    // ç³»ç»Ÿè®¾ç½®æ¨¡å—
    class SettingsModule extends BaseModule {
      constructor() {
        super();
        this.settings = {};
        this.cookies = [];
      }
      
      async render() {
        App.updatePageHeader('ç³»ç»Ÿè®¾ç½®', 'Cookieç®¡ç†å’Œè°ƒåº¦é…ç½®');
        await super.render();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="gap: 20px;">
            <!-- Cookieç®¡ç† -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Cookieç®¡ç†</h3>
                <button class="btn btn-sm btn-primary" onclick="settingsModule.showAddCookie()">æ·»åŠ Cookie</button>
              </div>
              <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                  Cookieç”¨äºè®¿é—®éœ€è¦ç™»å½•çš„Bç«™å†…å®¹ï¼Œå»ºè®®ä½¿ç”¨å°å·Cookieä»¥é¿å…é£é™©
                </div>
                <div id="cookies-list">
                  ${this.renderCookiesList()}
                </div>
              </div>
            </div>
            
            <!-- è°ƒåº¦é…ç½® -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">è°ƒåº¦é…ç½®</h3>
                <button class="btn btn-sm" onclick="settingsModule.saveScheduleSettings()">ä¿å­˜é…ç½®</button>
              </div>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="font-size: 12px; color: #6b7280;">åŒæ­¥æ£€æŸ¥é—´éš” (åˆ†é’Ÿ)</label>
                  <input id="sync-interval" type="number" min="1" value="${this.settings.sync_interval || 60}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">ä¸‹è½½é‡è¯•æ¬¡æ•°</label>
                  <input id="download-retries" type="number" min="0" value="${this.settings.download_retries || 3}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">è¯·æ±‚è¶…æ—¶æ—¶é—´ (ç§’)</label>
                  <input id="request-timeout" type="number" min="1" value="${this.settings.request_timeout || 30}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">ä¸‹è½½ç›®å½•</label>
                  <input id="download-path" value="${this.settings.download_path || ''}" class="form-input" placeholder="ç•™ç©ºä½¿ç”¨é»˜è®¤ç›®å½•" />
                </div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-2" style="gap: 20px; margin-top: 20px;">
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">ç³»ç»ŸçŠ¶æ€</h3>
                <button class="btn btn-sm" onclick="settingsModule.refreshStatus()">åˆ·æ–°</button>
              </div>
              <div id="system-status">
                ${this.renderSystemStatus()}
              </div>
            </div>
            
            <!-- æ—¥å¿—ç®¡ç† -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æ—¥å¿—ç®¡ç†</h3>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-sm" onclick="settingsModule.downloadLogs()">ä¸‹è½½æ—¥å¿—</button>
                  <button class="btn btn-sm" onclick="settingsModule.clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                </div>
              </div>
              <div>
                <select id="log-level" class="form-input" style="margin-bottom: 12px;">
                  <option value="DEBUG">DEBUG</option>
                  <option value="INFO" selected>INFO</option>
                  <option value="WARNING">WARNING</option>
                  <option value="ERROR">ERROR</option>
                </select>
                <button class="btn btn-sm" onclick="settingsModule.setLogLevel()">è®¾ç½®æ—¥å¿—çº§åˆ«</button>
              </div>
            </div>
          </div>
          
          <!-- æ•°æ®ç®¡ç† -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">æ•°æ®ç®¡ç†</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button class="btn" onclick="settingsModule.exportData()">å¯¼å‡ºæ•°æ®</button>
              <button class="btn" onclick="settingsModule.importData()">å¯¼å…¥æ•°æ®</button>
              <button class="btn" onclick="settingsModule.cleanupData()">æ¸…ç†è¿‡æœŸæ•°æ®</button>
              <div style="flex: 1;"></div>
              <button class="btn" style="background: #dc2626; color: white;" onclick="settingsModule.resetSystem()">é‡ç½®ç³»ç»Ÿ</button>
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
              å¯¼å‡º/å¯¼å…¥åŠŸèƒ½å¯ç”¨äºå¤‡ä»½å’Œè¿ç§»æ•°æ®ã€‚é‡ç½®ç³»ç»Ÿå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Œè¯·è°¨æ…æ“ä½œã€‚
            </div>
          </div>
          
          <!-- æ·»åŠ Cookieæ¨¡æ€æ¡† -->
          <div id="add-cookie-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3>æ·»åŠ Cookie</h3>
                <button class="modal-close" onclick="settingsModule.closeAddCookie()">&times;</button>
              </div>
              <div class="modal-body">
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">Cookieåç§°</label>
                  <input id="cookie-name" placeholder="ä¾‹å¦‚: ä¸»è´¦å·Cookie" class="form-input" />
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">Cookieå€¼</label>
                  <textarea id="cookie-value" placeholder="ç²˜è´´å®Œæ•´çš„Cookieå­—ç¬¦ä¸²" class="form-input" rows="4"></textarea>
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">å¤‡æ³¨</label>
                  <input id="cookie-note" placeholder="å¯é€‰çš„å¤‡æ³¨ä¿¡æ¯" class="form-input" />
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn" onclick="settingsModule.closeAddCookie()">å–æ¶ˆ</button>
                  <button class="btn btn-primary" onclick="settingsModule.saveCookie()">ä¿å­˜</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const [settings, cookies] = await Promise.all([
            App.apiClient.get('/api/settings').catch(() => ({})),
            App.apiClient.get('/api/cookies').catch(() => [])
          ]);
          
          this.settings = settings;
          this.cookies = cookies;
        } catch (error) {
          console.error('Failed to load settings data:', error);
        }
      }
      
      renderCookiesList() {
        if (!this.cookies.length) {
          return '<div style="text-align: center; padding: 20px; color: #6b7280;">æš‚æ— Cookieé…ç½®</div>';
        }
        
        return this.cookies.map(cookie => {
          const isValid = cookie.is_active !== false && (cookie.valid !== false);
          const statusText = !cookie.is_active ? 'å·²ç¦ç”¨' : (isValid ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ');
          const statusClass = !cookie.is_active ? 'status-warning' : (isValid ? 'status-success' : 'status-error');
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${cookie.name || 'æœªå‘½å'}</div>
                <div style="font-size: 12px; color: #6b7280;">
                  ${cookie.note || 'æ— å¤‡æ³¨'} | 
                  æ·»åŠ æ—¶é—´: ${this.formatTime(cookie.created_at)} |
                  çŠ¶æ€: <span class="status ${statusClass}">${statusText}</span>
                  ${cookie.failure_count > 0 ? ` | å¤±è´¥: ${cookie.failure_count}æ¬¡` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" onclick="settingsModule.testCookie(${cookie.id})">æµ‹è¯•</button>
                <button class="btn btn-sm" onclick="settingsModule.deleteCookie(${cookie.id})">åˆ é™¤</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      renderSystemStatus() {
        const status = this.settings.system_status || {};
        
        return `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>è°ƒåº¦å™¨çŠ¶æ€</span>
              <span class="status ${status.scheduler_running ? 'status-success' : 'status-error'}">
                ${status.scheduler_running ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>æ•°æ®åº“è¿æ¥</span>
              <span class="status ${status.database_connected ? 'status-success' : 'status-error'}">
                ${status.database_connected ? 'æ­£å¸¸' : 'å¼‚å¸¸'}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>ç£ç›˜ç©ºé—´</span>
              <span style="font-size: 12px; color: #6b7280;">${status.disk_usage || 'æœªçŸ¥'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>è¿è¡Œæ—¶é—´</span>
              <span style="font-size: 12px; color: #6b7280;">${status.uptime || 'æœªçŸ¥'}</span>
            </div>
          </div>
        `;
      }
      
      bindEvents() {
        window.settingsModule = this;
      }
      
      showAddCookie() {
        document.getElementById('add-cookie-modal').classList.remove('hidden');
      }
      
      closeAddCookie() {
        document.getElementById('add-cookie-modal').classList.add('hidden');
        document.getElementById('cookie-name').value = '';
        document.getElementById('cookie-value').value = '';
        document.getElementById('cookie-note').value = '';
      }
      
      async saveCookie() {
        const name = document.getElementById('cookie-name').value.trim();
        const value = document.getElementById('cookie-value').value.trim();
        const note = document.getElementById('cookie-note').value.trim();
        
        if (!name || !value) {
          alert('è¯·å¡«å†™Cookieåç§°å’Œå€¼');
          return;
        }
        
        try {
          await App.apiClient.post('/api/cookies', { name, value, note });
          await this.refreshData();
          this.closeAddCookie();
        } catch (error) {
          alert('ä¿å­˜Cookieå¤±è´¥: ' + error.message);
        }
      }
      
      async testCookie(cookieId) {
        try {
          const result = await App.apiClient.post(`/api/cookies/${cookieId}/validate`);
          
          // æ›´æ–°CookieçŠ¶æ€æ˜¾ç¤º
          const cookieIndex = this.cookies.findIndex(c => c.id === cookieId);
          if (cookieIndex !== -1) {
            this.cookies[cookieIndex].valid = result.valid && result.is_active;
            this.cookies[cookieIndex].failure_count = result.failure_count || 0;
            this.cookies[cookieIndex].last_failure_at = result.last_failure_at;
            this.cookies[cookieIndex].is_active = result.is_active;
          }
          
          // åˆ·æ–°Cookieåˆ—è¡¨æ˜¾ç¤º
          document.getElementById('cookies-list').innerHTML = this.renderCookiesList();
          
          let message = result.valid && result.is_active ? 'CookieéªŒè¯æœ‰æ•ˆ' : 'CookieéªŒè¯æ— æ•ˆ';
          if (result.failure_count > 0) {
            message += `\nå¤±è´¥æ¬¡æ•°: ${result.failure_count}`;
          }
          if (!result.is_active) {
            message += '\nçŠ¶æ€: å·²ç¦ç”¨';
          }
          
          alert(message);
          await this.refreshData();
        } catch (error) {
          alert('æµ‹è¯•Cookieå¤±è´¥: ' + error.message);
        }
      }
      
      async deleteCookie(cookieId) {
        if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªCookieå—ï¼Ÿ')) {
          return;
        }
        
        try {
          await App.apiClient.delete(`/api/cookies/${cookieId}`);
          await this.refreshData();
        } catch (error) {
          alert('åˆ é™¤Cookieå¤±è´¥: ' + error.message);
        }
      }
      
      async saveScheduleSettings() {
        try {
          const settings = {
            sync_interval: parseInt(document.getElementById('sync-interval').value),
            download_retries: parseInt(document.getElementById('download-retries').value),
            request_timeout: parseInt(document.getElementById('request-timeout').value),
            download_path: document.getElementById('download-path').value.trim()
          };
          
          await App.apiClient.post('/api/settings', settings);
          alert('é…ç½®å·²ä¿å­˜');
        } catch (error) {
          alert('ä¿å­˜é…ç½®å¤±è´¥: ' + error.message);
        }
      }
      
      async refreshStatus() {
        await this.loadData();
        document.getElementById('system-status').innerHTML = this.renderSystemStatus();
      }
      
      async setLogLevel() {
        try {
          const level = document.getElementById('log-level').value;
          await App.apiClient.post('/api/settings/log-level', { level });
          alert('æ—¥å¿—çº§åˆ«å·²è®¾ç½®ä¸º: ' + level);
        } catch (error) {
          alert('è®¾ç½®æ—¥å¿—çº§åˆ«å¤±è´¥: ' + error.message);
        }
      }
      
      async downloadLogs() {
        try {
          const response = await fetch('/api/logs/download');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('ä¸‹è½½æ—¥å¿—å¤±è´¥: ' + error.message);
        }
      }
      
      async clearLogs() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
          return;
        }
        
        try {
          await App.apiClient.post('/api/logs/clear');
          alert('æ—¥å¿—å·²æ¸…ç©º');
        } catch (error) {
          alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message);
        }
      }
      
      async exportData() {
        try {
          const response = await fetch('/api/data/export');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `data_export_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('å¯¼å‡ºæ•°æ®å¤±è´¥: ' + error.message);
        }
      }
      
      async importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const formData = new FormData();
          formData.append('file', file);
          
          try {
            await fetch('/api/data/import', {
              method: 'POST',
              body: formData
            });
            alert('æ•°æ®å¯¼å…¥æˆåŠŸ');
            await this.refreshData();
          } catch (error) {
            alert('å¯¼å…¥æ•°æ®å¤±è´¥: ' + error.message);
          }
        };
        
        input.click();
      }
      
      async cleanupData() {
        if (!confirm('ç¡®å®šè¦æ¸…ç†è¿‡æœŸæ•°æ®å—ï¼Ÿè¿™å°†åˆ é™¤è¶…è¿‡30å¤©çš„æ—¥å¿—å’Œä¸´æ—¶æ–‡ä»¶ã€‚')) {
          return;
        }
        
        try {
          await App.apiClient.post('/api/data/cleanup');
          alert('æ•°æ®æ¸…ç†å®Œæˆ');
        } catch (error) {
          alert('æ•°æ®æ¸…ç†å¤±è´¥: ' + error.message);
        }
      }
      
      async resetSystem() {
        const confirmation = prompt('æ­¤æ“ä½œå°†æ¸…ç©ºæ‰€æœ‰æ•°æ®å¹¶é‡ç½®ç³»ç»Ÿï¼è¯·è¾“å…¥"RESET"ç¡®è®¤ï¼š');
        if (confirmation !== 'RESET') {
          return;
        }
        
        try {
          await App.apiClient.post('/api/system/reset');
          alert('ç³»ç»Ÿé‡ç½®å®Œæˆï¼Œé¡µé¢å°†åˆ·æ–°');
          window.location.reload();
        } catch (error) {
          alert('ç³»ç»Ÿé‡ç½®å¤±è´¥: ' + error.message);
        }
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('cookies-list').innerHTML = this.renderCookiesList();
        document.getElementById('system-status').innerHTML = this.renderSystemStatus();
      }
    }
    
    // å¯åŠ¨åº”ç”¨
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
    });
  </script>
</body>
</html>

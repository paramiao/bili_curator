<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bili Curator 管理后台</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
      background: #f5f5f5;
      color: #1f2937;
      line-height: 1.6;
    }
    
    /* 布局结构 */
    .admin-layout {
      display: flex;
      min-height: 100vh;
    }
    
    /* 侧边栏 */
    .sidebar {
      width: 240px;
      background: #1f2937;
      color: #fff;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 1000;
    }
    
    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #374151;
    }
    
    .sidebar-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .sidebar-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }
    
    .sidebar-nav {
      padding: 20px 0;
    }
    
    .nav-item {
      display: block;
      padding: 12px 20px;
      color: #d1d5db;
      text-decoration: none;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }
    
    .nav-item:hover {
      background: #374151;
      color: #fff;
    }
    
    .nav-item.active {
      background: #3b82f6;
      color: #fff;
    }
    
    .nav-item .nav-icon {
      display: inline-block;
      width: 16px;
      margin-right: 8px;
    }
    
    /* 主内容区 */
    .main-content {
      flex: 1;
      margin-left: 240px;
      padding: 0;
    }
    
    .content-header {
      background: #fff;
      padding: 20px 30px;
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .content-title {
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 4px;
    }
    
    .content-subtitle {
      color: #6b7280;
      font-size: 14px;
    }
    
    .content-body {
      padding: 30px;
      max-width: 1200px;
    }
    
    /* 通用组件样式 */
    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
    }
    
    .grid {
      display: grid;
      gap: 20px;
    }
    
    .grid-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-4 { grid-template-columns: repeat(4, 1fr); }
    
    @media (max-width: 768px) {
      .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
    }
    
    /* 按钮样式 */
    .btn {
      display: inline-flex;
      align-items: center;
      padding: 8px 16px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      background: #fff;
      color: #374151;
      text-decoration: none;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    .btn:hover {
      background: #f9fafb;
      border-color: #9ca3af;
    }
    
    .btn-primary {
      background: #3b82f6;
      color: #fff;
      border-color: #2563eb;
    }
    
    .btn-primary:hover {
      background: #2563eb;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* 表单样式 */
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      font-size: 14px;
    }
    
    .form-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* 状态指示器 */
    .status {
      display: inline-flex;
      align-items: center;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .status-info {
      background: #dbeafe;
      color: #1e40af;
    }
    
    /* 加载状态 */
    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
    }
    
    .error {
      text-align: center;
      padding: 40px;
      color: #dc2626;
    }
    
    /* 模态框样式 */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    
    .modal-content {
      background: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-close:hover {
      color: #374151;
    }
    
    .modal-body {
      padding: 20px;
    }
    
    /* 隐藏类 */
    .hidden {
      display: none !important;
    }
    
    /* 响应式设计 */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
        transition: transform 0.3s;
      }
      
      .sidebar.open {
        transform: translateX(0);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .content-body {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="admin-layout">
    <!-- 侧边栏 -->
    <nav class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Bili Curator</div>
        <div class="sidebar-subtitle">管理后台 v6.0</div>
      </div>
      
      <div class="sidebar-nav">
        <button class="nav-item active" data-module="dashboard">
          <span class="nav-icon">📊</span>
          仪表板
        </button>
        <button class="nav-item" data-module="subscriptions">
          <span class="nav-icon">📺</span>
          订阅管理
        </button>
        <button class="nav-item" data-module="queue">
          <span class="nav-icon">⚡</span>
          队列监控
        </button>
        <button class="nav-item" data-module="videos">
          <span class="nav-icon">🎬</span>
          视频检测
        </button>
        <button class="nav-item" data-module="settings">
          <span class="nav-icon">⚙️</span>
          系统设置
        </button>
        <button class="nav-item" data-module="backend">
          <span class="nav-icon">🔧</span>
          后台管理
        </button>
      </div>
    </nav>
    
    <!-- 主内容区 -->
    <main class="main-content">
      <header class="content-header">
        <h1 class="content-title" id="page-title">仪表板</h1>
        <p class="content-subtitle" id="page-subtitle">系统概览和关键指标</p>
      </header>
      
      <div class="content-body" id="content-body">
        <!-- 内容将在这里动态加载 -->
        <div class="loading">加载中...</div>
      </div>
    </main>
  </div>

  <script>
    // 全局应用状态
    const App = {
      currentModule: 'dashboard',
      modules: {},
      apiClient: null,
      
      init() {
        this.setupApiClient();
        this.setupNavigation();
        this.loadModule('dashboard');
      },
      
      setupApiClient() {
        this.apiClient = new ApiClient();
      },
      
      setupNavigation() {
        const navItems = document.querySelectorAll('.nav-item');
        navItems.forEach(item => {
          item.addEventListener('click', (e) => {
            const module = e.target.closest('.nav-item').dataset.module;
            this.loadModule(module);
          });
        });
      },
      
      async loadModule(moduleName) {
        if (this.currentModule === moduleName) return;
        
        // 更新导航状态
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.toggle('active', item.dataset.module === moduleName);
        });
        
        this.currentModule = moduleName;
        
        // 加载模块
        try {
          const module = await this.getModule(moduleName);
          await module.render();
        } catch (error) {
          console.error('Failed to load module:', error);
          this.showError('加载模块失败: ' + error.message);
        }
      },
      
      async getModule(moduleName) {
        if (!this.modules[moduleName]) {
          this.modules[moduleName] = new (this.getModuleClass(moduleName))();
        }
        return this.modules[moduleName];
      },
      
      getModuleClass(moduleName) {
        const moduleClasses = {
          dashboard: DashboardModule,
          subscriptions: SubscriptionsModule,
          queue: QueueModule,
          videos: VideosModule,
          settings: SettingsModule,
          backend: BackendModule
        };
        return moduleClasses[moduleName] || DashboardModule;
      },
      
      updatePageHeader(title, subtitle) {
        document.getElementById('page-title').textContent = title;
        document.getElementById('page-subtitle').textContent = subtitle;
      },
      
      showError(message) {
        document.getElementById('content-body').innerHTML = `
          <div class="error">${message}</div>
        `;
      }
    };
    
    // API 客户端
    class ApiClient {
      async get(path) {
        const response = await fetch(path);
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async post(path, data) {
        const response = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async put(path, data) {
        const response = await fetch(path, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
      
      async delete(path) {
        const response = await fetch(path, { method: 'DELETE' });
        if (!response.ok) throw new Error(await response.text());
        return response.json();
      }
    }
    
    // 基础模块类
    class BaseModule {
      constructor() {
        this.container = document.getElementById('content-body');
      }
      
      async render() {
        this.container.innerHTML = '<div class="loading">加载中...</div>';
        try {
          const content = await this.getContent();
          this.container.innerHTML = content;
          this.bindEvents();
        } catch (error) {
          this.container.innerHTML = `<div class="error">加载失败: ${error.message}</div>`;
        }
      }
      
      async getContent() {
        return '<div>模块内容</div>';
      }
      
      bindEvents() {
        // 子类重写
      }
      
      formatTime(timeStr) {
        if (!timeStr) return '未知';
        try {
          return new Date(timeStr).toLocaleString();
        } catch {
          return timeStr;
        }
      }
    }
    
    // 仪表板模块
    class DashboardModule extends BaseModule {
      async render() {
        App.updatePageHeader('仪表板', '系统概览和关键指标');
        await super.render();
      }
      
      async getContent() {
        // 获取系统统计数据
        const [subscriptions, queueStats] = await Promise.all([
          App.apiClient.get('/api/subscriptions').catch(() => ({ items: [] })),
          App.apiClient.get('/api/queue/stats').catch(() => ({}))
        ]);
        
        const activeSubscriptions = subscriptions.items?.filter(s => s.is_active).length || 0;
        const totalSubscriptions = subscriptions.items?.length || 0;
        const runningTasks = queueStats.counts?.running || 0;
        const queuedTasks = queueStats.counts?.queued || 0;
        
        return `
          <div class="grid grid-4">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">活跃订阅</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #059669;">${activeSubscriptions}</div>
              <div style="color: #6b7280; font-size: 14px;">总共 ${totalSubscriptions} 个订阅</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">运行中任务</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #3b82f6;">${runningTasks}</div>
              <div style="color: #6b7280; font-size: 14px;">队列中 ${queuedTasks} 个</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">系统状态</h3>
              </div>
              <div style="font-size: 32px; font-weight: 700; color: #059669;">正常</div>
              <div style="color: #6b7280; font-size: 14px;">所有服务运行中</div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">最后更新</h3>
              </div>
              <div style="font-size: 16px; font-weight: 600;">${this.formatTime(new Date().toISOString())}</div>
              <div style="color: #6b7280; font-size: 14px;">自动刷新</div>
            </div>
          </div>
          
          <div class="grid grid-2">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">快速操作</h3>
              </div>
              <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <button class="btn btn-primary" onclick="App.loadModule('subscriptions')">管理订阅</button>
                <button class="btn btn-primary" onclick="App.loadModule('queue')">查看队列</button>
                <button class="btn" onclick="location.reload()">刷新数据</button>
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">系统信息</h3>
              </div>
              <div style="color: #6b7280; font-size: 14px; line-height: 1.8;">
                <div>版本: Bili Curator v6.0</div>
                <div>运行时间: ${this.getUptime()}</div>
                <div>数据库: SQLite</div>
                <div>下载引擎: yt-dlp</div>
              </div>
            </div>
          </div>
        `;
      }
      
      getUptime() {
        // 简单的运行时间显示
        const start = new Date();
        start.setHours(0, 0, 0, 0);
        const now = new Date();
        const diff = now - start;
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        return `${hours}小时${minutes}分钟`;
      }
    }
    
    // 订阅管理模块
    class SubscriptionsModule extends BaseModule {
      constructor() {
        super();
        this.subscriptions = [];
        this.syncOverview = {};
        this.selectedIds = new Set();
        this.poller = null;
      }
      
      async render() {
        App.updatePageHeader('订阅管理', '管理所有订阅和同步状态');
        await super.render();
        this.startPolling();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">批量操作</h3>
              </div>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn" onclick="subscriptionsModule.selectAll()">全选</button>
                <button class="btn" onclick="subscriptionsModule.clearSelection()">清空</button>
                <button class="btn btn-primary" onclick="subscriptionsModule.batchSync()">批量同步</button>
                <button class="btn" onclick="subscriptionsModule.batchToggleActive()">切换状态</button>
              </div>
              <div style="margin-top: 8px; font-size: 12px; color: #6b7280;">
                已选择 <span id="selected-count">0</span> 个订阅
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">同步概览</h3>
                <button class="btn btn-sm" onclick="subscriptionsModule.refreshData()">刷新</button>
              </div>
              <div class="grid grid-3" style="gap: 12px;">
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #059669;" id="running-count">0</div>
                  <div style="font-size: 12px; color: #6b7280;">同步中</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #dc2626;" id="pending-count">0</div>
                  <div style="font-size: 12px; color: #6b7280;">待下载</div>
                </div>
                <div style="text-align: center;">
                  <div style="font-size: 20px; font-weight: 700; color: #3b82f6;" id="total-videos">0</div>
                  <div style="font-size: 12px; color: #6b7280;">总视频数</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">订阅列表</h3>
              <button class="btn btn-primary" onclick="subscriptionsModule.showAddModal()">添加订阅</button>
            </div>
            <div class="subscription-list" id="subscription-list">
              ${this.renderSubscriptionList()}
            </div>
          </div>
          
          <!-- 订阅详情模态框 -->
          <div id="subscription-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3 id="modal-title">订阅详情</h3>
                <button class="modal-close" onclick="subscriptionsModule.closeModal()">&times;</button>
              </div>
              <div class="modal-body" id="modal-body">
                <!-- 内容动态加载 -->
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          // 加载订阅列表
          const subscriptionsResponse = await App.apiClient.get('/api/subscriptions').catch(() => ({ items: [] }));
          this.subscriptions = subscriptionsResponse.items || subscriptionsResponse || [];
          
          // 获取同步状态概览
          this.syncOverview = { items: [] };
          if (this.subscriptions.length > 0) {
            const ids = this.subscriptions.map(s => s.id);
            try {
              this.syncOverview = await App.apiClient.post('/api/subscriptions/sync_overview', {
                subscription_ids: ids
              });
            } catch (error) {
              console.warn('Failed to load sync overview:', error);
              this.syncOverview = { items: [] };
            }
          }
        } catch (error) {
          console.error('Failed to load subscriptions:', error);
          this.subscriptions = [];
          this.syncOverview = { items: [] };
        }
      }
      
      renderSubscriptionList() {
        if (!this.subscriptions.length) {
          return '<div style="text-align: center; padding: 40px; color: #6b7280;">暂无订阅</div>';
        }
        
        return this.subscriptions.map(sub => {
          const syncData = this.syncOverview.items?.find(s => s.id === sub.id) || {};
          const statusClass = this.getStatusClass(syncData.status);
          const statusText = this.getStatusText(syncData.status);
          
          return `
            <div class="subscription-item" style="display: flex; align-items: center; padding: 16px; border-bottom: 1px solid #e5e7eb;">
              <input type="checkbox" class="subscription-checkbox" value="${sub.id}" 
                     onchange="subscriptionsModule.updateSelection()" style="margin-right: 12px;">
              
              <div style="flex: 1;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                  <div>
                    <div style="font-weight: 600; margin-bottom: 4px;">${sub.name}</div>
                    <div style="color: #6b7280; font-size: 14px;">
                      ${sub.type} • ${sub.is_active ? '活跃' : '已暂停'} • 
                      ${sub.video_count || 0} 个视频
                    </div>
                  </div>
                  <div style="text-align: right;">
                    <div class="status ${statusClass}" style="margin-bottom: 4px;">${statusText}</div>
                    <div style="font-size: 12px; color: #6b7280;">
                      ${this.formatTime(syncData.updated_at)}
                    </div>
                  </div>
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div style="display: flex; gap: 16px; font-size: 12px;">
                    <span style="color: ${syncData.pending > 0 ? '#dc2626' : '#6b7280'};">
                      待下载: ${syncData.pending || 0}
                    </span>
                    <span style="color: #6b7280;">
                      总数: ${syncData.remote_total || 0}
                    </span>
                  </div>
                  
                  <div style="display: flex; gap: 8px;">
                    <button class="btn btn-sm" onclick="subscriptionsModule.viewSyncDetail(${sub.id})">
                      同步详情
                    </button>
                    <button class="btn btn-sm" onclick="subscriptionsModule.editSubscription(${sub.id})">
                      编辑
                    </button>
                    <button class="btn btn-sm" onclick="subscriptionsModule.toggleActive(${sub.id})">
                      ${sub.is_active ? '暂停' : '启用'}
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        }).join('');
      }
      
      bindEvents() {
        // 将模块实例绑定到全局，供onclick使用
        window.subscriptionsModule = this;
        this.updateSummary();
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-success',
          'completed': 'status-info',
          'failed': 'status-error',
          'idle': 'status-warning'
        };
        return classMap[status] || 'status-info';
      }
      
      getStatusText(status) {
        const textMap = {
          'running': '同步中',
          'completed': '已完成',
          'failed': '失败',
          'idle': '空闲'
        };
        return textMap[status] || '未知';
      }
      
      updateSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        this.selectedIds.clear();
        checkboxes.forEach(cb => {
          if (cb.checked) {
            this.selectedIds.add(parseInt(cb.value));
          }
        });
        document.getElementById('selected-count').textContent = this.selectedIds.size;
      }
      
      selectAll() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        this.updateSelection();
      }
      
      clearSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        this.updateSelection();
      }
      
      async batchSync() {
        if (this.selectedIds.size === 0) {
          alert('请先选择要同步的订阅');
          return;
        }
        
        if (!confirm(`确定要同步选中的 ${this.selectedIds.size} 个订阅吗？`)) {
          return;
        }
        
        // 这里调用批量同步API
        console.log('Batch sync subscriptions:', Array.from(this.selectedIds));
        alert('同步任务已提交，请稍后查看状态');
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('subscription-list').innerHTML = this.renderSubscriptionList();
        this.updateSummary();
      }
      
      updateSummary() {
        const syncItems = this.syncOverview.items || [];
        const runningCount = syncItems.filter(s => s.status === 'running').length;
        const pendingCount = syncItems.reduce((sum, s) => sum + (s.pending || 0), 0);
        const totalVideos = syncItems.reduce((sum, s) => sum + (s.remote_total || 0), 0);
        
        document.getElementById('running-count').textContent = runningCount;
        document.getElementById('pending-count').textContent = pendingCount;
        document.getElementById('total-videos').textContent = totalVideos;
      }
      
      async viewSyncDetail(subscriptionId) {
        try {
          const [status, trace] = await Promise.all([
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_status`),
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_trace`)
          ]);
          
          this.showSyncDetailModal(subscriptionId, status, trace);
        } catch (error) {
          alert('获取同步详情失败: ' + error.message);
        }
      }
      
      showSyncDetailModal(subscriptionId, status, trace) {
        const subscription = this.subscriptions.find(s => s.id === subscriptionId);
        
        document.getElementById('modal-title').textContent = `${subscription.name} - 同步详情`;
        document.getElementById('modal-body').innerHTML = `
          <div style="margin-bottom: 20px;">
            <h4 style="margin-bottom: 12px;">同步状态</h4>
            <div class="grid grid-3" style="gap: 12px;">
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: ${status.pending > 0 ? '#dc2626' : '#059669'};">
                  ${status.pending || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">待下载</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">
                  ${status.remote_total || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">远端总数</div>
              </div>
              <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                <div style="font-size: 18px; font-weight: 700; color: #059669;">
                  ${status.existing || 0}
                </div>
                <div style="font-size: 12px; color: #6b7280;">已存在</div>
              </div>
            </div>
            
            <div style="margin-top: 12px; font-size: 12px; color: #6b7280;">
              状态: <span class="status ${this.getStatusClass(status.status)}">${this.getStatusText(status.status)}</span> • 
              更新时间: ${this.formatTime(status.updated_at)}
            </div>
          </div>
          
          <div>
            <h4 style="margin-bottom: 12px;">事件时间线</h4>
            <div style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 12px;">
              ${this.renderTraceEvents(trace.events || [])}
            </div>
          </div>
        `;
        
        this.showModal();
      }
      
      renderTraceEvents(events) {
        if (!events.length) {
          return '<div style="text-align: center; color: #6b7280;">暂无事件记录</div>';
        }
        
        return events.slice(-10).reverse().map(event => {
          const isError = event.type.includes('failed');
          const iconColor = isError ? '#dc2626' : '#059669';
          
          return `
            <div style="display: flex; gap: 12px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #f3f4f6;">
              <div style="width: 8px; height: 8px; border-radius: 50%; background: ${iconColor}; margin-top: 6px; flex-shrink: 0;"></div>
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px;">${this.getEventTypeText(event.type)}</div>
                <div style="font-size: 12px; color: #6b7280;">
                  ${this.formatTime(event.ts)}
                  ${event.range ? ` • 范围: ${event.range}` : ''}
                  ${event.count ? ` • 数量: ${event.count}` : ''}
                  ${event.duration_ms ? ` • 耗时: ${event.duration_ms}ms` : ''}
                </div>
                ${event.error ? `<div style="font-size: 12px; color: #dc2626; margin-top: 4px;">错误: ${event.error}</div>` : ''}
              </div>
            </div>
          `;
        }).join('');
      }
      
      getEventTypeText(type) {
        const typeMap = {
          'list_start': '开始获取列表',
          'chunk_ok': '分页获取成功',
          'chunk_failed': '分页获取失败',
          'list_done': '列表获取完成',
          'list_failed': '列表获取失败'
        };
        return typeMap[type] || type;
      }
      
      showModal() {
        document.getElementById('subscription-modal').classList.remove('hidden');
      }
      
      closeModal() {
        document.getElementById('subscription-modal').classList.add('hidden');
      }
      
      startPolling() {
        this.stopPolling();
        this.poller = setInterval(() => {
          this.refreshData();
        }, 10000); // 10秒刷新一次
      }
      
      stopPolling() {
        if (this.poller) {
          clearInterval(this.poller);
          this.poller = null;
        }
      }
      
      // 缺失的方法实现
      updateSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        const checked = Array.from(checkboxes).filter(cb => cb.checked);
        this.selectedIds = checked.map(cb => parseInt(cb.value));
        this.updateSummary();
      }
      
      updateSummary() {
        const summaryElement = document.getElementById('selection-summary');
        if (summaryElement) {
          summaryElement.textContent = `已选择 ${this.selectedIds.length} 个订阅`;
        }
      }
      
      selectAll() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = true);
        this.updateSelection();
      }
      
      clearSelection() {
        const checkboxes = document.querySelectorAll('.subscription-checkbox');
        checkboxes.forEach(cb => cb.checked = false);
        this.updateSelection();
      }
      
      async batchSync() {
        if (this.selectedIds.length === 0) {
          alert('请先选择要同步的订阅');
          return;
        }
        
        try {
          await App.apiClient.post('/api/subscriptions/batch_sync', {
            subscription_ids: this.selectedIds
          });
          alert(`已启动 ${this.selectedIds.length} 个订阅的同步任务`);
          this.clearSelection();
          await this.refreshData();
        } catch (error) {
          alert('批量同步失败: ' + error.message);
        }
      }
      
      async batchToggle() {
        if (this.selectedIds.length === 0) {
          alert('请先选择要操作的订阅');
          return;
        }
        
        try {
          await App.apiClient.post('/api/subscriptions/batch_toggle', {
            subscription_ids: this.selectedIds
          });
          alert(`已切换 ${this.selectedIds.length} 个订阅的状态`);
          this.clearSelection();
          await this.refreshData();
        } catch (error) {
          alert('批量切换状态失败: ' + error.message);
        }
      }
      
      async viewSyncDetail(subscriptionId) {
        try {
          const [syncStatus, syncTrace] = await Promise.all([
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_status`),
            App.apiClient.get(`/api/subscriptions/${subscriptionId}/sync_trace`)
          ]);
          
          const subscription = this.subscriptions.find(s => s.id === subscriptionId);
          
          document.getElementById('modal-title').textContent = `${subscription?.name || '订阅'} - 同步详情`;
          document.getElementById('modal-body').innerHTML = this.renderSyncDetail(syncStatus, syncTrace);
          this.showModal();
        } catch (error) {
          alert('加载同步详情失败: ' + error.message);
        }
      }
      
      async editSubscription(subscriptionId) {
        alert('编辑功能开发中...');
      }
      
      async toggleActive(subscriptionId) {
        try {
          await App.apiClient.post(`/api/subscriptions/${subscriptionId}/toggle`);
          await this.refreshData();
        } catch (error) {
          alert('切换订阅状态失败: ' + error.message);
        }
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-warning',
          'completed': 'status-success',
          'failed': 'status-error',
          'idle': 'status-info'
        };
        return classMap[status] || 'status-info';
      }
      
      getStatusText(status) {
        const textMap = {
          'running': '同步中',
          'completed': '已完成',
          'failed': '失败',
          'idle': '空闲'
        };
        return textMap[status] || '未知';
      }
      
      async refreshData() {
        await this.loadData();
        const listElement = document.getElementById('subscription-list');
        if (listElement) {
          listElement.innerHTML = this.renderSubscriptionList();
        }
        this.updateSummary();
      }
    }
    
    // 队列监控模块
    class QueueModule extends BaseModule {
      constructor() {
        super();
        this.queueStats = {};
        this.requests = [];
        this.poller = null;
      }
      
      async render() {
        App.updatePageHeader('队列监控', '监控请求队列和下载任务');
        await super.render();
        this.startPolling();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">暂停/恢复控制</h3>
              </div>
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 12px;">
                <select id="pause-scope" class="form-input" style="width: auto;">
                  <option value="all">全部(all)</option>
                  <option value="requires_cookie">需要Cookie</option>
                  <option value="no_cookie">无需Cookie</option>
                </select>
                <button class="btn" onclick="queueModule.pauseQueue()">暂停</button>
                <button class="btn btn-primary" onclick="queueModule.resumeQueue()">恢复</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                暂停仅阻止新任务进入运行，已在运行中的任务不被强制中断
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">并发配置</h3>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                <div>
                  <label style="font-size: 12px; color: #6b7280;">需要Cookie:</label>
                  <input id="cap-cookie" type="number" min="0" value="1" class="form-input" style="width: 80px;" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">无需Cookie:</label>
                  <input id="cap-nocookie" type="number" min="0" value="2" class="form-input" style="width: 80px;" />
                </div>
                <button class="btn btn-primary" onclick="queueModule.applyCapacity()">应用</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                修改后立即生效。设置为 0 表示禁止该通道的新任务进入运行
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-bottom: 20px;">
            <div class="card-header">
              <h3 class="card-title">队列总览 <span id="queue-status-badge" class="status">-</span></h3>
              <button class="btn btn-sm" onclick="queueModule.refreshData()">刷新</button>
            </div>
            <div class="grid grid-4" id="queue-stats">
              ${this.renderQueueStats()}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">任务操作</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
              <input id="job-id" placeholder="输入 job_id" class="form-input" style="width: 300px;" />
              <button class="btn" onclick="queueModule.cancelJob()">取消任务</button>
              <button class="btn" onclick="queueModule.prioritizeJob()">置顶优先</button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">请求列表</h3>
              <div style="font-size: 12px; color: #6b7280;">每 2 秒自动刷新</div>
            </div>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">Job ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">类型</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">订阅ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">需Cookie</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">状态</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">创建时间</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">开始时间</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">结束时间</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">错误信息</th>
                  </tr>
                </thead>
                <tbody id="requests-table">
                  ${this.renderRequestsTable()}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const [stats, requests] = await Promise.all([
            App.apiClient.get('/api/queue/stats').catch(() => ({})),
            App.apiClient.get('/api/requests').catch(() => ({ items: [] }))
          ]);
          
          this.queueStats = stats;
          this.requests = requests.items || requests || [];
        } catch (error) {
          console.error('Failed to load queue data:', error);
        }
      }
      
      renderQueueStats() {
        const stats = this.queueStats;
        const capacity = stats.capacity || {};
        const counts = stats.counts_by_channel || {};
        
        return `
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #059669;">
              ${capacity.requires_cookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">Cookie通道配置</div>
            <div style="font-size: 10px; color: #6b7280;">
              运行: ${capacity.running_cookie || 0} | 可用: ${capacity.available_cookie || 0}
            </div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #3b82f6;">
              ${capacity.no_cookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 4px;">无Cookie通道配置</div>
            <div style="font-size: 10px; color: #6b7280;">
              运行: ${capacity.running_nocookie || 0} | 可用: ${capacity.available_nocookie || 0}
            </div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #f59e0b;">
              ${counts.queued_cookie + counts.queued_nocookie || 0}
            </div>
            <div style="font-size: 12px; color: #6b7280;">排队任务</div>
          </div>
          
          <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
            <div style="font-size: 18px; font-weight: 700; color: #10b981;">
              ${(capacity.running_cookie || 0) + (capacity.running_nocookie || 0)}
            </div>
            <div style="font-size: 12px; color: #6b7280;">运行任务</div>
          </div>
        `;
      }
      
      renderRequestsTable() {
        if (!this.requests.length) {
          return '<tr><td colspan="9" style="text-align: center; padding: 20px; color: #6b7280;">暂无任务</td></tr>';
        }
        
        return this.requests.slice(0, 20).map(req => `
          <tr>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-family: monospace; font-size: 12px;">
              ${req.id}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.type || ''}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.subscription_id || ''}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">${req.requires_cookie ? '是' : '否'}</td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <span class="status ${this.getStatusClass(req.status)}">${req.status}</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.created_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.started_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(req.finished_at)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #dc2626; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
              ${req.last_error || ''}
            </td>
          </tr>
        `).join('');
      }
      
      getStatusClass(status) {
        const classMap = {
          'running': 'status-success',
          'queued': 'status-warning',
          'failed': 'status-error',
          'canceled': 'status-info',
          'completed': 'status-success'
        };
        return classMap[status] || 'status-info';
      }
      
      bindEvents() {
        window.queueModule = this;
        this.updateStatusBadge();
        this.updateCapacityInputs();
      }
      
      updateStatusBadge() {
        const badge = document.getElementById('queue-status-badge');
        const paused = this.queueStats.paused || {};
        const anyPaused = paused.all || paused.requires_cookie || paused.no_cookie;
        
        if (anyPaused) {
          badge.textContent = '已暂停';
          badge.className = 'status status-error';
        } else {
          badge.textContent = '运行中';
          badge.className = 'status status-success';
        }
      }
      
      updateCapacityInputs() {
        const capacity = this.queueStats.capacity || {};
        if (capacity.requires_cookie !== undefined) {
          document.getElementById('cap-cookie').value = capacity.requires_cookie;
        }
        if (capacity.no_cookie !== undefined) {
          document.getElementById('cap-nocookie').value = capacity.no_cookie;
        }
      }
      
      async pauseQueue() {
        try {
          const scope = document.getElementById('pause-scope').value;
          await App.apiClient.post('/api/queue/pause', { scope });
          await this.refreshData();
        } catch (error) {
          alert('暂停队列失败: ' + error.message);
        }
      }
      
      async resumeQueue() {
        try {
          const scope = document.getElementById('pause-scope').value;
          await App.apiClient.post('/api/queue/resume', { scope });
          await this.refreshData();
        } catch (error) {
          alert('恢复队列失败: ' + error.message);
        }
      }
      
      async applyCapacity() {
        try {
          const requires_cookie = parseInt(document.getElementById('cap-cookie').value);
          const no_cookie = parseInt(document.getElementById('cap-nocookie').value);
          
          await App.apiClient.post('/api/queue/capacity', { requires_cookie, no_cookie });
          await this.refreshData();
        } catch (error) {
          alert('设置并发失败: ' + error.message);
        }
      }
      
      async cancelJob() {
        const jobId = document.getElementById('job-id').value.trim();
        if (!jobId) {
          alert('请输入 job_id');
          return;
        }
        
        try {
          await App.apiClient.post(`/api/requests/${encodeURIComponent(jobId)}/cancel`);
          await this.refreshData();
          document.getElementById('job-id').value = '';
        } catch (error) {
          alert('取消任务失败: ' + error.message);
        }
      }
      
      async prioritizeJob() {
        const jobId = document.getElementById('job-id').value.trim();
        if (!jobId) {
          alert('请输入 job_id');
          return;
        }
        
        try {
          await App.apiClient.post(`/api/requests/${encodeURIComponent(jobId)}/prioritize`, { priority: 0 });
          await this.refreshData();
          document.getElementById('job-id').value = '';
        } catch (error) {
          alert('置顶任务失败: ' + error.message);
        }
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('queue-stats').innerHTML = this.renderQueueStats();
        document.getElementById('requests-table').innerHTML = this.renderRequestsTable();
        this.updateStatusBadge();
        this.updateCapacityInputs();
      }
      
      startPolling() {
        this.stopPolling();
        this.poller = setInterval(() => {
          this.refreshData();
        }, 2000);
      }
      
      stopPolling() {
        if (this.poller) {
          clearInterval(this.poller);
          this.poller = null;
        }
      }
    }
    
    // 视频检测模块
    class VideosModule extends BaseModule {
      constructor() {
        super();
        this.videos = [];
        this.stats = {};
        this.filters = {
          status: '',
          subscription_id: '',
          search: ''
        };
        this.pagination = {
          page: 1,
          size: 20,
          total: 0
        };
      }
      
      async render() {
        App.updatePageHeader('视频检测', '文件扫描和匹配状态');
        await super.render();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="margin-bottom: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">文件扫描</h3>
              </div>
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 12px;">
                <input id="scan-path" placeholder="扫描路径 (留空使用默认)" class="form-input" style="flex: 1;" />
                <button class="btn btn-primary" onclick="videosModule.startScan()">开始扫描</button>
              </div>
              <div style="font-size: 12px; color: #6b7280;">
                扫描指定目录下的视频文件，检测文件完整性和匹配状态
              </div>
            </div>
            
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">统计信息</h3>
              </div>
              <div class="grid grid-2" style="gap: 12px;">
                <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                  <div style="font-size: 18px; font-weight: 700; color: #059669;">
                    ${this.stats.total || 0}
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">视频总数</div>
                </div>
                <div style="text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px;">
                  <div style="font-size: 18px; font-weight: 700; color: #dc2626;">
                    ${this.stats.missing || 0}
                  </div>
                  <div style="font-size: 12px; color: #6b7280;">缺失文件</div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">筛选条件</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 16px;">
              <select id="status-filter" class="form-input" style="width: 150px;">
                <option value="">全部状态</option>
                <option value="exists">文件存在</option>
                <option value="missing">文件缺失</option>
                <option value="partial">部分文件</option>
              </select>
              <input id="subscription-filter" placeholder="订阅ID" class="form-input" style="width: 120px;" />
              <input id="search-filter" placeholder="搜索标题或文件名" class="form-input" style="flex: 1;" />
              <button class="btn" onclick="videosModule.applyFilters()">筛选</button>
              <button class="btn btn-sm" onclick="videosModule.clearFilters()">清空</button>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">视频列表</h3>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" onclick="videosModule.refreshData()">刷新</button>
                <button class="btn btn-sm" onclick="videosModule.exportResults()">导出结果</button>
              </div>
            </div>
            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background: #f9fafb;">
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">ID</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">标题</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">订阅</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">文件状态</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">文件大小</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">上传时间</th>
                    <th style="padding: 8px; text-align: left; border-bottom: 1px solid #e5e7eb;">操作</th>
                  </tr>
                </thead>
                <tbody id="videos-table">
                  ${this.renderVideosTable()}
                </tbody>
              </table>
            </div>
            
            <div style="display: flex; justify-content: between; align-items: center; margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
              <div style="font-size: 14px; color: #6b7280;">
                显示 ${Math.min((this.pagination.page - 1) * this.pagination.size + 1, this.pagination.total)} - 
                ${Math.min(this.pagination.page * this.pagination.size, this.pagination.total)} 
                共 ${this.pagination.total} 条
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" ${this.pagination.page <= 1 ? 'disabled' : ''} 
                        onclick="videosModule.changePage(${this.pagination.page - 1})">上一页</button>
                <span style="padding: 6px 12px; font-size: 14px;">第 ${this.pagination.page} 页</span>
                <button class="btn btn-sm" ${this.pagination.page * this.pagination.size >= this.pagination.total ? 'disabled' : ''} 
                        onclick="videosModule.changePage(${this.pagination.page + 1})">下一页</button>
              </div>
            </div>
          </div>
          
          <!-- 视频详情模态框 -->
          <div id="video-detail-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3>视频详情</h3>
                <button class="modal-close" onclick="videosModule.closeVideoDetail()">&times;</button>
              </div>
              <div class="modal-body" id="video-detail-content">
                <!-- 详情内容将动态加载 -->
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const params = new URLSearchParams({
            page: this.pagination.page,
            size: this.pagination.size,
            ...this.filters
          });
          
          const [videos, stats] = await Promise.all([
            App.apiClient.get(`/api/videos?${params}`).catch(() => ({ items: [], total: 0 })),
            App.apiClient.get('/api/videos/stats').catch(() => ({}))
          ]);
          
          this.videos = videos.items || [];
          this.pagination.total = videos.total || 0;
          this.stats = stats;
        } catch (error) {
          console.error('Failed to load videos data:', error);
        }
      }
      
      renderVideosTable() {
        if (!this.videos.length) {
          return '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #6b7280;">暂无视频数据</td></tr>';
        }
        
        return this.videos.map(video => `
          <tr>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-family: monospace; font-size: 12px;">
              ${video.id}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; max-width: 300px;">
              <div style="font-weight: 500; margin-bottom: 2px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                ${video.title || ''}
              </div>
              <div style="font-size: 11px; color: #6b7280; font-family: monospace;">
                BV${video.bvid || ''}
              </div>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <div style="font-size: 12px;">${video.subscription_title || ''}</div>
              <div style="font-size: 10px; color: #6b7280;">ID: ${video.subscription_id || ''}</div>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <span class="status ${this.getFileStatusClass(video.file_status)}">${this.getFileStatusText(video.file_status)}</span>
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px;">
              ${this.formatFileSize(video.file_size)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6; font-size: 12px; color: #6b7280;">
              ${this.formatTime(video.upload_date)}
            </td>
            <td style="padding: 8px; border-bottom: 1px solid #f3f4f6;">
              <button class="btn btn-sm" onclick="videosModule.showVideoDetail(${video.id})">详情</button>
            </td>
          </tr>
        `).join('');
      }
      
      getFileStatusClass(status) {
        const classMap = {
          'exists': 'status-success',
          'missing': 'status-error',
          'partial': 'status-warning',
          'unknown': 'status-info'
        };
        return classMap[status] || 'status-info';
      }
      
      getFileStatusText(status) {
        const textMap = {
          'exists': '文件完整',
          'missing': '文件缺失',
          'partial': '部分文件',
          'unknown': '未知'
        };
        return textMap[status] || '未知';
      }
      
      formatFileSize(bytes) {
        if (!bytes) return '-';
        const units = ['B', 'KB', 'MB', 'GB'];
        let size = bytes;
        let unitIndex = 0;
        
        while (size >= 1024 && unitIndex < units.length - 1) {
          size /= 1024;
          unitIndex++;
        }
        
        return `${size.toFixed(1)} ${units[unitIndex]}`;
      }
      
      bindEvents() {
        window.videosModule = this;
        
        // 绑定筛选输入框的回车事件
        ['status-filter', 'subscription-filter', 'search-filter'].forEach(id => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                this.applyFilters();
              }
            });
          }
        });
      }
      
      async startScan() {
        const path = document.getElementById('scan-path').value.trim();
        
        try {
          await App.apiClient.post('/api/videos/scan', { path: path || null });
          alert('文件扫描已开始，请稍后查看结果');
          await this.refreshData();
        } catch (error) {
          alert('启动扫描失败: ' + error.message);
        }
      }
      
      applyFilters() {
        this.filters.status = document.getElementById('status-filter').value;
        this.filters.subscription_id = document.getElementById('subscription-filter').value;
        this.filters.search = document.getElementById('search-filter').value;
        this.pagination.page = 1;
        this.refreshData();
      }
      
      clearFilters() {
        this.filters = { status: '', subscription_id: '', search: '' };
        document.getElementById('status-filter').value = '';
        document.getElementById('subscription-filter').value = '';
        document.getElementById('search-filter').value = '';
        this.pagination.page = 1;
        this.refreshData();
      }
      
      async changePage(page) {
        if (page < 1 || page * this.pagination.size > this.pagination.total + this.pagination.size) {
          return;
        }
        this.pagination.page = page;
        await this.refreshData();
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('videos-table').innerHTML = this.renderVideosTable();
        // 更新分页信息
        const content = await this.getContent();
        document.getElementById('main-content').innerHTML = content;
        this.bindEvents();
      }
      
      async showVideoDetail(videoId) {
        try {
          const video = await App.apiClient.get(`/api/videos/${videoId}`);
          const content = `
            <div style="display: grid; gap: 16px;">
              <div>
                <h4 style="margin: 0 0 8px 0;">基本信息</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                  <div><strong>标题:</strong> ${video.title || ''}</div>
                  <div><strong>BVID:</strong> BV${video.bvid || ''}</div>
                  <div><strong>订阅:</strong> ${video.subscription_title || ''} (ID: ${video.subscription_id || ''})</div>
                  <div><strong>上传时间:</strong> ${this.formatTime(video.upload_date)}</div>
                  <div><strong>时长:</strong> ${video.duration || 0} 秒</div>
                </div>
              </div>
              
              <div>
                <h4 style="margin: 0 0 8px 0;">文件信息</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px;">
                  <div><strong>状态:</strong> <span class="status ${this.getFileStatusClass(video.file_status)}">${this.getFileStatusText(video.file_status)}</span></div>
                  <div><strong>文件大小:</strong> ${this.formatFileSize(video.file_size)}</div>
                  <div><strong>文件路径:</strong> ${video.file_path || '未知'}</div>
                  ${video.file_error ? `<div style="color: #dc2626;"><strong>错误信息:</strong> ${video.file_error}</div>` : ''}
                </div>
              </div>
              
              ${video.description ? `
              <div>
                <h4 style="margin: 0 0 8px 0;">视频描述</h4>
                <div style="background: #f9fafb; padding: 12px; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                  ${video.description.replace(/\n/g, '<br>')}
                </div>
              </div>
              ` : ''}
            </div>
          `;
          
          document.getElementById('video-detail-content').innerHTML = content;
          document.getElementById('video-detail-modal').classList.remove('hidden');
        } catch (error) {
          alert('加载视频详情失败: ' + error.message);
        }
      }
      
      closeVideoDetail() {
        document.getElementById('video-detail-modal').classList.add('hidden');
      }
      
      async exportResults() {
        try {
          const params = new URLSearchParams({
            ...this.filters,
            export: 'csv'
          });
          
          const response = await fetch(`/api/videos?${params}`);
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `videos_export_${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('导出失败: ' + error.message);
        }
      }
    }
    
    // 后台管理模块
    class BackendModule extends BaseModule {
      async render() {
        App.updatePageHeader('后台管理', '系统后台管理和维护工具');
        await super.render();
      }
      
      async getContent() {
        return `
          <div class="card">
            <div class="card-header">
              <h3 class="card-title">后台管理工具</h3>
            </div>
            <div style="display: grid; gap: 16px;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/queue_admin.html', '_blank')">队列管理后台</button>
                <span style="font-size: 12px; color: #6b7280;">原始队列管理界面，包含详细的队列操作功能</span>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/subscription_detail.html', '_blank')">订阅详情页面</button>
                <span style="font-size: 12px; color: #6b7280;">独立的订阅同步详情查看页面</span>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn btn-primary" onclick="window.open('/static/test.html', '_blank')">API测试页面</button>
                <span style="font-size: 12px; color: #6b7280;">用于测试API接口的简单工具页面</span>
              </div>
            </div>
          </div>
          
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">快速操作</h3>
            </div>
            <div style="display: grid; gap: 12px;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" onclick="backendModule.restartScheduler()">重启调度器</button>
                <button class="btn" onclick="backendModule.clearCache()">清理缓存</button>
                <button class="btn" onclick="backendModule.checkHealth()">健康检查</button>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <button class="btn" onclick="backendModule.viewLogs()">查看日志</button>
                <button class="btn" onclick="backendModule.exportConfig()">导出配置</button>
                <button class="btn" onclick="backendModule.backupData()">备份数据</button>
              </div>
            </div>
          </div>
        `;
      }
      
      bindEvents() {
        window.backendModule = this;
      }
      
      async restartScheduler() {
        try {
          await App.apiClient.post('/api/scheduler/restart');
          alert('调度器重启成功');
        } catch (error) {
          alert('重启调度器失败: ' + error.message);
        }
      }
      
      async clearCache() {
        try {
          await App.apiClient.post('/api/cache/clear');
          alert('缓存清理成功');
        } catch (error) {
          alert('清理缓存失败: ' + error.message);
        }
      }
      
      async checkHealth() {
        try {
          const health = await App.apiClient.get('/api/health');
          alert('系统健康状态: ' + (health.status || 'OK'));
        } catch (error) {
          alert('健康检查失败: ' + error.message);
        }
      }
      
      async viewLogs() {
        window.open('/api/logs/view', '_blank');
      }
      
      async exportConfig() {
        try {
          const response = await fetch('/api/config/export');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `config_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('导出配置失败: ' + error.message);
        }
      }
      
      async backupData() {
        try {
          const response = await fetch('/api/backup/create');
          const result = await response.json();
          alert('数据备份成功: ' + result.backup_file);
        } catch (error) {
          alert('数据备份失败: ' + error.message);
        }
      }
    }

    // 系统设置模块
    class SettingsModule extends BaseModule {
      constructor() {
        super();
        this.settings = {};
        this.cookies = [];
      }
      
      async render() {
        App.updatePageHeader('系统设置', 'Cookie管理和调度配置');
        await super.render();
      }
      
      async getContent() {
        await this.loadData();
        
        return `
          <div class="grid grid-2" style="gap: 20px;">
            <!-- Cookie管理 -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">Cookie管理</h3>
                <button class="btn btn-sm btn-primary" onclick="settingsModule.showAddCookie()">添加Cookie</button>
              </div>
              <div style="margin-bottom: 16px;">
                <div style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
                  Cookie用于访问需要登录的B站内容，建议使用小号Cookie以避免风险
                </div>
                <div id="cookies-list">
                  ${this.renderCookiesList()}
                </div>
              </div>
            </div>
            
            <!-- 调度配置 -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">调度配置</h3>
                <button class="btn btn-sm" onclick="settingsModule.saveScheduleSettings()">保存配置</button>
              </div>
              <div style="display: grid; gap: 12px;">
                <div>
                  <label style="font-size: 12px; color: #6b7280;">同步检查间隔 (分钟)</label>
                  <input id="sync-interval" type="number" min="1" value="${this.settings.sync_interval || 60}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">下载重试次数</label>
                  <input id="download-retries" type="number" min="0" value="${this.settings.download_retries || 3}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">请求超时时间 (秒)</label>
                  <input id="request-timeout" type="number" min="1" value="${this.settings.request_timeout || 30}" class="form-input" />
                </div>
                <div>
                  <label style="font-size: 12px; color: #6b7280;">下载目录</label>
                  <input id="download-path" value="${this.settings.download_path || ''}" class="form-input" placeholder="留空使用默认目录" />
                </div>
              </div>
            </div>
          </div>
          
          <div class="grid grid-2" style="gap: 20px; margin-top: 20px;">
            <!-- 系统状态 -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">系统状态</h3>
                <button class="btn btn-sm" onclick="settingsModule.refreshStatus()">刷新</button>
              </div>
              <div id="system-status">
                ${this.renderSystemStatus()}
              </div>
            </div>
            
            <!-- 日志管理 -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">日志管理</h3>
                <div style="display: flex; gap: 8px;">
                  <button class="btn btn-sm" onclick="settingsModule.downloadLogs()">下载日志</button>
                  <button class="btn btn-sm" onclick="settingsModule.clearLogs()">清空日志</button>
                </div>
              </div>
              <div>
                <select id="log-level" class="form-input" style="margin-bottom: 12px;">
                  <option value="DEBUG">DEBUG</option>
                  <option value="INFO" selected>INFO</option>
                  <option value="WARNING">WARNING</option>
                  <option value="ERROR">ERROR</option>
                </select>
                <button class="btn btn-sm" onclick="settingsModule.setLogLevel()">设置日志级别</button>
              </div>
            </div>
          </div>
          
          <!-- 数据管理 -->
          <div class="card" style="margin-top: 20px;">
            <div class="card-header">
              <h3 class="card-title">数据管理</h3>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
              <button class="btn" onclick="settingsModule.exportData()">导出数据</button>
              <button class="btn" onclick="settingsModule.importData()">导入数据</button>
              <button class="btn" onclick="settingsModule.cleanupData()">清理过期数据</button>
              <div style="flex: 1;"></div>
              <button class="btn" style="background: #dc2626; color: white;" onclick="settingsModule.resetSystem()">重置系统</button>
            </div>
            <div style="font-size: 12px; color: #6b7280; margin-top: 8px;">
              导出/导入功能可用于备份和迁移数据。重置系统将清空所有数据，请谨慎操作。
            </div>
          </div>
          
          <!-- 添加Cookie模态框 -->
          <div id="add-cookie-modal" class="modal hidden">
            <div class="modal-content">
              <div class="modal-header">
                <h3>添加Cookie</h3>
                <button class="modal-close" onclick="settingsModule.closeAddCookie()">&times;</button>
              </div>
              <div class="modal-body">
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">Cookie名称</label>
                  <input id="cookie-name" placeholder="例如: 主账号Cookie" class="form-input" />
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">Cookie值</label>
                  <textarea id="cookie-value" placeholder="粘贴完整的Cookie字符串" class="form-input" rows="4"></textarea>
                </div>
                <div style="margin-bottom: 16px;">
                  <label style="font-size: 12px; color: #6b7280;">备注</label>
                  <input id="cookie-note" placeholder="可选的备注信息" class="form-input" />
                </div>
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                  <button class="btn" onclick="settingsModule.closeAddCookie()">取消</button>
                  <button class="btn btn-primary" onclick="settingsModule.saveCookie()">保存</button>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      async loadData() {
        try {
          const [settings, cookies] = await Promise.all([
            App.apiClient.get('/api/settings').catch(() => ({})),
            App.apiClient.get('/api/cookies').catch(() => [])
          ]);
          
          this.settings = settings;
          this.cookies = cookies;
        } catch (error) {
          console.error('Failed to load settings data:', error);
        }
      }
      
      renderCookiesList() {
        if (!this.cookies.length) {
          return '<div style="text-align: center; padding: 20px; color: #6b7280;">暂无Cookie配置</div>';
        }
        
        return this.cookies.map(cookie => {
          const isValid = cookie.is_active !== false && (cookie.valid !== false);
          const statusText = !cookie.is_active ? '已禁用' : (isValid ? '有效' : '无效');
          const statusClass = !cookie.is_active ? 'status-warning' : (isValid ? 'status-success' : 'status-error');
          
          return `
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #e5e7eb; border-radius: 6px; margin-bottom: 8px;">
              <div>
                <div style="font-weight: 500;">${cookie.name || '未命名'}</div>
                <div style="font-size: 12px; color: #6b7280;">
                  ${cookie.note || '无备注'} | 
                  添加时间: ${this.formatTime(cookie.created_at)} |
                  状态: <span class="status ${statusClass}">${statusText}</span>
                  ${cookie.failure_count > 0 ? ` | 失败: ${cookie.failure_count}次` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 8px;">
                <button class="btn btn-sm" onclick="settingsModule.testCookie(${cookie.id})">测试</button>
                <button class="btn btn-sm" onclick="settingsModule.deleteCookie(${cookie.id})">删除</button>
              </div>
            </div>
          `;
        }).join('');
      }
      
      renderSystemStatus() {
        const status = this.settings.system_status || {};
        
        return `
          <div style="display: grid; gap: 12px;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>调度器状态</span>
              <span class="status ${status.scheduler_running ? 'status-success' : 'status-error'}">
                ${status.scheduler_running ? '运行中' : '已停止'}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>数据库连接</span>
              <span class="status ${status.database_connected ? 'status-success' : 'status-error'}">
                ${status.database_connected ? '正常' : '异常'}
              </span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>磁盘空间</span>
              <span style="font-size: 12px; color: #6b7280;">${status.disk_usage || '未知'}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #f3f4f6;">
              <span>运行时间</span>
              <span style="font-size: 12px; color: #6b7280;">${status.uptime || '未知'}</span>
            </div>
          </div>
        `;
      }
      
      bindEvents() {
        window.settingsModule = this;
      }
      
      showAddCookie() {
        document.getElementById('add-cookie-modal').classList.remove('hidden');
      }
      
      closeAddCookie() {
        document.getElementById('add-cookie-modal').classList.add('hidden');
        document.getElementById('cookie-name').value = '';
        document.getElementById('cookie-value').value = '';
        document.getElementById('cookie-note').value = '';
      }
      
      async saveCookie() {
        const name = document.getElementById('cookie-name').value.trim();
        const value = document.getElementById('cookie-value').value.trim();
        const note = document.getElementById('cookie-note').value.trim();
        
        if (!name || !value) {
          alert('请填写Cookie名称和值');
          return;
        }
        
        try {
          await App.apiClient.post('/api/cookies', { name, value, note });
          await this.refreshData();
          this.closeAddCookie();
        } catch (error) {
          alert('保存Cookie失败: ' + error.message);
        }
      }
      
      async testCookie(cookieId) {
        try {
          const result = await App.apiClient.post(`/api/cookies/${cookieId}/validate`);
          
          // 更新Cookie状态显示
          const cookieIndex = this.cookies.findIndex(c => c.id === cookieId);
          if (cookieIndex !== -1) {
            this.cookies[cookieIndex].valid = result.valid && result.is_active;
            this.cookies[cookieIndex].failure_count = result.failure_count || 0;
            this.cookies[cookieIndex].last_failure_at = result.last_failure_at;
            this.cookies[cookieIndex].is_active = result.is_active;
          }
          
          // 刷新Cookie列表显示
          document.getElementById('cookies-list').innerHTML = this.renderCookiesList();
          
          let message = result.valid && result.is_active ? 'Cookie验证有效' : 'Cookie验证无效';
          if (result.failure_count > 0) {
            message += `\n失败次数: ${result.failure_count}`;
          }
          if (!result.is_active) {
            message += '\n状态: 已禁用';
          }
          
          alert(message);
          await this.refreshData();
        } catch (error) {
          alert('测试Cookie失败: ' + error.message);
        }
      }
      
      async deleteCookie(cookieId) {
        if (!confirm('确定要删除这个Cookie吗？')) {
          return;
        }
        
        try {
          await App.apiClient.delete(`/api/cookies/${cookieId}`);
          await this.refreshData();
        } catch (error) {
          alert('删除Cookie失败: ' + error.message);
        }
      }
      
      async saveScheduleSettings() {
        try {
          const settings = {
            sync_interval: parseInt(document.getElementById('sync-interval').value),
            download_retries: parseInt(document.getElementById('download-retries').value),
            request_timeout: parseInt(document.getElementById('request-timeout').value),
            download_path: document.getElementById('download-path').value.trim()
          };
          
          await App.apiClient.post('/api/settings', settings);
          alert('配置已保存');
        } catch (error) {
          alert('保存配置失败: ' + error.message);
        }
      }
      
      async refreshStatus() {
        await this.loadData();
        document.getElementById('system-status').innerHTML = this.renderSystemStatus();
      }
      
      async setLogLevel() {
        try {
          const level = document.getElementById('log-level').value;
          await App.apiClient.post('/api/settings/log-level', { level });
          alert('日志级别已设置为: ' + level);
        } catch (error) {
          alert('设置日志级别失败: ' + error.message);
        }
      }
      
      async downloadLogs() {
        try {
          const response = await fetch('/api/logs/download');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `logs_${new Date().toISOString().split('T')[0]}.txt`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('下载日志失败: ' + error.message);
        }
      }
      
      async clearLogs() {
        if (!confirm('确定要清空所有日志吗？此操作不可恢复。')) {
          return;
        }
        
        try {
          await App.apiClient.post('/api/logs/clear');
          alert('日志已清空');
        } catch (error) {
          alert('清空日志失败: ' + error.message);
        }
      }
      
      async exportData() {
        try {
          const response = await fetch('/api/data/export');
          const blob = await response.blob();
          
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `data_export_${new Date().toISOString().split('T')[0]}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          alert('导出数据失败: ' + error.message);
        }
      }
      
      async importData() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        
        input.onchange = async (e) => {
          const file = e.target.files[0];
          if (!file) return;
          
          const formData = new FormData();
          formData.append('file', file);
          
          try {
            await fetch('/api/data/import', {
              method: 'POST',
              body: formData
            });
            alert('数据导入成功');
            await this.refreshData();
          } catch (error) {
            alert('导入数据失败: ' + error.message);
          }
        };
        
        input.click();
      }
      
      async cleanupData() {
        if (!confirm('确定要清理过期数据吗？这将删除超过30天的日志和临时文件。')) {
          return;
        }
        
        try {
          await App.apiClient.post('/api/data/cleanup');
          alert('数据清理完成');
        } catch (error) {
          alert('数据清理失败: ' + error.message);
        }
      }
      
      async resetSystem() {
        const confirmation = prompt('此操作将清空所有数据并重置系统！请输入"RESET"确认：');
        if (confirmation !== 'RESET') {
          return;
        }
        
        try {
          await App.apiClient.post('/api/system/reset');
          alert('系统重置完成，页面将刷新');
          window.location.reload();
        } catch (error) {
          alert('系统重置失败: ' + error.message);
        }
      }
      
      async refreshData() {
        await this.loadData();
        document.getElementById('cookies-list').innerHTML = this.renderCookiesList();
        document.getElementById('system-status').innerHTML = this.renderSystemStatus();
      }
    }
    
    // 启动应用
    document.addEventListener('DOMContentLoaded', () => {
      App.init();
    });
  </script>
</body>
</html>

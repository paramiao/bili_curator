<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bili_curator V6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .header { background: #00a1d6; color: white; padding: 1rem; text-align: center; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 10px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem; box-shadow: 0 2px 10px rgba(0,0,0,0.06); border: 1px solid #eef2f7; }
        .card h3 { margin-bottom: 0.5rem; font-size: 1.1rem; color: #333; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem; }
        .tab { padding: 0.5rem 1rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab.active { border-bottom-color: #00a1d6; color: #00a1d6; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn { background: #00a1d6; color: white; border: none; padding: 0.45rem 0.8rem; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #0084b4; }
        .btn-outline { background: #fff; color: #007fa6; border: 1px solid #cde8f3; }
        .btn-outline:hover { background: #f2fbff; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 12px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        /* ä»»åŠ¡ç®¡ç†æ ·å¼ */
        .task-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-header h4 {
            margin: 0;
            color: #333;
        }

        /* ç»Ÿè®¡å°èƒ¶å›Š */
        .subscription-stats .stat-item { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #f6f8fa; border: 1px solid #eef2f7; color: #333; }
        .stat-total { background: #eef7ff; color: #0b5cab; border-color: #d9ecff; }
        .stat-downloaded { background: #e9f9ef; color: #1e7e34; border-color: #d6f5df; }
        .stat-pending { background: #fff7e6; color: #b26a00; border-color: #ffe7ba; }

        /* è¡¨æ ¼ç»Ÿä¸€æ ·å¼ï¼ˆè§†é¢‘ç®¡ç†ï¼‰ */
        .table-wrap { overflow: auto; }
        table.data { width: 100%; border-collapse: collapse; font-size: 14px; }
        table.data thead th { position: sticky; top: 0; background: #f9fbfd; color: #445; text-align: left; border-bottom: 1px solid #eef2f7; padding: 10px 12px; }
        table.data tbody td { border-bottom: 1px solid #f0f3f7; padding: 10px 12px; color: #333; }
        table.data tbody tr:nth-child(even) { background: #fcfdff; }
        table.data tbody tr:hover { background: #f0f7ff; }
        .pager { display: flex; gap: 8px; align-items: center; margin-top: 8px; }

        /* å¡ç‰‡å†…åˆ†èŠ‚æ ‡é¢˜è¡Œ */
        .card .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; }

        .task-controls {
            display: flex;
            gap: 8px;
        }

        .task-info {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-status {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
        }

        .status-pending .task-status { background-color: #6c757d; }
        .status-checking .task-status { background-color: #17a2b8; }
        .status-downloading .task-status { background-color: #007bff; }
        .status-paused .task-status { background-color: #ffc107; color: #000; }
        .status-completed .task-status { background-color: #28a745; }
        .status-failed .task-status { background-color: #dc3545; }
        .status-cancelled .task-status { background-color: #6c757d; }

        .task-progress {
            color: #666;
        }

        .current-video {
            color: #007bff;
            font-style: italic;
        }

        .progress-bar {
            position: relative;
            background-color: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #007bff;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-logs {
            margin-top: 12px;
        }

        .logs-content {
            background-color: #f1f3f4;
            border: 1px solid #e1e3e4;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
            white-space: pre-wrap;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
        }

        .btn-outline:hover {
            background-color: #6c757d;
            color: white;
        }

        /* è¡¨å•å¢å¼ºæ ·å¼ */
        .form-section {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .form-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .half-width {
            flex: 1;
        }

        .third-width {
            flex: 1;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }

        /* è®¢é˜…ç»Ÿè®¡æ ·å¼ */
        .subscription-stats {
            display: flex;
            gap: 16px;
            margin-top: 8px;
            font-size: 14px;
        }

        .stat-item {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stat-total {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .stat-downloaded {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .stat-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .subscription-item {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            background-color: #fff;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .subscription-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .subscription-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .type-collection {
            background-color: #007bff;
        }

        .type-uploader {
            background-color: #28a745;
        }

        .type-keyword {
            background-color: #ffc107;
            color: #000;
        }

        .type-specific-urls {
            background-color: #6f42c1;
        }

        .subscription-controls {
            display: flex;
            gap: 8px;
        }

        .subscription-filters {
            margin-top: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .filter-tag {
            display: inline-block;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        .status { padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¬ bili_curator V6</h1>
        <p>Bç«™è§†é¢‘ä¸‹è½½ç®¡ç†ç³»ç»Ÿ - å®¶ç”¨ç®€åŒ–ç‰ˆ</p>
    </div>

    <div class="container">
        <div class="card">
            <div class="tabs">
                <div class="tab active" onclick="showTab(this,'dashboard')">æ€»è§ˆ</div>
                <div class="tab" onclick="showTab(this,'subscriptions')">è®¢é˜…ç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'tasks')">ä¸‹è½½ä»»åŠ¡</div>
                <div class="tab" onclick="showTab(this,'cookies')">Cookieç®¡ç†</div>
                <div class="tab" onclick="showTab(this,'settings')">ç³»ç»Ÿè®¾ç½®</div>
            </div>

            <!-- æ€»è§ˆï¼ˆåˆå¹¶ä»ªè¡¨ç›˜ + è§†é¢‘ç®¡ç†ï¼‰ -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2>ç³»ç»ŸçŠ¶æ€</h2>
                    <div id="system-status">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-overview" class="card" style="margin-top:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>åª’ä½“æ€»è§ˆ</h3>
                        <div>
                            <button class="btn btn-outline" onclick="loadMediaOverview(false)">åˆ·æ–°</button>
                            <button class="btn" onclick="loadMediaOverview(true)">æ‰«æç£ç›˜</button>
                        </div>
                    </div>
                    <div id="media-overview-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-sub-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>è®¢é˜…ç»Ÿè®¡</h3>
                        <input id="sub-filter" type="text" placeholder="æœç´¢è®¢é˜…åç§°..." oninput="renderSubscriptionStats()" style="padding:6px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div id="media-sub-stats-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-dir-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>ç›®å½•ç»Ÿè®¡</h3>
                    </div>
                    <div id="media-dir-stats-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-sub-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-sub-detail-title">è®¢é˜…æ˜ç»†</h3>
                        <button class="btn btn-outline" onclick="hideSubscriptionDetail()">è¿”å›ç»Ÿè®¡</button>
                    </div>
                    <div id="media-sub-detail-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>

                <div id="media-dir-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-dir-detail-title">ç›®å½•æ˜ç»†</h3>
                        <button class="btn btn-outline" onclick="hideDirectoryDetail()">è¿”å›ç»Ÿè®¡</button>
                    </div>
                    <div id="media-dir-detail-content" style="margin-top:8px;">åŠ è½½ä¸­...</div>
                </div>
            </div>

            <!-- è®¢é˜…ç®¡ç† -->
            <div id="subscriptions" class="tab-content">
                <div class="section-header">
                    <h2>è®¢é˜…ç®¡ç†</h2>
                    <div style="display:flex; gap:8px; flex-wrap: wrap; align-items:center;">
                        <button onclick="showAddSubscription()" class="btn btn-primary">æ·»åŠ è®¢é˜…</button>
                        <button onclick="scanAll()" class="btn btn-secondary">å…¨é‡æ‰«æå¯¼å…¥</button>
                        <button onclick="associateAll()" class="btn btn-outline">å…¨é‡è‡ªåŠ¨å…³è”</button>
                        <button onclick="loadSubscriptions()" class="btn btn-info">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                </div>
                <div id="subscription-list"></div>
            </div>
            
            <!-- ä¸‹è½½ä»»åŠ¡ -->
            <div id="tasks" class="tab-content">
                <div class="section-header">
                    <h2>ä¸‹è½½ä»»åŠ¡</h2>
                    <button onclick="refreshTasks()" class="btn btn-secondary">åˆ·æ–°</button>
                    <button onclick="clearCompletedTasks()" class="btn btn-outline">æ¸…ç†å®Œæˆä»»åŠ¡</button>
                </div>
                <div id="task-list">åŠ è½½ä¸­...</div>
            </div>    
                <div id="add-subscription" style="display:none; margin-top:1rem;">
                    <h3>æ·»åŠ æ–°è®¢é˜…</h3>
                    <div class="form-group">
                        <label>è®¢é˜…ç±»å‹</label>
                        <select id="sub-type" onchange="toggleSubFields()">
                            <option value="collection">åˆé›†è®¢é˜…</option>
                            <option value="uploader">UPä¸»è®¢é˜…</option>
                            <option value="keyword">å…³é”®è¯è®¢é˜…</option>
                            <option value="specific-urls">ç‰¹å®šè§†é¢‘è®¢é˜…</option>
                        </select>
                    </div>
                    
                    <!-- åˆé›†è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="collection-fields">
                        <label>åˆé›†URL <span class="help-text">ç²˜è´´Bç«™åˆé›†é“¾æ¥ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¯†åˆ«åç§°</span></label>
                        <input type="text" id="sub-url" placeholder="https://space.bilibili.com/xxx/channel/collectiondetail?sid=xxx" onblur="autoFillCollectionName()">
                    </div>
                    
                    <!-- UPä¸»è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="uploader-fields" style="display:none;">
                        <label>UPä¸»IDæˆ–åç§° <span class="help-text">è¾“å…¥UPä¸»çš„IDæˆ–ç”¨æˆ·å</span></label>
                        <input type="text" id="sub-uploader" placeholder="UPä¸»IDæˆ–ç”¨æˆ·å">
                    </div>
                    
                    <!-- å…³é”®è¯è®¢é˜…å­—æ®µ -->
                    <div class="form-group" id="keyword-fields" style="display:none;">
                        <label>æœç´¢å…³é”®è¯ <span class="help-text">è¾“å…¥è¦æœç´¢çš„å…³é”®è¯</span></label>
                        <input type="text" id="sub-keyword" placeholder="æœç´¢å…³é”®è¯">
                    </div>
                    
                    <!-- ç‰¹å®šURLå­—æ®µ -->
                    <div class="form-group" id="specific-urls-fields" style="display:none;">
                        <label>ç‰¹å®šè§†é¢‘URL <span class="help-text">æ¯è¡Œä¸€ä¸ªè§†é¢‘é“¾æ¥</span></label>
                        <textarea id="sub-specific-urls" rows="4" placeholder="https://www.bilibili.com/video/BVxxx&#10;https://www.bilibili.com/video/BVyyy"></textarea>
                    </div>
                    
                    <!-- ç­›é€‰æ¡ä»¶ -->
                    <div class="form-section">
                        <h4>ç­›é€‰æ¡ä»¶ <span class="help-text">å¯é€‰ï¼Œç”¨äºè¿‡æ»¤ä¸‹è½½çš„è§†é¢‘</span></h4>
                        
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label>å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="sub-date-after">
                            </div>
                            <div class="form-group half-width">
                                <label>ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="sub-date-before">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group third-width">
                                <label>æœ€å°ç‚¹èµæ•°</label>
                                <input type="number" id="sub-min-likes" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>æœ€å°æ”¶è—æ•°</label>
                                <input type="number" id="sub-min-favorites" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>æœ€å°æ’­æ”¾æ•°</label>
                                <input type="number" id="sub-min-views" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>è®¢é˜…åç§°</label>
                        <input type="text" id="sub-name" placeholder="è‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨è¾“å…¥">
                        <small style="color:#666;">åˆé›†è®¢é˜…ä¼šè‡ªåŠ¨è¯†åˆ«ä¸º"UPä¸»åï¼šåˆé›†å"</small>
                    </div>
                    
                    <button class="btn" onclick="addSubscription()">æ·»åŠ è®¢é˜…</button>
                    <button class="btn" onclick="hideAddSubscription()" style="background:#666;">å–æ¶ˆ</button>
                </div>
            </div>


            <!-- Cookieç®¡ç† -->
            <div id="cookies" class="tab-content">
                <h2>Cookieç®¡ç†</h2>
                <button class="btn" onclick="showAddCookie()">æ·»åŠ Cookie</button>
                <div id="cookie-list">åŠ è½½ä¸­...</div>
                
                <div id="add-cookie" style="display:none; margin-top:1rem;">
                    <h3>æ·»åŠ æ–°Cookie</h3>
                    <div class="form-group">
                        <label>Cookieåç§°</label>
                        <input type="text" id="cookie-name" placeholder="è¾“å…¥Cookieåç§°">
                    </div>
                    <div class="form-group">
                        <label>SESSDATA</label>
                        <input type="text" id="cookie-sessdata" placeholder="è¾“å…¥SESSDATAå€¼">
                    </div>
                    <div class="form-group">
                        <label>bili_jct</label>
                        <input type="text" id="cookie-jct" placeholder="è¾“å…¥bili_jctå€¼">
                    </div>
                    <div class="form-group">
                        <label>DedeUserID</label>
                        <input type="text" id="cookie-userid" placeholder="è¾“å…¥DedeUserIDå€¼">
                    </div>
                    <button class="btn" onclick="addCookie()">æ·»åŠ </button>
                    <button class="btn" onclick="hideAddCookie()" style="background:#666;">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- ç³»ç»Ÿè®¾ç½® -->
            <div id="settings" class="tab-content">
                <h2>ç³»ç»Ÿè®¾ç½®</h2>
                <div id="settings-list">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // æ ‡ç­¾é¡µåˆ‡æ¢
        function showTab(el, tabName) {
            // å…¼å®¹æ—§è°ƒç”¨ç­¾åï¼šshowTab('videos')
            if (typeof el === 'string' && !tabName) {
                tabName = el;
                el = null;
            }
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                // æ—  el æ—¶ï¼Œæ¿€æ´»ä¸ tabName å¯¹åº”çš„ tab
                const candidate = Array.from(document.querySelectorAll('.tab')).find(t => (t.getAttribute('onclick') || '').includes(`'${tabName}'`));
                if (candidate) candidate.classList.add('active');
            }
            const pane = document.getElementById(tabName);
            if (pane) pane.classList.add('active');
            // åŠ è½½å¯¹åº”æ•°æ®
            loadTabData(tabName);
        }

        // åŠ è½½æ ‡ç­¾é¡µæ•°æ®
        function loadTabData(tabName) {
            // åˆ‡æ¢åˆ°éä»»åŠ¡æ ‡ç­¾æ—¶åœæ­¢è½®è¯¢
            if (tabName !== 'tasks') {
                stopTasksPolling();
            }
            switch(tabName) {
                case 'dashboard':
                    // åˆå¹¶åçš„æ€»è§ˆï¼šç³»ç»ŸçŠ¶æ€ + åª’ä½“æ¦‚è§ˆ
                    loadDashboard();
                    loadVideos();
                    break;
                case 'subscriptions':
                    loadSubscriptions();
                    break;
                case 'tasks':
                    startTasksPolling();
                    break;
                case 'cookies':
                    loadCookies();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }

        // APIè¯·æ±‚å°è£…
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const ct = (response.headers.get('content-type') || '').toLowerCase();
                let payload;
                if (ct.includes('application/json')) {
                    payload = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    payload = text ? { message: text } : null;
                }
                if (!response.ok) {
                    const msg = (payload && (payload.error || payload.message)) || `HTTP ${response.status}`;
                    return { error: msg, status: response.status };
                }
                return payload ?? {};
            } catch (error) {
                console.error('APIè¯·æ±‚å¤±è´¥:', error);
                return { error: error.message };
            }
        }

        // åˆ·æ–°å¹¶æ˜¾ç¤ºåˆé›†çš„è¿œç«¯æ€»æ•°ï¼ˆ1å°æ—¶ç¼“å­˜ï¼ŒlocalStorage æŒä¹…åŒ–ï¼‰
        const __expectedCache = {};
        function getExpectedCache(id) {
            try {
                const k = `expectedCache:${id}`;
                const s = localStorage.getItem(k);
                if (!s) return null;
                const obj = JSON.parse(s);
                if (!obj || typeof obj.at !== 'number') return null;
                return obj;
            } catch (_) { return null; }
        }
        function setExpectedCache(id, value) {
            const obj = { value, at: Date.now() };
            __expectedCache[id] = obj;
            try { localStorage.setItem(`expectedCache:${id}`, JSON.stringify(obj)); } catch (_) {}
            return obj;
        }
        async function refreshExpected(subscriptionId, force = false) {
            const el = document.getElementById(`expected-${subscriptionId}`);
            if (!el) return;
            const countEl = el.querySelector('.expected-count');
            // å‘½ä¸­ç¼“å­˜ä¸”æœªè¿‡æœŸï¼ˆ1å°æ—¶ï¼‰ä¸”éå¼ºåˆ¶åˆ·æ–°
            const now = Date.now();
            const c = __expectedCache[subscriptionId] || getExpectedCache(subscriptionId);
            const notExpired = c && (now - c.at < 3600 * 1000);
            if (!force && notExpired) {
                if (countEl) countEl.textContent = String(c.value);
                return;
            }
            if (countEl) countEl.textContent = 'åŠ è½½ä¸­...';
            const data = await apiRequest(`/api/subscriptions/${subscriptionId}/expected-total`);
            if (data && typeof data.expected_total_videos === 'number') {
                if (countEl) countEl.textContent = String(data.expected_total_videos);
                setExpectedCache(subscriptionId, data.expected_total_videos);
                // åŒæ­¥æ›´æ–°å¾…ä¸‹è½½å±•ç¤ºï¼ˆä¼˜å…ˆè¿œç«¯ï¼‰
                try {
                    const subEl = document.getElementById(`sub-${subscriptionId}`);
                    if (subEl) {
                        const downloaded = parseInt(subEl.getAttribute('data-downloaded') || '0', 10);
                        const pending = Math.max((data.expected_total_videos - downloaded), 0);
                        const pEl = document.getElementById(`pending-${subscriptionId}`);
                        const sEl = document.getElementById(`pending-src-${subscriptionId}`);
                        if (pEl) pEl.textContent = String(pending);
                        if (sEl) sEl.textContent = '(è¿œç«¯)';
                    }
                } catch (_) {}
            } else {
                if (countEl) countEl.textContent = 'è·å–å¤±è´¥';
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿
        async function loadDashboard() {
            const data = await apiRequest('/api/status');
            const html = `
                <div class="status success">
                    <strong>ç³»ç»Ÿè¿è¡Œæ­£å¸¸</strong> - ç‰ˆæœ¬: ${data.version || '6.0.0'}
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                    <div class="card">
                        <h3>è®¢é˜…ç»Ÿè®¡</h3>
                        <p>æ€»è®¢é˜…: ${data.statistics?.total_subscriptions || 0}</p>
                        <p>æ´»è·ƒè®¢é˜…: ${data.statistics?.active_subscriptions || 0}</p>
                    </div>
                    <div class="card">
                        <h3>è§†é¢‘ç»Ÿè®¡</h3>
                        <p>æ€»è§†é¢‘: ${data.statistics?.total_videos || 0}</p>
                        <p>å·²ä¸‹è½½: ${data.statistics?.downloaded_videos || 0}</p>
                    </div>
                    <div class="card">
                        <h3>CookieçŠ¶æ€</h3>
                        <p>å¯ç”¨Cookie: ${data.statistics?.active_cookies || 0}</p>
                    </div>
                </div>
            `;
            document.getElementById('system-status').innerHTML = html;
        }

        // åŠ è½½è®¢é˜…åˆ—è¡¨
        async function loadSubscriptions() {
            const result = await apiRequest('/api/subscriptions');
            if (result.error) {
                document.getElementById('subscription-list').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${result.error}</p>`;
                return;
            }
            
            let html = '';
            result.forEach(sub => {
                const statusClass = sub.is_active ? 'success' : 'error';
                const statusText = sub.is_active ? 'æ´»è·ƒ' : 'æš‚åœ';
                const lastCheck = sub.last_check ? new Date(sub.last_check).toLocaleString() : 'ä»æœª';
                
                // ç»Ÿè®¡ä¿¡æ¯
                const totalVideos = sub.total_videos || 0;
                const downloadedVideos = sub.downloaded_videos || 0;
                const localPending = Math.max((totalVideos - downloadedVideos), 0);
                
                // è®¢é˜…ç±»å‹æ˜¾ç¤º
                const typeTexts = {
                    'collection': 'åˆé›†è®¢é˜…',
                    'uploader': 'UPä¸»è®¢é˜…', 
                    'keyword': 'å…³é”®è¯è®¢é˜…',
                    'specific-urls': 'ç‰¹å®šè§†é¢‘è®¢é˜…'
                };
                const typeText = typeTexts[sub.type] || sub.type;
                
                // ç­›é€‰æ¡ä»¶æ˜¾ç¤º
                let filtersHtml = '';
                const filters = [];
                if (sub.date_after) filters.push(`å¼€å§‹æ—¥æœŸ: ${sub.date_after}`);
                if (sub.date_before) filters.push(`ç»“æŸæ—¥æœŸ: ${sub.date_before}`);
                if (sub.min_likes) filters.push(`æœ€å°ç‚¹èµ: ${sub.min_likes}`);
                if (sub.min_favorites) filters.push(`æœ€å°æ”¶è—: ${sub.min_favorites}`);
                if (sub.min_views) filters.push(`æœ€å°æ’­æ”¾: ${sub.min_views}`);
                
                if (filters.length > 0) {
                    filtersHtml = `
                        <div class="subscription-filters">
                            ç­›é€‰æ¡ä»¶: ${filters.map(f => `<span class="filter-tag">${f}</span>`).join('')}
                        </div>
                    `;
                }
                
                // é¢„å¡«å……è¿œç«¯æ€»æ•°ï¼ˆè‹¥æœ‰ç¼“å­˜ä¸”æœªè¿‡æœŸï¼‰
                const cached = getExpectedCache(sub.id);
                const cachedOk = cached && (Date.now() - cached.at < 3600*1000);
                const expectedText = cachedOk ? String(cached.value) : 'æœªè·å–';
                const remotePending = cachedOk ? Math.max((cached.value - downloadedVideos), 0) : null;
                const pendingToShow = (remotePending !== null) ? remotePending : localPending;
                const pendingSource = (remotePending !== null) ? 'è¿œç«¯' : 'æœ¬åœ°';

                html += `
                    <div class="subscription-item" id="sub-${sub.id}" data-total="${totalVideos}" data-downloaded="${downloadedVideos}">
                        <div class="subscription-header">
                            <div>
                                <h3 class="subscription-title">${sub.name}</h3>
                                <span class="subscription-type type-${sub.type}">${typeText}</span>
                            </div>
                            <div class="subscription-controls">
                                <button onclick="downloadSubscription(${sub.id})" class="btn btn-primary">å¼€å§‹ä¸‹è½½</button>
                                <button onclick="associateSubscription(${sub.id})" class="btn btn-outline">è‡ªåŠ¨å…³è”</button>
                                <button onclick="viewSubscription(${sub.id})" class="btn btn-info">æŸ¥çœ‹è¯¦æƒ…</button>
                                <button onclick="editSubscription(${sub.id})" class="btn btn-secondary">ç¼–è¾‘</button>
                                <button onclick="toggleSubscription(${sub.id}, ${sub.is_active})" class="btn ${sub.is_active ? 'btn-warning' : 'btn-success'}">
                                    ${sub.is_active ? 'æš‚åœ' : 'å¯ç”¨'}
                                </button>
                                <button onclick="deleteSubscription(${sub.id})" class="btn btn-danger">åˆ é™¤</button>
                            </div>
                        </div>
                        
                        <div class="subscription-stats">
                            <span class="stat-item stat-total">æ€»è®¡: ${totalVideos}</span>
                            <span class="stat-item stat-downloaded">å·²ä¸‹è½½: ${downloadedVideos}</span>
                            <span class="stat-item stat-pending">å¾…ä¸‹è½½: <span id="pending-${sub.id}">${pendingToShow}</span> <small id="pending-src-${sub.id}" style="opacity:.7;">(${pendingSource})</small></span>
                            ${sub.type === 'collection' ? `
                                <span class="stat-item" id="expected-${sub.id}" style="background-color:#f3e5f5;color:#6a1b9a;">
                                    è¿œç«¯æ€»æ•°: <span class="expected-count">${expectedText}</span>
                                    <button class="btn btn-small btn-outline" style="margin-left:6px;" onclick="refreshExpected(${sub.id})">è·å–</button>
                                    <button class="btn btn-small btn-outline" style="margin-left:6px;" onclick="refreshExpected(${sub.id}, true)">åˆ·æ–°</button>
                                </span>
                            ` : ''}
                        </div>
                        
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">
                            çŠ¶æ€: ${statusText} | æœ€åæ£€æŸ¥: ${lastCheck}
                        </div>
                        
                        ${filtersHtml}
                    </div>
                `;
            });
            
            document.getElementById('subscription-list').innerHTML = html || '<p>æš‚æ— è®¢é˜…</p>';
            // ä¸å†è‡ªåŠ¨æ‹‰å–ï¼Œä¾èµ–æœ¬åœ°ç¼“å­˜ä¸æŒ‰é’®è§¦å‘ï¼Œé¿å…é¢‘ç¹è¯·æ±‚
        }
        
        // åˆ‡æ¢è®¢é˜…çŠ¶æ€
        async function toggleSubscription(subscriptionId, currentStatus) {
            const newStatus = !currentStatus;
            const result = await apiRequest(`/api/subscriptions/${subscriptionId}`, {
                method: 'PUT',
                body: JSON.stringify({ is_active: newStatus })
            });
            
            if (result.error) {
                alert('æ“ä½œå¤±è´¥: ' + result.error);
            } else {
                loadSubscriptions();
            }
        }

        // åˆ‡æ¢è®¢é˜…ç±»å‹å­—æ®µ
        function toggleSubFields() {
            const type = document.getElementById('sub-type').value;
            
            // éšè—æ‰€æœ‰å­—æ®µ
            document.getElementById('collection-fields').style.display = 'none';
            document.getElementById('uploader-fields').style.display = 'none';
            document.getElementById('keyword-fields').style.display = 'none';
            document.getElementById('specific-urls-fields').style.display = 'none';
            
            // æ˜¾ç¤ºå¯¹åº”å­—æ®µ
            if (type === 'collection') {
                document.getElementById('collection-fields').style.display = 'block';
            } else if (type === 'uploader') {
                document.getElementById('uploader-fields').style.display = 'block';
            } else if (type === 'keyword') {
                document.getElementById('keyword-fields').style.display = 'block';
            } else if (type === 'specific-urls') {
                document.getElementById('specific-urls-fields').style.display = 'block';
            }
            
            // æ¸…ç©ºè®¢é˜…åç§°
            document.getElementById('sub-name').value = '';
        }

        // è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°
        async function autoFillCollectionName() {
            const url = document.getElementById('sub-url').value;
            if (!url) return;
            
            try {
                // è°ƒç”¨åç«¯APIè·å–åˆé›†ä¿¡æ¯
                const result = await apiRequest('/api/subscriptions/parse-collection', {
                    method: 'POST',
                    body: JSON.stringify({ url })
                });
                
                if (result.name) {
                    document.getElementById('sub-name').value = result.name;
                } else if (result.error) {
                    console.warn('æ— æ³•è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°:', result.error);
                }
            } catch (error) {
                console.warn('è‡ªåŠ¨è¯†åˆ«åˆé›†åç§°å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤º/éšè—æ·»åŠ è®¢é˜…è¡¨å•
        function showAddSubscription() {
            document.getElementById('add-subscription').style.display = 'block';
            toggleSubFields(); // åˆå§‹åŒ–å­—æ®µæ˜¾ç¤º
        }
        
        function hideAddSubscription() {
            document.getElementById('add-subscription').style.display = 'none';
            // æ¸…ç©ºè¡¨å•
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-url').value = '';
            document.getElementById('sub-uploader').value = '';
            document.getElementById('sub-keyword').value = '';
        }

        // æ·»åŠ è®¢é˜…
        async function addSubscription() {
            const type = document.getElementById('sub-type').value;
            let name = document.getElementById('sub-name').value;
            
            // æ ¹æ®ç±»å‹è·å–ç›¸åº”çš„å€¼
            let data = { type };
            
            if (type === 'collection') {
                const url = document.getElementById('sub-url').value;
                if (!url) {
                    alert('è¯·è¾“å…¥åˆé›†URL');
                    return;
                }
                data.url = url;
                
                // ç•™ç©ºåç§°ç”±åç«¯è‡ªåŠ¨è¯†åˆ«ï¼ˆuploaderï¼šplaylist_titleï¼‰
                
            } else if (type === 'uploader') {
                const uploader = document.getElementById('sub-uploader').value;
                if (!uploader) {
                    alert('è¯·è¾“å…¥UPä¸»IDæˆ–åç§°');
                    return;
                }
                data.uploader_id = uploader;
                
                // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨UPä¸»ä¿¡æ¯
                if (!name) {
                    name = 'UPä¸»è®¢é˜… - ' + uploader;
                }
                
            } else if (type === 'keyword') {
                const keyword = document.getElementById('sub-keyword').value;
                if (!keyword) {
                    alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                    return;
                }
                data.keyword = keyword;
                
                // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨å…³é”®è¯
                if (!name) {
                    name = 'å…³é”®è¯è®¢é˜… - ' + keyword;
                }
                
            } else if (type === 'specific-urls') {
                const specificUrls = document.getElementById('sub-specific-urls').value;
                if (!specificUrls.trim()) {
                    alert('è¯·è¾“å…¥è‡³å°‘ä¸€ä¸ªè§†é¢‘URL');
                    return;
                }
                
                // è§£æURLåˆ—è¡¨
                const urls = specificUrls.split('\n').map(url => url.trim()).filter(url => url);
                if (urls.length === 0) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è§†é¢‘URL');
                    return;
                }
                
                data.specific_urls = JSON.stringify(urls);
                
                // å¦‚æœæ²¡æœ‰åç§°ï¼Œä½¿ç”¨URLæ•°é‡
                if (!name) {
                    name = `ç‰¹å®šè§†é¢‘è®¢é˜… - ${urls.length}ä¸ªè§†é¢‘`;
                }
            }
            
            // è·å–ç­›é€‰æ¡ä»¶
            const dateAfter = document.getElementById('sub-date-after').value;
            const dateBefore = document.getElementById('sub-date-before').value;
            const minLikes = document.getElementById('sub-min-likes').value;
            const minFavorites = document.getElementById('sub-min-favorites').value;
            const minViews = document.getElementById('sub-min-views').value;
            
            if (dateAfter) data.date_after = dateAfter;
            if (dateBefore) data.date_before = dateBefore;
            if (minLikes && parseInt(minLikes) > 0) data.min_likes = parseInt(minLikes);
            if (minFavorites && parseInt(minFavorites) > 0) data.min_favorites = parseInt(minFavorites);
            if (minViews && parseInt(minViews) > 0) data.min_views = parseInt(minViews);
            
            data.name = name;
            
            const result = await apiRequest('/api/subscriptions', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('æ·»åŠ å¤±è´¥: ' + result.error);
            } else {
                alert('æ·»åŠ æˆåŠŸ');
                hideAddSubscription();
                loadSubscriptions();
            }
        }

        // ä¸‹è½½è®¢é˜…
        async function downloadSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}/download`, { method: 'POST' });
            if (result.error) {
                alert('å¯åŠ¨ä¸‹è½½å¤±è´¥: ' + result.error);
            } else {
                alert('ä¸‹è½½ä»»åŠ¡å·²å¯åŠ¨');
                // åˆ‡æ¢åˆ°ä¸‹è½½ä»»åŠ¡æ ‡ç­¾å¹¶å¼€å§‹è½®è¯¢
                const tasksTab = Array.from(document.querySelectorAll('.tab')).find(t => t.textContent.includes('ä¸‹è½½ä»»åŠ¡'));
                if (tasksTab) {
                    tasksTab.click();
                } else {
                    loadTabData('tasks');
                }
            }
        }

        // å…¨é‡æ‰«æå¯¼å…¥
        async function scanAll() {
            if (!confirm('ç¡®è®¤å¯¹ä¸‹è½½ç›®å½•è¿›è¡Œå…¨é‡æ‰«æå¹¶å¯¼å…¥ï¼Ÿ')) return;
            const res = await apiRequest('/api/auto-import/scan', { method: 'POST' });
            if (res && res.error) {
                alert('æ‰«æå¯¼å…¥å¤±è´¥: ' + res.error);
            } else {
                alert('æ‰«æå¯¼å…¥å®Œæˆ');
                loadSubscriptions();
            }
        }

        // å…¨é‡è‡ªåŠ¨å…³è”
        async function associateAll() {
            const res = await apiRequest('/api/auto-import/associate', { method: 'POST' });
            if (res && res.error) {
                alert('è‡ªåŠ¨å…³è”å¤±è´¥: ' + res.error);
            } else {
                alert('è‡ªåŠ¨å…³è”å®Œæˆ');
                loadSubscriptions();
            }
        }

        // é’ˆå¯¹å•ä¸ªè®¢é˜…è¿›è¡Œè‡ªåŠ¨å…³è”ï¼ˆæŒ‰è®¢é˜…ç›®å½•å‰ç¼€ï¼‰
        async function associateSubscription(id) {
            const res = await apiRequest(`/api/subscriptions/${id}/associate`, { method: 'POST' });
            if (res && res.error) {
                alert('è‡ªåŠ¨å…³è”å¤±è´¥: ' + res.error);
            } else {
                alert('å·²è§¦å‘è‡ªåŠ¨å…³è”');
                loadSubscriptions();
            }
        }

        // ä»»åŠ¡è½®è¯¢ä¸æ¸²æŸ“
        let tasksPollTimer = null;

        function startTasksPolling() {
            refreshTasks();
            stopTasksPolling();
            tasksPollTimer = setInterval(refreshTasks, 2000);
        }

        function stopTasksPolling() {
            if (tasksPollTimer) {
                clearInterval(tasksPollTimer);
                tasksPollTimer = null;
            }
        }

        async function refreshTasks() {
            const data = await apiRequest('/api/tasks');
            if (data.error) {
                document.getElementById('task-list').innerHTML = `<p class="error">åŠ è½½å¤±è´¥: ${data.error}</p>`;
                return;
            }
            // å…¼å®¹åç«¯è¿”å›å¯¹è±¡ï¼ˆä»¥ task_id ä¸ºé”®ï¼‰æˆ–æ•°ç»„
            const tasksArr = Array.isArray(data) ? data : Object.values(data || {});
            renderTasks(tasksArr);
        }

        function renderTasks(tasks) {
            if (!tasks || tasks.length === 0) {
                document.getElementById('task-list').innerHTML = '<p>æš‚æ— ä»»åŠ¡</p>';
                return;
            }
            const statusText = {
                'pending': 'æ’é˜Ÿä¸­',
                'downloading': 'ä¸‹è½½ä¸­',
                'completed': 'å·²å®Œæˆ',
                'failed': 'å¤±è´¥',
                'paused': 'å·²æš‚åœ',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            const html = tasks.map(t => {
                const progress = typeof t.progress_percent === 'number' ? Math.max(0, Math.min(100, t.progress_percent)) : 0;
                const barClass = t.status === 'completed' ? 'success' : (t.status === 'failed' ? 'error' : '');
                const controls = renderTaskControls(t);
                return `
                    <div class="card" style="margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>ä»»åŠ¡#${t.task_id || t.id || '-'}</strong>
                                <span style="margin-left:8px;color:#666;">${statusText[t.status] || t.status}</span>
                            </div>
                            <div>${controls}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress ${barClass}" style="width:${progress}%"></div>
                        </div>
                        ${t.error_message ? `<div class="error">${t.error_message}</div>` : ''}
                        <div style="font-size:12px;color:#666;margin-top:4px;">
                            å¼€å§‹: ${t.started_at || '-'} | ç»“æŸ: ${t.completed_at || '-'}
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('task-list').innerHTML = html;
        }

        function renderTaskControls(t) {
            const buttons = [];
            if (t.status === 'downloading') {
                buttons.push(`<button class="btn btn-warning" onclick=\"pauseTask('${t.task_id || t.id}')\">æš‚åœ</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">å–æ¶ˆ</button>`);
            } else if (t.status === 'paused') {
                buttons.push(`<button class="btn btn-success" onclick=\"resumeTask('${t.task_id || t.id}')\">æ¢å¤</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">å–æ¶ˆ</button>`);
            }
            return buttons.join(' ');
        }

        async function pauseTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/pause`, { method: 'POST' });
            if (res.error) return alert('æš‚åœå¤±è´¥: ' + res.error);
            refreshTasks();
        }
        async function resumeTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/resume`, { method: 'POST' });
            if (res.error) return alert('æ¢å¤å¤±è´¥: ' + res.error);
            refreshTasks();
        }
        async function cancelTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
            if (res.error) return alert('å–æ¶ˆå¤±è´¥: ' + res.error);
            refreshTasks();
        }

        async function clearCompletedTasks() {
            const res = await apiRequest('/api/tasks/clear-completed', { method: 'POST' });
            if (res.error) return alert('æ¸…ç†å¤±è´¥: ' + res.error);
            refreshTasks();
        }

        // æŸ¥çœ‹è®¢é˜…è¯¦æƒ…
        async function viewSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}`);
            if (result.error) {
                alert('è·å–è®¢é˜…è¯¦æƒ…å¤±è´¥: ' + result.error);
                return;
            }
            
            const sub = result;
            const typeTexts = {
                'collection': 'åˆé›†è®¢é˜…',
                'uploader': 'UPä¸»è®¢é˜…', 
                'keyword': 'å…³é”®è¯è®¢é˜…',
                'specific-urls': 'ç‰¹å®šè§†é¢‘è®¢é˜…'
            };
            
            let detailsHtml = `
                <h3>è®¢é˜…è¯¦æƒ…</h3>
                <p><strong>åç§°:</strong> ${sub.name}</p>
                <p><strong>ç±»å‹:</strong> ${typeTexts[sub.type] || sub.type}</p>
                <p><strong>URL:</strong> ${sub.url}</p>
                <p><strong>çŠ¶æ€:</strong> ${sub.is_active ? 'æ´»è·ƒ' : 'æš‚åœ'}</p>
                <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(sub.created_at).toLocaleString()}</p>
                <p><strong>æœ€åæ£€æŸ¥:</strong> ${sub.last_check ? new Date(sub.last_check).toLocaleString() : 'ä»æœª'}</p>
            `;
            
            if (sub.date_after || sub.date_before || sub.min_likes || sub.min_favorites || sub.min_views) {
                detailsHtml += '<h4>ç­›é€‰æ¡ä»¶:</h4>';
                if (sub.date_after) detailsHtml += `<p>å¼€å§‹æ—¥æœŸ: ${sub.date_after}</p>`;
                if (sub.date_before) detailsHtml += `<p>ç»“æŸæ—¥æœŸ: ${sub.date_before}</p>`;
                if (sub.min_likes) detailsHtml += `<p>æœ€å°ç‚¹èµ: ${sub.min_likes}</p>`;
                if (sub.min_favorites) detailsHtml += `<p>æœ€å°æ”¶è—: ${sub.min_favorites}</p>`;
                if (sub.min_views) detailsHtml += `<p>æœ€å°æ’­æ”¾: ${sub.min_views}</p>`;
            }
            
            // åˆ›å»ºæ¨¡æ€æ¡†æ˜¾ç¤ºè¯¦æƒ…
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
                    ${detailsHtml}
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn" style="margin-top: 1rem;">å…³é—­</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // ç¼–è¾‘è®¢é˜…
        async function editSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}`);
            if (result.error) {
                alert('è·å–è®¢é˜…ä¿¡æ¯å¤±è´¥: ' + result.error);
                return;
            }
            
            const sub = result;
            
            // åˆ›å»ºç¼–è¾‘è¡¨å•æ¨¡æ€æ¡†
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; overflow-y: auto;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; margin: 2rem;">
                    <h3>ç¼–è¾‘è®¢é˜…</h3>
                    <form id="edit-subscription-form">
                        <div class="form-group">
                            <label>è®¢é˜…åç§°</label>
                            <input type="text" id="edit-name" value="${sub.name}" required>
                        </div>
                        <div class="form-group">
                            <label>è®¢é˜…URL</label>
                            <input type="url" id="edit-url" value="${sub.url}" required>
                        </div>
                        <div class="form-group">
                            <label>çŠ¶æ€</label>
                            <select id="edit-active">
                                <option value="true" ${sub.is_active ? 'selected' : ''}>æ´»è·ƒ</option>
                                <option value="false" ${!sub.is_active ? 'selected' : ''}>æš‚åœ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>å¼€å§‹æ—¥æœŸ (å¯é€‰)</label>
                            <input type="date" id="edit-date-after" value="${sub.date_after || ''}">
                        </div>
                        <div class="form-group">
                            <label>ç»“æŸæ—¥æœŸ (å¯é€‰)</label>
                            <input type="date" id="edit-date-before" value="${sub.date_before || ''}">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°ç‚¹èµæ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-likes" value="${sub.min_likes || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°æ”¶è—æ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-favorites" value="${sub.min_favorites || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°æ’­æ”¾æ•° (å¯é€‰)</label>
                            <input type="number" id="edit-min-views" value="${sub.min_views || ''}" min="0">
                        </div>
                        <div style="margin-top: 1rem;">
                            <button type="button" onclick="updateSubscription(${id})" class="btn btn-primary">ä¿å­˜</button>
                            <button type="button" onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn btn-secondary" style="margin-left: 0.5rem;">å–æ¶ˆ</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // æ›´æ–°è®¢é˜…
        async function updateSubscription(id) {
            const formData = {
                name: document.getElementById('edit-name').value,
                url: document.getElementById('edit-url').value,
                is_active: document.getElementById('edit-active').value === 'true',
                date_after: document.getElementById('edit-date-after').value || null,
                date_before: document.getElementById('edit-date-before').value || null,
                min_likes: parseInt(document.getElementById('edit-min-likes').value) || null,
                min_favorites: parseInt(document.getElementById('edit-min-favorites').value) || null,
                min_views: parseInt(document.getElementById('edit-min-views').value) || null
            };
            
            const result = await apiRequest(`/api/subscriptions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (result.error) {
                alert('æ›´æ–°è®¢é˜…å¤±è´¥: ' + result.error);
            } else {
                alert('è®¢é˜…æ›´æ–°æˆåŠŸ');
                document.querySelector('div[style*="position: fixed"]').remove();
                loadSubscriptions();
            }
        }

        // åˆ é™¤è®¢é˜…
        async function deleteSubscription(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢é˜…å—ï¼Ÿ')) return;
            
            const result = await apiRequest(`/api/subscriptions/${id}`, { method: 'DELETE' });
            if (result.error) {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            } else {
                alert('åˆ é™¤æˆåŠŸ');
                loadSubscriptions();
            }
        }

        // â€”â€” è§†é¢‘ç®¡ç†ï¼ˆæ–°ï¼‰ â€”â€”
        let __subStatsCache = [];

        async function loadVideos() {
            // å±•ç¤ºå®¹å™¨
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';

            await loadMediaOverview(false);
            await loadSubscriptionStats();
            await loadDirectoryStats();
        }

        async function loadMediaOverview(scan) {
            const content = document.getElementById('media-overview-content');
            content.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest(`/api/media/overview${scan ? '?scan=true' : ''}`);
            const totalSize = formatBytes(data.total_size || 0);
            const diskInfo = data.scan ? ` | æ–‡ä»¶æ•°: ${data.files_on_disk || 0} | ç£ç›˜å ç”¨: ${formatBytes(data.size_on_disk || 0)} | è·¯å¾„: ${data.download_path || ''}` : '';
            content.innerHTML = `
                <div>æ€»è§†é¢‘: <strong>${data.total_videos || 0}</strong> | å·²ä¸‹è½½: <strong>${data.downloaded_videos || 0}</strong> | æ€»å®¹é‡(æ•°æ®åº“): <strong>${totalSize}</strong> ${diskInfo}</div>
            `;
        }

        async function loadSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            content.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/media/subscription-stats');
            if (data && data.error) {
                content.innerHTML = `<p class="status error">è®¢é˜…ç»Ÿè®¡è·å–å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                __subStatsCache = [];
                return;
            }
            __subStatsCache = Array.isArray(data) ? data : [];
            renderSubscriptionStats();
        }

        function renderSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            const kw = (document.getElementById('sub-filter').value || '').toLowerCase();
            const list = __subStatsCache.filter(x => !kw || (x.subscription_name || '').toLowerCase().includes(kw));
            if (list.length === 0) { content.innerHTML = '<p>æš‚æ— æ•°æ®</p>'; return; }
            const rows = list.map(x => `
                <tr>
                    <td>${x.subscription_name || '-'}</td>
                    <td>${x.type || '-'}</td>
                    <td style="text-align:right;">${x.total_videos}</td>
                    <td style="text-align:right;">${x.downloaded_videos}</td>
                    <td style="text-align:right;">${formatBytes(x.total_size || 0)}</td>
                    <td>${x.latest_upload ? new Date(x.latest_upload).toLocaleString() : '-'}</td>
                    <td><button class="btn btn-small" onclick="showSubscriptionDetail(${x.subscription_id}, '${(x.subscription_name || '').replace(/'/g, "\'")}')">æŸ¥çœ‹æ˜ç»†</button></td>
                </tr>
            `).join('');
            content.innerHTML = `
                <div style="overflow:auto;">
                  <table style="width:100%; border-collapse: collapse;">
                    <thead>
                      <tr style="text-align:left; border-bottom:1px solid #eee;">
                        <th>è®¢é˜…åç§°</th><th>ç±»å‹</th><th style="text-align:right;">æ€»æ•°</th><th style="text-align:right;">å·²ä¸‹è½½</th><th style="text-align:right;">å®¹é‡</th><th>æœ€è¿‘ä¸Šä¼ </th><th>æ“ä½œ</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
            `;
        }

        async function showSubscriptionDetail(sid, name) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'block';
            document.getElementById('media-sub-detail-title').innerText = `è®¢é˜…æ˜ç»† - ${name || sid}`;
            await loadSubscriptionDetailPage(sid, 1);
        }

        function hideSubscriptionDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';
        }

        async function loadSubscriptionDetailPage(sid, page) {
            const size = 20;
            const data = await apiRequest(`/api/media/subscriptions/${sid}/videos?page=${page}&size=${size}&include_disk=true`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td style="text-align:right;">${formatBytes(v.file_size || 0)}</td>
                    <td>${v.on_disk ? 'åœ¨ç£ç›˜' : 'ç¼ºæ–‡ä»¶'}</td>
                    <td><small>${v.video_path || '-'}</small></td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page-1})">ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page+1})">ä¸‹ä¸€é¡µ</button>
                </div>`;
            document.getElementById('media-sub-detail-content').innerHTML = `
                <div style="overflow:auto;">
                  <table style="width:100%; border-collapse: collapse;">
                    <thead>
                      <tr style="text-align:left; border-bottom:1px solid #eee;">
                        <th>æ ‡é¢˜</th><th>BV</th><th>ä¸Šä¼ æ—¥æœŸ</th><th style="text-align:right;">å¤§å°</th><th>ç£ç›˜</th><th>è·¯å¾„</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="6">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}
            `;
        }

        function formatBytes(bytes) {
            if (!bytes || bytes <= 0) return '0 B';
            const units = ['B','KB','MB','GB','TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + units[i];
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',' ':' ' }[c] || c));
        }

        // â€”â€” ç›®å½•ç»Ÿè®¡ä¸æ˜ç»† â€”â€”
        async function loadDirectoryStats() {
            const wrap = document.getElementById('media-dir-stats-content');
            if (!wrap) return;
            wrap.innerHTML = 'åŠ è½½ä¸­...';
            const data = await apiRequest('/api/media/directories');
            if (data && data.error) {
                wrap.innerHTML = `<p class="status error">ç›®å½•ç»Ÿè®¡è·å–å¤±è´¥ï¼š${escapeHtml(data.error)}</p>`;
                return;
            }
            const items = (data && Array.isArray(data.items)) ? data.items : [];
            if (items.length === 0) { wrap.innerHTML = '<p>æš‚æ— ç›®å½•æ•°æ®</p>'; return; }
            const rows = items.map(d => `
              <tr>
                <td>${escapeHtml(d.dir)}</td>
                <td style="text-align:right;">${d.total_videos}</td>
                <td style="text-align:right;">${d.downloaded_videos}</td>
                <td style="text-align:right;">${formatBytes(d.total_size || 0)}</td>
                <td><button class="btn btn-small" onclick="showDirectoryDetail('${d.dir.replace(/'/g, "\\'")}')">æŸ¥çœ‹è§†é¢‘</button></td>
              </tr>`).join('');
            wrap.innerHTML = `
              <div class="table-wrap">
                <table class="data">
                  <thead>
                    <tr style="text-align:left; border-bottom:1px solid #eee;">
                      <th>ç›®å½•</th><th style="text-align:right;">æ€»æ•°</th><th style="text-align:right;">å·²ä¸‹è½½</th><th style="text-align:right;">å®¹é‡</th><th>æ“ä½œ</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
        }

        async function showDirectoryDetail(dir) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'none';
            document.getElementById('media-dir-stats').style.display = 'none';
            const panel = document.getElementById('media-dir-detail');
            panel.style.display = 'block';
            document.getElementById('media-dir-detail-title').innerText = `ç›®å½•æ˜ç»† - ${dir}`;
            await loadDirectoryVideosPage(dir, 1);
        }

        function hideDirectoryDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-dir-stats').style.display = 'block';
            document.getElementById('media-dir-detail').style.display = 'none';
        }

        async function loadDirectoryVideosPage(dir, page) {
            const size = 20;
            const data = await apiRequest(`/api/media/directory-videos?dir=${encodeURIComponent(dir)}&page=${page}&size=${size}`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td style="text-align:right;">${formatBytes(v.file_size || 0)}</td>
                    <td><small>${v.video_path || '-'}</small></td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page-1})">ä¸Šä¸€é¡µ</button>
                    <span>ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page+1})">ä¸‹ä¸€é¡µ</button>
                </div>`;
            document.getElementById('media-dir-detail-content').innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr style="text-align:left; border-bottom:1px solid #eee;">
                        <th>æ ‡é¢˜</th><th>BV</th><th>ä¸Šä¼ æ—¥æœŸ</th><th style="text-align:right;">å¤§å°</th><th>è·¯å¾„</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="5">æš‚æ— æ•°æ®</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}`;
        }

        // åŠ è½½Cookieåˆ—è¡¨
        async function loadCookies() {
            const data = await apiRequest('/api/cookies');
            const html = data.map(cookie => `
                <div class="list-item">
                    <div>
                        <strong>${cookie.name}</strong>
                        <br><small>ä½¿ç”¨æ¬¡æ•°: ${cookie.usage_count} | çŠ¶æ€: ${cookie.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleCookieActive(${cookie.id}, ${cookie.is_active})">${cookie.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
                        <button class="btn" onclick="validateCookie(${cookie.id})">éªŒè¯</button>
                        <button class="btn" onclick="deleteCookie(${cookie.id})" style="background:#dc3545;">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cookie-list').innerHTML = html || '<p>æš‚æ— Cookie</p>';
        }

        // æ˜¾ç¤º/éšè—æ·»åŠ Cookieè¡¨å•
        function showAddCookie() {
            document.getElementById('add-cookie').style.display = 'block';
        }
        function hideAddCookie() {
            document.getElementById('add-cookie').style.display = 'none';
        }

        // æ·»åŠ Cookie
        async function addCookie() {
            const name = document.getElementById('cookie-name').value;
            const sessdata = document.getElementById('cookie-sessdata').value;
            const bili_jct = document.getElementById('cookie-jct').value;
            const dedeuserid = document.getElementById('cookie-userid').value;
            
            if (!name || !sessdata) {
                alert('è¯·è¾“å…¥Cookieåç§°å’ŒSESSDATA');
                return;
            }
            
            const data = { name, sessdata, bili_jct, dedeuserid };
            const result = await apiRequest('/api/cookies', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('æ·»åŠ å¤±è´¥: ' + result.error);
            } else {
                alert('æ·»åŠ æˆåŠŸ');
                hideAddCookie();
                loadCookies();
            }
        }

        // éªŒè¯Cookie
        async function validateCookie(id) {
            const result = await apiRequest(`/api/cookies/${id}/validate`, { method: 'POST' });
            alert(result.valid ? 'Cookieæœ‰æ•ˆ' : 'Cookieæ— æ•ˆ');
            loadCookies();
        }

        // å¯ç”¨/ç¦ç”¨ Cookie
        async function toggleCookieActive(id, current) {
            const payload = { is_active: !current };
            const result = await apiRequest(`/api/cookies/${id}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
            if (result && result.error) {
                alert('åˆ‡æ¢å¤±è´¥: ' + result.error);
            } else {
                loadCookies();
            }
        }

        // åˆ é™¤Cookie
        async function deleteCookie(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªCookieå—ï¼Ÿ')) return;
            
            const result = await apiRequest(`/api/cookies/${id}`, { method: 'DELETE' });
            if (result.error) {
                alert('åˆ é™¤å¤±è´¥: ' + result.error);
            } else {
                alert('åˆ é™¤æˆåŠŸ');
                loadCookies();
            }
        }

        // åŠ è½½ç³»ç»Ÿè®¾ç½®
        async function loadSettings() {
            const data = await apiRequest('/api/settings');
            const html = Object.entries(data).map(([key, setting]) => `
                <div class="form-group">
                    <label>${setting.description}</label>
                    <input type="text" value="${setting.value}" onchange="updateSetting('${key}', this.value)">
                </div>
            `).join('');
            document.getElementById('settings-list').innerHTML = html;
        }

        // æ›´æ–°è®¾ç½®
        async function updateSetting(key, value) {
            const result = await apiRequest(`/api/settings/${key}`, {
                method: 'PUT',
                body: JSON.stringify({ value })
            });
            
            if (result.error) {
                alert('æ›´æ–°å¤±è´¥: ' + result.error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå¹¶åæ€»è§ˆéœ€è¦åŒæ—¶åŠ è½½ç³»ç»ŸçŠ¶æ€ä¸åª’ä½“æ•°æ®
            loadTabData('dashboard');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bili_curator V6</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #00a1d6 0%, #0084b4 100%); color: white; padding: 2rem 1rem; text-align: center; box-shadow: 0 4px 20px rgba(0,161,214,0.3); }
        .header h1 { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; font-size: 1.1rem; }
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .card { background: white; border-radius: 12px; padding: 1.5rem 2rem; margin-bottom: 1.5rem; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; transition: all 0.3s ease; }
        .card:hover { box-shadow: 0 8px 30px rgba(0,0,0,0.12); transform: translateY(-2px); }
        .card h3 { margin-bottom: 0.5rem; font-size: 1.05rem; color: #333; }
        .tabs { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 1rem; background: #fff; border-radius: 8px 8px 0 0; }
        .tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.3s ease; font-weight: 500; }
        .tab:hover { background: #f8f9fa; }
        .tab.active { border-bottom-color: #00a1d6; color: #00a1d6; background: #f0f9ff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .btn { background: #00a1d6; color: white; border: none; padding: 0.45rem 0.8rem; border-radius: 6px; cursor: pointer; }
        .btn:hover { background: #0084b4; }
        .btn-outline { background: #fff; color: #007fa6; border: 1px solid #cde8f3; }
        .btn-outline:hover { background: #f2fbff; }
        .btn-small { padding: 0.25rem 0.5rem; font-size: 12px; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        

        /* 任务管理样式 */
        .task-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .task-header h4 {
            margin: 0;
            color: #333;
        }

        /* 统计小胶囊 */
        .subscription-stats .stat-item { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border-radius: 999px; background: #f6f8fa; border: 1px solid #eef2f7; color: #333; }
        .stat-total { background: #eef7ff; color: #0b5cab; border-color: #d9ecff; }
        .stat-downloaded { background: #e9f9ef; color: #1e7e34; border-color: #d6f5df; }
        .stat-pending { background: #fff7e6; color: #b26a00; border-color: #ffe7ba; }

        /* 表格统一样式（视频管理） */
        .table-wrap { overflow: auto; }
        table.data { width: 100%; border-collapse: collapse; font-size: 14px; }
        table.data thead th { position: sticky; top: 0; background: #f9fbfd; color: #445; text-align: left; border-bottom: 1px solid #eef2f7; padding: 10px 12px; }
        table.data tbody td { border-bottom: 1px solid #f0f3f7; padding: 10px 12px; color: #333; }
        table.data tbody tr:nth-child(even) { background: #fcfdff; }
        table.data tbody tr:hover { background: #f0f7ff; }
        .pager { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
        .num { text-align: right; }
        .mono { font-family: Menlo, Monaco, Consolas, 'Courier New', monospace; font-size: 12px; color: #555; }

        /* 卡片内分节标题行 */
        .card .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom: 8px; }

        /* 队列管理样式 */
        .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; background:#f3f4f6; color:#374151; }
        .badge-success { background:#ecfdf5; color:#065f46; border-color:#a7f3d0; }
        .badge-danger { background:#fef2f2; color:#991b1b; border-color:#fecaca; }
        .stat-card { border:1px solid #e5e7eb; border-radius:8px; padding:12px; background:#fff; }
        .stat-title { font-weight:600; margin-bottom:6px; color:#374151; }
        .stat-row { display:flex; align-items:center; justify-content: space-between; padding:4px 0; }
        .stat-label { color:#6b7280; font-size:12px; }
        .stat-number { font-weight:700; color:#111827; }
        .stat-number.ok { color:#065f46; }
        .stat-number.warn { color:#b45309; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .status.pending { background: #f3f4f6; color: #374151; }
        .status.running { background: #dbeafe; color: #1e40af; }
        .status.done { background: #dcfce7; color: #166534; }
        .status.failed { background: #fee2e2; color: #dc2626; }
        .status.cancelled { background: #f3f4f6; color: #6b7280; }

        .task-controls {
            display: flex;
            gap: 8px;
        }

        .task-info {
            display: flex;
            gap: 16px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-status {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            color: white;
        }

        .status-pending .task-status { background-color: #6c757d; }
        .status-checking .task-status { background-color: #17a2b8; }
        .status-downloading .task-status { background-color: #007bff; }
        .status-paused .task-status { background-color: #ffc107; color: #000; }
        .status-completed .task-status { background-color: #28a745; }
        .status-failed .task-status { background-color: #dc3545; }
        .status-cancelled .task-status { background-color: #6c757d; }

        .task-progress {
            color: #666;
        }

        .current-video {
            color: #007bff;
            font-style: italic;
        }

        .progress-bar {
            position: relative;
            background-color: #e9ecef;
            border-radius: 4px;
            height: 20px;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .progress-fill {
            background-color: #007bff;
            height: 100%;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }

        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 12px;
            font-size: 14px;
        }

        .task-logs {
            margin-top: 12px;
        }

        .logs-content {
            background-color: #f1f3f4;
            border: 1px solid #e1e3e4;
            border-radius: 4px;
            padding: 12px;
            margin-top: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            color: #333;
            margin-bottom: 4px;
            white-space: pre-wrap;
        }

        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #000;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-info {
            background-color: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background-color: #138496;
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
        }

        .btn-outline {
            background-color: transparent;
            border: 1px solid #6c757d;
            color: #6c757d;
        }

        .btn-outline:hover {
            background-color: #6c757d;
            color: white;
        }

        /* 表单增强样式 */
        .form-section {
            margin-top: 20px;
            padding: 16px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .form-section h4 {
            margin: 0 0 16px 0;
            color: #495057;
            font-size: 16px;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }

        .half-width {
            flex: 1;
        }

        .third-width {
            flex: 1;
        }

        .help-text {
            font-size: 12px;
            color: #6c757d;
            font-weight: normal;
        }

        /* 订阅统计样式 */
        .subscription-stats { display: flex; gap: 12px; margin-top: 6px; font-size: 13px; }

        .stat-item {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .stat-total {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .stat-downloaded {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .stat-pending {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .subscription-item { border: 1px solid #e9ecef; border-radius: 8px; padding: 14px; margin-bottom: 12px; background-color: #fff; }
        .section-toolbar { display:flex; gap:8px; align-items:center; }
        .muted { color:#6b7280; }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .subscription-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin: 0;
        }

        .subscription-type {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .type-collection {
            background-color: #007bff;
        }

        .type-uploader {
            background-color: #28a745;
        }

        .type-keyword {
            background-color: #ffc107;
            color: #000;
        }

        .type-specific_urls {
            background-color: #6f42c1;
        }

        .subscription-controls {
            display: flex;
            gap: 8px;
        }

        .subscription-filters {
            margin-top: 8px;
            font-size: 12px;
            color: #6c757d;
        }

        .filter-tag {
            display: inline-block;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 6px;
            margin-bottom: 4px;
        }

        .status { padding: 0.5rem; border-radius: 4px; margin-bottom: 1rem; }
        .status.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .list-item { padding: 0.75rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .list-item:last-child { border-bottom: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>🎬 bili_curator V6</h1>
        <p>B站视频下载管理系统 - 家用简化版</p>
    </div>

    <div class="container">
        <div class="card">
            <div class="tabs">
                <div class="tab" onclick="showTab(this,'dashboard')">总览</div>
                <div class="tab" onclick="showTab(this,'subscriptions')">订阅管理</div>
                <div class="tab" onclick="showTab(this,'tasks')">下载任务</div>
                <div class="tab" onclick="showTab(this,'queue')">队列管理</div>
                <div class="tab" onclick="showTab(this,'cookies')">Cookie管理</div>
                <div class="tab" onclick="showTab(this,'settings')">系统设置</div>
            </div>

            <!-- 总览（合并仪表盘 + 视频管理） -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2>系统状态</h2>
                    <div id="system-status">加载中...</div>
                </div>

                <div id="global-overview" class="card" style="margin-top:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>全局总览</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button class="btn btn-outline" onclick="loadOverview()">刷新</button>
                            <button id="btn-sync-global" class="btn" onclick="triggerLiteSyncGlobal()">轻量同步</button>
                        </div>
                    </div>
                    <div id="global-overview-content" style="margin-top:8px;">加载中...</div>
                </div>

                <div id="media-overview" class="card" style="margin-top:8px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>媒体总览</h3>
                        <div>
                            <button class="btn btn-outline" onclick="loadMediaOverview(false)">刷新</button>
                            <button class="btn" onclick="loadMediaOverview(true)">扫描磁盘</button>
                        </div>
                    </div>
                    <div id="media-overview-content" style="margin-top:8px;">加载中...</div>
                </div>

                <div id="media-sub-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>订阅统计</h3>
                        <input id="sub-filter" type="text" placeholder="搜索订阅名称..." oninput="renderSubscriptionStats()" style="padding:6px; border:1px solid #ddd; border-radius:4px;">
                    </div>
                    <div id="media-sub-stats-content" style="margin-top:8px;">加载中...</div>
                </div>

                <div id="media-dir-stats" class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>目录统计</h3>
                    </div>
                    <div id="media-dir-stats-content" style="margin-top:8px;">加载中...</div>
                </div>

                <div id="media-sub-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-sub-detail-title">订阅明细</h3>
                        <button class="btn btn-outline" onclick="hideSubscriptionDetail()">返回统计</button>
                    </div>
                    <div id="media-sub-detail-content" style="margin-top:8px;">加载中...</div>
                </div>

                <div id="media-dir-detail" class="card" style="display:none;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="media-dir-detail-title">目录明细</h3>
                        <button class="btn btn-outline" onclick="hideDirectoryDetail()">返回统计</button>
                    </div>
                    <div id="media-dir-detail-content" style="margin-top:8px;">加载中...</div>
                </div>
            </div>
            <!-- 队列诊断模态 -->
            <div id="queue-insights-modal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
                <div style="position: absolute; right: 0; top: 0; height: 100%; width: min(560px, 100%); background: #fff; box-shadow: -2px 0 8px rgba(0,0,0,0.15); display:flex; flex-direction:column;">
                    <div style="padding:12px 16px; border-bottom:1px solid #eee; display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <h3 style="margin:0;">队列诊断</h3>
                            <small id="insights-meta" style="color:#666;"></small>
                        </div>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-outline" onclick="loadQueueInsights()">刷新</button>
                            <button class="btn" onclick="hideQueueInsights()">关闭</button>
                        </div>
                    </div>
                    <div id="queue-insights-content" style="padding: 12px 16px; overflow: auto; flex:1;">
                        加载中...
                    </div>
                </div>
            </div>

            <!-- 订阅管理 -->
            <div id="subscriptions" class="tab-content">
                <div class="section-header">
                    <h2>订阅管理</h2>
                    <div style="display:flex; gap:8px; flex-wrap: wrap; align-items:center;">
                        <button onclick="showAddSubscription()" class="btn btn-primary">添加订阅</button>
                        <button onclick="scanAll()" class="btn btn-secondary">全量扫描导入</button>
                        <button onclick="associateAll()" class="btn btn-outline">全量自动关联</button>
                        <button onclick="triggerCheckSubscriptions()" class="btn">检查订阅</button>
                        <button onclick="triggerLiteSyncGlobal()" class="btn">轻量同步(全局)</button>
                        <button onclick="loadSubscriptions()" class="btn btn-info">刷新列表</button>
                    </div>
                </div>
                <div id="subscription-list"></div>
            </div>
            
            <!-- 下载任务 -->
            <div id="tasks" class="tab-content">
                <div class="section-header">
                    <h2>下载任务</h2>
                    <button onclick="refreshTasks()" class="btn btn-secondary">刷新</button>
                    <button onclick="clearCompletedTasks()" class="btn btn-outline">清理完成任务</button>
                </div>
                <div class="card" id="download-aggregate" style="margin-bottom:12px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>下载汇总（按订阅）</h3>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button id="agg-collapse-btn" class="btn btn-outline" onclick="DownloadAggregateManager.toggleCollapse()" title="折叠/展开">折叠</button>
                            <button class="btn btn-outline" onclick="DownloadAggregateManager.load()">刷新</button>
                            <label style="color:#666; font-size:12px; display:flex; align-items:center; gap:6px;">
                                <input type="checkbox" id="agg-autorefresh" onchange="DownloadAggregateManager.toggleAuto(this.checked)"> 自动刷新(15s)
                            </label>
                        </div>
                    </div>
                    <div id="agg-content">
                        <div id="agg-totals" class="subscription-stats" style="margin:8px 0;">-</div>
                        <div class="table-wrap">
                            <table class="data">
                                <thead>
                                    <tr>
                                        <th>订阅名</th>
                                        <th class="num">Downloaded</th>
                                        <th class="num">Pending</th>
                                        <th class="num">Queued</th>
                                        <th class="num">Running</th>
                                        <th class="num">RemoteTotal</th>
                                    </tr>
                                </thead>
                                <tbody id="agg-tbody"></tbody>
                            </table>
                        </div>
                        <div style="margin-top:6px; color:#6b7280; font-size:12px;">注：Pending 为估算值；无远端总数(remote_total)时按 0 处理，口径“以本地为主”。</div>
                    </div>
                </div>
                <div id="task-list">加载中...</div>
            </div>

            <!-- 队列管理 -->
            <div id="queue" class="tab-content">
                <div class="section-header">
                    <h2>请求队列管理</h2>
                    <div style="font-size: 14px; color: #666;">可视化控制并发、暂停和任务优先级，实时观察队列</div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; margin-bottom: 20px;">
                    <div class="card">
                        <h3>暂停/恢复</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <select id="pause-scope" style="padding: 6px 8px; border: 1px solid #ddd; border-radius: 6px;">
                                <option value="all">全部(all)</option>
                                <option value="requires_cookie">需要Cookie</option>
                                <option value="no_cookie">无需Cookie</option>
                            </select>
                            <button id="btn-pause" class="btn">暂停</button>
                            <button id="btn-resume" class="btn">恢复</button>
                        </div>
                        <div style="color: #666; font-size: 12px;">注：暂停仅阻止新任务进入运行，已在运行中的任务不被强制中断。</div>
                    </div>

                    <div class="card">
                        <h3>并发配置</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px;">需要Cookie: <input id="cap-cookie" type="number" min="0" value="1" style="width:80px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px;" /></label>
                            <label style="display: flex; align-items: center; gap: 8px;">无需Cookie: <input id="cap-nocookie" type="number" min="0" value="2" style="width:80px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 4px;" /></label>
                            <button id="btn-apply-cap" class="btn">应用</button>
                        </div>
                        <div style="color: #666; font-size: 12px;">修改后立即生效。设置为 0 表示禁止该通道的新任务进入运行。</div>
                    </div>

                    <div class="card">
                        <h3>任务操作</h3>
                        <div style="margin-bottom: 12px;">
                            <input id="job-id" placeholder="输入 job_id" style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;" />
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button id="btn-cancel" class="btn btn-outline">取消</button>
                            <button id="btn-prio" class="btn">置顶优先</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="display:flex; align-items:center; gap:8px;">队列总览 <span id="badge-paused" style="padding: 2px 8px; border-radius: 999px; font-size: 12px; border: 1px solid #e5e7eb; background:#f3f4f6; color:#374151;">-</span></h3>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-top:8px;" id="cap-cards">
                        <!-- cards injected here -->
                    </div>
                    <details style="margin-top:8px;">
                        <summary style="cursor:pointer;">查看原始数据(JSON)</summary>
                        <pre id="stats" style="margin-top:8px; color: #666; font-size: 12px; background: #f8f9fa; padding: 12px; border-radius: 6px; overflow: auto;">载入中...</pre>
                    </details>
                </div>

                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <h3>请求列表</h3>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <div style="color: #666; font-size: 14px;">每 2 秒自动刷新</div>
                            <button id="btn-refresh" class="btn btn-outline">立即刷新</button>
                            <button id="btn-insights" class="btn" onclick="showQueueInsights()">诊断</button>
                        </div>
                    </div>
                    <div class="table-wrap">
                        <table class="data">
                            <thead>
                                <tr>
                                    <th>job_id</th>
                                    <th>类型</th>
                                    <th>订阅ID</th>
                                    <th>需Cookie</th>
                                    <th>状态</th>
                                    <th>创建</th>
                                    <th>开始</th>
                                    <th>结束</th>
                                    <th>错误</th>
                                </tr>
                            </thead>
                            <tbody id="queue-tbody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
                <div id="add-subscription" style="display:none; margin-top:1rem;">
                    <h3>添加新订阅</h3>
                    <div class="form-group">
                        <label>订阅类型</label>
                        <select id="sub-type" onchange="toggleSubFields()">
                            <option value="collection">合集订阅</option>
                            <option value="uploader">UP主订阅</option>
                            <option value="keyword">关键词订阅</option>
                            <option value="specific_urls">特定视频订阅</option>
                        </select>
                    </div>
                    
                    <!-- 合集订阅字段 -->
                    <div class="form-group" id="collection-fields">
                        <label>合集URL <span class="help-text">粘贴B站合集链接，系统会自动识别名称</span></label>
                        <input type="text" id="sub-url" placeholder="https://space.bilibili.com/xxx/channel/collectiondetail?sid=xxx" onblur="autoFillCollectionName()">
                    </div>
                    
                    <!-- UP主订阅字段 -->
                    <div class="form-group" id="uploader-fields" style="display:none;">
                        <label>UP主ID或名称 <span class="help-text">输入UP主的ID或用户名</span></label>
                        <input type="text" id="sub-uploader" placeholder="UP主ID或用户名">
                    </div>
                    
                    <!-- 关键词订阅字段 -->
                    <div class="form-group" id="keyword-fields" style="display:none;">
                        <label>搜索关键词 <span class="help-text">输入要搜索的关键词</span></label>
                        <input type="text" id="sub-keyword" placeholder="搜索关键词">
                    </div>
                    
                    <!-- 特定URL字段 -->
                    <div class="form-group" id="specific-urls-fields" style="display:none;">
                        <label>特定视频URL <span class="help-text">每行一个视频链接</span></label>
                        <textarea id="sub-specific-urls" rows="4" placeholder="https://www.bilibili.com/video/BVxxx&#10;https://www.bilibili.com/video/BVyyy"></textarea>
                    </div>
                    
                    <!-- 筛选条件 -->
                    <div class="form-section">
                        <h4>筛选条件 <span class="help-text">可选，用于过滤下载的视频</span></h4>
                        
                        <div class="form-row">
                            <div class="form-group half-width">
                                <label>开始日期</label>
                                <input type="date" id="sub-date-after">
                            </div>
                            <div class="form-group half-width">
                                <label>结束日期</label>
                                <input type="date" id="sub-date-before">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group third-width">
                                <label>最小点赞数</label>
                                <input type="number" id="sub-min-likes" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>最小收藏数</label>
                                <input type="number" id="sub-min-favorites" placeholder="0" min="0">
                            </div>
                            <div class="form-group third-width">
                                <label>最小播放数</label>
                                <input type="number" id="sub-min-views" placeholder="0" min="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>订阅名称</label>
                        <input type="text" id="sub-name" placeholder="自动识别或手动输入">
                        <small style="color:#666;">合集订阅会自动识别为"UP主名：合集名"</small>
                    </div>
                    
                    <button class="btn" onclick="addSubscription()">添加订阅</button>
                    <button class="btn" onclick="hideAddSubscription()" style="background:#666;">取消</button>
                </div>
            </div>


            <!-- Cookie管理 -->
            <div id="cookies" class="tab-content">
                <h2>Cookie管理</h2>
                <button class="btn" onclick="showAddCookie()">添加Cookie</button>
                <button class="btn btn-outline" onclick="validateAllCookies()">全部验证</button>
                <div id="cookie-list">加载中...</div>
                
                <div id="add-cookie" style="display:none; margin-top:1rem;">
                    <h3>添加新Cookie</h3>
                    <div class="form-group">
                        <label>Cookie名称</label>
                        <input type="text" id="cookie-name" placeholder="输入Cookie名称">
                    </div>
                    <div class="form-group">
                        <label>SESSDATA</label>
                        <input type="text" id="cookie-sessdata" placeholder="输入SESSDATA值">
                    </div>
                    <div class="form-group">
                        <label>bili_jct</label>
                        <input type="text" id="cookie-jct" placeholder="输入bili_jct值">
                    </div>
                    <div class="form-group">
                        <label>DedeUserID</label>
                        <input type="text" id="cookie-userid" placeholder="输入DedeUserID值">
                    </div>
                    <button class="btn" onclick="addCookie()">添加</button>
                    <button class="btn" onclick="hideAddCookie()" style="background:#666;">取消</button>
                </div>
            </div>

            <!-- 系统设置 -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h2>系统设置</h2>
                    <div id="settings-list">加载中...</div>
                </div>
                
                <div class="card">
                    <h2>数据一致性检查</h2>
                    <p>检查本地目录与数据库记录的一致性，确保数据准确性。</p>
                    <div style="margin: 1rem 0;">
                        <button id="btn-consistency-check" class="btn" onclick="triggerConsistencyCheck()">执行一致性检查</button>
                        <button class="btn btn-outline" onclick="loadConsistencyStats()">刷新统计</button>
                    </div>
                    <div id="consistency-stats" style="margin-top: 1rem;">
                        <div class="status">点击"刷新统计"查看当前状态</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 标签页切换
        function showTab(el, tabName) {
            // 兼容旧调用签名：showTab('videos')
            if (typeof el === 'string' && !tabName) {
                tabName = el;
                el = null;
            }
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            if (el && el.classList) {
                el.classList.add('active');
            } else {
                // 无 el 时，激活与 tabName 对应的 tab
                const candidate = Array.from(document.querySelectorAll('.tab')).find(t => (t.getAttribute('onclick') || '').includes(`'${tabName}'`));
                if (candidate) candidate.classList.add('active');
            }
            const pane = document.getElementById(tabName);
            if (pane) pane.classList.add('active');
            // 加载对应数据
            loadTabData(tabName);
        }

        // 加载标签页数据
        function loadTabData(tabName) {
            // 切换到非任务标签时停止轮询
            if (tabName !== 'tasks') {
                stopTasksPolling();
                if (typeof DownloadAggregateManager !== 'undefined') DownloadAggregateManager.stop();
            }
            // 切换到非队列标签时停止队列轮询
            if (tabName !== 'queue') {
                stopQueuePolling();
            }
            // 切换到非订阅标签时停止订阅同步轮询
            if (tabName !== 'subscriptions') {
                stopSubscriptionsSyncPolling();
            }
            // 切换到非设置标签时停止一致性轮询
            if (tabName !== 'settings') {
                stopConsistencyPolling();
            }
            switch(tabName) {
                case 'dashboard':
                    // 合并后的总览：系统状态 + 媒体概览
                    loadDashboard();
                    loadOverview();
                    loadVideos();
                    break;
                case 'subscriptions':
                    loadSubscriptions();
                    startSubscriptionsSyncPolling();
                    break;
                case 'tasks':
                    startTasksPolling();
                    if (typeof DownloadAggregateManager !== 'undefined') DownloadAggregateManager.start();
                    break;
                case 'cookies':
                    loadCookies();
                    break;
                case 'queue':
                    loadQueueData();
                    break;
                case 'settings':
                    loadSettings();
                    window.loadConsistencyStats();
                    startConsistencyPolling();
                    break;
            }
        }

        // API请求封装
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: { 'Content-Type': 'application/json', ...options.headers },
                    ...options
                });
                const ct = (response.headers.get('content-type') || '').toLowerCase();
                let payload;
                if (ct.includes('application/json')) {
                    payload = await response.json().catch(() => null);
                } else {
                    const text = await response.text().catch(() => '');
                    payload = text ? { message: text } : null;
                }
                if (!response.ok) {
                    const msg = (payload && (payload.error || payload.message)) || `HTTP ${response.status}`;
                    return { error: msg, status: response.status };
                }
                return payload ?? {};
            } catch (error) {
                console.error('API请求失败:', error);
                return { error: error.message };
            }
        }

        // 刷新并显示合集的远端总数（1小时缓存，localStorage 持久化）
        const __expectedCache = {};
        function getExpectedCache(id) {
            try {
                const k = `expectedCache:${id}`;
                const s = localStorage.getItem(k);
                if (!s) return null;
                const obj = JSON.parse(s);
                if (!obj || typeof obj.at !== 'number') return null;
                return obj;
            } catch (_) { return null; }
        }
        function setExpectedCache(id, value) {
            const obj = { value, at: Date.now() };
            __expectedCache[id] = obj;
            try { localStorage.setItem(`expectedCache:${id}`, JSON.stringify(obj)); } catch (_) {}
            return obj;
        }
        async function refreshExpected(subscriptionId, force = false) {
            const el = document.getElementById(`expected-${subscriptionId}`);
            if (!el) return;
            const countEl = el.querySelector('.expected-count');
            // 命中缓存且未过期（1小时）且非强制刷新
            const now = Date.now();
            const c = __expectedCache[subscriptionId] || getExpectedCache(subscriptionId);
            const notExpired = c && (now - c.at < 3600 * 1000);
            if (!force && notExpired) {
                if (countEl) countEl.textContent = String(c.value);
                return;
            }
            if (countEl) countEl.textContent = '加载中...';
            const data = await apiRequest(`/api/subscriptions/${subscriptionId}/expected-total`);
            if (data && typeof data.expected_total === 'number') {
                if (countEl) countEl.textContent = String(data.expected_total);
                setExpectedCache(subscriptionId, data.expected_total);
                // 同步更新待下载展示（优先远端）
                try {
                    const subEl = document.getElementById(`sub-${subscriptionId}`);
                    if (subEl) {
                        const downloaded = parseInt(subEl.getAttribute('data-downloaded') || '0', 10);
                        const pending = Math.max((data.expected_total - downloaded), 0);
                        const pEl = document.getElementById(`pending-${subscriptionId}`);
                        const sEl = document.getElementById(`pending-src-${subscriptionId}`);
                        if (pEl) pEl.textContent = String(pending);
                        if (sEl) sEl.textContent = '(远端)';
                    }
                } catch (_) {}
            } else {
                if (countEl) countEl.textContent = '获取失败';
            }
        }

        // 加载仪表板
        async function loadDashboard() {
            const data = await apiRequest('/api/status');
            const html = `
                <div class="status success">
                    <strong>系统运行正常</strong> - 版本: ${data.version || '6.0.0'}
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem;">
                    <div class="card">
                        <h3>订阅统计</h3>
                        <p>总订阅: ${data.statistics?.total_subscriptions || 0}</p>
                        <p>活跃订阅: ${data.statistics?.active_subscriptions || 0}</p>
                    </div>
                    <div class="card">
                        <h3>视频统计</h3>
                        <p>总视频: ${data.statistics?.total_videos || 0}</p>
                        <p>已下载: ${data.statistics?.downloaded_videos || 0}</p>
                    </div>
                    <div class="card">
                        <h3>Cookie状态</h3>
                        <p>可用Cookie: ${data.statistics?.active_cookies || 0}</p>
                    </div>
                </div>
            `;
            document.getElementById('system-status').innerHTML = html;
        }

        // 加载订阅列表
        async function loadSubscriptions() {
            const result = await apiRequest('/api/subscriptions');
            if (result.error) {
                document.getElementById('subscription-list').innerHTML = `<p class="error">加载失败: ${result.error}</p>`;
                return;
            }
            
            let html = '';
            result.forEach(sub => {
                const statusClass = sub.is_active ? 'success' : 'error';
                const statusText = sub.is_active ? '活跃' : '暂停';
                const lastCheck = sub.last_check ? new Date(sub.last_check).toLocaleString() : '从未';
                
                // 统计信息（优先使用后端提供的远端总计与待下载）
                const totalVideos = sub.total_videos || 0; // 本地有文件数（口径A）
                const dbTotalVideos = (typeof sub.db_total_videos === 'number') ? sub.db_total_videos : totalVideos; // 数据库记录总数
                const downloadedVideos = sub.downloaded_videos || 0;
                const remoteTotal = (typeof sub.remote_total === 'number') ? sub.remote_total : null;
                const serverPending = (typeof sub.pending_videos === 'number') ? Math.max(sub.pending_videos, 0) : null;
                const localPending = Math.max((totalVideos - downloadedVideos), 0);
                
                // 订阅类型显示
                const typeTexts = {
                    'collection': '合集订阅',
                    'uploader': 'UP主订阅', 
                    'keyword': '关键词订阅',
                    'specific_urls': '特定视频订阅'
                };
                const typeText = typeTexts[sub.type] || sub.type;
                
                // 筛选条件显示
                let filtersHtml = '';
                const filters = [];
                if (sub.date_after) filters.push(`开始日期: ${sub.date_after}`);
                if (sub.date_before) filters.push(`结束日期: ${sub.date_before}`);
                if (sub.min_likes) filters.push(`最小点赞: ${sub.min_likes}`);
                if (sub.min_favorites) filters.push(`最小收藏: ${sub.min_favorites}`);
                if (sub.min_views) filters.push(`最小播放: ${sub.min_views}`);
                
                if (filters.length > 0) {
                    filtersHtml = `
                        <div class="subscription-filters">
                            筛选条件: ${filters.map(f => `<span class="filter-tag">${f}</span>`).join('')}
                        </div>
                    `;
                }
                
                // 远端信息优先级：后端 remote_total/pending_videos > 本地缓存 expected_total > 本地计算
                const cached = getExpectedCache(sub.id);
                const cachedOk = cached && (Date.now() - cached.at < 3600*1000);
                const expectedText = (remoteTotal !== null) ? String(remoteTotal) : (cachedOk ? String(cached.value) : '未获取');
                const expectedForPending = (remoteTotal !== null) ? remoteTotal : (cachedOk ? cached.value : null);
                const pendingFromExpected = (expectedForPending !== null) ? Math.max((expectedForPending - downloadedVideos), 0) : null;
                const pendingToShow = (serverPending !== null) ? serverPending : ((pendingFromExpected !== null) ? pendingFromExpected : localPending);
                const pendingSource = (serverPending !== null) ? '后端' : ((expectedForPending !== null) ? '远端' : '本地');

                html += `
                    <div class="subscription-item" id="sub-${sub.id}" data-total="${totalVideos}" data-downloaded="${downloadedVideos}">
                        <div class="subscription-header">
                            <div>
                                <h3 class="subscription-title">${sub.name}</h3>
                                <span class="subscription-type type-${sub.type}">${typeText}</span>
                            </div>
                            <div class="subscription-controls">
                                <button onclick="associateSubscription(${sub.id})" class="btn btn-outline">自动关联</button>
                                <button onclick="viewPending(${sub.id})" class="btn btn-outline">查看待下载</button>
                                <button onclick="viewSubscription(${sub.id})" class="btn btn-info">查看详情</button>
                                <button onclick="editSubscription(${sub.id})" class="btn btn-secondary">编辑</button>
                                <button onclick="toggleSubscription(${sub.id}, ${sub.is_active})" class="btn ${sub.is_active ? 'btn-warning' : 'btn-success'}">
                                    ${sub.is_active ? '暂停' : '启用'}
                                </button>
                                <button onclick="deleteSubscription(${sub.id})" class="btn btn-danger">删除</button>
                                <button onclick="triggerLiteSyncSubscription(${sub.id}, this)" class="btn">轻量同步</button>
                                <span class="hint" style="margin-left:8px;color:#666;font-size:12px;">启用=自动入队下载（由调度器执行）</span>
                            </div>
                        </div>
                        
                        <div class="subscription-stats">
                            <span class="stat-item stat-total">本地(有文件): ${totalVideos}</span>
                            <span class="stat-item" title="数据库中的视频记录总数（可能包含无本地文件的记录）">数据库记录: ${dbTotalVideos}</span>
                            <span class="stat-item stat-downloaded">已下载: ${downloadedVideos}</span>
                            <span class="stat-item stat-pending">待下载: <span id="pending-${sub.id}">${pendingToShow}</span> <small id="pending-src-${sub.id}" style="opacity:.7;">(${pendingSource})</small></span>
                            <span class="stat-item" id="retry-${sub.id}" style="background:#fff0f0;color:#b91c1c;">失败回补队列: <span class="retry-count">-</span></span>
                            <span class="stat-item" id="expected-${sub.id}" style="background-color:#f3e5f5;color:#6a1b9a;">
                                远端总数: <span class="expected-count">${expectedText}</span>
                                <button class="btn btn-small btn-outline" style="margin-left:6px;" onclick="refreshExpected(${sub.id})">获取</button>
                                <button class="btn btn-small btn-outline" style="margin-left:6px;" onclick="refreshExpected(${sub.id}, true)">刷新</button>
                            </span>
                        </div>
                        
                        <div style="margin-top: 8px; font-size: 14px; color: #666;">
                            状态: ${statusText} | 最后检查: ${lastCheck}
                        </div>
                        
                        ${filtersHtml}
                    </div>
                `;
            });
            
            document.getElementById('subscription-list').innerHTML = html || '<p>暂无订阅</p>';
            // 高亮跳转的订阅（来自下载汇总点击）
            try {
                const sid = localStorage.getItem('highlight_subscription');
                if (sid) {
                    const el = document.getElementById('sub-' + sid);
                    if (el && typeof DownloadAggregateManager !== 'undefined' && DownloadAggregateManager.highlightEl) {
                        DownloadAggregateManager.highlightEl(el);
                    } else if (el) {
                        el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    localStorage.removeItem('highlight_subscription');
                }
            } catch (_) {}
            // 不再自动拉取，依赖本地缓存与按钮触发，避免频繁请求
            // 但会有轻量的状态轮询，用于刷新 pending_estimated / retry 队列长度
        }

        // 轻量同步：API 客户端与轮询
        let __subsSyncTimer = null;
        const __subsSyncIntervalMs = 15000;

        function startSubscriptionsSyncPolling() {
            stopSubscriptionsSyncPolling();
            // 立即跑一次
            refreshSubscriptionsSyncStatus();
            __subsSyncTimer = setInterval(refreshSubscriptionsSyncStatus, __subsSyncIntervalMs);
        }

        function stopSubscriptionsSyncPolling() {
            if (__subsSyncTimer) {
                clearInterval(__subsSyncTimer);
                __subsSyncTimer = null;
            }
        }

        // —— 一致性检查（设置页） ——
        let __consistencyTimer = null;
        const __consistencyIntervalMs = 15000;

        function startConsistencyPolling() {
            stopConsistencyPolling();
            // 立即刷新一次
            window.loadConsistencyStats();
            __consistencyTimer = setInterval(() => window.loadConsistencyStats(), __consistencyIntervalMs);
        }

        function stopConsistencyPolling() {
            if (__consistencyTimer) {
                clearInterval(__consistencyTimer);
                __consistencyTimer = null;
            }
        }

        async function triggerLiteSyncGlobal() {
            const btn = document.getElementById('btn-sync-global');
            if (btn) btn.disabled = true;
            try {
                const res = await apiRequest('/api/sync/trigger', { method: 'POST', body: JSON.stringify({}) });
                if (res && res.error) {
                    alert('轻量同步触发失败: ' + res.error);
                } else {
                    // 触发后轻量刷新几个区域
                    loadOverview();
                    if (typeof DownloadAggregateManager !== 'undefined') DownloadAggregateManager.load();
                    refreshSubscriptionsSyncStatus();
                }
            } catch (e) {
                alert('轻量同步触发失败: ' + (e?.message || e));
            } finally {
                if (btn) btn.disabled = false;
            }
        }

        async function triggerLiteSyncSubscription(subscriptionId, el) {
            if (el) el.disabled = true;
            try {
                const res = await apiRequest('/api/sync/trigger', { method: 'POST', body: JSON.stringify({ sid: subscriptionId }) });
                if (res && res.error) {
                    alert('订阅轻量同步失败: ' + res.error);
                } else {
                    // 触发后刷新该订阅的 expected 与 pending 展示
                    refreshExpected(subscriptionId, true);
                    // 立即拉取一次状态
                    await refreshSubscriptionsSyncStatus(subscriptionId);
                }
            } catch (e) {
                alert('订阅轻量同步失败: ' + (e?.message || e));
            } finally {
                if (el) el.disabled = false;
            }
        }

        async function refreshSubscriptionsSyncStatus(onlySid) {
            try {
                let url = '/api/sync/status';
                if (typeof onlySid === 'number') url += `?sid=${onlySid}`;
                const data = await apiRequest(url);
                const items = (data && data.items) ? data.items : [];
                items.forEach(stat => {
                    const sid = stat.subscription_id;
                    // pending_estimated 优先展示
                    if (typeof stat.pending_estimated === 'number') {
                        const pEl = document.getElementById(`pending-${sid}`);
                        const sEl = document.getElementById(`pending-src-${sid}`);
                        if (pEl) pEl.textContent = String(Math.max(0, stat.pending_estimated));
                        if (sEl) sEl.textContent = '(后端)';
                    }
                    // retry 队列长度
                    const rEl = document.getElementById(`retry-${sid}`);
                    if (rEl) {
                        const rc = rEl.querySelector('.retry-count');
                        if (rc) rc.textContent = String(stat.retry_queue_len || 0);
                    }
                });
            } catch (_) {}
        }

        // 查看待下载（远端-本地差集）
        async function viewPending(subscriptionId) {
            // 先显示加载提示
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; overflow-y:auto;`;
            modal.innerHTML = `
                <div style="background: white; padding: 1rem 1.5rem; border-radius: 8px; max-width: 800px; width: 92%; max-height: 85%; overflow:auto;">
                    <h3 style="margin-top:0;">待下载列表</h3>
                    <div id="pending-content" style="margin: .5rem 0;">加载中...</div>
                    <div style="text-align:right; margin-top: .5rem;">
                        <button onclick="this.closest('div[style*=position]').remove()" class="btn">关闭</button>
                    </div>
                </div>`;
            document.body.appendChild(modal);

            const data = await apiRequest(`/api/subscriptions/${subscriptionId}/pending`);
            const container = modal.querySelector('#pending-content');
            if (!container) return;
            if (!data || data.error) {
                container.innerHTML = `<div class="error">获取失败: ${data?.error || '未知错误'}</div>`;
                return;
            }

            const total = Number(data.remote_total || 0);
            const existing = Number(data.existing || 0);
            const pending = Number(data.pending || 0);
            const list = Array.isArray(data.videos) ? data.videos : [];

            const rows = list.map((v, idx) => {
                const url = v.webpage_url || '#';
                const title = (v.title || '').replace(/</g,'&lt;').replace(/>/g,'&gt;');
                const id = v.id || '';
                const queuedBadge = v.is_queued ? `<span style="display:inline-block;margin-left:8px;padding:2px 6px;background:#e8f5e9;color:#1b5e20;border-radius:10px;font-size:11px;vertical-align:middle;">已在队列</span>` : '';
                return `<tr>
                    <td style="width:48px;text-align:right;color:#666;">${idx+1}</td>
                    <td style="word-break:break-all;">
                        <div style="font-weight:600;">${title || '(无标题)'} ${queuedBadge}</div>
                        <div style="font-size:12px;color:#666;">ID: ${id}</div>
                    </td>
                    <td style="width:260px; text-align:right;">
                        <a href="${url}" target="_blank" class="btn btn-small btn-outline">打开链接</a>
                        ${v.is_queued ? `<button class="btn btn-small" disabled style="opacity:.7;cursor:not-allowed;">已在队列</button>` : `<button class="btn btn-small btn-primary" onclick="enqueuePendingVideo(${subscriptionId}, '${id}', this)">加入队列</button>`}
                    </td>
                </tr>`;
            }).join('');

            container.innerHTML = `
                <div style="margin-bottom:.5rem; color:#333;">
                    远端总数: <strong>${total}</strong> | 本地已有: <strong>${existing}</strong> | 待下载: <strong>${pending}</strong>
                </div>
                <div class="table-wrap">
                    <table class="data">
                        <thead>
                            <tr><th>#</th><th>视频</th><th>操作</th></tr>
                        </thead>
                        <tbody>${rows || '<tr><td colspan="3" style="text-align:center;color:#666;">无待下载视频</td></tr>'}</tbody>
                    </table>
                </div>`;
        }

        // 将待下载条目加入队列
        async function enqueuePendingVideo(subscriptionId, videoId, el) {
            if (!subscriptionId || !videoId) return;
            if (el) el.disabled = true;
            try {
                const res = await apiRequest(`/api/subscriptions/${subscriptionId}/enqueue_video`, {
                    method: 'POST',
                    body: JSON.stringify({ video_id: videoId })
                });
                if (res && res.error) {
                    alert('加入队列失败: ' + res.error);
                    if (el) el.disabled = false;
                    return;
                }
                // 更新行内UI：标记徽章并禁用按钮
                if (el) {
                    const row = el.closest('tr');
                    const titleDiv = row ? row.querySelector('td:nth-child(2) > div:first-child') : null;
                    if (titleDiv && !titleDiv.querySelector('.queued-badge')) {
                        const badge = document.createElement('span');
                        badge.className = 'queued-badge';
                        badge.style.cssText = 'display:inline-block;margin-left:8px;padding:2px 6px;background:#e8f5e9;color:#1b5e20;border-radius:10px;font-size:11px;vertical-align:middle;';
                        badge.textContent = '已在队列';
                        titleDiv.appendChild(badge);
                    }
                    el.textContent = '已在队列';
                    el.classList.remove('btn-primary');
                    el.classList.add('btn');
                    el.disabled = true;
                    el.style.opacity = '.7';
                    el.style.cursor = 'not-allowed';
                }
            } catch (e) {
                alert('加入队列失败: ' + (e?.message || e));
                if (el) el.disabled = false;
            }
        }

        // 触发后台检查订阅（差值入队并持续补齐）
        async function triggerCheckSubscriptions() {
            const btns = document.querySelectorAll('button[onclick="triggerCheckSubscriptions()"]');
            btns.forEach(b => b.disabled = true);
            try {
                const res = await apiRequest('/api/scheduler/check-subscriptions', { method: 'POST' });
                if (res && res.error) {
                    alert('触发失败: ' + res.error);
                } else {
                    alert('已触发订阅检查，后台正在处理');
                    loadSubscriptions();
                }
            } catch (e) {
                alert('触发失败: ' + (e?.message || e));
            } finally {
                btns.forEach(b => b.disabled = false);
            }
        }
        
        // 切换订阅状态
        async function toggleSubscription(subscriptionId, currentStatus) {
            const newStatus = !currentStatus;
            const result = await apiRequest(`/api/subscriptions/${subscriptionId}`, {
                method: 'PUT',
                body: JSON.stringify({ is_active: newStatus })
            });
            
            if (result.error) {
                alert('操作失败: ' + result.error);
            } else {
                loadSubscriptions();
            }
        }

        // 切换订阅类型字段
        function toggleSubFields() {
            const type = document.getElementById('sub-type').value;
            
            // 隐藏所有字段
            document.getElementById('collection-fields').style.display = 'none';
            document.getElementById('uploader-fields').style.display = 'none';
            document.getElementById('keyword-fields').style.display = 'none';
            document.getElementById('specific-urls-fields').style.display = 'none';
            
            // 显示对应字段
            if (type === 'collection') {
                document.getElementById('collection-fields').style.display = 'block';
            } else if (type === 'uploader') {
                document.getElementById('uploader-fields').style.display = 'block';
            } else if (type === 'keyword') {
                document.getElementById('keyword-fields').style.display = 'block';
            } else if (type === 'specific_urls') {
                document.getElementById('specific-urls-fields').style.display = 'block';
            }
            
            // 清空订阅名称
            document.getElementById('sub-name').value = '';
        }

        // 自动识别合集名称
        async function autoFillCollectionName() {
            const url = document.getElementById('sub-url').value;
            if (!url) return;
            
            try {
                // 调用后端API获取合集信息
                const result = await apiRequest('/api/subscriptions/parse-collection', {
                    method: 'POST',
                    body: JSON.stringify({ url })
                });
                
                if (result.name) {
                    document.getElementById('sub-name').value = result.name;
                } else if (result.error) {
                    console.warn('无法自动识别合集名称:', result.error);
                }
            } catch (error) {
                console.warn('自动识别合集名称失败:', error);
            }
        }

        // 显示/隐藏添加订阅表单
        function showAddSubscription() {
            document.getElementById('add-subscription').style.display = 'block';
            toggleSubFields(); // 初始化字段显示
        }
        
        function hideAddSubscription() {
            document.getElementById('add-subscription').style.display = 'none';
            // 清空表单
            document.getElementById('sub-name').value = '';
            document.getElementById('sub-url').value = '';
            document.getElementById('sub-uploader').value = '';
            document.getElementById('sub-keyword').value = '';
        }

        // 添加订阅
        async function addSubscription() {
            const type = document.getElementById('sub-type').value;
            let name = document.getElementById('sub-name').value;
            
            // 根据类型获取相应的值
            let data = { type };
            
            if (type === 'collection') {
                const url = document.getElementById('sub-url').value;
                if (!url) {
                    alert('请输入合集URL');
                    return;
                }
                data.url = url;
                
                // 留空名称由后端自动识别（uploader：playlist_title）
                
            } else if (type === 'uploader') {
                const uploader = document.getElementById('sub-uploader').value;
                if (!uploader) {
                    alert('请输入UP主ID或名称');
                    return;
                }
                data.uploader_id = uploader;
                
                // 如果没有名称，使用UP主信息
                if (!name) {
                    name = 'UP主订阅 - ' + uploader;
                }
                
            } else if (type === 'keyword') {
                const keyword = document.getElementById('sub-keyword').value;
                if (!keyword) {
                    alert('请输入搜索关键词');
                    return;
                }
                data.keyword = keyword;
                
                // 如果没有名称，使用关键词
                if (!name) {
                    name = '关键词订阅 - ' + keyword;
                }
                
            } else if (type === 'specific_urls') {
                const specificUrls = document.getElementById('sub-specific-urls').value;
                if (!specificUrls.trim()) {
                    alert('请输入至少一个视频URL');
                    return;
                }
                
                // 解析URL列表
                const urls = specificUrls.split('\n').map(url => url.trim()).filter(url => url);
                if (urls.length === 0) {
                    alert('请输入有效的视频URL');
                    return;
                }
                
                data.specific_urls = JSON.stringify(urls);
                
                // 如果没有名称，使用URL数量
                if (!name) {
                    name = `特定视频订阅 - ${urls.length}个视频`;
                }
            }
            
            // 获取筛选条件
            const dateAfter = document.getElementById('sub-date-after').value;
            const dateBefore = document.getElementById('sub-date-before').value;
            const minLikes = document.getElementById('sub-min-likes').value;
            const minFavorites = document.getElementById('sub-min-favorites').value;
            const minViews = document.getElementById('sub-min-views').value;
            
            if (dateAfter) data.date_after = dateAfter;
            if (dateBefore) data.date_before = dateBefore;
            if (minLikes && parseInt(minLikes) > 0) data.min_likes = parseInt(minLikes);
            if (minFavorites && parseInt(minFavorites) > 0) data.min_favorites = parseInt(minFavorites);
            if (minViews && parseInt(minViews) > 0) data.min_views = parseInt(minViews);
            
            data.name = name;
            
            const result = await apiRequest('/api/subscriptions', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('添加失败: ' + result.error);
            } else {
                alert('添加成功');
                hideAddSubscription();
                loadSubscriptions();
            }
        }

        // 已移除“开始下载”：下载由启用订阅后调度器自动执行

        // 全量扫描导入
        async function scanAll() {
            if (!confirm('确认对下载目录进行全量扫描并导入？')) return;
            const res = await apiRequest('/api/auto-import/scan', { method: 'POST' });
            if (res && res.error) {
                alert('扫描导入失败: ' + res.error);
            } else {
                alert('扫描导入完成');
                loadSubscriptions();
            }
        }

        // 全量自动关联
        async function associateAll() {
            const res = await apiRequest('/api/auto-import/associate', { method: 'POST' });
            if (res && res.error) {
                alert('自动关联失败: ' + res.error);
            } else {
                alert('自动关联完成');
                loadSubscriptions();
            }
        }

        // 针对单个订阅进行自动关联（按订阅目录前缀）
        async function associateSubscription(id) {
            const res = await apiRequest(`/api/subscriptions/${id}/associate`, { method: 'POST' });
            if (res && res.error) {
                alert('自动关联失败: ' + res.error);
            } else {
                alert('已触发自动关联');
                loadSubscriptions();
            }
        }

        // —— 下载汇总（按订阅） ——
        const DownloadAggregateManager = {
            timer: null,
            intervalMs: 15000,
            start() {
                try {
                    // 若勾选自动刷新则启动定时器
                    // 初始化自动刷新勾选状态
                    const auto = document.getElementById('agg-autorefresh');
                    if (auto) {
                        const persisted = localStorage.getItem('agg_autorefresh') === '1';
                        auto.checked = persisted;
                    }
                    // 初始化折叠状态
                    this.applyCollapseFromStore();
                    // 立即加载一次
                    this.load();
                    // 重置并根据勾选启动轮询
                    this.stop();
                    if (auto && auto.checked) this.timer = setInterval(() => this.load(), this.intervalMs);
                } catch (_) {}
            },
            stop() {
                if (this.timer) { clearInterval(this.timer); this.timer = null; }
            },
            toggleAuto(on) {
                if (on) {
                    this.stop();
                    this.timer = setInterval(() => this.load(), this.intervalMs);
                } else {
                    this.stop();
                }
                try { localStorage.setItem('agg_autorefresh', on ? '1' : '0'); } catch (_) {}
            },
            applyCollapseFromStore() {
                const collapsed = localStorage.getItem('agg_collapsed') === '1';
                const content = document.getElementById('agg-content');
                const btn = document.getElementById('agg-collapse-btn');
                if (content) content.style.display = collapsed ? 'none' : '';
                if (btn) btn.textContent = collapsed ? '展开' : '折叠';
            },
            toggleCollapse() {
                const content = document.getElementById('agg-content');
                const btn = document.getElementById('agg-collapse-btn');
                if (!content) return;
                const collapsed = content.style.display === 'none';
                content.style.display = collapsed ? '' : 'none';
                if (btn) btn.textContent = collapsed ? '折叠' : '展开';
                try { localStorage.setItem('agg_collapsed', (!collapsed) ? '1' : '0'); } catch (_) {}
            },
            async load() {
                const totalsEl = document.getElementById('agg-totals');
                const tbody = document.getElementById('agg-tbody');
                if (!totalsEl || !tbody) return;
                totalsEl.textContent = '加载中...';
                try {
                    const data = await apiRequest('/api/download/aggregate');
                    if (!data || data.error) {
                        totalsEl.innerHTML = `<span style="color:#b91c1c;">加载失败：${(data && data.error) || '未知错误'}</span> <button class="btn btn-small btn-outline" onclick="DownloadAggregateManager.load()">重试</button>`;
                        return;
                    }
                    this.render(data);
                } catch (e) {
                    totalsEl.innerHTML = `<span style="color:#b91c1c;">加载异常：${e?.message || e}</span> <button class=\"btn btn-small btn-outline\" onclick=\"DownloadAggregateManager.load()\">重试</button>`;
                }
            },
            render(data) {
                const totals = data.totals || {};
                const items = Array.isArray(data.items) ? data.items.slice() : [];
                // 排序：活跃度(queued+running) 降序，其次 pending_estimated 降序
                items.sort((a,b) => {
                    const aAct = (a.queue?.queued||0) + (a.queue?.running||0);
                    const bAct = (b.queue?.queued||0) + (b.queue?.running||0);
                    if (bAct !== aAct) return bAct - aAct;
                    const ap = a.pending_estimated ?? 0;
                    const bp = b.pending_estimated ?? 0;
                    return bp - ap;
                });

                const totalHtml = `
                    <span class="stat-item stat-downloaded">Downloaded: ${totals.downloaded || 0}</span>
                    <span class="stat-item stat-pending">Pending: ${totals.pending_estimated || 0}</span>
                    <span class="stat-item">Queued: ${totals.queued || 0}</span>
                    <span class="stat-item">Running: ${totals.running || 0}</span>
                `;
                document.getElementById('agg-totals').innerHTML = totalHtml;

                const rows = items.map(x => {
                    const name = (x.subscription && x.subscription.name) || `#${x.subscription_id || ''}`;
                    const sid = (x.subscription && x.subscription.id) || x.subscription_id;
                    const remote = (typeof x.remote_total === 'number') ? x.remote_total : '-';
                    const onClick = sid ? `onclick=\"DownloadAggregateManager.gotoSubscription(${sid})\"` : '';
                    return `
                        <tr>
                            <td ${onClick} style=\"cursor:${sid?'pointer':'default'};\">${name}</td>
                            <td class=\"num\">${x.downloaded ?? 0}</td>
                            <td class=\"num\">${x.pending_estimated ?? 0}</td>
                            <td class=\"num\">${(x.queue && x.queue.queued) ?? 0}</td>
                            <td class=\"num\">${(x.queue && x.queue.running) ?? 0}</td>
                            <td class=\"num\">${remote}</td>
                        </tr>`;
                }).join('');
                document.getElementById('agg-tbody').innerHTML = rows || '<tr><td colspan="6" style="text-align:center; color:#666;">暂无数据</td></tr>';
            },
            gotoSubscription(sid) {
                if (!sid) return;
                try { localStorage.setItem('highlight_subscription', String(sid)); } catch (_) {}
                showTab('subscriptions');
                // 若列表已在，直接尝试高亮
                setTimeout(() => {
                    const el = document.getElementById('sub-' + sid);
                    if (el) this.highlightEl(el);
                }, 300);
            },
            highlightEl(el) {
                if (!el) return;
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                const prevBg = el.style.backgroundColor;
                const prevShadow = el.style.boxShadow;
                el.style.transition = 'background-color .3s ease, box-shadow .3s ease';
                el.style.backgroundColor = '#fff7ed';
                el.style.boxShadow = '0 0 0 3px rgba(249,115,22,0.35) inset';
                setTimeout(() => {
                    el.style.backgroundColor = prevBg || '';
                    el.style.boxShadow = prevShadow || '';
                }, 4000);
            }
        };

        // 任务轮询与渲染
        let tasksPollTimer = null;

        function startTasksPolling() {
            refreshTasks();
            stopTasksPolling();
            tasksPollTimer = setInterval(refreshTasks, 2000);
        }

        function stopTasksPolling() {
            if (tasksPollTimer) {
                clearInterval(tasksPollTimer);
                tasksPollTimer = null;
            }
        }

        async function refreshTasks() {
            const data = await apiRequest('/api/tasks');
            if (data.error) {
                document.getElementById('task-list').innerHTML = `<p class="error">加载失败: ${data.error}</p>`;
                return;
            }
            // 兼容后端返回对象（以 task_id 为键）或数组
            const tasksArr = Array.isArray(data) ? data : Object.values(data || {});
            renderTasks(tasksArr);
        }

        function renderTasks(tasks) {
            if (!tasks || tasks.length === 0) {
                document.getElementById('task-list').innerHTML = '<p>暂无任务</p>';
                return;
            }
            const statusText = {
                'pending': '排队中',
                'downloading': '下载中',
                'completed': '已完成',
                'failed': '失败',
                'paused': '已暂停',
                'cancelled': '已取消'
            };
            const html = tasks.map(t => {
                const progress = typeof t.progress_percent === 'number' ? Math.max(0, Math.min(100, t.progress_percent)) : 0;
                const barClass = t.status === 'completed' ? 'success' : (t.status === 'failed' ? 'error' : '');
                const controls = renderTaskControls(t);
                return `
                    <div class="card" style="margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>任务#${t.task_id || t.id || '-'}</strong>
                                <span style="margin-left:8px;color:#666;">${statusText[t.status] || t.status}</span>
                            </div>
                            <div>${controls}</div>
                        </div>
                        <div class="progress-bar">
                            <div class="progress ${barClass}" style="width:${progress}%"></div>
                        </div>
                        ${t.error_message ? `<div class="error">${t.error_message}</div>` : ''}
                        <div style="font-size:12px;color:#666;margin-top:4px;">
                            开始: ${t.started_at || '-'} | 结束: ${t.completed_at || '-'}
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('task-list').innerHTML = html;
        }

        function renderTaskControls(t) {
            const buttons = [];
            if (t.status === 'downloading') {
                buttons.push(`<button class="btn btn-warning" onclick=\"pauseTask('${t.task_id || t.id}')\">暂停</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">取消</button>`);
            } else if (t.status === 'paused') {
                buttons.push(`<button class="btn btn-success" onclick=\"resumeTask('${t.task_id || t.id}')\">恢复</button>`);
                buttons.push(`<button class="btn btn-danger" onclick=\"cancelTask('${t.task_id || t.id}')\">取消</button>`);
            }
            return buttons.join(' ');
        }

        async function pauseTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/pause`, { method: 'POST' });
            if (res.error) return alert('暂停失败: ' + res.error);
            refreshTasks();
        }
        async function resumeTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/resume`, { method: 'POST' });
            if (res.error) return alert('恢复失败: ' + res.error);
            refreshTasks();
        }
        async function cancelTask(taskId) {
            const res = await apiRequest(`/api/tasks/${taskId}/cancel`, { method: 'POST' });
            if (res.error) return alert('取消失败: ' + res.error);
            refreshTasks();
        }

        async function clearCompletedTasks() {
            const res = await apiRequest('/api/tasks/clear-completed', { method: 'POST' });
            if (res.error) return alert('清理失败: ' + res.error);
            refreshTasks();
        }

        // 查看订阅详情
        async function viewSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}`);
            if (result.error) {
                alert('获取订阅详情失败: ' + result.error);
                return;
            }
            
            const sub = result;
            const typeTexts = {
                'collection': '合集订阅',
                'uploader': 'UP主订阅', 
                'keyword': '关键词订阅',
                'specific_urls': '特定视频订阅'
            };
            
            let detailsHtml = `
                <h3>订阅详情</h3>
                <p><strong>名称:</strong> ${sub.name}</p>
                <p><strong>类型:</strong> ${typeTexts[sub.type] || sub.type}</p>
                <p><strong>URL:</strong> ${sub.url}</p>
                <p><strong>状态:</strong> ${sub.is_active ? '活跃' : '暂停'}</p>
                <p><strong>创建时间:</strong> ${new Date(sub.created_at).toLocaleString()}</p>
                <p><strong>最后检查:</strong> ${sub.last_check ? new Date(sub.last_check).toLocaleString() : '从未'}</p>
            `;
            
            if (sub.date_after || sub.date_before || sub.min_likes || sub.min_favorites || sub.min_views) {
                detailsHtml += '<h4>筛选条件:</h4>';
                if (sub.date_after) detailsHtml += `<p>开始日期: ${sub.date_after}</p>`;
                if (sub.date_before) detailsHtml += `<p>结束日期: ${sub.date_before}</p>`;
                if (sub.min_likes) detailsHtml += `<p>最小点赞: ${sub.min_likes}</p>`;
                if (sub.min_favorites) detailsHtml += `<p>最小收藏: ${sub.min_favorites}</p>`;
                if (sub.min_views) detailsHtml += `<p>最小播放: ${sub.min_views}</p>`;
            }
            
            // 创建模态框显示详情
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%;">
                    ${detailsHtml}
                    <button onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn" style="margin-top: 1rem;">关闭</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 编辑订阅
        async function editSubscription(id) {
            const result = await apiRequest(`/api/subscriptions/${id}`);
            if (result.error) {
                alert('获取订阅信息失败: ' + result.error);
                return;
            }
            
            const sub = result;
            
            // 创建编辑表单模态框
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000; overflow-y: auto;
            `;
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 600px; width: 90%; margin: 2rem;">
                    <h3>编辑订阅</h3>
                    <form id="edit-subscription-form">
                        <div class="form-group">
                            <label>订阅名称</label>
                            <input type="text" id="edit-name" value="${sub.name}" required>
                        </div>
                        <div class="form-group">
                            <label>订阅URL</label>
                            <input type="url" id="edit-url" value="${sub.url}" required>
                        </div>
                        <div class="form-group">
                            <label>状态</label>
                            <select id="edit-active">
                                <option value="true" ${sub.is_active ? 'selected' : ''}>活跃</option>
                                <option value="false" ${!sub.is_active ? 'selected' : ''}>暂停</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>开始日期 (可选)</label>
                            <input type="date" id="edit-date-after" value="${sub.date_after || ''}">
                        </div>
                        <div class="form-group">
                            <label>结束日期 (可选)</label>
                            <input type="date" id="edit-date-before" value="${sub.date_before || ''}">
                        </div>
                        <div class="form-group">
                            <label>最小点赞数 (可选)</label>
                            <input type="number" id="edit-min-likes" value="${sub.min_likes || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>最小收藏数 (可选)</label>
                            <input type="number" id="edit-min-favorites" value="${sub.min_favorites || ''}" min="0">
                        </div>
                        <div class="form-group">
                            <label>最小播放数 (可选)</label>
                            <input type="number" id="edit-min-views" value="${sub.min_views || ''}" min="0">
                        </div>
                        <div style="margin-top: 1rem;">
                            <button type="button" onclick="updateSubscription(${id})" class="btn btn-primary">保存</button>
                            <button type="button" onclick="this.closest('div[style*=\"position: fixed\"]').remove()" class="btn btn-secondary" style="margin-left: 0.5rem;">取消</button>
                        </div>
                    </form>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // 更新订阅
        async function updateSubscription(id) {
            const formData = {
                name: document.getElementById('edit-name').value,
                url: document.getElementById('edit-url').value,
                is_active: document.getElementById('edit-active').value === 'true',
                date_after: document.getElementById('edit-date-after').value || null,
                date_before: document.getElementById('edit-date-before').value || null,
                min_likes: parseInt(document.getElementById('edit-min-likes').value) || null,
                min_favorites: parseInt(document.getElementById('edit-min-favorites').value) || null,
                min_views: parseInt(document.getElementById('edit-min-views').value) || null
            };
            
            const result = await apiRequest(`/api/subscriptions/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });
            
            if (result.error) {
                alert('更新订阅失败: ' + result.error);
            } else {
                alert('订阅更新成功');
                document.querySelector('div[style*="position: fixed"]').remove();
                loadSubscriptions();
            }
        }

        // 删除订阅
        async function deleteSubscription(id) {
            if (!confirm('确定要删除这个订阅吗？')) return;
            
            const result = await apiRequest(`/api/subscriptions/${id}`, { method: 'DELETE' });
            if (result.error) {
                alert('删除失败: ' + result.error);
            } else {
                alert('删除成功');
                loadSubscriptions();
            }
        }

        // —— 视频管理（新） ——
        let __subStatsCache = [];

        async function loadVideos() {
            // 展示容器
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';

            await loadMediaOverview(false);
            await loadSubscriptionStats();
            await loadDirectoryStats();
        }

        async function loadMediaOverview(scan) {
            const content = document.getElementById('media-overview-content');
            content.innerHTML = '加载中...';
            const data = await apiRequest(`/api/media/overview${scan ? '?scan=true' : ''}`);
            const totalSize = formatBytes(data.total_size || 0);
            const diskInfo = data.scan ? ` | 文件数: ${data.files_on_disk || 0} | 磁盘占用: ${formatBytes(data.size_on_disk || 0)} | 路径: ${data.download_path || ''}` : '';
            content.innerHTML = `
                <div>总视频: <strong>${data.total_videos || 0}</strong> | 已下载: <strong>${data.downloaded_videos || 0}</strong> | 总容量(数据库): <strong>${totalSize}</strong> ${diskInfo}</div>
            `;
        }

        // —— 全局总览（/api/overview） ——
        async function loadOverview() {
            const box = document.getElementById('global-overview-content');
            if (!box) return;
            box.innerHTML = '加载中...';
            const data = await apiRequest('/api/overview');
            if (data && data.error) { box.innerHTML = `<p class="status error">加载失败：${escapeHtml(data.error)}</p>`; return; }
            const remote = data.remote_total ?? '-';
            const local = data.local_total ?? '-';
            const pending = data.pending_total ?? (typeof remote==='number' && typeof local==='number' ? Math.max(remote-local,0) : '-');
            const q = data.queue || {};
            const counts = q.counts || {};
            const running = counts.running ?? counts.RUNNING ?? '-';
            const queued = counts.queued ?? counts.QUEUED ?? '-';
            const succeeded = counts.succeeded ?? counts.SUCCEEDED ?? '-';
            const failed = counts.failed ?? counts.FAILED ?? '-';
            const recentFail = data.recent_failed_24h ?? '-';
            const paused = (q.paused && (q.paused.all || q.paused.requires_cookie || q.paused.no_cookie)) ? '是' : '否';
            const cap = q.capacity || {};
            box.innerHTML = `
                <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:12px;">
                    <div class="stat-card"><div class="stat-title">Remote</div><div class="stat-number">${remote}</div></div>
                    <div class="stat-card"><div class="stat-title">Local</div><div class="stat-number">${local}</div></div>
                    <div class="stat-card"><div class="stat-title">Pending</div><div class="stat-number">${pending}</div></div>
                    <div class="stat-card"><div class="stat-title">Queue 运行</div><div class="stat-number">${running}</div></div>
                    <div class="stat-card"><div class="stat-title">Queue 排队</div><div class="stat-number">${queued}</div></div>
                    <div class="stat-card"><div class="stat-title">Queue 成功</div><div class="stat-number">${succeeded}</div></div>
                    <div class="stat-card"><div class="stat-title">Queue 失败</div><div class="stat-number">${failed}</div></div>
                    <div class="stat-card"><div class="stat-title">暂停中</div><div class="stat-number">${paused}</div></div>
                    <div class="stat-card"><div class="stat-title">最近24h失败</div><div class="stat-number">${recentFail}</div></div>
                </div>
                <details style="margin-top:8px;">
                    <summary style="cursor:pointer;">查看原始数据(JSON)</summary>
                    <pre style="margin-top:8px; color:#666; font-size:12px; background:#f8f9fa; padding:12px; border-radius:6px; overflow:auto;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>
                </details>
            `;
        }

        async function loadSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            content.innerHTML = '加载中...';
            const data = await apiRequest('/api/media/subscription-stats');
            if (data && data.error) {
                content.innerHTML = `<p class="status error">订阅统计获取失败：${escapeHtml(data.error)}</p>`;
                __subStatsCache = [];
                return;
            }
            __subStatsCache = Array.isArray(data) ? data : [];
            renderSubscriptionStats();
        }

        function renderSubscriptionStats() {
            const content = document.getElementById('media-sub-stats-content');
            const kw = (document.getElementById('sub-filter').value || '').toLowerCase();
            const list = __subStatsCache.filter(x => !kw || (x.subscription_name || '').toLowerCase().includes(kw));
            const rows = list.map(x => `
                <tr>
                    <td>${x.subscription_name || '-'}</td>
                    <td>${x.type || '-'}</td>
                    <td class="num">${x.total_videos}</td>
                    <td class="num">${x.downloaded_videos}</td>
                    <td class="num">${formatBytes(x.total_size || 0)}</td>
                    <td>${x.latest_upload ? new Date(x.latest_upload).toLocaleString() : '-'}</td>
                    <td><button class="btn btn-small" onclick="showSubscriptionDetail(${x.subscription_id})">查看视频</button></td>
                </tr>
            `).join('');
            content.innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>订阅名称</th>
                        <th>类型</th>
                        <th>总数</th>
                        <th>已下载</th>
                        <th>容量</th>
                        <th>最近上传</th>
                        <th>操作</th>
                      </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
            `;
        }

        async function showSubscriptionDetail(sid, name) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'block';
            document.getElementById('media-sub-detail-title').innerText = `订阅明细 - ${name || sid}`;
            await loadSubscriptionDetailPage(sid, 1);
        }

        function hideSubscriptionDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-sub-detail').style.display = 'none';
        }

        async function loadSubscriptionDetailPage(sid, page) {
            const size = 20;
            const data = await apiRequest(`/api/media/subscriptions/${sid}/videos?page=${page}&size=${size}&include_disk=true`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td class="num">${formatBytes(v.file_size || 0)}</td>
                    <td>${v.on_disk ? '在磁盘' : '缺文件'}</td>
                    <td class="mono">${v.video_path || '-'}</td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div class="pager">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page-1})">上一页</button>
                    <span>第 ${page} / ${totalPages} 页，共 ${total} 条</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadSubscriptionDetailPage(${sid}, ${page+1})">下一页</button>
                </div>`;
            document.getElementById('media-sub-detail-content').innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>标题</th>
                        <th>BV</th>
                        <th>上传日期</th>
                        <th class="num">大小</th>
                        <th>磁盘</th>
                        <th>路径</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="6">暂无数据</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}
            `;
        }

        function formatBytes(bytes) {
            if (!bytes || bytes <= 0) return '0 B';
            const units = ['B','KB','MB','GB','TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + units[i];
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"] /g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',' ':' ' }[c] || c));
        }

        // —— 目录统计与明细 ——
        async function loadDirectoryStats() {
            const wrap = document.getElementById('media-dir-stats-content');
            if (!wrap) return;
            wrap.innerHTML = '加载中...';
            const data = await apiRequest('/api/media/directories');
            if (data && data.error) {
                wrap.innerHTML = `<p class="status error">目录统计获取失败：${escapeHtml(data.error)}</p>`;
                return;
            }
            const items = (data && Array.isArray(data.items)) ? data.items : [];
            if (items.length === 0) { wrap.innerHTML = '<p>暂无目录数据</p>'; return; }
            const rows = items.map(d => `
              <tr>
                <td>${escapeHtml(d.dir)}</td>
                <td class="num">${d.total_videos}</td>
                <td class="num">${d.downloaded_videos}</td>
                <td class="num">${formatBytes(d.total_size || 0)}</td>
                <td><button class="btn btn-small" onclick="showDirectoryDetail('${d.dir.replace(/'/g, "\\'")}')">查看视频</button></td>
              </tr>`).join('');
            wrap.innerHTML = `
              <div class="table-wrap">
                <table class="data">
                  <thead>
                    <tr>
                      <th>目录</th>
                      <th class="num">总数</th>
                      <th class="num">已下载</th>
                      <th class="num">容量</th>
                      <th>操作</th>
                    </tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
              </div>`;
        }

        async function showDirectoryDetail(dir) {
            document.getElementById('media-overview').style.display = 'none';
            document.getElementById('media-sub-stats').style.display = 'none';
            document.getElementById('media-sub-detail').style.display = 'none';
            document.getElementById('media-dir-stats').style.display = 'none';
            const panel = document.getElementById('media-dir-detail');
            panel.style.display = 'block';
            document.getElementById('media-dir-detail-title').innerText = `目录明细 - ${dir}`;
            await loadDirectoryVideosPage(dir, 1);
        }

        function hideDirectoryDetail() {
            document.getElementById('media-overview').style.display = 'block';
            document.getElementById('media-sub-stats').style.display = 'block';
            document.getElementById('media-dir-stats').style.display = 'block';
            document.getElementById('media-dir-detail').style.display = 'none';
        }

        async function loadDirectoryVideosPage(dir, page) {
            const size = 20;
            const data = await apiRequest(`/api/media/directory-videos?dir=${encodeURIComponent(dir)}&page=${page}&size=${size}`);
            const rows = (data.videos || []).map(v => `
                <tr>
                    <td>${escapeHtml(v.title || '')}</td>
                    <td>${v.bilibili_id || ''}</td>
                    <td>${v.upload_date ? new Date(v.upload_date).toLocaleDateString() : '-'}</td>
                    <td class="num">${formatBytes(v.file_size || 0)}</td>
                    <td class="mono">${v.video_path || '-'}</td>
                </tr>
            `).join('');
            const total = data.total || 0;
            const totalPages = Math.max(1, Math.ceil(total / size));
            const pager = `
                <div class="pager">
                    <button class="btn btn-outline" ${page<=1?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page-1})">上一页</button>
                    <span>第 ${page} / ${totalPages} 页，共 ${total} 条</span>
                    <button class="btn btn-outline" ${page>=totalPages?'disabled':''} onclick="loadDirectoryVideosPage('${dir.replace(/'/g, "\\'")}', ${page+1})">下一页</button>
                </div>`;
            document.getElementById('media-dir-detail-content').innerHTML = `
                <div class="table-wrap">
                  <table class="data">
                    <thead>
                      <tr>
                        <th>标题</th>
                        <th>BV</th>
                        <th>上传日期</th>
                        <th class="num">大小</th>
                        <th>路径</th>
                      </tr>
                    </thead>
                    <tbody>${rows || '<tr><td colspan="5">暂无数据</td></tr>'}</tbody>
                  </table>
                </div>
                ${pager}`;
        }

        // 加载Cookie列表
        async function loadCookies() {
            const data = await apiRequest('/api/cookies');
            const html = data.map(cookie => `
                <div class="list-item">
                    <div>
                        <strong>${cookie.name}</strong>
                        <br><small>使用次数: ${cookie.usage_count} | 状态: ${cookie.is_active ? '活跃' : '禁用'}</small>
                    </div>
                    <div>
                        <button class="btn" onclick="toggleCookieActive(${cookie.id}, ${cookie.is_active})">${cookie.is_active ? '禁用' : '启用'}</button>
                        <button class="btn" onclick="validateCookie(${cookie.id})">验证</button>
                        <button class="btn" onclick="deleteCookie(${cookie.id})" style="background:#dc3545;">删除</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('cookie-list').innerHTML = html || '<p>暂无Cookie</p>';
        }

        // 显示/隐藏添加Cookie表单
        function showAddCookie() {
            document.getElementById('add-cookie').style.display = 'block';
        }
        function hideAddCookie() {
            document.getElementById('add-cookie').style.display = 'none';
        }

        // 添加Cookie
        async function addCookie() {
            const name = document.getElementById('cookie-name').value;
            const sessdata = document.getElementById('cookie-sessdata').value;
            const bili_jct = document.getElementById('cookie-jct').value;
            const dedeuserid = document.getElementById('cookie-userid').value;
            
            if (!name || !sessdata) {
                alert('请输入Cookie名称和SESSDATA');
                return;
            }
            
            const data = { name, sessdata, bili_jct, dedeuserid };
            const result = await apiRequest('/api/cookies', {
                method: 'POST',
                body: JSON.stringify(data)
            });
            
            if (result.error) {
                alert('添加失败: ' + result.error);
            } else {
                alert('添加成功');
                hideAddCookie();
                loadCookies();
            }
        }

        // 验证Cookie
        async function validateCookie(id) {
            const result = await apiRequest(`/api/cookies/${id}/validate`, { method: 'POST' });
            alert(result.valid ? 'Cookie有效' : 'Cookie无效');
            loadCookies();
        }

        // 批量验证Cookie
        async function validateAllCookies() {
            const triggers = document.querySelectorAll('button[onclick="validateAllCookies()"]');
            triggers.forEach(b => b.disabled = true);
            try {
                const list = await apiRequest('/api/cookies');
                const cookies = Array.isArray(list) ? list : [];
                if (cookies.length === 0) {
                    alert('暂无可验证的Cookie');
                    return;
                }
                let ok = 0, fail = 0;
                for (const c of cookies) {
                    try {
                        const res = await apiRequest(`/api/cookies/${c.id}/validate`, { method: 'POST' });
                        if (res && res.valid) ok++; else fail++;
                    } catch (_) { fail++; }
                }
                alert(`验证完成：有效 ${ok}，无效 ${fail}`);
            } catch (e) {
                alert('批量验证失败: ' + (e?.message || e));
            } finally {
                triggers.forEach(b => b.disabled = false);
                loadCookies();
            }
        }

        // 启用/禁用 Cookie
        async function toggleCookieActive(id, current) {
            const payload = { is_active: !current };
            const result = await apiRequest(`/api/cookies/${id}`, {
                method: 'PUT',
                body: JSON.stringify(payload)
            });
            if (result && result.error) {
                alert('切换失败: ' + result.error);
            } else {
                loadCookies();
            }
        }

        // 删除Cookie
        async function deleteCookie(id) {
            if (!confirm('确定要删除这个Cookie吗？')) return;
            
            const result = await apiRequest(`/api/cookies/${id}`, { method: 'DELETE' });
            if (result.error) {
                alert('删除失败: ' + result.error);
            } else {
                alert('删除成功');
                loadCookies();
            }
        }

        // 加载系统设置
        async function loadSettings() {
            const data = await apiRequest('/api/settings');
            const html = Object.entries(data).map(([key, setting]) => `
                <div class="form-group">
                    <label>${setting.description}</label>
                    <input type="text" value="${setting.value}" onchange="updateSetting('${key}', this.value)">
                </div>
            `).join('');
            document.getElementById('settings-list').innerHTML = html;
        }

        // 更新设置
        async function updateSetting(key, value) {
            const result = await apiRequest(`/api/settings/${key}`, {
                method: 'PUT',
                body: JSON.stringify({ value })
            });
            
            if (result.error) {
                alert('更新失败: ' + result.error);
            }
        }

        // 队列管理相关函数
        let queuePollingTimer = null;

        function formatTime(s) {
            if (!s) return '';
            try { return new Date(s).toLocaleString(); } catch { return s; }
        }

        function setPausedBadge(s) {
            const el = document.getElementById('badge-paused');
            if (!el || !s || !s.paused) return;
            const anyPaused = !!(s.paused.all || s.paused.requires_cookie || s.paused.no_cookie);
            el.textContent = anyPaused ? '已暂停' : '运行中';
            el.className = 'badge ' + (anyPaused ? 'badge-danger' : 'badge-success');
        }

        function renderCapCards(s) {
            const root = document.getElementById('cap-cards');
            if (!root) return;
            const cc = (s && s.capacity) || {};
            const cb = (s && s.counts && s.counts_by_channel) ? s.counts_by_channel : (s && s.counts_by_channel) || {};
            const queuedCookie = typeof cb.queued_cookie === 'number' ? cb.queued_cookie : '-';
            const queuedNoCookie = typeof cb.queued_nocookie === 'number' ? cb.queued_nocookie : '-';
            const blocks = [
                { title: '需要Cookie', cfg: cc.requires_cookie, run: cc.running_cookie, avail: (cc.available_cookie ?? (cc.requires_cookie - cc.running_cookie)), queued: queuedCookie },
                { title: '无需Cookie', cfg: cc.no_cookie, run: cc.running_nocookie, avail: (cc.available_nocookie ?? (cc.no_cookie - cc.running_nocookie)), queued: queuedNoCookie },
            ];
            root.innerHTML = blocks.map(b => `
                <div class="stat-card">
                    <div class="stat-title">${b.title}</div>
                    <div class="stat-row"><span class="stat-label">配置</span><span class="stat-number">${b.cfg ?? '-'}</span></div>
                    <div class="stat-row"><span class="stat-label">运行</span><span class="stat-number">${b.run ?? '-'}</span></div>
                    <div class="stat-row"><span class="stat-label">可用</span><span class="stat-number ${Number(b.avail) > 0 ? 'ok' : 'warn'}">${(b.avail ?? '-')}</span></div>
                    <div class="stat-row"><span class="stat-label">排队</span><span class="stat-number">${b.queued}</span></div>
                </div>
            `).join('');
        }

        async function loadQueueStats() {
            try {
                const s = await apiRequest('/api/queue/stats');
                setPausedBadge(s);
                renderCapCards(s);
                document.getElementById('stats').textContent = JSON.stringify(s, null, 2);
                if (s && s.capacity) {
                    if (typeof s.capacity.requires_cookie === 'number') document.getElementById('cap-cookie').value = s.capacity.requires_cookie;
                    if (typeof s.capacity.no_cookie === 'number') document.getElementById('cap-nocookie').value = s.capacity.no_cookie;
                }
            } catch (e) {
                document.getElementById('stats').textContent = '加载失败: ' + e.message;
            }
        }

        function statusClass(s) {
            return 'status ' + (s||'').toLowerCase();
        }

        async function loadQueueRequests() {
            try {
                const data = await apiRequest('/api/requests');
                const items = data.items || data || [];
                const tbody = document.getElementById('queue-tbody');
                tbody.innerHTML = '';
                for (const it of items) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="font-family: monospace; font-size: 11px; color: #666;">${it.id}</td>
                        <td>${it.type || ''}</td>
                        <td>${it.subscription_id ?? ''}</td>
                        <td>${it.requires_cookie ? '是' : '否'}</td>
                        <td><span class="${statusClass(it.status)}">${it.status}</span></td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.created_at)}</td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.started_at)}</td>
                        <td style="font-size: 12px; color: #666;">${formatTime(it.finished_at)}</td>
                        <td style="font-size: 12px; color: #666;">${it.last_error || ''}</td>
                    `;
                    tbody.appendChild(tr);
                }
            } catch (e) {
                console.error(e);
            }
        }

        function loadQueueData() {
            loadQueueStats();
            loadQueueRequests();
            // 启动队列轮询
            if (queuePollingTimer) clearInterval(queuePollingTimer);
            queuePollingTimer = setInterval(() => {
                loadQueueStats();
                loadQueueRequests();
            }, 2000);
        }

        function stopQueuePolling() {
            if (queuePollingTimer) {
                clearInterval(queuePollingTimer);
                queuePollingTimer = null;
            }
        }

        // —— 队列诊断（/api/queue/insights） ——
        function showQueueInsights() {
            const modal = document.getElementById('queue-insights-modal');
            if (!modal) return;
            modal.style.display = 'block';
            loadQueueInsights();
        }

        function hideQueueInsights() {
            const modal = document.getElementById('queue-insights-modal');
            if (!modal) return;
            modal.style.display = 'none';
        }

        async function loadQueueInsights() {
            const content = document.getElementById('queue-insights-content');
            const meta = document.getElementById('insights-meta');
            if (!content) return;
            content.innerHTML = '加载中...';
            const data = await apiRequest('/api/queue/insights');
            if (data && data.error) { content.innerHTML = `<p class=\"status error\">加载失败：${escapeHtml(data.error)}</p>`; return; }
            try { meta.textContent = `失败样本 ${Array.isArray(data.failed_samples)?data.failed_samples.length:0}`; } catch { /* noop */ }
            content.innerHTML = renderInsightsHtml(data);
        }

        function renderInsightsHtml(d) {
            const wr = d && d.wait_reasons || {};
            const et = d && d.errors_top || [];
            const fs = d && d.failed_samples || [];
            const paused = d && d.paused || {};
            const cap = d && d.capacity || {};
            const counts = d && d.counts || {};
            const waitRows = Object.entries(wr).map(([k,v]) => `<tr><td>${escapeHtml(k)}</td><td class=\"num\">${v}</td></tr>`).join('');
            const errRows = et.map(x => `<tr><td class=\"mono\" style=\"max-width:260px; overflow:hidden; text-overflow:ellipsis;\" title=\"${escapeHtml(x.message || '')}\">${escapeHtml(x.message || '')}</td><td class=\"num\">${x.count || 0}</td></tr>`).join('');
            const failRows = fs.map(x => `<tr><td class=\"mono\" style=\"max-width:120px;\">${escapeHtml(x.id || '')}</td><td>${escapeHtml(x.type || '')}</td><td>${x.subscription_id ?? ''}</td><td class=\"mono\" title=\"${escapeHtml(x.last_error || '')}\" style=\"max-width:240px; overflow:hidden; text-overflow:ellipsis;\">${escapeHtml(x.last_error || '')}</td><td>${x.finished_at ? new Date(x.finished_at).toLocaleString() : '-'}</td></tr>`).join('');
            return `
                <div style=\"display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px;\">
                    <div class=\"stat-card\"><div class=\"stat-title\">运行</div><div class=\"stat-number\">${counts.running ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">排队</div><div class=\"stat-number\">${counts.queued ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">成功</div><div class=\"stat-number\">${counts.succeeded ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">失败</div><div class=\"stat-number\">${counts.failed ?? '-'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">暂停</div><div class=\"stat-number\">${(paused.all || paused.requires_cookie || paused.no_cookie) ? '是' : '否'}</div></div>
                    <div class=\"stat-card\"><div class=\"stat-title\">并发(需Cookie/无需)</div><div class=\"stat-number\">${cap.requires_cookie ?? '-'} / ${cap.no_cookie ?? '-'}</div></div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>等待原因分布</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>原因</th><th class=\"num\">数量</th></tr></thead><tbody>${waitRows || '<tr><td colspan=2>暂无数据</td></tr>'}</tbody></table>
                    </div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>错误Top</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>错误</th><th class=\"num\">次数</th></tr></thead><tbody>${errRows || '<tr><td colspan=2>暂无数据</td></tr>'}</tbody></table>
                    </div>
                </div>
                <div class=\"card\" style=\"margin-top:12px;\">
                    <h4>失败样本</h4>
                    <div class=\"table-wrap\">
                        <table class=\"data\"><thead><tr><th>job_id</th><th>类型</th><th>订阅</th><th>错误</th><th>结束时间</th></tr></thead><tbody>${failRows || '<tr><td colspan=5>暂无数据</td></tr>'}</tbody></table>
                    </div>
                </div>
            `;
        }

        // 队列管理事件绑定
        document.addEventListener('DOMContentLoaded', function() {
            // 队列控制按钮事件
            const btnRefresh = document.getElementById('btn-refresh');
            if (btnRefresh) {
                btnRefresh.onclick = () => { loadQueueStats(); loadQueueRequests(); };
            }

            const btnPause = document.getElementById('btn-pause');
            if (btnPause) {
                btnPause.onclick = async () => {
                    const scope = document.getElementById('pause-scope').value;
                    await apiRequest('/api/queue/pause', { method: 'POST', body: JSON.stringify({ scope }) });
                    await loadQueueStats();
                };
            }

            const btnResume = document.getElementById('btn-resume');
            if (btnResume) {
                btnResume.onclick = async () => {
                    const scope = document.getElementById('pause-scope').value;
                    await apiRequest('/api/queue/resume', { method: 'POST', body: JSON.stringify({ scope }) });
                    await loadQueueStats();
                };
            }

            const btnApplyCap = document.getElementById('btn-apply-cap');
            if (btnApplyCap) {
                btnApplyCap.onclick = async () => {
                    const requires_cookie = document.getElementById('cap-cookie').value;
                    const no_cookie = document.getElementById('cap-nocookie').value;
                    await apiRequest('/api/queue/capacity', { 
                        method: 'POST', 
                        body: JSON.stringify({ requires_cookie: parseInt(requires_cookie), no_cookie: parseInt(no_cookie) })
                    });
                    await loadQueueStats();
                };
            }

            const btnCancel = document.getElementById('btn-cancel');
            if (btnCancel) {
                btnCancel.onclick = async () => {
                    const id = document.getElementById('job-id').value.trim();
                    if (!id) return alert('请输入 job_id');
                    await apiRequest(`/api/requests/${encodeURIComponent(id)}/cancel`, { method: 'POST' });
                    await loadQueueStats();
                    await loadQueueRequests();
                };
            }

            const btnPrio = document.getElementById('btn-prio');
            if (btnPrio) {
                btnPrio.onclick = async () => {
                    const id = document.getElementById('job-id').value.trim();
                    if (!id) return alert('请输入 job_id');
                    await apiRequest(`/api/requests/${encodeURIComponent(id)}/prioritize`, { 
                        method: 'POST', 
                        body: JSON.stringify({ priority: 0 })
                    });
                    await loadQueueRequests();
                };
            }

            // 一致性检查相关函数
            window.triggerConsistencyCheck = async function() {
                const btn = document.getElementById('btn-consistency-check');
                const originalText = btn.textContent;
                
                try {
                    btn.textContent = '检查中...';
                    btn.disabled = true;
                    
                    const result = await apiRequest('/api/system/consistency-check', 'POST');
                    
                    // 显示检查结果
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `
                        <div class="status success">一致性检查完成</div>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="stat-item">
                                <strong>数据库记录数:</strong> ${result.total_db_records || 0}
                            </div>
                            <div class="stat-item">
                                <strong>本地文件数:</strong> ${result.files_found || 0}
                            </div>
                            <div class="stat-item">
                                <strong>缺失文件数:</strong> ${result.files_missing || 0}
                            </div>
                            <div class="stat-item">
                                <strong>更新记录数:</strong> ${result.records_updated || 0}
                            </div>
                            <div class="stat-item">
                                <strong>清理记录数:</strong> ${result.records_cleaned || 0}
                            </div>
                            <div class="stat-item">
                                <strong>孤立文件数:</strong> ${result.orphan_files || 0}
                            </div>
                            <div class="stat-item">
                                <strong>导入视频数:</strong> ${result.imported_videos || 0}
                            </div>
                        </div>
                    `;
                    
                } catch (error) {
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `<div class="status error">检查失败: ${error.message}</div>`;
                } finally {
                    btn.textContent = originalText;
                    btn.disabled = false;
                }
            };
            
            window.loadConsistencyStats = async function() {
                try {
                    const result = await apiRequest('/api/system/consistency-stats');
                    
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `
                        <div class="status">当前一致性状态</div>
                        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div class="stat-item">
                                <strong>总视频数:</strong> ${result.total_videos || 0}
                            </div>
                            <div class="stat-item">
                                <strong>已下载数:</strong> ${result.downloaded_videos || 0}
                            </div>
                            <div class="stat-item">
                                <strong>有路径记录:</strong> ${result.with_path || 0}
                            </div>
                            <div class="stat-item">
                                <strong>无路径记录:</strong> ${result.without_path || 0}
                            </div>
                        </div>
                        <div style="margin-top: 1rem; font-size: 0.9em; color: #666;">
                            最后检查时间: ${result.last_check_time || '未知'}
                        </div>
                    `;
                    
                } catch (error) {
                    const statsDiv = document.getElementById('consistency-stats');
                    statsDiv.innerHTML = `<div class="status error">加载失败: ${error.message}</div>`;
                }
            };

            loadTabData('dashboard');
        });
    </script>
</body>
</html>
